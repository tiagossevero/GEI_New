[
{
  "model": "desktop.document2",
  "pk": 104553,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: NFE",
    "description": "",
    "uuid": "639693b9-15f0-823d-50e7-941b0e1d6bab",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 104553, \"uuid\": \"639693b9-15f0-823d-50e7-941b0e1d6bab\", \"name\": \"GEI: NFE\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"639693b9-15f0-823d-50e7-941b0e1d6bab\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"da92e7fa-fb80-b443-8bf6-7829cf1be80a\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"teste\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- Passo 1: Criar a VIEW Unificada (NFe e NFCe)\\r\\nDROP VIEW IF EXISTS gessimples.gei_nfe;\\r\\nCREATE VIEW gessimples.gei_nfe AS\\r\\n\\r\\n-- Parte 1: Dados das Notas Fiscais Eletr\\u00f4nicas (NFe)\\r\\nSELECT\\r\\n    a.chave AS NFE_NU_CHAVE_ACESSO,\\r\\n    (a.ano_emissao * 100 + a.mes_emissao) AS NFE_PER_REF,\\r\\n    a.dhemi_orig AS NFE_DT_EMISSAO,\\r\\n    a.ip_transmissor AS NFE_IP_TRANSMISSAO,\\r\\n    a.situacao AS NFE_SITUACAO,\\r\\n    cf_emit.num_grupo AS grupo_emit,\\r\\n    a.procnfe.nfe.infnfe.emit.cnpj AS NFE_CNPJ_CPF_EMIT,\\r\\n    a.procnfe.nfe.infnfe.emit.ie AS NFE_EMIT_IE,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.fone AS NFE_EMIT_TELEFONE,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xlgr AS NFE_EMIT_END_LOGRADOURO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.nro AS NFE_EMIT_END_NUMERO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xcpl AS NFE_EMIT_END_COMPLEMENTO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xbairro AS NFE_EMIT_END_BAIRRO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xmun AS NFE_EMIT_END_MUNICIPIO,\\r\\n    a.procnfe.nfe.infnfe.emit.xfant AS NFE_EMIT_NM_FANTASIA,\\r\\n    a.procnfe.nfe.infnfe.emit.xnome AS NFE_EMIT_RAZAO_SOCIAL,\\r\\n    cf_dest.num_grupo AS grupo_dest,\\r\\n    a.procnfe.nfe.infnfe.dest.cnpj AS NFE_CNPJ_CPF_DEST,\\r\\n    a.procnfe.nfe.infnfe.dest.ie AS NFE_DEST_IE,\\r\\n    a.procnfe.nfe.infnfe.dest.email AS NFE_DEST_EMAIL,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.fone AS NFE_DEST_TELEFONE,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xlgr AS NFE_DEST_END_LOGRADOURO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.nro AS NFE_DEST_END_NUMERO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xcpl AS NFE_DEST_END_COMPLEMENTO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xbairro AS NFE_DEST_END_BAIRRO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xmun AS NFE_DEST_END_MUNICIPIO,\\r\\n    a.procnfe.nfe.infnfe.dest.xnome AS NFE_DEST_RAZAO_SOCIAL,\\r\\n    b.prod.cprod AS NFE_CD_PRODUTO,\\r\\n    b.prod.xprod AS NFE_DE_PRODUTO,\\r\\n\\r\\n    CONCAT(\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xlgr, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.nro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xcpl, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xbairro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xmun, '')\\r\\n    ) AS NFE_EMIT_END_COMPLETO,\\r\\n\\r\\n    CONCAT(\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xlgr, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.nro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xcpl, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xbairro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xmun, '')\\r\\n    ) AS NFE_DEST_END_COMPLETO,\\r\\n\\r\\n    'NFe' AS origem\\r\\n\\r\\nFROM nfe.nfe a,\\r\\n     a.procnfe.nfe.infnfe.det b\\r\\n\\r\\nLEFT JOIN gessimples.gei_cnpj cf_emit\\r\\n    ON cf_emit.cnpj = REGEXP_REPLACE(TRIM(CAST(a.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '')\\r\\nLEFT JOIN gessimples.gei_cnpj cf_dest\\r\\n    ON cf_dest.cnpj = REGEXP_REPLACE(TRIM(CAST(a.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '')\\r\\n\\r\\nWHERE a.situacao = 1\\r\\n  AND (cf_emit.num_grupo IS NOT NULL OR cf_dest.num_grupo IS NOT NULL)\\r\\n  AND CAST((a.ano_emissao * 100 + a.mes_emissao) AS STRING) LIKE '2025%'\\r\\n\\r\\nUNION ALL\\r\\n\\r\\n-- Parte 2: Dados das Notas Fiscais de Consumidor Eletr\\u00f4nicas (NFCe)\\r\\nSELECT\\r\\n    a.chave AS NFE_NU_CHAVE_ACESSO,\\r\\n    (a.ano_emissao * 100 + a.mes_emissao) AS NFE_PER_REF,\\r\\n    a.dhemi_orig AS NFE_DT_EMISSAO,\\r\\n    a.ip_transmissor AS NFE_IP_TRANSMISSAO,\\r\\n    1 AS NFE_SITUACAO, -- assumindo situa\\u00e7\\u00e3o padr\\u00e3o = 1\\r\\n    cf_emit.num_grupo AS grupo_emit,\\r\\n    a.procnfe.nfe.infnfe.emit.cnpj AS NFE_CNPJ_CPF_EMIT,\\r\\n    NULL AS NFE_EMIT_IE, -- Coluna adicionada para corresponder \\u00e0 NFe, IE pode n\\u00e3o ser aplic\\u00e1vel ou informada para NFCe\\r\\n    NULL AS NFE_EMIT_TELEFONE,  -- telefone n\\u00e3o informado para NFCe\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xlgr AS NFE_EMIT_END_LOGRADOURO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.nro AS NFE_EMIT_END_NUMERO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xcpl AS NFE_EMIT_END_COMPLEMENTO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xbairro AS NFE_EMIT_END_BAIRRO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xmun AS NFE_EMIT_END_MUNICIPIO,\\r\\n    a.procnfe.nfe.infnfe.emit.xfant AS NFE_EMIT_NM_FANTASIA,\\r\\n    a.procnfe.nfe.infnfe.emit.xnome AS NFE_EMIT_RAZAO_SOCIAL,\\r\\n    cf_dest.num_grupo AS grupo_dest,\\r\\n    a.procnfe.nfe.infnfe.dest.cnpj AS NFE_CNPJ_CPF_DEST,\\r\\n    NULL AS NFE_DEST_IE,  -- dado n\\u00e3o informado para NFCe\\r\\n    a.procnfe.nfe.infnfe.dest.email AS NFE_DEST_EMAIL,\\r\\n    NULL AS NFE_DEST_TELEFONE,  -- dado n\\u00e3o informado para NFCe\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xlgr AS NFE_DEST_END_LOGRADOURO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.nro AS NFE_DEST_END_NUMERO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xcpl AS NFE_DEST_END_COMPLEMENTO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xbairro AS NFE_DEST_END_BAIRRO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xmun AS NFE_DEST_END_MUNICIPIO,\\r\\n    a.procnfe.nfe.infnfe.dest.xnome AS NFE_DEST_RAZAO_SOCIAL,\\r\\n    d.item.prod.cprod AS NFE_CD_PRODUTO,\\r\\n    d.item.prod.xprod AS NFE_DE_PRODUTO,\\r\\n\\r\\n    CONCAT(\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xlgr, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.nro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xcpl, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xbairro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xmun, '')\\r\\n    ) AS NFE_EMIT_END_COMPLETO,\\r\\n\\r\\n    CONCAT(\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xlgr, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.nro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xcpl, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xbairro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xmun, '')\\r\\n    ) AS NFE_DEST_END_COMPLETO,\\r\\n\\r\\n    'NFCe' AS origem\\r\\n\\r\\nFROM nfce.nfce a,\\r\\n     a.procnfe.nfe.infnfe.det d\\r\\n\\r\\nLEFT JOIN gessimples.gei_cnpj cf_emit\\r\\n    ON cf_emit.cnpj = REGEXP_REPLACE(TRIM(CAST(a.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '')\\r\\nLEFT JOIN gessimples.gei_cnpj cf_dest\\r\\n    ON cf_dest.cnpj = REGEXP_REPLACE(TRIM(CAST(a.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '')\\r\\n\\r\\nWHERE (cf_emit.num_grupo IS NOT NULL OR cf_dest.num_grupo IS NOT NULL)\\r\\n  AND CAST((a.ano_emissao * 100 + a.mes_emissao) AS STRING) LIKE '2025%'\\r\\n-- AND (a.ano_emissao * 100 + a.mes_emissao) >= 202001  -- Janeiro de 2020\\r\\n-- AND (a.ano_emissao * 100 + a.mes_emissao) <= 202512  -- Dezembro de 2025\", \"statementsList\": [\"-- Passo 1: Criar a VIEW Unificada (NFe e NFCe)\\r\\nDROP VIEW IF EXISTS gessimples.gei_nfe;\", \"\\r\\nCREATE VIEW gessimples.gei_nfe AS\\r\\n\\r\\n-- Parte 1: Dados das Notas Fiscais Eletr\\u00f4nicas (NFe)\\r\\nSELECT\\r\\n    a.chave AS NFE_NU_CHAVE_ACESSO,\\r\\n    (a.ano_emissao * 100 + a.mes_emissao) AS NFE_PER_REF,\\r\\n    a.dhemi_orig AS NFE_DT_EMISSAO,\\r\\n    a.ip_transmissor AS NFE_IP_TRANSMISSAO,\\r\\n    a.situacao AS NFE_SITUACAO,\\r\\n    cf_emit.num_grupo AS grupo_emit,\\r\\n    a.procnfe.nfe.infnfe.emit.cnpj AS NFE_CNPJ_CPF_EMIT,\\r\\n    a.procnfe.nfe.infnfe.emit.ie AS NFE_EMIT_IE,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.fone AS NFE_EMIT_TELEFONE,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xlgr AS NFE_EMIT_END_LOGRADOURO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.nro AS NFE_EMIT_END_NUMERO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xcpl AS NFE_EMIT_END_COMPLEMENTO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xbairro AS NFE_EMIT_END_BAIRRO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xmun AS NFE_EMIT_END_MUNICIPIO,\\r\\n    a.procnfe.nfe.infnfe.emit.xfant AS NFE_EMIT_NM_FANTASIA,\\r\\n    a.procnfe.nfe.infnfe.emit.xnome AS NFE_EMIT_RAZAO_SOCIAL,\\r\\n    cf_dest.num_grupo AS grupo_dest,\\r\\n    a.procnfe.nfe.infnfe.dest.cnpj AS NFE_CNPJ_CPF_DEST,\\r\\n    a.procnfe.nfe.infnfe.dest.ie AS NFE_DEST_IE,\\r\\n    a.procnfe.nfe.infnfe.dest.email AS NFE_DEST_EMAIL,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.fone AS NFE_DEST_TELEFONE,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xlgr AS NFE_DEST_END_LOGRADOURO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.nro AS NFE_DEST_END_NUMERO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xcpl AS NFE_DEST_END_COMPLEMENTO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xbairro AS NFE_DEST_END_BAIRRO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xmun AS NFE_DEST_END_MUNICIPIO,\\r\\n    a.procnfe.nfe.infnfe.dest.xnome AS NFE_DEST_RAZAO_SOCIAL,\\r\\n    b.prod.cprod AS NFE_CD_PRODUTO,\\r\\n    b.prod.xprod AS NFE_DE_PRODUTO,\\r\\n\\r\\n    CONCAT(\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xlgr, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.nro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xcpl, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xbairro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xmun, '')\\r\\n    ) AS NFE_EMIT_END_COMPLETO,\\r\\n\\r\\n    CONCAT(\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xlgr, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.nro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xcpl, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xbairro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xmun, '')\\r\\n    ) AS NFE_DEST_END_COMPLETO,\\r\\n\\r\\n    'NFe' AS origem\\r\\n\\r\\nFROM nfe.nfe a,\\r\\n     a.procnfe.nfe.infnfe.det b\\r\\n\\r\\nLEFT JOIN gessimples.gei_cnpj cf_emit\\r\\n    ON cf_emit.cnpj = REGEXP_REPLACE(TRIM(CAST(a.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '')\\r\\nLEFT JOIN gessimples.gei_cnpj cf_dest\\r\\n    ON cf_dest.cnpj = REGEXP_REPLACE(TRIM(CAST(a.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '')\\r\\n\\r\\nWHERE a.situacao = 1\\r\\n  AND (cf_emit.num_grupo IS NOT NULL OR cf_dest.num_grupo IS NOT NULL)\\r\\n  AND CAST((a.ano_emissao * 100 + a.mes_emissao) AS STRING) LIKE '2025%'\\r\\n\\r\\nUNION ALL\\r\\n\\r\\n-- Parte 2: Dados das Notas Fiscais de Consumidor Eletr\\u00f4nicas (NFCe)\\r\\nSELECT\\r\\n    a.chave AS NFE_NU_CHAVE_ACESSO,\\r\\n    (a.ano_emissao * 100 + a.mes_emissao) AS NFE_PER_REF,\\r\\n    a.dhemi_orig AS NFE_DT_EMISSAO,\\r\\n    a.ip_transmissor AS NFE_IP_TRANSMISSAO,\\r\\n    1 AS NFE_SITUACAO, -- assumindo situa\\u00e7\\u00e3o padr\\u00e3o = 1\\r\\n    cf_emit.num_grupo AS grupo_emit,\\r\\n    a.procnfe.nfe.infnfe.emit.cnpj AS NFE_CNPJ_CPF_EMIT,\\r\\n    NULL AS NFE_EMIT_IE, -- Coluna adicionada para corresponder \\u00e0 NFe, IE pode n\\u00e3o ser aplic\\u00e1vel ou informada para NFCe\\r\\n    NULL AS NFE_EMIT_TELEFONE,  -- telefone n\\u00e3o informado para NFCe\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xlgr AS NFE_EMIT_END_LOGRADOURO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.nro AS NFE_EMIT_END_NUMERO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xcpl AS NFE_EMIT_END_COMPLEMENTO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xbairro AS NFE_EMIT_END_BAIRRO,\\r\\n    a.procnfe.nfe.infnfe.emit.enderemit.xmun AS NFE_EMIT_END_MUNICIPIO,\\r\\n    a.procnfe.nfe.infnfe.emit.xfant AS NFE_EMIT_NM_FANTASIA,\\r\\n    a.procnfe.nfe.infnfe.emit.xnome AS NFE_EMIT_RAZAO_SOCIAL,\\r\\n    cf_dest.num_grupo AS grupo_dest,\\r\\n    a.procnfe.nfe.infnfe.dest.cnpj AS NFE_CNPJ_CPF_DEST,\\r\\n    NULL AS NFE_DEST_IE,  -- dado n\\u00e3o informado para NFCe\\r\\n    a.procnfe.nfe.infnfe.dest.email AS NFE_DEST_EMAIL,\\r\\n    NULL AS NFE_DEST_TELEFONE,  -- dado n\\u00e3o informado para NFCe\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xlgr AS NFE_DEST_END_LOGRADOURO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.nro AS NFE_DEST_END_NUMERO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xcpl AS NFE_DEST_END_COMPLEMENTO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xbairro AS NFE_DEST_END_BAIRRO,\\r\\n    a.procnfe.nfe.infnfe.dest.enderdest.xmun AS NFE_DEST_END_MUNICIPIO,\\r\\n    a.procnfe.nfe.infnfe.dest.xnome AS NFE_DEST_RAZAO_SOCIAL,\\r\\n    d.item.prod.cprod AS NFE_CD_PRODUTO,\\r\\n    d.item.prod.xprod AS NFE_DE_PRODUTO,\\r\\n\\r\\n    CONCAT(\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xlgr, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.nro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xcpl, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xbairro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xmun, '')\\r\\n    ) AS NFE_EMIT_END_COMPLETO,\\r\\n\\r\\n    CONCAT(\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xlgr, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.nro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xcpl, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xbairro, ''), ' ',\\r\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xmun, '')\\r\\n    ) AS NFE_DEST_END_COMPLETO,\\r\\n\\r\\n    'NFCe' AS origem\\r\\n\\r\\nFROM nfce.nfce a,\\r\\n     a.procnfe.nfe.infnfe.det d\\r\\n\\r\\nLEFT JOIN gessimples.gei_cnpj cf_emit\\r\\n    ON cf_emit.cnpj = REGEXP_REPLACE(TRIM(CAST(a.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '')\\r\\nLEFT JOIN gessimples.gei_cnpj cf_dest\\r\\n    ON cf_dest.cnpj = REGEXP_REPLACE(TRIM(CAST(a.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '')\\r\\n\\r\\nWHERE (cf_emit.num_grupo IS NOT NULL OR cf_dest.num_grupo IS NOT NULL)\\r\\n  AND CAST((a.ano_emissao * 100 + a.mes_emissao) AS STRING) LIKE '2025%'\\r\\n-- AND (a.ano_emissao * 100 + a.mes_emissao) >= 202001  -- Janeiro de 2020\\r\\n-- AND (a.ano_emissao * 100 + a.mes_emissao) <= 202512  -- Dezembro de 2025\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- Passo 1: Criar a VIEW Unificada (NFe e NFCe)\\r\\nDROP VIEW IF EXISTS gessimples.gei_nfe;\", \"result\": {\"id\": \"8560d090-6f64-aa0f-1ba2-9a1b851a5581\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"3wUOdwUCRCivYBwx1afSHQ==\", \"guid\": \"N8VyS4n2SHEAAAAACOC/hQ==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"3345bfd907de2a28:b9695806e7b0bb9c\", \"session_id\": 20613, \"session_type\": \"impala\", \"statement_id\": 1, \"has_more_statements\": false, \"statements_count\": 2, \"previous_statement_hash\": \"996be21a64756e9e2d75b7b70071847f64d6d0b15343dfece874ab2b\", \"start\": {\"row\": 2, \"column\": 0}, \"end\": {\"row\": 129, \"column\": 75}, \"statement\": \"CREATE VIEW gessimples.gei_nfe AS\\n\\n-- Parte 1: Dados das Notas Fiscais Eletr\\u00f4nicas (NFe)\\nSELECT\\n    a.chave AS NFE_NU_CHAVE_ACESSO,\\n    (a.ano_emissao * 100 + a.mes_emissao) AS NFE_PER_REF,\\n    a.dhemi_orig AS NFE_DT_EMISSAO,\\n    a.ip_transmissor AS NFE_IP_TRANSMISSAO,\\n    a.situacao AS NFE_SITUACAO,\\n    cf_emit.num_grupo AS grupo_emit,\\n    a.procnfe.nfe.infnfe.emit.cnpj AS NFE_CNPJ_CPF_EMIT,\\n    a.procnfe.nfe.infnfe.emit.ie AS NFE_EMIT_IE,\\n    a.procnfe.nfe.infnfe.emit.enderemit.fone AS NFE_EMIT_TELEFONE,\\n    a.procnfe.nfe.infnfe.emit.enderemit.xlgr AS NFE_EMIT_END_LOGRADOURO,\\n    a.procnfe.nfe.infnfe.emit.enderemit.nro AS NFE_EMIT_END_NUMERO,\\n    a.procnfe.nfe.infnfe.emit.enderemit.xcpl AS NFE_EMIT_END_COMPLEMENTO,\\n    a.procnfe.nfe.infnfe.emit.enderemit.xbairro AS NFE_EMIT_END_BAIRRO,\\n    a.procnfe.nfe.infnfe.emit.enderemit.xmun AS NFE_EMIT_END_MUNICIPIO,\\n    a.procnfe.nfe.infnfe.emit.xfant AS NFE_EMIT_NM_FANTASIA,\\n    a.procnfe.nfe.infnfe.emit.xnome AS NFE_EMIT_RAZAO_SOCIAL,\\n    cf_dest.num_grupo AS grupo_dest,\\n    a.procnfe.nfe.infnfe.dest.cnpj AS NFE_CNPJ_CPF_DEST,\\n    a.procnfe.nfe.infnfe.dest.ie AS NFE_DEST_IE,\\n    a.procnfe.nfe.infnfe.dest.email AS NFE_DEST_EMAIL,\\n    a.procnfe.nfe.infnfe.dest.enderdest.fone AS NFE_DEST_TELEFONE,\\n    a.procnfe.nfe.infnfe.dest.enderdest.xlgr AS NFE_DEST_END_LOGRADOURO,\\n    a.procnfe.nfe.infnfe.dest.enderdest.nro AS NFE_DEST_END_NUMERO,\\n    a.procnfe.nfe.infnfe.dest.enderdest.xcpl AS NFE_DEST_END_COMPLEMENTO,\\n    a.procnfe.nfe.infnfe.dest.enderdest.xbairro AS NFE_DEST_END_BAIRRO,\\n    a.procnfe.nfe.infnfe.dest.enderdest.xmun AS NFE_DEST_END_MUNICIPIO,\\n    a.procnfe.nfe.infnfe.dest.xnome AS NFE_DEST_RAZAO_SOCIAL,\\n    b.prod.cprod AS NFE_CD_PRODUTO,\\n    b.prod.xprod AS NFE_DE_PRODUTO,\\n\\n    CONCAT(\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xlgr, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.nro, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xcpl, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xbairro, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xmun, '')\\n    ) AS NFE_EMIT_END_COMPLETO,\\n\\n    CONCAT(\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xlgr, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.nro, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xcpl, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xbairro, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xmun, '')\\n    ) AS NFE_DEST_END_COMPLETO,\\n\\n    'NFe' AS origem\\n\\nFROM nfe.nfe a,\\n     a.procnfe.nfe.infnfe.det b\\n\\nLEFT JOIN gessimples.gei_cnpj cf_emit\\n    ON cf_emit.cnpj = REGEXP_REPLACE(TRIM(CAST(a.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '')\\nLEFT JOIN gessimples.gei_cnpj cf_dest\\n    ON cf_dest.cnpj = REGEXP_REPLACE(TRIM(CAST(a.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '')\\n\\nWHERE a.situacao = 1\\n  AND (cf_emit.num_grupo IS NOT NULL OR cf_dest.num_grupo IS NOT NULL)\\n  AND CAST((a.ano_emissao * 100 + a.mes_emissao) AS STRING) LIKE '2025%'\\n\\nUNION ALL\\n\\n-- Parte 2: Dados das Notas Fiscais de Consumidor Eletr\\u00f4nicas (NFCe)\\nSELECT\\n    a.chave AS NFE_NU_CHAVE_ACESSO,\\n    (a.ano_emissao * 100 + a.mes_emissao) AS NFE_PER_REF,\\n    a.dhemi_orig AS NFE_DT_EMISSAO,\\n    a.ip_transmissor AS NFE_IP_TRANSMISSAO,\\n    1 AS NFE_SITUACAO, -- assumindo situa\\u00e7\\u00e3o padr\\u00e3o = 1\\n    cf_emit.num_grupo AS grupo_emit,\\n    a.procnfe.nfe.infnfe.emit.cnpj AS NFE_CNPJ_CPF_EMIT,\\n    NULL AS NFE_EMIT_IE, -- Coluna adicionada para corresponder \\u00e0 NFe, IE pode n\\u00e3o ser aplic\\u00e1vel ou informada para NFCe\\n    NULL AS NFE_EMIT_TELEFONE,  -- telefone n\\u00e3o informado para NFCe\\n    a.procnfe.nfe.infnfe.emit.enderemit.xlgr AS NFE_EMIT_END_LOGRADOURO,\\n    a.procnfe.nfe.infnfe.emit.enderemit.nro AS NFE_EMIT_END_NUMERO,\\n    a.procnfe.nfe.infnfe.emit.enderemit.xcpl AS NFE_EMIT_END_COMPLEMENTO,\\n    a.procnfe.nfe.infnfe.emit.enderemit.xbairro AS NFE_EMIT_END_BAIRRO,\\n    a.procnfe.nfe.infnfe.emit.enderemit.xmun AS NFE_EMIT_END_MUNICIPIO,\\n    a.procnfe.nfe.infnfe.emit.xfant AS NFE_EMIT_NM_FANTASIA,\\n    a.procnfe.nfe.infnfe.emit.xnome AS NFE_EMIT_RAZAO_SOCIAL,\\n    cf_dest.num_grupo AS grupo_dest,\\n    a.procnfe.nfe.infnfe.dest.cnpj AS NFE_CNPJ_CPF_DEST,\\n    NULL AS NFE_DEST_IE,  -- dado n\\u00e3o informado para NFCe\\n    a.procnfe.nfe.infnfe.dest.email AS NFE_DEST_EMAIL,\\n    NULL AS NFE_DEST_TELEFONE,  -- dado n\\u00e3o informado para NFCe\\n    a.procnfe.nfe.infnfe.dest.enderdest.xlgr AS NFE_DEST_END_LOGRADOURO,\\n    a.procnfe.nfe.infnfe.dest.enderdest.nro AS NFE_DEST_END_NUMERO,\\n    a.procnfe.nfe.infnfe.dest.enderdest.xcpl AS NFE_DEST_END_COMPLEMENTO,\\n    a.procnfe.nfe.infnfe.dest.enderdest.xbairro AS NFE_DEST_END_BAIRRO,\\n    a.procnfe.nfe.infnfe.dest.enderdest.xmun AS NFE_DEST_END_MUNICIPIO,\\n    a.procnfe.nfe.infnfe.dest.xnome AS NFE_DEST_RAZAO_SOCIAL,\\n    d.item.prod.cprod AS NFE_CD_PRODUTO,\\n    d.item.prod.xprod AS NFE_DE_PRODUTO,\\n\\n    CONCAT(\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xlgr, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.nro, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xcpl, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xbairro, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xmun, '')\\n    ) AS NFE_EMIT_END_COMPLETO,\\n\\n    CONCAT(\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xlgr, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.nro, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xcpl, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xbairro, ''), ' ',\\n        COALESCE(a.procnfe.nfe.infnfe.dest.enderdest.xmun, '')\\n    ) AS NFE_DEST_END_COMPLETO,\\n\\n    'NFCe' AS origem\\n\\nFROM nfce.nfce a,\\n     a.procnfe.nfe.infnfe.det d\\n\\nLEFT JOIN gessimples.gei_cnpj cf_emit\\n    ON cf_emit.cnpj = REGEXP_REPLACE(TRIM(CAST(a.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '')\\nLEFT JOIN gessimples.gei_cnpj cf_dest\\n    ON cf_dest.cnpj = REGEXP_REPLACE(TRIM(CAST(a.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '')\\n\\nWHERE (cf_emit.num_grupo IS NOT NULL OR cf_dest.num_grupo IS NOT NULL)\\n  AND CAST((a.ano_emissao * 100 + a.mes_emissao) AS STRING) LIKE '2025%'\\n-- AND (a.ano_emissao * 100 + a.mes_emissao) >= 202001  -- Janeiro de 2020\\n-- AND (a.ano_emissao * 100 + a.mes_emissao) <= 202512  -- Dezembro de 2025\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 1, \"statement_range\": {\"start\": {\"row\": 2, \"column\": 0}, \"end\": {\"row\": 129, \"column\": 75}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-09-19T12:40:17.421Z\", \"endTime\": \"2025-09-19T12:40:17.613Z\", \"executionTime\": 192, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1758285617084, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 100, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- Passo 1: Criar a VIEW Unificada (NFe e NFCe)\r\nDROP VIEW IF EXISTS gessimples.gei_nfe;\r\nCREATE VIEW gessimples.gei_nfe AS\r\n\r\n-- Parte 1: Dados das Notas Fiscais EletrÃ´nicas (NFe)\r\nSELECT\r\n    a.chave AS NFE_NU_CHAVE_ACESSO,\r\n    (a.ano_emissao * 100 + a.mes_emissao) AS NFE_PER_REF,\r\n    a.dhemi_orig AS NFE_DT_EMISSAO,\r\n    a.ip_transmissor AS NFE_IP_TRANSMISSAO,\r\n    a.situacao AS NFE_SITUACAO,\r\n    cf_emit.num_grupo AS grupo_emit,\r\n    a.procnfe.nfe.infnfe.emit.cnpj AS NFE_CNPJ_CPF_EMIT,\r\n    a.procnfe.nfe.infnfe.emit.ie AS NFE_EMIT_IE,\r\n    a.procnfe.nfe.infnfe.emit.enderemit.fone AS NFE_EMIT_TELEFONE,\r\n    a.procnfe.nfe.infnfe.emit.enderemit.xlgr AS NFE_EMIT_END_LOGRADOURO,\r\n    a.procnfe.nfe.infnfe.emit.enderemit.nro AS NFE_EMIT_END_NUMERO,\r\n    a.procnfe.nfe.infnfe.emit.enderemit.xcpl AS NFE_EMIT_END_COMPLEMENTO,\r\n    a.procnfe.nfe.infnfe.emit.enderemit.xbairro AS NFE_EMIT_END_BAIRRO,\r\n    a.procnfe.nfe.infnfe.emit.enderemit.xmun AS NFE_EMIT_END_MUNICIPIO,\r\n    a.procnfe.nfe.infnfe.emit.xfant AS NFE_EMIT_NM_FANTASIA,\r\n    a.procnfe.nfe.infnfe.emit.xnome AS NFE_EMIT_RAZAO_SOCIAL,\r\n    cf_dest.num_grupo AS grupo_dest,\r\n    a.procnfe.nfe.infnfe.dest.cnpj AS NFE_CNPJ_CPF_DEST,\r\n    a.procnfe.nfe.infnfe.dest.ie AS NFE_DEST_IE,\r\n    a.procnfe.nfe.infnfe.dest.email AS NFE_DEST_EMAIL,\r\n    a.procnfe.nfe.infnfe.dest.enderdest.fone AS NFE_DEST_TELEFONE,\r\n    a.procnfe.nfe.infnfe.dest.enderdest.xlgr AS NFE_DEST_END_LOGRADOURO,\r\n    a.procnfe.nfe.infnfe.dest.enderdest.nro AS NFE_DEST_END_NUMERO,\r\n    a.procnfe.nfe.infnfe.dest.enderdest.xcpl AS NFE_DEST_END_COMPLEMENTO,\r\n    a.procnfe.nfe.infnfe.dest.enderdest.xbairro AS NFE_DEST_END_BAIRRO,\r\n    a.procnfe.nfe.infnfe.dest.enderdest.xmun AS NFE_DEST_END_MUNICIPIO,\r\n    a.procnfe.nfe.infnfe.dest.xnome AS NFE_DEST_RAZAO_SOCIAL,\r\n    b.prod.cprod AS NFE_CD_PRODUTO,\r\n    b.prod.xprod AS NFE_DE_PRODUTO,\r\n\r\n    CONCAT(\r\n        COALESCE(a.procnfe.nfe.infnfe.emit.enderemit.xlgr, ''), ' ',\r\n        COALESCE(a.procnfe.nfe.infnfe.em",
    "last_modified": "2025-10-02T17:44:50.160",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 105024,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: INCONS",
    "description": "",
    "uuid": "14f33d3b-50f9-ee48-77de-f40d835a36c8",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 105024, \"uuid\": \"14f33d3b-50f9-ee48-77de-f40d835a36c8\", \"name\": \"GEI: INCONS\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"14f33d3b-50f9-ee48-77de-f40d835a36c8\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"4b2018b5-8f39-4825-16ac-2c0a77aee389\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"--------------------------------------------------------------------------------\\r\\n-- 1) Inconsist\\u00eancia de Clientes\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_clientes_incons;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE VIEW gessimples.gei_clientes_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'cliente' AS info_tipo,\\r\\n      n.NFE_CNPJ_CPF_DEST AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON (n.NFE_CNPJ_CPF_EMIT = c.cnpj)\\r\\n    WHERE n.NFE_CNPJ_CPF_EMIT IS NOT NULL\\r\\n      AND n.NFE_CNPJ_CPF_DEST IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\\r\\n\\r\\nSELECT b.*, \\r\\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS cliente_incons\\r\\nFROM gessimples.gei_nfe b\\r\\nLEFT JOIN gessimples.gei_clientes_incons c\\r\\n  ON c.num_grupo = b.grupo_emit AND c.info_valor = b.nfe_cnpj_cpf_dest\\r\\nWHERE c.num_grupo IS NOT NULL;\\r\\n\\r\\n--------------------------------------------------------------------------------\\r\\n-- 2) Inconsist\\u00eancia de E-mails de Destinat\\u00e1rios\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_email_incons;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE VIEW gessimples.gei_email_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'email_dest' AS info_tipo,\\r\\n      n.NFE_DEST_EMAIL AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON n.NFE_CNPJ_CPF_DEST = c.cnpj\\r\\n    WHERE n.NFE_DEST_EMAIL IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\\r\\n\\r\\nSELECT b.*, \\r\\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS email_incons\\r\\nFROM gessimples.gei_nfe b\\r\\nLEFT JOIN gessimples.gei_email_incons c\\r\\n  ON c.num_grupo = b.grupo_dest AND c.info_valor = b.nfe_dest_email\\r\\nWHERE c.num_grupo IS NOT NULL;\\r\\n\\r\\n--------------------------------------------------------------------------------\\r\\n-- 3) Inconsist\\u00eancia de Telefones de Destinat\\u00e1rios\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_tel_dest_incons;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE VIEW gessimples.gei_tel_dest_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'tel_dest' AS info_tipo,\\r\\n      n.NFE_DEST_TELEFONE AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON n.NFE_CNPJ_CPF_DEST = c.cnpj\\r\\n    WHERE n.NFE_DEST_TELEFONE IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\\r\\n\\r\\nSELECT b.*, \\r\\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS tel_dest_incons\\r\\nFROM gessimples.gei_nfe b\\r\\nLEFT JOIN gessimples.gei_tel_dest_incons c\\r\\n  ON c.num_grupo = b.grupo_dest AND c.info_valor = b.nfe_dest_telefone\\r\\nWHERE c.num_grupo IS NOT NULL;\\r\\n\\r\\n--------------------------------------------------------------------------------\\r\\n-- 4) Inconsist\\u00eancia de Telefones de Emitentes\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_tel_emit_incons;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE VIEW gessimples.gei_tel_emit_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'tel_emit' AS info_tipo,\\r\\n      n.NFE_EMIT_TELEFONE AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON n.NFE_CNPJ_CPF_EMIT = c.cnpj\\r\\n    WHERE n.NFE_EMIT_TELEFONE IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\\r\\n\\r\\nSELECT b.*, \\r\\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS tel_emit_incons\\r\\nFROM gessimples.gei_nfe b\\r\\nLEFT JOIN gessimples.gei_tel_emit_incons c\\r\\n  ON c.num_grupo = b.grupo_emit AND c.info_valor = b.nfe_emit_telefone\\r\\nWHERE c.num_grupo IS NOT NULL;\\r\\n\\r\\n--------------------------------------------------------------------------------\\r\\n-- 5) Inconsist\\u00eancia de C\\u00f3digos de Produto\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_codigos_incons;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE VIEW gessimples.gei_codigos_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'codigo_produto' AS info_tipo,\\r\\n      n.NFE_CD_PRODUTO AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON n.NFE_CNPJ_CPF_EMIT = c.cnpj\\r\\n    WHERE n.NFE_CD_PRODUTO IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\\r\\n\\r\\nSELECT b.*, \\r\\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS codigo_produto_incons\\r\\nFROM gessimples.gei_nfe b\\r\\nLEFT JOIN gessimples.gei_codigos_incons c\\r\\n  ON c.num_grupo = b.grupo_emit AND c.info_valor = b.nfe_cd_produto\\r\\nWHERE c.num_grupo IS NOT NULL;\\r\\n\\r\\n--------------------------------------------------------------------------------\\r\\n-- 6) Inconsist\\u00eancia de Fornecedores\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_fornecedores_incons;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE VIEW gessimples.gei_fornecedores_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'fornecedor' AS info_tipo,\\r\\n      n.NFE_CNPJ_CPF_EMIT AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON n.NFE_CNPJ_CPF_DEST = c.cnpj\\r\\n    WHERE n.NFE_CNPJ_CPF_DEST IS NOT NULL\\r\\n      AND n.NFE_CNPJ_CPF_EMIT IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\\r\\n\\r\\nSELECT b.*, \\r\\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS fornecedor_incons\\r\\nFROM gessimples.gei_nfe b\\r\\nLEFT JOIN gessimples.gei_fornecedores_incons c\\r\\n  ON c.num_grupo = b.grupo_dest AND c.info_valor = b.nfe_cnpj_cpf_emit\\r\\nWHERE c.num_grupo IS NOT NULL;\\r\\n\\r\\n--------------------------------------------------------------------------------\\r\\n-- 7) Inconsist\\u00eancia de Endere\\u00e7o do Emitente\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_end_emit_incons;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE VIEW gessimples.gei_end_emit_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'end_emit' AS info_tipo,\\r\\n      n.NFE_EMIT_END_COMPLETO AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON n.NFE_CNPJ_CPF_EMIT = c.cnpj\\r\\n    WHERE n.NFE_EMIT_END_COMPLETO IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\\r\\n\\r\\nSELECT b.*, \\r\\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS end_emit_incons\\r\\nFROM gessimples.gei_nfe b\\r\\nLEFT JOIN gessimples.gei_end_emit_incons c\\r\\n  ON c.num_grupo = b.grupo_emit AND c.info_valor = b.nfe_emit_end_completo\\r\\nWHERE c.num_grupo IS NOT NULL;\\r\\n\\r\\n--------------------------------------------------------------------------------\\r\\n-- 8) Inconsist\\u00eancia de Endere\\u00e7o do Destinat\\u00e1rio\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_end_dest_incons;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE VIEW gessimples.gei_end_dest_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'end_dest' AS info_tipo,\\r\\n      n.NFE_DEST_END_COMPLETO AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON n.NFE_CNPJ_CPF_DEST = c.cnpj\\r\\n    WHERE n.NFE_DEST_END_COMPLETO IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\\r\\n\\r\\nSELECT b.*, \\r\\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS end_dest_incons\\r\\nFROM gessimples.gei_nfe b\\r\\nLEFT JOIN gessimples.gei_end_dest_incons c\\r\\n  ON c.num_grupo = b.grupo_dest AND c.info_valor = b.nfe_dest_end_completo\\r\\nWHERE c.num_grupo IS NOT NULL;\\r\\n\\r\\n--------------------------------------------------------------------------------\\r\\n-- 9) Inconsist\\u00eancia de Descri\\u00e7\\u00e3o do Produto\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_produtos_incons;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE VIEW gessimples.gei_produtos_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'descricao_produto' AS info_tipo,\\r\\n      n.NFE_DE_PRODUTO AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON n.NFE_CNPJ_CPF_EMIT = c.cnpj\\r\\n    WHERE n.NFE_DE_PRODUTO IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\\r\\n\\r\\nSELECT b.*, \\r\\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS descricao_produto_incons\\r\\nFROM gessimples.gei_nfe b\\r\\nLEFT JOIN gessimples.gei_produtos_incons c\\r\\n  ON c.num_grupo = b.grupo_emit AND c.info_valor = b.nfe_de_produto\\r\\nWHERE c.num_grupo IS NOT NULL;\\r\\n\\r\\n--------------------------------------------------------------------------------\\r\\n-- 10) Inconsist\\u00eancia de IP de Transmiss\\u00e3o\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_ip_incons;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE VIEW gessimples.gei_ip_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'ip_transmissao' AS info_tipo,\\r\\n      n.NFE_IP_TRANSMISSAO AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON n.NFE_CNPJ_CPF_EMIT = c.cnpj\\r\\n    WHERE n.NFE_IP_TRANSMISSAO IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\\r\\n\\r\\nSELECT b.*, \\r\\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS ip_transmissao_incons\\r\\nFROM gessimples.gei_nfe b\\r\\nLEFT JOIN gessimples.gei_ip_incons c\\r\\n  ON c.num_grupo = b.grupo_emit AND c.info_valor = b.nfe_ip_transmissao\\r\\nWHERE c.num_grupo IS NOT NULL;\", \"statementsList\": [\"--------------------------------------------------------------------------------\\r\\n-- 1) Inconsist\\u00eancia de Clientes\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_clientes_incons;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE VIEW gessimples.gei_clientes_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'cliente' AS info_tipo,\\r\\n      n.NFE_CNPJ_CPF_DEST AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON (n.NFE_CNPJ_CPF_EMIT = c.cnpj)\\r\\n    WHERE n.NFE_CNPJ_CPF_EMIT IS NOT NULL\\r\\n      AND n.NFE_CNPJ_CPF_DEST IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\", \"\\r\\n\\r\\nSELECT b.*, \\r\\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS cliente_incons\\r\\nFROM gessimples.gei_nfe b\\r\\nLEFT JOIN gessimples.gei_clientes_incons c\\r\\n  ON c.num_grupo = b.grupo_emit AND c.info_valor = b.nfe_cnpj_cpf_dest\\r\\nWHERE c.num_grupo IS NOT NULL;\", \"\\r\\n\\r\\n--------------------------------------------------------------------------------\\r\\n-- 2) Inconsist\\u00eancia de E-mails de Destinat\\u00e1rios\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_email_incons;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE VIEW gessimples.gei_email_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'email_dest' AS info_tipo,\\r\\n      n.NFE_DEST_EMAIL AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON n.NFE_CNPJ_CPF_DEST = c.cnpj\\r\\n    WHERE n.NFE_DEST_EMAIL IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\", \"\\r\\n\\r\\nSELECT b.*, \\r\\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS email_incons\\r\\nFROM gessimples.gei_nfe b\\r\\nLEFT JOIN gessimples.gei_email_incons c\\r\\n  ON c.num_grupo = b.grupo_dest AND c.info_valor = b.nfe_dest_email\\r\\nWHERE c.num_grupo IS NOT NULL;\", \"\\r\\n\\r\\n--------------------------------------------------------------------------------\\r\\n-- 3) Inconsist\\u00eancia de Telefones de Destinat\\u00e1rios\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_tel_dest_incons;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE VIEW gessimples.gei_tel_dest_incons AS (\\r\\n  SELECT \\r\\n    num_grupo, \\r\\n    info_valor, \\r\\n    info_tipo, \\r\\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\\r\\n  FROM (\\r\\n    SELECT\\r\\n      c.num_grupo,\\r\\n      c.cnpj AS cnpj_grupo,\\r\\n      'tel_dest' AS info_tipo,\\r\\n      n.NFE_DEST_TELEFONE AS info_valor,\\r\\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\\r\\n    FROM gessimples.gei_nfe n\\r\\n    JOIN gessimples.gei_cnpj c\\r\\n      ON n.NFE_CNPJ_CPF_DEST = c.cnpj\\r\\n    WHERE n.NFE_DEST_TELEFONE IS NOT NULL\\r\\n  ) sub\\r\\n  GROUP BY num_grupo, info_valor, info_tipo\\r\\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\\r\\n);\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"--------------------------------------------------------------------------------\\r\\n-- 1) Inconsist\\u00eancia de Clientes\\r\\n--------------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS gessimples.gei_clientes_incons;\", \"result\": {\"id\": \"a65d5ac1-9eb9-309e-a47b-8a426142ed19\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"wKf6lapqTZWKkodXR4YVjQ==\", \"guid\": \"qGCbjl9JTScAAAAAOl8rpw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"6445179dd1f0034e:faec21667ece6698\", \"session_id\": 15772, \"session_type\": \"impala\", \"statement_id\": 39, \"has_more_statements\": false, \"statements_count\": 40, \"previous_statement_hash\": \"3cca5502c3ec6857337d11a9178c3d7e487b7a7bffce44da8e757c1e\", \"start\": {\"row\": 345, \"column\": 0}, \"end\": {\"row\": 350, \"column\": 29}, \"statement\": \"SELECT b.*, \\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS ip_transmissao_incons\\nFROM gessimples.gei_nfe b\\nLEFT JOIN gessimples.gei_ip_incons c\\n  ON c.num_grupo = b.grupo_emit AND c.info_valor = b.nfe_ip_transmissao\\nWHERE c.num_grupo IS NOT NULL\"}, \"meta\": [], \"rows\": null, \"hasMore\": false, \"statement_id\": 39, \"statement_range\": {\"start\": {\"row\": 345, \"column\": 0}, \"end\": {\"row\": 350, \"column\": 29}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-05-20T18:55:37.469Z\", \"endTime\": \"2025-05-20T18:55:45.859Z\", \"executionTime\": 8390, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1747767336710, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 100, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false, \"is_history\": false}",
    "extra": "",
    "search": "--------------------------------------------------------------------------------\r\n-- 1) InconsistÃªncia de Clientes\r\n--------------------------------------------------------------------------------\r\nDROP VIEW IF EXISTS gessimples.gei_clientes_incons;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE VIEW gessimples.gei_clientes_incons AS (\r\n  SELECT \r\n    num_grupo, \r\n    info_valor, \r\n    info_tipo, \r\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\r\n  FROM (\r\n    SELECT\r\n      c.num_grupo,\r\n      c.cnpj AS cnpj_grupo,\r\n      'cliente' AS info_tipo,\r\n      n.NFE_CNPJ_CPF_DEST AS info_valor,\r\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\r\n    FROM gessimples.gei_nfe n\r\n    JOIN gessimples.gei_cnpj c\r\n      ON (n.NFE_CNPJ_CPF_EMIT = c.cnpj)\r\n    WHERE n.NFE_CNPJ_CPF_EMIT IS NOT NULL\r\n      AND n.NFE_CNPJ_CPF_DEST IS NOT NULL\r\n  ) sub\r\n  GROUP BY num_grupo, info_valor, info_tipo\r\n  HAVING COUNT(DISTINCT cnpj_grupo) > 0\r\n);\r\n\r\nSELECT b.*, \r\n       CASE WHEN c.info_valor IS NOT NULL AND c.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS cliente_incons\r\nFROM gessimples.gei_nfe b\r\nLEFT JOIN gessimples.gei_clientes_incons c\r\n  ON c.num_grupo = b.grupo_emit AND c.info_valor = b.nfe_cnpj_cpf_dest\r\nWHERE c.num_grupo IS NOT NULL;\r\n\r\n--------------------------------------------------------------------------------\r\n-- 2) InconsistÃªncia de E-mails de DestinatÃ¡rios\r\n--------------------------------------------------------------------------------\r\nDROP VIEW IF EXISTS gessimples.gei_email_incons;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE VIEW gessimples.gei_email_incons AS (\r\n  SELECT \r\n    num_grupo, \r\n    info_valor, \r\n    info_tipo, \r\n    COUNT(DISTINCT cnpj_grupo) AS contagem_cnpj\r\n  FROM (\r\n    SELECT\r\n      c.num_grupo,\r\n      c.cnpj AS cnpj_grupo,\r\n      'email_dest' AS info_tipo,\r\n      n.NFE_DEST_EMAIL AS info_valor,\r\n      n.NFE_NU_CHAVE_ACESSO AS nfe_nu_chave_acesso\r\n    FROM gessimples.gei_nfe n\r\n    JOIN gessimples.gei_cnpj c\r\n      ON n.NFE_CNPJ_CPF_DEST = c.cnpj\r\n    WHERE n.NFE_DES",
    "last_modified": "2025-10-02T17:46:34.334",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 105064,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: COMPLETO",
    "description": "",
    "uuid": "49df7830-bad9-c094-6521-b3f5144d33f9",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 105064, \"uuid\": \"49df7830-bad9-c094-6521-b3f5144d33f9\", \"name\": \"GEI: COMPLETO\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"0a92eb40-31ab-5cb2-5bfa-10399065d855\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"DROP TABLE IF EXISTS gessimples.gei_nfe_completo;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfe_completo AS\\r\\nSELECT\\r\\n    -- Colunas originais da gei_nfe\\r\\n    n.NFE_NU_CHAVE_ACESSO,\\r\\n    n.NFE_PER_REF,\\r\\n    n.NFE_DT_EMISSAO,\\r\\n    n.NFE_IP_TRANSMISSAO,\\r\\n    n.NFE_SITUACAO,\\r\\n    n.grupo_emit,\\r\\n    n.NFE_CNPJ_CPF_EMIT,\\r\\n    n.NFE_EMIT_IE,\\r\\n    n.NFE_EMIT_TELEFONE,\\r\\n    n.NFE_EMIT_END_COMPLETO,\\r\\n    n.NFE_EMIT_NM_FANTASIA,\\r\\n    n.NFE_EMIT_RAZAO_SOCIAL,\\r\\n    n.grupo_dest,\\r\\n    n.NFE_CNPJ_CPF_DEST,\\r\\n    n.NFE_DEST_IE,\\r\\n    n.NFE_DEST_EMAIL,\\r\\n    n.NFE_DEST_TELEFONE,\\r\\n    n.NFE_DEST_END_COMPLETO,\\r\\n    n.NFE_DEST_RAZAO_SOCIAL,\\r\\n    n.NFE_CD_PRODUTO,\\r\\n    n.NFE_DE_PRODUTO,\\r\\n    \\r\\n    -- Colunas de inconsist\\u00eancia: 'S' se houver inconsist\\u00eancia, 'N' caso contr\\u00e1rio\\r\\n    CASE WHEN ci.info_valor IS NOT NULL AND ci.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS cliente_incons,\\r\\n    CASE WHEN ei.info_valor IS NOT NULL AND ei.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS email_incons,\\r\\n    CASE WHEN td.info_valor IS NOT NULL AND td.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS tel_dest_incons,\\r\\n    CASE WHEN te.info_valor IS NOT NULL AND te.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS tel_emit_incons,\\r\\n    CASE WHEN cp.info_valor IS NOT NULL AND cp.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS codigo_produto_incons,\\r\\n    CASE WHEN fo.info_valor IS NOT NULL AND fo.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS fornecedor_incons,\\r\\n    CASE WHEN ee.info_valor IS NOT NULL AND ee.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS end_emit_incons,\\r\\n    CASE WHEN ed.info_valor IS NOT NULL AND ed.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS end_dest_incons,\\r\\n    CASE WHEN dp.info_valor IS NOT NULL AND dp.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS descricao_produto_incons,\\r\\n    CASE WHEN ip.info_valor IS NOT NULL AND ip.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS ip_transmissao_incons\\r\\nFROM gessimples.gei_nfe n\\r\\n    -- JOINs com as views de inconsist\\u00eancia\\r\\n    LEFT JOIN gessimples.gei_clientes_incons ci\\r\\n      ON ci.num_grupo = n.grupo_emit \\r\\n     AND ci.info_valor = n.NFE_CNPJ_CPF_DEST\\r\\n    LEFT JOIN gessimples.gei_email_incons ei\\r\\n      ON ei.num_grupo = n.grupo_dest \\r\\n     AND ei.info_valor = n.NFE_DEST_EMAIL\\r\\n    LEFT JOIN gessimples.gei_tel_dest_incons td\\r\\n      ON td.num_grupo = n.grupo_dest \\r\\n     AND td.info_valor = n.NFE_DEST_TELEFONE\\r\\n    LEFT JOIN gessimples.gei_tel_emit_incons te\\r\\n      ON te.num_grupo = n.grupo_emit \\r\\n     AND te.info_valor = n.NFE_EMIT_TELEFONE\\r\\n    LEFT JOIN gessimples.gei_codigos_incons cp\\r\\n      ON cp.num_grupo = n.grupo_emit \\r\\n     AND cp.info_valor = n.NFE_CD_PRODUTO\\r\\n    LEFT JOIN gessimples.gei_fornecedores_incons fo\\r\\n      ON fo.num_grupo = n.grupo_dest \\r\\n     AND fo.info_valor = n.NFE_CNPJ_CPF_EMIT\\r\\n    LEFT JOIN gessimples.gei_end_emit_incons ee\\r\\n      ON ee.num_grupo = n.grupo_emit \\r\\n     AND ee.info_valor = n.NFE_EMIT_END_COMPLETO\\r\\n    LEFT JOIN gessimples.gei_end_dest_incons ed\\r\\n      ON ed.num_grupo = n.grupo_dest \\r\\n     AND ed.info_valor = n.NFE_DEST_END_COMPLETO\\r\\n    LEFT JOIN gessimples.gei_produtos_incons dp\\r\\n      ON dp.num_grupo = n.grupo_emit \\r\\n     AND dp.info_valor = n.NFE_DE_PRODUTO\\r\\n    LEFT JOIN gessimples.gei_ip_incons ip\\r\\n      ON ip.num_grupo = n.grupo_emit \\r\\n     AND ip.info_valor = n.NFE_IP_TRANSMISSAO;\", \"statementsList\": [\"DROP TABLE IF EXISTS gessimples.gei_nfe_completo;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfe_completo AS\\r\\nSELECT\\r\\n    -- Colunas originais da gei_nfe\\r\\n    n.NFE_NU_CHAVE_ACESSO,\\r\\n    n.NFE_PER_REF,\\r\\n    n.NFE_DT_EMISSAO,\\r\\n    n.NFE_IP_TRANSMISSAO,\\r\\n    n.NFE_SITUACAO,\\r\\n    n.grupo_emit,\\r\\n    n.NFE_CNPJ_CPF_EMIT,\\r\\n    n.NFE_EMIT_IE,\\r\\n    n.NFE_EMIT_TELEFONE,\\r\\n    n.NFE_EMIT_END_COMPLETO,\\r\\n    n.NFE_EMIT_NM_FANTASIA,\\r\\n    n.NFE_EMIT_RAZAO_SOCIAL,\\r\\n    n.grupo_dest,\\r\\n    n.NFE_CNPJ_CPF_DEST,\\r\\n    n.NFE_DEST_IE,\\r\\n    n.NFE_DEST_EMAIL,\\r\\n    n.NFE_DEST_TELEFONE,\\r\\n    n.NFE_DEST_END_COMPLETO,\\r\\n    n.NFE_DEST_RAZAO_SOCIAL,\\r\\n    n.NFE_CD_PRODUTO,\\r\\n    n.NFE_DE_PRODUTO,\\r\\n    \\r\\n    -- Colunas de inconsist\\u00eancia: 'S' se houver inconsist\\u00eancia, 'N' caso contr\\u00e1rio\\r\\n    CASE WHEN ci.info_valor IS NOT NULL AND ci.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS cliente_incons,\\r\\n    CASE WHEN ei.info_valor IS NOT NULL AND ei.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS email_incons,\\r\\n    CASE WHEN td.info_valor IS NOT NULL AND td.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS tel_dest_incons,\\r\\n    CASE WHEN te.info_valor IS NOT NULL AND te.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS tel_emit_incons,\\r\\n    CASE WHEN cp.info_valor IS NOT NULL AND cp.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS codigo_produto_incons,\\r\\n    CASE WHEN fo.info_valor IS NOT NULL AND fo.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS fornecedor_incons,\\r\\n    CASE WHEN ee.info_valor IS NOT NULL AND ee.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS end_emit_incons,\\r\\n    CASE WHEN ed.info_valor IS NOT NULL AND ed.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS end_dest_incons,\\r\\n    CASE WHEN dp.info_valor IS NOT NULL AND dp.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS descricao_produto_incons,\\r\\n    CASE WHEN ip.info_valor IS NOT NULL AND ip.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS ip_transmissao_incons\\r\\nFROM gessimples.gei_nfe n\\r\\n    -- JOINs com as views de inconsist\\u00eancia\\r\\n    LEFT JOIN gessimples.gei_clientes_incons ci\\r\\n      ON ci.num_grupo = n.grupo_emit \\r\\n     AND ci.info_valor = n.NFE_CNPJ_CPF_DEST\\r\\n    LEFT JOIN gessimples.gei_email_incons ei\\r\\n      ON ei.num_grupo = n.grupo_dest \\r\\n     AND ei.info_valor = n.NFE_DEST_EMAIL\\r\\n    LEFT JOIN gessimples.gei_tel_dest_incons td\\r\\n      ON td.num_grupo = n.grupo_dest \\r\\n     AND td.info_valor = n.NFE_DEST_TELEFONE\\r\\n    LEFT JOIN gessimples.gei_tel_emit_incons te\\r\\n      ON te.num_grupo = n.grupo_emit \\r\\n     AND te.info_valor = n.NFE_EMIT_TELEFONE\\r\\n    LEFT JOIN gessimples.gei_codigos_incons cp\\r\\n      ON cp.num_grupo = n.grupo_emit \\r\\n     AND cp.info_valor = n.NFE_CD_PRODUTO\\r\\n    LEFT JOIN gessimples.gei_fornecedores_incons fo\\r\\n      ON fo.num_grupo = n.grupo_dest \\r\\n     AND fo.info_valor = n.NFE_CNPJ_CPF_EMIT\\r\\n    LEFT JOIN gessimples.gei_end_emit_incons ee\\r\\n      ON ee.num_grupo = n.grupo_emit \\r\\n     AND ee.info_valor = n.NFE_EMIT_END_COMPLETO\\r\\n    LEFT JOIN gessimples.gei_end_dest_incons ed\\r\\n      ON ed.num_grupo = n.grupo_dest \\r\\n     AND ed.info_valor = n.NFE_DEST_END_COMPLETO\\r\\n    LEFT JOIN gessimples.gei_produtos_incons dp\\r\\n      ON dp.num_grupo = n.grupo_emit \\r\\n     AND dp.info_valor = n.NFE_DE_PRODUTO\\r\\n    LEFT JOIN gessimples.gei_ip_incons ip\\r\\n      ON ip.num_grupo = n.grupo_emit \\r\\n     AND ip.info_valor = n.NFE_IP_TRANSMISSAO;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"DROP TABLE IF EXISTS gessimples.gei_nfe_completo;\", \"result\": {\"id\": \"adc22c89-c5fe-bb67-9a1a-47d9d619bd28\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"7BF2SJ3gT+ihygjlKTMEBQ==\", \"guid\": \"qPTU1tWQT7gAAAAA0bD9Hw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"7f463a8ef026a238:a46a2e08fa626581\", \"session_id\": 12971, \"session_type\": \"impala\", \"statement_id\": 2, \"has_more_statements\": false, \"statements_count\": 3, \"previous_statement_hash\": \"8c7da4e858a03267ff6dfd7cae6716d93abf203c3aee00c1d447ef82\", \"start\": {\"row\": 3, \"column\": 0}, \"end\": {\"row\": 70, \"column\": 45}, \"statement\": \"CREATE TABLE gessimples.gei_nfe_completo AS\\nSELECT\\n    -- Colunas originais da gei_nfe\\n    n.NFE_NU_CHAVE_ACESSO,\\n    n.NFE_PER_REF,\\n    n.NFE_DT_EMISSAO,\\n    n.NFE_IP_TRANSMISSAO,\\n    n.NFE_SITUACAO,\\n    n.grupo_emit,\\n    n.NFE_CNPJ_CPF_EMIT,\\n    n.NFE_EMIT_IE,\\n    n.NFE_EMIT_TELEFONE,\\n    n.NFE_EMIT_END_COMPLETO,\\n    n.NFE_EMIT_NM_FANTASIA,\\n    n.NFE_EMIT_RAZAO_SOCIAL,\\n    n.grupo_dest,\\n    n.NFE_CNPJ_CPF_DEST,\\n    n.NFE_DEST_IE,\\n    n.NFE_DEST_EMAIL,\\n    n.NFE_DEST_TELEFONE,\\n    n.NFE_DEST_END_COMPLETO,\\n    n.NFE_DEST_RAZAO_SOCIAL,\\n    n.NFE_CD_PRODUTO,\\n    n.NFE_DE_PRODUTO,\\n    \\n    -- Colunas de inconsist\\u00eancia: 'S' se houver inconsist\\u00eancia, 'N' caso contr\\u00e1rio\\n    CASE WHEN ci.info_valor IS NOT NULL AND ci.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS cliente_incons,\\n    CASE WHEN ei.info_valor IS NOT NULL AND ei.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS email_incons,\\n    CASE WHEN td.info_valor IS NOT NULL AND td.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS tel_dest_incons,\\n    CASE WHEN te.info_valor IS NOT NULL AND te.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS tel_emit_incons,\\n    CASE WHEN cp.info_valor IS NOT NULL AND cp.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS codigo_produto_incons,\\n    CASE WHEN fo.info_valor IS NOT NULL AND fo.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS fornecedor_incons,\\n    CASE WHEN ee.info_valor IS NOT NULL AND ee.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS end_emit_incons,\\n    CASE WHEN ed.info_valor IS NOT NULL AND ed.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS end_dest_incons,\\n    CASE WHEN dp.info_valor IS NOT NULL AND dp.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS descricao_produto_incons,\\n    CASE WHEN ip.info_valor IS NOT NULL AND ip.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS ip_transmissao_incons\\nFROM gessimples.gei_nfe n\\n    -- JOINs com as views de inconsist\\u00eancia\\n    LEFT JOIN gessimples.gei_clientes_incons ci\\n      ON ci.num_grupo = n.grupo_emit \\n     AND ci.info_valor = n.NFE_CNPJ_CPF_DEST\\n    LEFT JOIN gessimples.gei_email_incons ei\\n      ON ei.num_grupo = n.grupo_dest \\n     AND ei.info_valor = n.NFE_DEST_EMAIL\\n    LEFT JOIN gessimples.gei_tel_dest_incons td\\n      ON td.num_grupo = n.grupo_dest \\n     AND td.info_valor = n.NFE_DEST_TELEFONE\\n    LEFT JOIN gessimples.gei_tel_emit_incons te\\n      ON te.num_grupo = n.grupo_emit \\n     AND te.info_valor = n.NFE_EMIT_TELEFONE\\n    LEFT JOIN gessimples.gei_codigos_incons cp\\n      ON cp.num_grupo = n.grupo_emit \\n     AND cp.info_valor = n.NFE_CD_PRODUTO\\n    LEFT JOIN gessimples.gei_fornecedores_incons fo\\n      ON fo.num_grupo = n.grupo_dest \\n     AND fo.info_valor = n.NFE_CNPJ_CPF_EMIT\\n    LEFT JOIN gessimples.gei_end_emit_incons ee\\n      ON ee.num_grupo = n.grupo_emit \\n     AND ee.info_valor = n.NFE_EMIT_END_COMPLETO\\n    LEFT JOIN gessimples.gei_end_dest_incons ed\\n      ON ed.num_grupo = n.grupo_dest \\n     AND ed.info_valor = n.NFE_DEST_END_COMPLETO\\n    LEFT JOIN gessimples.gei_produtos_incons dp\\n      ON dp.num_grupo = n.grupo_emit \\n     AND dp.info_valor = n.NFE_DE_PRODUTO\\n    LEFT JOIN gessimples.gei_ip_incons ip\\n      ON ip.num_grupo = n.grupo_emit \\n     AND ip.info_valor = n.NFE_IP_TRANSMISSAO\"}, \"meta\": [], \"rows\": null, \"hasMore\": false, \"statement_id\": 2, \"statement_range\": {\"start\": {\"row\": 3, \"column\": 0}, \"end\": {\"row\": 70, \"column\": 45}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-03-07T20:52:19.056Z\", \"endTime\": \"2025-03-07T20:52:40.683Z\", \"executionTime\": 21627, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1741380738596, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 100, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false, \"is_history\": false}",
    "extra": "",
    "search": "DROP TABLE IF EXISTS gessimples.gei_nfe_completo;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_nfe_completo AS\r\nSELECT\r\n    -- Colunas originais da gei_nfe\r\n    n.NFE_NU_CHAVE_ACESSO,\r\n    n.NFE_PER_REF,\r\n    n.NFE_DT_EMISSAO,\r\n    n.NFE_IP_TRANSMISSAO,\r\n    n.NFE_SITUACAO,\r\n    n.grupo_emit,\r\n    n.NFE_CNPJ_CPF_EMIT,\r\n    n.NFE_EMIT_IE,\r\n    n.NFE_EMIT_TELEFONE,\r\n    n.NFE_EMIT_END_COMPLETO,\r\n    n.NFE_EMIT_NM_FANTASIA,\r\n    n.NFE_EMIT_RAZAO_SOCIAL,\r\n    n.grupo_dest,\r\n    n.NFE_CNPJ_CPF_DEST,\r\n    n.NFE_DEST_IE,\r\n    n.NFE_DEST_EMAIL,\r\n    n.NFE_DEST_TELEFONE,\r\n    n.NFE_DEST_END_COMPLETO,\r\n    n.NFE_DEST_RAZAO_SOCIAL,\r\n    n.NFE_CD_PRODUTO,\r\n    n.NFE_DE_PRODUTO,\r\n    \r\n    -- Colunas de inconsistÃªncia: 'S' se houver inconsistÃªncia, 'N' caso contrÃ¡rio\r\n    CASE WHEN ci.info_valor IS NOT NULL AND ci.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS cliente_incons,\r\n    CASE WHEN ei.info_valor IS NOT NULL AND ei.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS email_incons,\r\n    CASE WHEN td.info_valor IS NOT NULL AND td.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS tel_dest_incons,\r\n    CASE WHEN te.info_valor IS NOT NULL AND te.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS tel_emit_incons,\r\n    CASE WHEN cp.info_valor IS NOT NULL AND cp.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS codigo_produto_incons,\r\n    CASE WHEN fo.info_valor IS NOT NULL AND fo.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS fornecedor_incons,\r\n    CASE WHEN ee.info_valor IS NOT NULL AND ee.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS end_emit_incons,\r\n    CASE WHEN ed.info_valor IS NOT NULL AND ed.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS end_dest_incons,\r\n    CASE WHEN dp.info_valor IS NOT NULL AND dp.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS descricao_produto_incons,\r\n    CASE WHEN ip.info_valor IS NOT NULL AND ip.contagem_cnpj > 1 THEN 'S' ELSE 'N' END AS ip_transmissao_incons\r\nFROM gessimples.gei_nfe n\r\n    -- JOINs com as views de inconsistÃªncia\r\n    LEFT JOIN gessimples.gei_clientes_incons ci\r",
    "last_modified": "2025-10-02T17:47:04.781",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 105069,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: CADASTRO",
    "description": "",
    "uuid": "9035ad20-0156-dac0-daeb-92f0121cd8cb",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 105069, \"uuid\": \"9035ad20-0156-dac0-daeb-92f0121cd8cb\", \"name\": \"GEI: CADASTRO\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"9035ad20-0156-dac0-daeb-92f0121cd8cb\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"9ddaac84-af60-75e6-38e2-3ee31b677f38\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- Primeiro comando: Cria\\u00e7\\u00e3o da tabela\\r\\nDROP TABLE IF EXISTS gessimples.gei_cadastro;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_cadastro AS\\r\\nWITH cnpj_emit AS (\\r\\n   SELECT DISTINCT nfe_cnpj_cpf_emit AS cnpj\\r\\n   FROM gessimples.gei_nfe_completo\\r\\n   WHERE grupo_emit IS NOT NULL\\r\\n   AND nfe_cnpj_cpf_emit IS NOT NULL\\r\\n),\\r\\ncnpj_dest AS (\\r\\n   SELECT DISTINCT nfe_cnpj_cpf_dest AS cnpj\\r\\n   FROM gessimples.gei_nfe_completo\\r\\n   WHERE grupo_dest IS NOT NULL\\r\\n   AND nfe_cnpj_cpf_dest IS NOT NULL\\r\\n),\\r\\n-- Interse\\u00e7\\u00e3o dos CNPJs que aparecem nas duas colunas\\r\\ncnpjs AS (\\r\\n   SELECT e.cnpj\\r\\n   FROM cnpj_emit e\\r\\n   INNER JOIN cnpj_dest d\\r\\n     ON e.cnpj = d.cnpj\\r\\n),\\r\\nfiltered AS (\\r\\n  SELECT \\r\\n    t1.*,\\r\\n    ROW_NUMBER() OVER (PARTITION BY t1.nu_cnpj ORDER BY t1.nu_cnpj) AS rn\\r\\n  FROM usr_sat_ods.vw_ods_contrib t1\\r\\n  INNER JOIN cnpjs c\\r\\n    ON t1.nu_cnpj = c.cnpj\\r\\n)\\r\\nSELECT *\\r\\nFROM filtered\\r\\nWHERE rn = 1;\", \"statementsList\": [\"-- Primeiro comando: Cria\\u00e7\\u00e3o da tabela\\r\\nDROP TABLE IF EXISTS gessimples.gei_cadastro;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_cadastro AS\\r\\nWITH cnpj_emit AS (\\r\\n   SELECT DISTINCT nfe_cnpj_cpf_emit AS cnpj\\r\\n   FROM gessimples.gei_nfe_completo\\r\\n   WHERE grupo_emit IS NOT NULL\\r\\n   AND nfe_cnpj_cpf_emit IS NOT NULL\\r\\n),\\r\\ncnpj_dest AS (\\r\\n   SELECT DISTINCT nfe_cnpj_cpf_dest AS cnpj\\r\\n   FROM gessimples.gei_nfe_completo\\r\\n   WHERE grupo_dest IS NOT NULL\\r\\n   AND nfe_cnpj_cpf_dest IS NOT NULL\\r\\n),\\r\\n-- Interse\\u00e7\\u00e3o dos CNPJs que aparecem nas duas colunas\\r\\ncnpjs AS (\\r\\n   SELECT e.cnpj\\r\\n   FROM cnpj_emit e\\r\\n   INNER JOIN cnpj_dest d\\r\\n     ON e.cnpj = d.cnpj\\r\\n),\\r\\nfiltered AS (\\r\\n  SELECT \\r\\n    t1.*,\\r\\n    ROW_NUMBER() OVER (PARTITION BY t1.nu_cnpj ORDER BY t1.nu_cnpj) AS rn\\r\\n  FROM usr_sat_ods.vw_ods_contrib t1\\r\\n  INNER JOIN cnpjs c\\r\\n    ON t1.nu_cnpj = c.cnpj\\r\\n)\\r\\nSELECT *\\r\\nFROM filtered\\r\\nWHERE rn = 1;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- Primeiro comando: Cria\\u00e7\\u00e3o da tabela\\r\\nDROP TABLE IF EXISTS gessimples.gei_cadastro;\", \"result\": {\"id\": \"36dde1d4-8c10-32b2-20ec-63b6d7335eea\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"7BF2SJ3gT+ihygjlKTMEBQ==\", \"guid\": \"6usIBdfXS90AAAAA+Qwazg==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"7f463a8ef026a238:a46a2e08fa626581\", \"session_id\": 12971, \"session_type\": \"impala\", \"statement_id\": 2, \"has_more_statements\": false, \"statements_count\": 3, \"previous_statement_hash\": \"3ec7f27c032e99e6076384d376a48744221ec0050aa7d1f37873ad95\", \"start\": {\"row\": 4, \"column\": 0}, \"end\": {\"row\": 34, \"column\": 12}, \"statement\": \"CREATE TABLE gessimples.gei_cadastro AS\\nWITH cnpj_emit AS (\\n   SELECT DISTINCT nfe_cnpj_cpf_emit AS cnpj\\n   FROM gessimples.gei_nfe_completo\\n   WHERE grupo_emit IS NOT NULL\\n   AND nfe_cnpj_cpf_emit IS NOT NULL\\n),\\ncnpj_dest AS (\\n   SELECT DISTINCT nfe_cnpj_cpf_dest AS cnpj\\n   FROM gessimples.gei_nfe_completo\\n   WHERE grupo_dest IS NOT NULL\\n   AND nfe_cnpj_cpf_dest IS NOT NULL\\n),\\n-- Interse\\u00e7\\u00e3o dos CNPJs que aparecem nas duas colunas\\ncnpjs AS (\\n   SELECT e.cnpj\\n   FROM cnpj_emit e\\n   INNER JOIN cnpj_dest d\\n     ON e.cnpj = d.cnpj\\n),\\nfiltered AS (\\n  SELECT \\n    t1.*,\\n    ROW_NUMBER() OVER (PARTITION BY t1.nu_cnpj ORDER BY t1.nu_cnpj) AS rn\\n  FROM usr_sat_ods.vw_ods_contrib t1\\n  INNER JOIN cnpjs c\\n    ON t1.nu_cnpj = c.cnpj\\n)\\nSELECT *\\nFROM filtered\\nWHERE rn = 1\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 2, \"statement_range\": {\"start\": {\"row\": 4, \"column\": 0}, \"end\": {\"row\": 34, \"column\": 12}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-03-07T20:57:06.029Z\", \"endTime\": \"2025-03-07T20:57:30.643Z\", \"executionTime\": 24614, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1741381025654, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 100, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false, \"is_history\": false}",
    "extra": "",
    "search": "-- Primeiro comando: CriaÃ§Ã£o da tabela\r\nDROP TABLE IF EXISTS gessimples.gei_cadastro;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_cadastro AS\r\nWITH cnpj_emit AS (\r\n   SELECT DISTINCT nfe_cnpj_cpf_emit AS cnpj\r\n   FROM gessimples.gei_nfe_completo\r\n   WHERE grupo_emit IS NOT NULL\r\n   AND nfe_cnpj_cpf_emit IS NOT NULL\r\n),\r\ncnpj_dest AS (\r\n   SELECT DISTINCT nfe_cnpj_cpf_dest AS cnpj\r\n   FROM gessimples.gei_nfe_completo\r\n   WHERE grupo_dest IS NOT NULL\r\n   AND nfe_cnpj_cpf_dest IS NOT NULL\r\n),\r\n-- InterseÃ§Ã£o dos CNPJs que aparecem nas duas colunas\r\ncnpjs AS (\r\n   SELECT e.cnpj\r\n   FROM cnpj_emit e\r\n   INNER JOIN cnpj_dest d\r\n     ON e.cnpj = d.cnpj\r\n),\r\nfiltered AS (\r\n  SELECT \r\n    t1.*,\r\n    ROW_NUMBER() OVER (PARTITION BY t1.nu_cnpj ORDER BY t1.nu_cnpj) AS rn\r\n  FROM usr_sat_ods.vw_ods_contrib t1\r\n  INNER JOIN cnpjs c\r\n    ON t1.nu_cnpj = c.cnpj\r\n)\r\nSELECT *\r\nFROM filtered\r\nWHERE rn = 1;",
    "last_modified": "2025-10-02T17:46:57.390",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 105084,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: PGDAS DIME",
    "description": "",
    "uuid": "4568097c-d939-c6ea-6727-0cb745384c0e",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 105084, \"uuid\": \"354d6420-62f4-402a-b12e-8cd3535884ad\", \"name\": \"GEI: PGDAS DIME\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"4568097c-d939-c6ea-6727-0cb745384c0e\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"1caa5534-baf3-fb93-3dc4-7480ab74a479\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Query\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 184, \"column\": 19}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"DROP TABLE IF EXISTS gessimples.gei_pgdas;\\nSET REQUEST_POOL = 'medium';\\n\\nCREATE TABLE gessimples.gei_pgdas AS\\nWITH base AS (\\n  SELECT\\n    nu_cnpj,\\n    nu_per_ref,\\n    SUM(vl_rec_bruta_estab) OVER (\\n      PARTITION BY nu_cnpj\\n      ORDER BY nu_per_ref\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\n    ) AS vl_rec_bruta_12m\\n  FROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\\n  WHERE nu_per_ref BETWEEN 202001 AND 202509  -- Filtra apenas os per\\u00edodos necess\\u00e1rios\\n  AND nu_cnpj IS NOT NULL\\n)\\nSELECT\\n  b.nu_cnpj AS cnpj,\\n  \\n  -- Per\\u00edodo 2021\\n  MAX(CASE WHEN b.nu_per_ref = 202101 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202102 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202103 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202104 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202105 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202106 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202107 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202108 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202109 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202110 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202111 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202112 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2021,\\n  \\n  -- Per\\u00edodo 2022\\n  MAX(CASE WHEN b.nu_per_ref = 202201 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202202 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202203 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202204 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202205 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202206 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202207 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202208 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202209 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202210 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202211 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202212 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2022,\\n  \\n  -- Per\\u00edodo 2023\\n  MAX(CASE WHEN b.nu_per_ref = 202301 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202302 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202303 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202304 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202305 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202306 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202307 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202308 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202309 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202310 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202311 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202312 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2023,\\n  \\n  -- Per\\u00edodo 2024\\n  MAX(CASE WHEN b.nu_per_ref = 202401 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202402 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202403 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202404 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202405 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202406 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202407 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202408 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202409 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202410 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202411 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202412 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2024,\\n  \\n  -- Per\\u00edodo 2025\\n  MAX(CASE WHEN b.nu_per_ref = 202501 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202502 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202503 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202504 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202505 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202506 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202507 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202508 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202509 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2025\\nFROM base b\\nJOIN gessimples.gei_cnpj gc ON b.nu_cnpj = gc.cnpj\\nWHERE b.vl_rec_bruta_12m IS NOT NULL\\nGROUP BY b.nu_cnpj;\\n\\n-- =====================================================\\n-- TABELA GEI_DIME - Faturamento Regime Normal\\n-- =====================================================\\n\\nDROP TABLE IF EXISTS gessimples.gei_dime;\\nSET REQUEST_POOL = 'medium';\\n\\nCREATE TABLE gessimples.gei_dime AS\\nWITH base AS (\\n  SELECT\\n    REGEXP_REPLACE(TRIM(CAST(NU_CNPJ AS STRING)), '[^0-9]', '') AS nu_cnpj,\\n    nu_per_ref,\\n    SUM(COALESCE(VL_FATURAMENTO, 0)) OVER (\\n      PARTITION BY REGEXP_REPLACE(TRIM(CAST(NU_CNPJ AS STRING)), '[^0-9]', '')\\n      ORDER BY nu_per_ref\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\n    ) AS vl_rec_bruta_12m\\n  FROM usr_sat_ods.ods_decl_dime_raw\\n  WHERE nu_per_ref BETWEEN 202001 AND 202509\\n    AND NU_CNPJ IS NOT NULL\\n)\\nSELECT\\n  b.nu_cnpj AS cnpj,\\n\\n  -- Periodo 2021\\n  MAX(CASE WHEN b.nu_per_ref = 202101 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202102 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202103 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202104 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202105 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202106 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202107 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202108 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202109 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202110 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202111 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202112 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2021,\\n\\n  -- Periodo 2022\\n  MAX(CASE WHEN b.nu_per_ref = 202201 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202202 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202203 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202204 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202205 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202206 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202207 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202208 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202209 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202210 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202211 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202212 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2022,\\n\\n  -- Periodo 2023\\n  MAX(CASE WHEN b.nu_per_ref = 202301 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202302 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202303 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202304 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202305 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202306 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202307 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202308 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202309 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202310 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202311 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202312 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2023,\\n\\n  -- Periodo 2024\\n  MAX(CASE WHEN b.nu_per_ref = 202401 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202402 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202403 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202404 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202405 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202406 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202407 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202408 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202409 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202410 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202411 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202412 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2024,\\n\\n  -- Periodo 2025\\n  MAX(CASE WHEN b.nu_per_ref = 202501 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202502 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202503 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202504 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202505 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202506 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202507 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202508 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202509 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2025\\nFROM base b\\nJOIN gessimples.gei_cnpj gc ON b.nu_cnpj = gc.cnpj\\nWHERE b.vl_rec_bruta_12m IS NOT NULL\\nGROUP BY b.nu_cnpj;\", \"statementsList\": [\"DROP TABLE IF EXISTS gessimples.gei_pgdas;\", \"\\nSET REQUEST_POOL = 'medium';\", \"\\n\\nCREATE TABLE gessimples.gei_pgdas AS\\nWITH base AS (\\n  SELECT\\n    nu_cnpj,\\n    nu_per_ref,\\n    SUM(vl_rec_bruta_estab) OVER (\\n      PARTITION BY nu_cnpj\\n      ORDER BY nu_per_ref\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\n    ) AS vl_rec_bruta_12m\\n  FROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\\n  WHERE nu_per_ref BETWEEN 202001 AND 202509  -- Filtra apenas os per\\u00edodos necess\\u00e1rios\\n  AND nu_cnpj IS NOT NULL\\n)\\nSELECT\\n  b.nu_cnpj AS cnpj,\\n  \\n  -- Per\\u00edodo 2021\\n  MAX(CASE WHEN b.nu_per_ref = 202101 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202102 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202103 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202104 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202105 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202106 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202107 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202108 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202109 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202110 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202111 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202112 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2021,\\n  \\n  -- Per\\u00edodo 2022\\n  MAX(CASE WHEN b.nu_per_ref = 202201 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202202 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202203 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202204 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202205 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202206 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202207 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202208 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202209 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202210 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202211 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202212 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2022,\\n  \\n  -- Per\\u00edodo 2023\\n  MAX(CASE WHEN b.nu_per_ref = 202301 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202302 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202303 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202304 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202305 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202306 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202307 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202308 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202309 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202310 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202311 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202312 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2023,\\n  \\n  -- Per\\u00edodo 2024\\n  MAX(CASE WHEN b.nu_per_ref = 202401 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202402 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202403 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202404 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202405 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202406 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202407 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202408 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202409 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202410 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202411 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202412 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2024,\\n  \\n  -- Per\\u00edodo 2025\\n  MAX(CASE WHEN b.nu_per_ref = 202501 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202502 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202503 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202504 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202505 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202506 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202507 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202508 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202509 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2025\\nFROM base b\\nJOIN gessimples.gei_cnpj gc ON b.nu_cnpj = gc.cnpj\\nWHERE b.vl_rec_bruta_12m IS NOT NULL\\nGROUP BY b.nu_cnpj;\", \"\\n\\n-- =====================================================\\n-- TABELA GEI_DIME - Faturamento Regime Normal\\n-- =====================================================\\n\\nDROP TABLE IF EXISTS gessimples.gei_dime;\", \"\\nSET REQUEST_POOL = 'medium';\", \"\\n\\nCREATE TABLE gessimples.gei_dime AS\\nWITH base AS (\\n  SELECT\\n    REGEXP_REPLACE(TRIM(CAST(NU_CNPJ AS STRING)), '[^0-9]', '') AS nu_cnpj,\\n    nu_per_ref,\\n    SUM(COALESCE(VL_FATURAMENTO, 0)) OVER (\\n      PARTITION BY REGEXP_REPLACE(TRIM(CAST(NU_CNPJ AS STRING)), '[^0-9]', '')\\n      ORDER BY nu_per_ref\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\n    ) AS vl_rec_bruta_12m\\n  FROM usr_sat_ods.ods_decl_dime_raw\\n  WHERE nu_per_ref BETWEEN 202001 AND 202509\\n    AND NU_CNPJ IS NOT NULL\\n)\\nSELECT\\n  b.nu_cnpj AS cnpj,\\n\\n  -- Periodo 2021\\n  MAX(CASE WHEN b.nu_per_ref = 202101 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202102 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202103 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202104 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202105 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202106 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202107 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202108 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202109 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202110 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202111 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202112 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2021,\\n\\n  -- Periodo 2022\\n  MAX(CASE WHEN b.nu_per_ref = 202201 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202202 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202203 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202204 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202205 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202206 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202207 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202208 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202209 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202210 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202211 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202212 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2022,\\n\\n  -- Periodo 2023\\n  MAX(CASE WHEN b.nu_per_ref = 202301 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202302 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202303 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202304 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202305 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202306 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202307 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202308 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202309 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202310 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202311 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202312 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2023,\\n\\n  -- Periodo 2024\\n  MAX(CASE WHEN b.nu_per_ref = 202401 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202402 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202403 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202404 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202405 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202406 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202407 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202408 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202409 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202410 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202411 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202412 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2024,\\n\\n  -- Periodo 2025\\n  MAX(CASE WHEN b.nu_per_ref = 202501 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202502 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202503 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202504 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202505 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202506 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202507 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202508 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202509 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2025\\nFROM base b\\nJOIN gessimples.gei_cnpj gc ON b.nu_cnpj = gc.cnpj\\nWHERE b.vl_rec_bruta_12m IS NOT NULL\\nGROUP BY b.nu_cnpj;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Example: SELECT * FROM tablename, or press CTRL + space\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"DROP TABLE IF EXISTS gessimples.gei_pgdas;\\nSET REQUEST_POOL = 'medium';\\n\\nCREATE TABLE gessimples.gei_pgdas AS\\nWITH base AS (\\n  SELECT\\n    nu_cnpj,\\n    nu_per_ref,\\n    SUM(vl_rec_bruta_estab) OVER (\\n      PARTITION BY nu_cnpj\\n      ORDER BY nu_per_ref\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\n    ) AS vl_rec_bruta_12m\\n  FROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\\n  WHERE nu_per_ref BETWEEN 202001 AND 202509  -- Filtra apenas os per\\u00edodos necess\\u00e1rios\\n  AND nu_cnpj IS NOT NULL\\n)\\nSELECT\\n  b.nu_cnpj AS cnpj,\\n  \\n  -- Per\\u00edodo 2021\\n  MAX(CASE WHEN b.nu_per_ref = 202101 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202102 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202103 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202104 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202105 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202106 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202107 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202108 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202109 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202110 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202111 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202112 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2021,\\n  \\n  -- Per\\u00edodo 2022\\n  MAX(CASE WHEN b.nu_per_ref = 202201 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202202 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202203 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202204 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202205 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202206 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202207 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202208 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202209 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202210 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202211 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202212 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2022,\\n  \\n  -- Per\\u00edodo 2023\\n  MAX(CASE WHEN b.nu_per_ref = 202301 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202302 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202303 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202304 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202305 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202306 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202307 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202308 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202309 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202310 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202311 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202312 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2023,\\n  \\n  -- Per\\u00edodo 2024\\n  MAX(CASE WHEN b.nu_per_ref = 202401 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202402 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202403 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202404 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202405 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202406 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202407 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202408 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202409 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202410 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202411 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202412 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2024,\\n  \\n  -- Per\\u00edodo 2025\\n  MAX(CASE WHEN b.nu_per_ref = 202501 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202502 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202503 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202504 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202505 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202506 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202507 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202508 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202509 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2025\\nFROM base b\\nJOIN gessimples.gei_cnpj gc ON b.nu_cnpj = gc.cnpj\\nWHERE b.vl_rec_bruta_12m IS NOT NULL\\nGROUP BY b.nu_cnpj;\\n\\n-- =====================================================\\n-- TABELA GEI_DIME - Faturamento Regime Normal\\n-- =====================================================\\n\\nDROP TABLE IF EXISTS gessimples.gei_dime;\\nSET REQUEST_POOL = 'medium';\\n\\nCREATE TABLE gessimples.gei_dime AS\\nWITH base AS (\\n  SELECT\\n    REGEXP_REPLACE(TRIM(CAST(NU_CNPJ AS STRING)), '[^0-9]', '') AS nu_cnpj,\\n    nu_per_ref,\\n    SUM(COALESCE(VL_FATURAMENTO, 0)) OVER (\\n      PARTITION BY REGEXP_REPLACE(TRIM(CAST(NU_CNPJ AS STRING)), '[^0-9]', '')\\n      ORDER BY nu_per_ref\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\n    ) AS vl_rec_bruta_12m\\n  FROM usr_sat_ods.ods_decl_dime_raw\\n  WHERE nu_per_ref BETWEEN 202001 AND 202509\\n    AND NU_CNPJ IS NOT NULL\\n)\\nSELECT\\n  b.nu_cnpj AS cnpj,\\n\\n  -- Periodo 2021\\n  MAX(CASE WHEN b.nu_per_ref = 202101 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202102 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202103 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202104 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202105 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202106 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202107 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202108 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202109 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202110 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202111 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202112 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2021,\\n\\n  -- Periodo 2022\\n  MAX(CASE WHEN b.nu_per_ref = 202201 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202202 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202203 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202204 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202205 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202206 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202207 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202208 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202209 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202210 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202211 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202212 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2022,\\n\\n  -- Periodo 2023\\n  MAX(CASE WHEN b.nu_per_ref = 202301 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202302 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202303 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202304 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202305 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202306 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202307 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202308 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202309 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202310 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202311 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202312 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2023,\\n\\n  -- Periodo 2024\\n  MAX(CASE WHEN b.nu_per_ref = 202401 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202402 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202403 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202404 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202405 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202406 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202407 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202408 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202409 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202410 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202411 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202412 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2024,\\n\\n  -- Periodo 2025\\n  MAX(CASE WHEN b.nu_per_ref = 202501 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202502 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202503 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202504 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202505 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202506 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202507 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202508 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202509 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2025\\nFROM base b\\nJOIN gessimples.gei_cnpj gc ON b.nu_cnpj = gc.cnpj\\nWHERE b.vl_rec_bruta_12m IS NOT NULL\\nGROUP BY b.nu_cnpj;\", \"result\": {\"id\": \"eb7f7d82-86f1-3091-4128-b83f6c1ec7a0\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"r11d5IQLTgK/bC2f+1DBdQ==\", \"guid\": \"+2kd3QJgSQIAAAAAf4yX6g==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"ea4ab28ee9320620:441f6049a7171eb9\", \"session_id\": 23792, \"session_type\": \"impala\", \"statement_id\": 5, \"has_more_statements\": false, \"statements_count\": 6, \"previous_statement_hash\": \"9ed226d2bb32a69ef59d5986fdb9bec66e9eb562bef7143e88bca14b\", \"start\": {\"row\": 98, \"column\": 0}, \"end\": {\"row\": 184, \"column\": 18}, \"statement\": \"CREATE TABLE gessimples.gei_dime AS\\nWITH base AS (\\n  SELECT\\n    REGEXP_REPLACE(TRIM(CAST(NU_CNPJ AS STRING)), '[^0-9]', '') AS nu_cnpj,\\n    nu_per_ref,\\n    SUM(COALESCE(VL_FATURAMENTO, 0)) OVER (\\n      PARTITION BY REGEXP_REPLACE(TRIM(CAST(NU_CNPJ AS STRING)), '[^0-9]', '')\\n      ORDER BY nu_per_ref\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\n    ) AS vl_rec_bruta_12m\\n  FROM usr_sat_ods.ods_decl_dime_raw\\n  WHERE nu_per_ref BETWEEN 202001 AND 202509\\n    AND NU_CNPJ IS NOT NULL\\n)\\nSELECT\\n  b.nu_cnpj AS cnpj,\\n\\n  -- Periodo 2021\\n  MAX(CASE WHEN b.nu_per_ref = 202101 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202102 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202103 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202104 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202105 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202106 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202107 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202108 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202109 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202110 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202111 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202112 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2021,\\n\\n  -- Periodo 2022\\n  MAX(CASE WHEN b.nu_per_ref = 202201 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202202 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202203 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202204 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202205 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202206 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202207 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202208 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202209 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202210 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202211 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202212 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2022,\\n\\n  -- Periodo 2023\\n  MAX(CASE WHEN b.nu_per_ref = 202301 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202302 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202303 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202304 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202305 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202306 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202307 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202308 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202309 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202310 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202311 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202312 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2023,\\n\\n  -- Periodo 2024\\n  MAX(CASE WHEN b.nu_per_ref = 202401 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202402 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202403 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202404 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202405 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202406 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202407 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202408 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202409 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202410 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202411 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202412 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2024,\\n\\n  -- Periodo 2025\\n  MAX(CASE WHEN b.nu_per_ref = 202501 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202502 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202503 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202504 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202505 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202506 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202507 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202508 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202509 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2025\\nFROM base b\\nJOIN gessimples.gei_cnpj gc ON b.nu_cnpj = gc.cnpj\\nWHERE b.vl_rec_bruta_12m IS NOT NULL\\nGROUP BY b.nu_cnpj\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 5, \"statement_range\": {\"start\": {\"row\": 98, \"column\": 0}, \"end\": {\"row\": 184, \"column\": 18}}, \"statements_count\": 6, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"summary\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-12-10T19:39:37.370Z\", \"endTime\": \"2025-12-10T19:39:41.260Z\", \"executionTime\": 3890, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 4, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 5063, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"option\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 5109, \"getLogsTimeout\": 5127, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1765395576987, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"DROP TABLE IF EXISTS gessimples.gei_pgdas;\\nSET REQUEST_POOL = 'medium';\\n\\nCREATE TABLE gessimples.gei_pgdas AS\\nWITH base AS (\\n  SELECT\\n    nu_cnpj,\\n    nu_per_ref,\\n    SUM(vl_rec_bruta_estab) OVER (\\n      PARTITION BY nu_cnpj\\n      ORDER BY nu_per_ref\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\n    ) AS vl_rec_bruta_12m\\n  FROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\\n  WHERE nu_per_ref BETWEEN 202001 AND 202509  -- Filtra apenas os per\\u00edodos necess\\u00e1rios\\n  AND nu_cnpj IS NOT NULL\\n)\\nSELECT\\n  b.nu_cnpj AS cnpj,\\n  \\n  -- Per\\u00edodo 2021\\n  MAX(CASE WHEN b.nu_per_ref = 202101 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202102 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202103 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202104 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202105 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202106 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202107 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202108 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202109 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202110 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202111 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202112 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2021,\\n  \\n  -- Per\\u00edodo 2022\\n  MAX(CASE WHEN b.nu_per_ref = 202201 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202202 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202203 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202204 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202205 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202206 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202207 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202208 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202209 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202210 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202211 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202212 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2022,\\n  \\n  -- Per\\u00edodo 2023\\n  MAX(CASE WHEN b.nu_per_ref = 202301 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202302 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202303 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202304 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202305 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202306 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202307 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202308 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202309 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202310 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202311 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202312 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2023,\\n  \\n  -- Per\\u00edodo 2024\\n  MAX(CASE WHEN b.nu_per_ref = 202401 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202402 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202403 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202404 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202405 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202406 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202407 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202408 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202409 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202410 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202411 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202412 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2024,\\n  \\n  -- Per\\u00edodo 2025\\n  MAX(CASE WHEN b.nu_per_ref = 202501 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202502 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202503 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202504 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202505 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202506 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202507 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202508 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202509 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2025\\nFROM base b\\nJOIN gessimples.gei_cnpj gc ON b.nu_cnpj = gc.cnpj\\nWHERE b.vl_rec_bruta_12m IS NOT NULL\\nGROUP BY b.nu_cnpj;\\n\\n-- =====================================================\\n-- TABELA GEI_DIME - Faturamento Regime Normal\\n-- =====================================================\\n\\nDROP TABLE IF EXISTS gessimples.gei_dime;\\nSET REQUEST_POOL = 'medium';\\n\\nCREATE TABLE gessimples.gei_dime AS\\nWITH base AS (\\n  SELECT\\n    REGEXP_REPLACE(TRIM(CAST(NU_CNPJ AS STRING)), '[^0-9]', '') AS nu_cnpj,\\n    nu_per_ref,\\n    SUM(COALESCE(VL_FATURAMENTO, 0)) OVER (\\n      PARTITION BY REGEXP_REPLACE(TRIM(CAST(NU_CNPJ AS STRING)), '[^0-9]', '')\\n      ORDER BY nu_per_ref\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\n    ) AS vl_rec_bruta_12m\\n  FROM usr_sat_ods.ods_decl_dime_raw\\n  WHERE nu_per_ref BETWEEN 202001 AND 202509\\n    AND NU_CNPJ IS NOT NULL\\n)\\nSELECT\\n  b.nu_cnpj AS cnpj,\\n\\n  -- Periodo 2021\\n  MAX(CASE WHEN b.nu_per_ref = 202101 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202102 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202103 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202104 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202105 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202106 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202107 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202108 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202109 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202110 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202111 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2021,\\n  MAX(CASE WHEN b.nu_per_ref = 202112 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2021,\\n\\n  -- Periodo 2022\\n  MAX(CASE WHEN b.nu_per_ref = 202201 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202202 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202203 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202204 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202205 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202206 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202207 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202208 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202209 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202210 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202211 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2022,\\n  MAX(CASE WHEN b.nu_per_ref = 202212 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2022,\\n\\n  -- Periodo 2023\\n  MAX(CASE WHEN b.nu_per_ref = 202301 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202302 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202303 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202304 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202305 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202306 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202307 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202308 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202309 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202310 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202311 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2023,\\n  MAX(CASE WHEN b.nu_per_ref = 202312 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2023,\\n\\n  -- Periodo 2024\\n  MAX(CASE WHEN b.nu_per_ref = 202401 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202402 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202403 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202404 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202405 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202406 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202407 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202408 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202409 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202410 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202411 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2024,\\n  MAX(CASE WHEN b.nu_per_ref = 202412 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2024,\\n\\n  -- Periodo 2025\\n  MAX(CASE WHEN b.nu_per_ref = 202501 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202502 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202503 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202504 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202505 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202506 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202507 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202508 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2025,\\n  MAX(CASE WHEN b.nu_per_ref = 202509 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2025\\nFROM base b\\nJOIN gessimples.gei_cnpj gc ON b.nu_cnpj = gc.cnpj\\nWHERE b.vl_rec_bruta_12m IS NOT NULL\\nGROUP BY b.nu_cnpj;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 184, \"column\": 19}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 02496002dd1d69fb:ea978c7f00000000 100% Complete (9 out of 9)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"02496002dd1d69fb:ea978c7f00000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=02496002dd1d69fb:ea978c7f00000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 02496002dd1d69fb:ea978c7f00000000 100% Complete (9 out of 9)\", \"progress\": 100, \"jobs\": [{\"name\": \"02496002dd1d69fb:ea978c7f00000000\", \"url\": \"/hue/jobbrowser#!id=02496002dd1d69fb:ea978c7f00000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 12207, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 222, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "DROP TABLE IF EXISTS gessimples.gei_pgdas;\nSET REQUEST_POOL = 'medium';\n\nCREATE TABLE gessimples.gei_pgdas AS\nWITH base AS (\n  SELECT\n    nu_cnpj,\n    nu_per_ref,\n    SUM(vl_rec_bruta_estab) OVER (\n      PARTITION BY nu_cnpj\n      ORDER BY nu_per_ref\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\n    ) AS vl_rec_bruta_12m\n  FROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\n  WHERE nu_per_ref BETWEEN 202001 AND 202509  -- Filtra apenas os perÃ­odos necessÃ¡rios\n  AND nu_cnpj IS NOT NULL\n)\nSELECT\n  b.nu_cnpj AS cnpj,\n  \n  -- PerÃ­odo 2021\n  MAX(CASE WHEN b.nu_per_ref = 202101 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2021,\n  MAX(CASE WHEN b.nu_per_ref = 202102 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2021,\n  MAX(CASE WHEN b.nu_per_ref = 202103 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2021,\n  MAX(CASE WHEN b.nu_per_ref = 202104 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2021,\n  MAX(CASE WHEN b.nu_per_ref = 202105 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mai2021,\n  MAX(CASE WHEN b.nu_per_ref = 202106 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jun2021,\n  MAX(CASE WHEN b.nu_per_ref = 202107 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jul2021,\n  MAX(CASE WHEN b.nu_per_ref = 202108 THEN b.vl_rec_bruta_12m ELSE 0 END) AS ago2021,\n  MAX(CASE WHEN b.nu_per_ref = 202109 THEN b.vl_rec_bruta_12m ELSE 0 END) AS set2021,\n  MAX(CASE WHEN b.nu_per_ref = 202110 THEN b.vl_rec_bruta_12m ELSE 0 END) AS out2021,\n  MAX(CASE WHEN b.nu_per_ref = 202111 THEN b.vl_rec_bruta_12m ELSE 0 END) AS nov2021,\n  MAX(CASE WHEN b.nu_per_ref = 202112 THEN b.vl_rec_bruta_12m ELSE 0 END) AS dez2021,\n  \n  -- PerÃ­odo 2022\n  MAX(CASE WHEN b.nu_per_ref = 202201 THEN b.vl_rec_bruta_12m ELSE 0 END) AS jan2022,\n  MAX(CASE WHEN b.nu_per_ref = 202202 THEN b.vl_rec_bruta_12m ELSE 0 END) AS fev2022,\n  MAX(CASE WHEN b.nu_per_ref = 202203 THEN b.vl_rec_bruta_12m ELSE 0 END) AS mar2022,\n  MAX(CASE WHEN b.nu_per_ref = 202204 THEN b.vl_rec_bruta_12m ELSE 0 END) AS abr2022,\n  MAX(CASE WHEN b.nu_per_ref = 202205 THEN b.vl_rec_bruta_12m EL",
    "last_modified": "2025-12-10T16:44:25.026",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 105107,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: CONTADOR",
    "description": "",
    "uuid": "d2d26706-9554-e8d6-2f5e-a6b1124359fb",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 105107, \"uuid\": \"36e11569-5635-477e-b58b-9fc70375e7e4\", \"name\": \"GEI: CONTADOR\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"d2d26706-9554-e8d6-2f5e-a6b1124359fb\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"fa265343-6be0-0fbd-857b-be57ef121363\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 0, \"column\": 21}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"DROP TABLE IF EXISTS gessimples.gei_contador;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_contador AS\\r\\nWITH\\r\\n\\r\\n-- Passo 1: Criar uma rela\\u00e7\\u00e3o direta e \\u00fanica entre cada contador e os grupos que ele atende.\\r\\ncontador_grupo_link AS (\\r\\n    SELECT DISTINCT\\r\\n        c.nm_contador,\\r\\n        g.num_grupo\\r\\n    FROM\\r\\n        gessimples.gei_cnpj g\\r\\n    JOIN\\r\\n        gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\\r\\n    WHERE\\r\\n        c.nm_contador IS NOT NULL AND c.nm_contador != ''\\r\\n),\\r\\n\\r\\n-- Passo 2: Calcular as m\\u00e9tricas por contador (contagem de grupos e m\\u00e9dia do score de risco).\\r\\n-- Passo 2 (Ajustado): Calcular as m\\u00e9tricas por contador usando LEFT JOIN.\\r\\nmetricas_por_contador AS (\\r\\n    SELECT\\r\\n        l.nm_contador,\\r\\n        COUNT(l.num_grupo) AS qntd_grupos,\\r\\n        ROUND(AVG(COALESCE(p.score_final_avancado, 0)), 2) AS media_score_grupos\\r\\n    FROM\\r\\n        contador_grupo_link l\\r\\n    LEFT JOIN \\r\\n        gessimples.gei_percent p ON CAST(l.num_grupo AS STRING) = CAST(p.num_grupo AS STRING) -- << ROBUST FIX\\r\\n    GROUP BY\\r\\n        l.nm_contador\\r\\n),\\r\\n\\r\\n-- Passo 3: Enriquecer com os dados da GERFE (unidade fiscal).\\r\\ncad_contabilista AS (\\r\\n    SELECT DISTINCT nm_pessoa, nm_gerfe\\r\\n    FROM usr_sat_ods.vw_cad_contabilista\\r\\n    WHERE nm_pessoa IS NOT NULL\\r\\n)\\r\\n\\r\\n-- Passo Final: Juntar tudo e gerar a tabela final.\\r\\nSELECT\\r\\n    m.nm_contador,\\r\\n    COALESCE(cc.nm_gerfe, 'N\\u00e3o identificada') AS nm_gerfe,\\r\\n    m.media_score_grupos AS media,\\r\\n    m.qntd_grupos\\r\\nFROM\\r\\n    metricas_por_contador m\\r\\nLEFT JOIN\\r\\n    cad_contabilista cc ON m.nm_contador = cc.nm_pessoa\\r\\n-- Opcional: Filtre para ver apenas os contadores que atendem a mais de um grupo.\\r\\n-- WHERE m.qntd_grupos > 1\\r\\nORDER BY\\r\\n    m.qntd_grupos DESC, m.media_score_grupos DESC\\r\\nLIMIT 10000;\", \"statementsList\": [\"DROP TABLE IF EXISTS gessimples.gei_contador;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_contador AS\\r\\nWITH\\r\\n\\r\\n-- Passo 1: Criar uma rela\\u00e7\\u00e3o direta e \\u00fanica entre cada contador e os grupos que ele atende.\\r\\ncontador_grupo_link AS (\\r\\n    SELECT DISTINCT\\r\\n        c.nm_contador,\\r\\n        g.num_grupo\\r\\n    FROM\\r\\n        gessimples.gei_cnpj g\\r\\n    JOIN\\r\\n        gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\\r\\n    WHERE\\r\\n        c.nm_contador IS NOT NULL AND c.nm_contador != ''\\r\\n),\\r\\n\\r\\n-- Passo 2: Calcular as m\\u00e9tricas por contador (contagem de grupos e m\\u00e9dia do score de risco).\\r\\n-- Passo 2 (Ajustado): Calcular as m\\u00e9tricas por contador usando LEFT JOIN.\\r\\nmetricas_por_contador AS (\\r\\n    SELECT\\r\\n        l.nm_contador,\\r\\n        COUNT(l.num_grupo) AS qntd_grupos,\\r\\n        ROUND(AVG(COALESCE(p.score_final_avancado, 0)), 2) AS media_score_grupos\\r\\n    FROM\\r\\n        contador_grupo_link l\\r\\n    LEFT JOIN \\r\\n        gessimples.gei_percent p ON CAST(l.num_grupo AS STRING) = CAST(p.num_grupo AS STRING) -- << ROBUST FIX\\r\\n    GROUP BY\\r\\n        l.nm_contador\\r\\n),\\r\\n\\r\\n-- Passo 3: Enriquecer com os dados da GERFE (unidade fiscal).\\r\\ncad_contabilista AS (\\r\\n    SELECT DISTINCT nm_pessoa, nm_gerfe\\r\\n    FROM usr_sat_ods.vw_cad_contabilista\\r\\n    WHERE nm_pessoa IS NOT NULL\\r\\n)\\r\\n\\r\\n-- Passo Final: Juntar tudo e gerar a tabela final.\\r\\nSELECT\\r\\n    m.nm_contador,\\r\\n    COALESCE(cc.nm_gerfe, 'N\\u00e3o identificada') AS nm_gerfe,\\r\\n    m.media_score_grupos AS media,\\r\\n    m.qntd_grupos\\r\\nFROM\\r\\n    metricas_por_contador m\\r\\nLEFT JOIN\\r\\n    cad_contabilista cc ON m.nm_contador = cc.nm_pessoa\\r\\n-- Opcional: Filtre para ver apenas os contadores que atendem a mais de um grupo.\\r\\n-- WHERE m.qntd_grupos > 1\\r\\nORDER BY\\r\\n    m.qntd_grupos DESC, m.media_score_grupos DESC\\r\\nLIMIT 10000;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"gessimples.gei_contador\", \"result\": {\"id\": \"8a3ea8c7-586e-fad7-4a57-3d1122ab63eb\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"Wwa74HBNQ6aRRPI+3Bi7Jw==\", \"guid\": \"hLMgM4VBREwAAAAANttUOQ==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"e7482dbeae065c4b:21b20ad37e7898a0\", \"session_id\": 21363, \"session_type\": \"impala\", \"statement_id\": 2, \"has_more_statements\": false, \"statements_count\": 3, \"previous_statement_hash\": \"2f5e5770b4461e5df20c5ce4e7e2d2c5ab1c516191507b94948401cb\", \"start\": {\"row\": 3, \"column\": 0}, \"end\": {\"row\": 55, \"column\": 11}, \"statement\": \"CREATE TABLE gessimples.gei_contador AS\\nWITH\\n\\n-- Passo 1: Criar uma rela\\u00e7\\u00e3o direta e \\u00fanica entre cada contador e os grupos que ele atende.\\ncontador_grupo_link AS (\\n    SELECT DISTINCT\\n        c.nm_contador,\\n        g.num_grupo\\n    FROM\\n        gessimples.gei_cnpj g\\n    JOIN\\n        gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\\n    WHERE\\n        c.nm_contador IS NOT NULL AND c.nm_contador != ''\\n),\\n\\n-- Passo 2: Calcular as m\\u00e9tricas por contador (contagem de grupos e m\\u00e9dia do score de risco).\\n-- Passo 2 (Ajustado): Calcular as m\\u00e9tricas por contador usando LEFT JOIN.\\nmetricas_por_contador AS (\\n    SELECT\\n        l.nm_contador,\\n        COUNT(l.num_grupo) AS qntd_grupos,\\n        ROUND(AVG(COALESCE(p.score_final_avancado, 0)), 2) AS media_score_grupos\\n    FROM\\n        contador_grupo_link l\\n    LEFT JOIN \\n        gessimples.gei_percent p ON CAST(l.num_grupo AS STRING) = CAST(p.num_grupo AS STRING) -- << ROBUST FIX\\n    GROUP BY\\n        l.nm_contador\\n),\\n\\n-- Passo 3: Enriquecer com os dados da GERFE (unidade fiscal).\\ncad_contabilista AS (\\n    SELECT DISTINCT nm_pessoa, nm_gerfe\\n    FROM usr_sat_ods.vw_cad_contabilista\\n    WHERE nm_pessoa IS NOT NULL\\n)\\n\\n-- Passo Final: Juntar tudo e gerar a tabela final.\\nSELECT\\n    m.nm_contador,\\n    COALESCE(cc.nm_gerfe, 'N\\u00e3o identificada') AS nm_gerfe,\\n    m.media_score_grupos AS media,\\n    m.qntd_grupos\\nFROM\\n    metricas_por_contador m\\nLEFT JOIN\\n    cad_contabilista cc ON m.nm_contador = cc.nm_pessoa\\n-- Opcional: Filtre para ver apenas os contadores que atendem a mais de um grupo.\\n-- WHERE m.qntd_grupos > 1\\nORDER BY\\n    m.qntd_grupos DESC, m.media_score_grupos DESC\\nLIMIT 10000\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 2, \"statement_range\": {\"start\": {\"row\": 3, \"column\": 0}, \"end\": {\"row\": 55, \"column\": 11}}, \"statements_count\": 3, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"summary\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-10-09T18:31:02.381Z\", \"endTime\": \"2025-10-09T18:31:07.182Z\", \"executionTime\": 4801, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 8, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 42883, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"option\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 43179, \"getLogsTimeout\": 43330, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1760034662098, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"DROP TABLE IF EXISTS gessimples.gei_contador;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_contador AS\\r\\nWITH\\r\\n\\r\\n-- Passo 1: Criar uma rela\\u00e7\\u00e3o direta e \\u00fanica entre cada contador e os grupos que ele atende.\\r\\ncontador_grupo_link AS (\\r\\n    SELECT DISTINCT\\r\\n        c.nm_contador,\\r\\n        g.num_grupo\\r\\n    FROM\\r\\n        gessimples.gei_cnpj g\\r\\n    JOIN\\r\\n        gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\\r\\n    WHERE\\r\\n        c.nm_contador IS NOT NULL AND c.nm_contador != ''\\r\\n),\\r\\n\\r\\n-- Passo 2: Calcular as m\\u00e9tricas por contador (contagem de grupos e m\\u00e9dia do score de risco).\\r\\n-- Passo 2 (Ajustado): Calcular as m\\u00e9tricas por contador usando LEFT JOIN.\\r\\nmetricas_por_contador AS (\\r\\n    SELECT\\r\\n        l.nm_contador,\\r\\n        COUNT(l.num_grupo) AS qntd_grupos,\\r\\n        ROUND(AVG(COALESCE(p.score_final_avancado, 0)), 2) AS media_score_grupos\\r\\n    FROM\\r\\n        contador_grupo_link l\\r\\n    LEFT JOIN \\r\\n        gessimples.gei_percent p ON CAST(l.num_grupo AS STRING) = CAST(p.num_grupo AS STRING) -- << ROBUST FIX\\r\\n    GROUP BY\\r\\n        l.nm_contador\\r\\n),\\r\\n\\r\\n-- Passo 3: Enriquecer com os dados da GERFE (unidade fiscal).\\r\\ncad_contabilista AS (\\r\\n    SELECT DISTINCT nm_pessoa, nm_gerfe\\r\\n    FROM usr_sat_ods.vw_cad_contabilista\\r\\n    WHERE nm_pessoa IS NOT NULL\\r\\n)\\r\\n\\r\\n-- Passo Final: Juntar tudo e gerar a tabela final.\\r\\nSELECT\\r\\n    m.nm_contador,\\r\\n    COALESCE(cc.nm_gerfe, 'N\\u00e3o identificada') AS nm_gerfe,\\r\\n    m.media_score_grupos AS media,\\r\\n    m.qntd_grupos\\r\\nFROM\\r\\n    metricas_por_contador m\\r\\nLEFT JOIN\\r\\n    cad_contabilista cc ON m.nm_contador = cc.nm_pessoa\\r\\n-- Opcional: Filtre para ver apenas os contadores que atendem a mais de um grupo.\\r\\n-- WHERE m.qntd_grupos > 1\\r\\nORDER BY\\r\\n    m.qntd_grupos DESC, m.media_score_grupos DESC\\r\\nLIMIT 10000;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 55, \"column\": 12}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 4c4441853320b384:3954db3600000000 100% Complete (16 out of 16)\\\\nParquet file 'hdfs://powerscale.sef.sc.gov.br:8020/data/prod/raw/cad_pessoa_fisica_raw/2025/10/08/part-00000-480f1aad-95c5-47d3-b913-827f1189c56d-c000.snappy.parquet' column 'DT_EMISSAO_DOCUMENTO' contains an out of range timestamp. The valid date range is 1400-01-01..9999-12-31. (1 of 53 similar)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"4c4441853320b384:3954db3600000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=4c4441853320b384:3954db3600000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 4c4441853320b384:3954db3600000000 100% Complete (16 out of 16)\\nParquet file 'hdfs://powerscale.sef.sc.gov.br:8020/data/prod/raw/cad_pessoa_fisica_raw/2025/10/08/part-00000-480f1aad-95c5-47d3-b913-827f1189c56d-c000.snappy.parquet' column 'DT_EMISSAO_DOCUMENTO' contains an out of range timestamp. The valid date range is 1400-01-01..9999-12-31. (1 of 53 similar)\", \"progress\": 100, \"jobs\": [{\"name\": \"4c4441853320b384:3954db3600000000\", \"url\": \"/hue/jobbrowser#!id=4c4441853320b384:3954db3600000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 13169, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 116, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "DROP TABLE IF EXISTS gessimples.gei_contador;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_contador AS\r\nWITH\r\n\r\n-- Passo 1: Criar uma relaÃ§Ã£o direta e Ãºnica entre cada contador e os grupos que ele atende.\r\ncontador_grupo_link AS (\r\n    SELECT DISTINCT\r\n        c.nm_contador,\r\n        g.num_grupo\r\n    FROM\r\n        gessimples.gei_cnpj g\r\n    JOIN\r\n        gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\r\n    WHERE\r\n        c.nm_contador IS NOT NULL AND c.nm_contador != ''\r\n),\r\n\r\n-- Passo 2: Calcular as mÃ©tricas por contador (contagem de grupos e mÃ©dia do score de risco).\r\n-- Passo 2 (Ajustado): Calcular as mÃ©tricas por contador usando LEFT JOIN.\r\nmetricas_por_contador AS (\r\n    SELECT\r\n        l.nm_contador,\r\n        COUNT(l.num_grupo) AS qntd_grupos,\r\n        ROUND(AVG(COALESCE(p.score_final_avancado, 0)), 2) AS media_score_grupos\r\n    FROM\r\n        contador_grupo_link l\r\n    LEFT JOIN \r\n        gessimples.gei_percent p ON CAST(l.num_grupo AS STRING) = CAST(p.num_grupo AS STRING) -- << ROBUST FIX\r\n    GROUP BY\r\n        l.nm_contador\r\n),\r\n\r\n-- Passo 3: Enriquecer com os dados da GERFE (unidade fiscal).\r\ncad_contabilista AS (\r\n    SELECT DISTINCT nm_pessoa, nm_gerfe\r\n    FROM usr_sat_ods.vw_cad_contabilista\r\n    WHERE nm_pessoa IS NOT NULL\r\n)\r\n\r\n-- Passo Final: Juntar tudo e gerar a tabela final.\r\nSELECT\r\n    m.nm_contador,\r\n    COALESCE(cc.nm_gerfe, 'NÃ£o identificada') AS nm_gerfe,\r\n    m.media_score_grupos AS media,\r\n    m.qntd_grupos\r\nFROM\r\n    metricas_por_contador m\r\nLEFT JOIN\r\n    cad_contabilista cc ON m.nm_contador = cc.nm_pessoa\r\n-- Opcional: Filtre para ver apenas os contadores que atendem a mais de um grupo.\r\n-- WHERE m.qntd_grupos > 1\r\nORDER BY\r\n    m.qntd_grupos DESC, m.media_score_grupos DESC\r\nLIMIT 10000;",
    "last_modified": "2025-10-09T15:31:11.375",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 109662,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: SOCIOS",
    "description": "",
    "uuid": "789e8822-c463-73b8-c932-586581247e3f",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 109662, \"uuid\": \"789e8822-c463-73b8-c932-586581247e3f\", \"name\": \"GEI: SOCIOS\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"789e8822-c463-73b8-c932-586581247e3f\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"67d410c3-9e5d-06aa-0baa-188a82cf2210\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"gessimples\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ========================================================================\\r\\n-- PARTE 1: Cria\\u00e7\\u00e3o da tabela base de rela\\u00e7\\u00f5es societ\\u00e1rias\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_socios;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_socios AS\\r\\nWITH socios_empresas AS (\\r\\n    SELECT \\r\\n        g.num_grupo,\\r\\n        g.cnpj,\\r\\n        v.nu_cnpj_cpf_secund AS cpf_socio,\\r\\n        v.nm_relacao,\\r\\n        v.nm_qualificacao,\\r\\n        v.dt_inicio_relacao,\\r\\n        v.dt_fim_relacao,\\r\\n        v.pe_capital_empresa,\\r\\n        v.sn_relacao_ativa\\r\\n    FROM \\r\\n        gessimples.gei_cnpj g\\r\\n    JOIN \\r\\n        usr_sat_ods.vw_cad_vinculo v ON g.cnpj = v.nu_cnpj_princ\\r\\n    WHERE \\r\\n        v.nm_relacao != 'CONTABILISTA'\\r\\n)\\r\\nSELECT * FROM socios_empresas;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 2: Identifica\\u00e7\\u00e3o de s\\u00f3cios compartilhados entre empresas do mesmo grupo\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_socios_compartilhados;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_socios_compartilhados AS\\r\\nWITH socios_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        cpf_socio,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_empresas\\r\\n    FROM\\r\\n        gessimples.gei_socios\\r\\n    GROUP BY\\r\\n        num_grupo, cpf_socio\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n)\\r\\nSELECT\\r\\n    sc.num_grupo,\\r\\n    sc.cpf_socio,\\r\\n    sc.qtd_empresas,\\r\\n    s.cnpj,\\r\\n    s.nm_relacao,\\r\\n    s.nm_qualificacao,\\r\\n    s.dt_inicio_relacao,\\r\\n    s.dt_fim_relacao,\\r\\n    s.pe_capital_empresa,\\r\\n    s.sn_relacao_ativa\\r\\nFROM\\r\\n    socios_count sc\\r\\nJOIN\\r\\n    gessimples.gei_socios s \\r\\n    ON sc.num_grupo = s.num_grupo AND sc.cpf_socio = s.cpf_socio;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 3: M\\u00e9tricas consolidadas por grupo\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_socios_metricas;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_socios_metricas AS\\r\\nWITH grupo_cnpj_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs\\r\\n    FROM\\r\\n        gessimples.gei_cnpj\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\nsocios_compartilhados AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cpf_socio) AS qtd_socios_compartilhados,\\r\\n        MAX(qtd_empresas) AS max_empresas_por_socio\\r\\n    FROM\\r\\n        gessimples.gei_socios_compartilhados\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ncnpjs_com_socios_compartilhados AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_com_socios_compartilhados\\r\\n    FROM\\r\\n        gessimples.gei_socios_compartilhados\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\npares_cnpjs AS (\\r\\n    SELECT \\r\\n        num_grupo,\\r\\n        COUNT(*) AS qtd_pares_cnpjs_relacionados\\r\\n    FROM (\\r\\n        SELECT\\r\\n            sc1.num_grupo,\\r\\n            sc1.cnpj AS cnpj1,\\r\\n            sc2.cnpj AS cnpj2\\r\\n        FROM \\r\\n            gessimples.gei_socios_compartilhados sc1\\r\\n        JOIN \\r\\n            gessimples.gei_socios_compartilhados sc2\\r\\n            ON sc1.num_grupo = sc2.num_grupo\\r\\n            AND sc1.cpf_socio = sc2.cpf_socio\\r\\n            AND sc1.cnpj < sc2.cnpj\\r\\n        GROUP BY\\r\\n            sc1.num_grupo, sc1.cnpj, sc2.cnpj\\r\\n    ) t\\r\\n    GROUP BY num_grupo\\r\\n)\\r\\nSELECT\\r\\n    g.num_grupo,\\r\\n    g.total_cnpjs,\\r\\n    COALESCE(s.qtd_socios_compartilhados, 0) AS qtd_socios_compartilhados,\\r\\n    COALESCE(s.max_empresas_por_socio, 0) AS max_empresas_por_socio,\\r\\n    COALESCE(c.qtd_cnpjs_com_socios_compartilhados, 0) AS qtd_cnpjs_com_socios_compartilhados,\\r\\n    COALESCE(p.qtd_pares_cnpjs_relacionados, 0) AS qtd_pares_cnpjs_relacionados,\\r\\n    CASE \\r\\n        WHEN g.total_cnpjs > 0 THEN \\r\\n            ROUND(COALESCE(c.qtd_cnpjs_com_socios_compartilhados, 0) * 100.0 / g.total_cnpjs, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_cnpjs_com_socios,\\r\\n    CASE\\r\\n        WHEN g.total_cnpjs > 1 THEN\\r\\n            ROUND(COALESCE(p.qtd_pares_cnpjs_relacionados, 0) * 2.0 / (g.total_cnpjs * (g.total_cnpjs - 1)), 2)\\r\\n        ELSE 0\\r\\n    END AS indice_interconexao\\r\\nFROM\\r\\n    grupo_cnpj_count g\\r\\nLEFT JOIN\\r\\n    socios_compartilhados s ON g.num_grupo = s.num_grupo\\r\\nLEFT JOIN\\r\\n    cnpjs_com_socios_compartilhados c ON g.num_grupo = c.num_grupo\\r\\nLEFT JOIN\\r\\n    pares_cnpjs p ON g.num_grupo = p.num_grupo;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 4: View para an\\u00e1lise detalhada de pares de empresas relacionadas\\r\\n-- ========================================================================\\r\\nDROP VIEW IF EXISTS gessimples.gei_pares_empresas_relacionadas;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE VIEW gessimples.gei_pares_empresas_relacionadas AS\\r\\nWITH pares AS (\\r\\n    SELECT\\r\\n        sc1.num_grupo,\\r\\n        sc1.cnpj AS cnpj1,\\r\\n        sc2.cnpj AS cnpj2,\\r\\n        COUNT(DISTINCT sc1.cpf_socio) AS qtd_socios_comuns\\r\\n    FROM \\r\\n        gessimples.gei_socios_compartilhados sc1\\r\\n    JOIN \\r\\n        gessimples.gei_socios_compartilhados sc2\\r\\n        ON sc1.num_grupo = sc2.num_grupo\\r\\n        AND sc1.cpf_socio = sc2.cpf_socio\\r\\n        AND sc1.cnpj < sc2.cnpj\\r\\n    GROUP BY\\r\\n        sc1.num_grupo, sc1.cnpj, sc2.cnpj\\r\\n),\\r\\ncnpj_info AS (\\r\\n    SELECT\\r\\n        g.cnpj,\\r\\n        c.nm_razao_social,\\r\\n        c.nm_fantasia,\\r\\n        c.nm_reg_apuracao\\r\\n    FROM\\r\\n        gessimples.gei_cnpj g\\r\\n    LEFT JOIN\\r\\n        gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\\r\\n)\\r\\nSELECT\\r\\n    p.num_grupo,\\r\\n    p.cnpj1,\\r\\n    c1.nm_razao_social AS razao_social1,\\r\\n    c1.nm_fantasia AS nome_fantasia1,\\r\\n    c1.nm_reg_apuracao AS regime_tributario1,\\r\\n    p.cnpj2,\\r\\n    c2.nm_razao_social AS razao_social2,\\r\\n    c2.nm_fantasia AS nome_fantasia2,\\r\\n    c2.nm_reg_apuracao AS regime_tributario2,\\r\\n    p.qtd_socios_comuns\\r\\nFROM\\r\\n    pares p\\r\\nLEFT JOIN\\r\\n    cnpj_info c1 ON p.cnpj1 = c1.cnpj\\r\\nLEFT JOIN\\r\\n    cnpj_info c2 ON p.cnpj2 = c2.cnpj\\r\\nORDER BY\\r\\n    p.num_grupo, p.qtd_socios_comuns DESC;\", \"statementsList\": [\"-- ========================================================================\\r\\n-- PARTE 1: Cria\\u00e7\\u00e3o da tabela base de rela\\u00e7\\u00f5es societ\\u00e1rias\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_socios;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_socios AS\\r\\nWITH socios_empresas AS (\\r\\n    SELECT \\r\\n        g.num_grupo,\\r\\n        g.cnpj,\\r\\n        v.nu_cnpj_cpf_secund AS cpf_socio,\\r\\n        v.nm_relacao,\\r\\n        v.nm_qualificacao,\\r\\n        v.dt_inicio_relacao,\\r\\n        v.dt_fim_relacao,\\r\\n        v.pe_capital_empresa,\\r\\n        v.sn_relacao_ativa\\r\\n    FROM \\r\\n        gessimples.gei_cnpj g\\r\\n    JOIN \\r\\n        usr_sat_ods.vw_cad_vinculo v ON g.cnpj = v.nu_cnpj_princ\\r\\n    WHERE \\r\\n        v.nm_relacao != 'CONTABILISTA'\\r\\n)\\r\\nSELECT * FROM socios_empresas;\", \"\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 2: Identifica\\u00e7\\u00e3o de s\\u00f3cios compartilhados entre empresas do mesmo grupo\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_socios_compartilhados;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_socios_compartilhados AS\\r\\nWITH socios_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        cpf_socio,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_empresas\\r\\n    FROM\\r\\n        gessimples.gei_socios\\r\\n    GROUP BY\\r\\n        num_grupo, cpf_socio\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n)\\r\\nSELECT\\r\\n    sc.num_grupo,\\r\\n    sc.cpf_socio,\\r\\n    sc.qtd_empresas,\\r\\n    s.cnpj,\\r\\n    s.nm_relacao,\\r\\n    s.nm_qualificacao,\\r\\n    s.dt_inicio_relacao,\\r\\n    s.dt_fim_relacao,\\r\\n    s.pe_capital_empresa,\\r\\n    s.sn_relacao_ativa\\r\\nFROM\\r\\n    socios_count sc\\r\\nJOIN\\r\\n    gessimples.gei_socios s \\r\\n    ON sc.num_grupo = s.num_grupo AND sc.cpf_socio = s.cpf_socio;\", \"\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 3: M\\u00e9tricas consolidadas por grupo\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_socios_metricas;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_socios_metricas AS\\r\\nWITH grupo_cnpj_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs\\r\\n    FROM\\r\\n        gessimples.gei_cnpj\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\nsocios_compartilhados AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cpf_socio) AS qtd_socios_compartilhados,\\r\\n        MAX(qtd_empresas) AS max_empresas_por_socio\\r\\n    FROM\\r\\n        gessimples.gei_socios_compartilhados\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ncnpjs_com_socios_compartilhados AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_com_socios_compartilhados\\r\\n    FROM\\r\\n        gessimples.gei_socios_compartilhados\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\npares_cnpjs AS (\\r\\n    SELECT \\r\\n        num_grupo,\\r\\n        COUNT(*) AS qtd_pares_cnpjs_relacionados\\r\\n    FROM (\\r\\n        SELECT\\r\\n            sc1.num_grupo,\\r\\n            sc1.cnpj AS cnpj1,\\r\\n            sc2.cnpj AS cnpj2\\r\\n        FROM \\r\\n            gessimples.gei_socios_compartilhados sc1\\r\\n        JOIN \\r\\n            gessimples.gei_socios_compartilhados sc2\\r\\n            ON sc1.num_grupo = sc2.num_grupo\\r\\n            AND sc1.cpf_socio = sc2.cpf_socio\\r\\n            AND sc1.cnpj < sc2.cnpj\\r\\n        GROUP BY\\r\\n            sc1.num_grupo, sc1.cnpj, sc2.cnpj\\r\\n    ) t\\r\\n    GROUP BY num_grupo\\r\\n)\\r\\nSELECT\\r\\n    g.num_grupo,\\r\\n    g.total_cnpjs,\\r\\n    COALESCE(s.qtd_socios_compartilhados, 0) AS qtd_socios_compartilhados,\\r\\n    COALESCE(s.max_empresas_por_socio, 0) AS max_empresas_por_socio,\\r\\n    COALESCE(c.qtd_cnpjs_com_socios_compartilhados, 0) AS qtd_cnpjs_com_socios_compartilhados,\\r\\n    COALESCE(p.qtd_pares_cnpjs_relacionados, 0) AS qtd_pares_cnpjs_relacionados,\\r\\n    CASE \\r\\n        WHEN g.total_cnpjs > 0 THEN \\r\\n            ROUND(COALESCE(c.qtd_cnpjs_com_socios_compartilhados, 0) * 100.0 / g.total_cnpjs, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_cnpjs_com_socios,\\r\\n    CASE\\r\\n        WHEN g.total_cnpjs > 1 THEN\\r\\n            ROUND(COALESCE(p.qtd_pares_cnpjs_relacionados, 0) * 2.0 / (g.total_cnpjs * (g.total_cnpjs - 1)), 2)\\r\\n        ELSE 0\\r\\n    END AS indice_interconexao\\r\\nFROM\\r\\n    grupo_cnpj_count g\\r\\nLEFT JOIN\\r\\n    socios_compartilhados s ON g.num_grupo = s.num_grupo\\r\\nLEFT JOIN\\r\\n    cnpjs_com_socios_compartilhados c ON g.num_grupo = c.num_grupo\\r\\nLEFT JOIN\\r\\n    pares_cnpjs p ON g.num_grupo = p.num_grupo;\", \"\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 4: View para an\\u00e1lise detalhada de pares de empresas relacionadas\\r\\n-- ========================================================================\\r\\nDROP VIEW IF EXISTS gessimples.gei_pares_empresas_relacionadas;\", \"\\r\\nSET REQUEST_POOL = 'medium';\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ========================================================================\\r\\n-- PARTE 1: Cria\\u00e7\\u00e3o da tabela base de rela\\u00e7\\u00f5es societ\\u00e1rias\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_socios;\", \"result\": {\"id\": \"a079b68c-e5ea-504a-23ca-705a371326df\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"u77q56p+S5OGWPIM4XqcaA==\", \"guid\": \"CpR3CorpQbQAAAAAiDCRrg==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"aa4b02e937f5a390:6a374327635e6090\", \"session_id\": 13801, \"session_type\": \"impala\", \"statement_id\": 11, \"has_more_statements\": false, \"statements_count\": 12, \"previous_statement_hash\": \"2adfe751b41a6777e50db404eebca48162f9ef2359933200dc5d109c\", \"start\": {\"row\": 151, \"column\": 0}, \"end\": {\"row\": 197, \"column\": 41}, \"statement\": \"CREATE VIEW gessimples.gei_pares_empresas_relacionadas AS\\nWITH pares AS (\\n    SELECT\\n        sc1.num_grupo,\\n        sc1.cnpj AS cnpj1,\\n        sc2.cnpj AS cnpj2,\\n        COUNT(DISTINCT sc1.cpf_socio) AS qtd_socios_comuns\\n    FROM \\n        gessimples.gei_socios_compartilhados sc1\\n    JOIN \\n        gessimples.gei_socios_compartilhados sc2\\n        ON sc1.num_grupo = sc2.num_grupo\\n        AND sc1.cpf_socio = sc2.cpf_socio\\n        AND sc1.cnpj < sc2.cnpj\\n    GROUP BY\\n        sc1.num_grupo, sc1.cnpj, sc2.cnpj\\n),\\ncnpj_info AS (\\n    SELECT\\n        g.cnpj,\\n        c.nm_razao_social,\\n        c.nm_fantasia,\\n        c.nm_reg_apuracao\\n    FROM\\n        gessimples.gei_cnpj g\\n    LEFT JOIN\\n        gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\\n)\\nSELECT\\n    p.num_grupo,\\n    p.cnpj1,\\n    c1.nm_razao_social AS razao_social1,\\n    c1.nm_fantasia AS nome_fantasia1,\\n    c1.nm_reg_apuracao AS regime_tributario1,\\n    p.cnpj2,\\n    c2.nm_razao_social AS razao_social2,\\n    c2.nm_fantasia AS nome_fantasia2,\\n    c2.nm_reg_apuracao AS regime_tributario2,\\n    p.qtd_socios_comuns\\nFROM\\n    pares p\\nLEFT JOIN\\n    cnpj_info c1 ON p.cnpj1 = c1.cnpj\\nLEFT JOIN\\n    cnpj_info c2 ON p.cnpj2 = c2.cnpj\\nORDER BY\\n    p.num_grupo, p.qtd_socios_comuns DESC\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 11, \"statement_range\": {\"start\": {\"row\": 151, \"column\": 0}, \"end\": {\"row\": 197, \"column\": 41}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-03-26T21:10:58.193Z\", \"endTime\": \"2025-03-26T21:10:58.371Z\", \"executionTime\": 178, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1743023457977, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 100, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ========================================================================\r\n-- PARTE 1: CriaÃ§Ã£o da tabela base de relaÃ§Ãµes societÃ¡rias\r\n-- ========================================================================\r\nDROP TABLE IF EXISTS gessimples.gei_socios;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_socios AS\r\nWITH socios_empresas AS (\r\n    SELECT \r\n        g.num_grupo,\r\n        g.cnpj,\r\n        v.nu_cnpj_cpf_secund AS cpf_socio,\r\n        v.nm_relacao,\r\n        v.nm_qualificacao,\r\n        v.dt_inicio_relacao,\r\n        v.dt_fim_relacao,\r\n        v.pe_capital_empresa,\r\n        v.sn_relacao_ativa\r\n    FROM \r\n        gessimples.gei_cnpj g\r\n    JOIN \r\n        usr_sat_ods.vw_cad_vinculo v ON g.cnpj = v.nu_cnpj_princ\r\n    WHERE \r\n        v.nm_relacao != 'CONTABILISTA'\r\n)\r\nSELECT * FROM socios_empresas;\r\n\r\n-- ========================================================================\r\n-- PARTE 2: IdentificaÃ§Ã£o de sÃ³cios compartilhados entre empresas do mesmo grupo\r\n-- ========================================================================\r\nDROP TABLE IF EXISTS gessimples.gei_socios_compartilhados;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_socios_compartilhados AS\r\nWITH socios_count AS (\r\n    SELECT\r\n        num_grupo,\r\n        cpf_socio,\r\n        COUNT(DISTINCT cnpj) AS qtd_empresas\r\n    FROM\r\n        gessimples.gei_socios\r\n    GROUP BY\r\n        num_grupo, cpf_socio\r\n    HAVING\r\n        COUNT(DISTINCT cnpj) > 1\r\n)\r\nSELECT\r\n    sc.num_grupo,\r\n    sc.cpf_socio,\r\n    sc.qtd_empresas,\r\n    s.cnpj,\r\n    s.nm_relacao,\r\n    s.nm_qualificacao,\r\n    s.dt_inicio_relacao,\r\n    s.dt_fim_relacao,\r\n    s.pe_capital_empresa,\r\n    s.sn_relacao_ativa\r\nFROM\r\n    socios_count sc\r\nJOIN\r\n    gessimples.gei_socios s \r\n    ON sc.num_grupo = s.num_grupo AND sc.cpf_socio = s.cpf_socio;\r\n\r\n-- ========================================================================\r\n-- PARTE 3: MÃ©tricas consolidadas por grupo\r\n-- =====================================================",
    "last_modified": "2025-10-02T17:46:50.038",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 109909,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: PERCENT 1",
    "description": "",
    "uuid": "817f09cb-dc22-8d6d-ae80-36e31acea1c3",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 109909, \"uuid\": \"817f09cb-dc22-8d6d-ae80-36e31acea1c3\", \"name\": \"GEI: PERCENT 1\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"e72d6b5b-c9fc-21ec-01a4-db6f3c83fdda\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- Parte 1: Cria\\u00e7\\u00e3o da tabela intermedi\\u00e1ria com os c\\u00e1lculos pesados\\r\\nDROP TABLE IF EXISTS gessimples.gei_percent_intermediario;\\r\\nSET REQUEST_POOL = 'default';\\r\\nSET MEM_LIMIT = 20G;\\r\\n\\r\\nCREATE TABLE gessimples.gei_percent_intermediario AS\\r\\nWITH analise_consistencia AS (\\r\\n  -- CTE para dados de consist\\u00eancia que antes estavam no UPDATE\\r\\n  SELECT\\r\\n    g.num_grupo,\\r\\n    CASE WHEN COUNT(DISTINCT t.nm_razao_social) = 1 AND COUNT(t.nm_razao_social) > 0 THEN 'S' ELSE 'N' END AS nm_razao_social,\\r\\n    CASE WHEN COUNT(DISTINCT t.nm_fantasia) = 1 AND COUNT(t.nm_fantasia) > 0 THEN 'S' ELSE 'N' END AS nm_fantasia,\\r\\n    CASE WHEN COUNT(DISTINCT t.cd_cnae) = 1 AND COUNT(t.cd_cnae) > 0 THEN 'S' ELSE 'N' END AS cd_cnae,\\r\\n    CASE WHEN COUNT(DISTINCT t.nm_contador) = 1 AND COUNT(t.nm_contador) > 0 THEN 'S' ELSE 'N' END AS nm_contador,\\r\\n    CASE WHEN COUNT(DISTINCT concat_ws(' ', t.nm_logradouro, t.nu_logradouro, t.tx_complemento, t.nm_bairro, t.nm_munic)) = 1 \\r\\n        AND COUNT(concat_ws(' ', t.nm_logradouro, t.nu_logradouro, t.tx_complemento, t.nm_bairro, t.nm_munic)) > 0\\r\\n        THEN 'S' ELSE 'N' END AS endereco\\r\\n  FROM gessimples.gei_cnpj g\\r\\n  LEFT JOIN gessimples.gei_cadastro t ON g.cnpj = t.nu_cnpj\\r\\n  GROUP BY g.num_grupo\\r\\n),\\r\\n-- Base para as inconsist\\u00eancias da NFe\\r\\nbase AS (\\r\\nSELECT\\r\\nnfe_nu_chave_acesso,\\r\\ngrupo_emit,\\r\\ngrupo_dest,\\r\\nCASE WHEN MAX(CASE WHEN cliente_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS cliente_incons,\\r\\nCASE WHEN MAX(CASE WHEN email_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS email_incons,\\r\\nCASE WHEN MAX(CASE WHEN tel_dest_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS tel_dest_incons,\\r\\nCASE WHEN MAX(CASE WHEN tel_emit_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS tel_emit_incons,\\r\\nCASE WHEN MAX(CASE WHEN codigo_produto_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS codigo_produto_incons,\\r\\nCASE WHEN MAX(CASE WHEN fornecedor_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS fornecedor_incons,\\r\\nCASE WHEN MAX(CASE WHEN end_emit_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS end_emit_incons,\\r\\nCASE WHEN MAX(CASE WHEN end_dest_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS end_dest_incons,\\r\\nCASE WHEN MAX(CASE WHEN descricao_produto_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS descricao_produto_incons,\\r\\nCASE WHEN MAX(CASE WHEN ip_transmissao_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS ip_transmissao_incons\\r\\nFROM gessimples.gei_nfe_completo\\r\\nGROUP BY nfe_nu_chave_acesso, grupo_emit, grupo_dest\\r\\n),\\r\\n-- C\\u00e1lculo dos percentuais por grupo\\r\\nperc_cliente AS (\\r\\nSELECT\\r\\ngrupo_emit AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN cliente_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_cliente\\r\\nFROM base\\r\\nWHERE grupo_emit IS NOT NULL\\r\\nGROUP BY grupo_emit\\r\\n),\\r\\nperc_email AS (\\r\\nSELECT\\r\\ngrupo_dest AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN email_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_email\\r\\nFROM base\\r\\nWHERE grupo_dest IS NOT NULL\\r\\nGROUP BY grupo_dest\\r\\n),\\r\\nperc_tel_dest AS (\\r\\nSELECT\\r\\ngrupo_dest AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN tel_dest_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_tel_dest\\r\\nFROM base\\r\\nWHERE grupo_dest IS NOT NULL\\r\\nGROUP BY grupo_dest\\r\\n),\\r\\nperc_tel_emit AS (\\r\\nSELECT\\r\\ngrupo_emit AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN tel_emit_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_tel_emit\\r\\nFROM base\\r\\nWHERE grupo_emit IS NOT NULL\\r\\nGROUP BY grupo_emit\\r\\n),\\r\\nperc_codigo_produto AS (\\r\\nSELECT\\r\\ngrupo_emit AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN codigo_produto_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_codigo_produto\\r\\nFROM base\\r\\nWHERE grupo_emit IS NOT NULL\\r\\nGROUP BY grupo_emit\\r\\n),\\r\\nperc_fornecedor AS (\\r\\nSELECT\\r\\ngrupo_dest AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN fornecedor_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_fornecedor\\r\\nFROM base\\r\\nWHERE grupo_dest IS NOT NULL\\r\\nGROUP BY grupo_dest\\r\\n),\\r\\nperc_end_emit AS (\\r\\nSELECT\\r\\ngrupo_emit AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN end_emit_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_end_emit\\r\\nFROM base\\r\\nWHERE grupo_emit IS NOT NULL\\r\\nGROUP BY grupo_emit\\r\\n),\\r\\nperc_end_dest AS (\\r\\nSELECT\\r\\ngrupo_dest AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN end_dest_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_end_dest\\r\\nFROM base\\r\\nWHERE grupo_dest IS NOT NULL\\r\\nGROUP BY grupo_dest\\r\\n),\\r\\nperc_descricao_produto AS (\\r\\nSELECT\\r\\ngrupo_emit AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN descricao_produto_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_descricao_produto\\r\\nFROM base\\r\\nWHERE grupo_emit IS NOT NULL\\r\\nGROUP BY grupo_emit\\r\\n),\\r\\nperc_ip_transmissao AS (\\r\\nSELECT\\r\\ngrupo_emit AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN ip_transmissao_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_ip_transmissao\\r\\nFROM base\\r\\nWHERE grupo_emit IS NOT NULL\\r\\nGROUP BY grupo_emit\\r\\n),\\r\\n-- Contagem de NFe distintas e total de itens por grupo\\r\\nnfe_counts AS (\\r\\nSELECT num_grupo,\\r\\nCOUNT(DISTINCT nfe_nu_chave_acesso) AS distinct_nfe,\\r\\nCOUNT(*) AS total_itens\\r\\nFROM (\\r\\nSELECT nfe_nu_chave_acesso, grupo_emit AS num_grupo FROM base WHERE grupo_emit IS NOT NULL\\r\\nUNION ALL\\r\\nSELECT nfe_nu_chave_acesso, grupo_dest AS num_grupo FROM base WHERE grupo_dest IS NOT NULL\\r\\n) t\\r\\nGROUP BY num_grupo\\r\\n),\\r\\n-- Lista de todos os grupos presentes\\r\\nall_groups AS (\\r\\nSELECT num_grupo FROM perc_cliente\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_email\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_tel_dest\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_tel_emit\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_codigo_produto\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_fornecedor\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_end_emit\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_end_dest\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_descricao_produto\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_ip_transmissao\\r\\n),\\r\\n-- An\\u00e1lises intragrupo dos CNPJs e contagem de CNPJs distintos\\r\\nanalise AS (\\r\\nSELECT\\r\\ng.num_grupo,\\r\\nCASE WHEN COUNT(DISTINCT t.nm_razao_social) = 1 AND COUNT(t.nm_razao_social) > 0 THEN 'S' ELSE 'N' END AS nm_razao_social,\\r\\nCASE WHEN COUNT(DISTINCT t.nm_fantasia) = 1 AND COUNT(t.nm_fantasia) > 0 THEN 'S' ELSE 'N' END AS nm_fantasia,\\r\\nCASE WHEN COUNT(DISTINCT t.cd_cnae) = 1 AND COUNT(t.cd_cnae) > 0 THEN 'S' ELSE 'N' END AS cd_cnae,\\r\\nCASE WHEN COUNT(DISTINCT t.nm_contador) = 1 AND COUNT(t.nm_contador) > 0 THEN 'S' ELSE 'N' END AS nm_contador,\\r\\nCASE WHEN COUNT(DISTINCT concat_ws(' ', t.nm_logradouro, t.nu_logradouro, t.tx_complemento, t.nm_bairro, t.nm_munic)) = 1\\r\\nAND COUNT(concat_ws(' ', t.nm_logradouro, t.nu_logradouro, t.tx_complemento, t.nm_bairro, t.nm_munic)) > 0\\r\\nTHEN 'S' ELSE 'N' END AS endereco,\\r\\nCOUNT(DISTINCT g.cnpj) AS qntd_cnpj\\r\\nFROM gessimples.gei_cnpj g\\r\\nLEFT JOIN gessimples.gei_cadastro t\\r\\nON g.cnpj = t.nu_cnpj\\r\\nGROUP BY g.num_grupo\\r\\n),\\r\\n-- Apura\\u00e7\\u00e3o dos registros de apura\\u00e7\\u00e3o\\r\\napuracao AS (\\r\\nSELECT\\r\\ng.num_grupo,\\r\\nSUM(CASE WHEN t.nm_reg_apuracao = 'NORMAL' THEN 1 ELSE 0 END) AS qntd_normal,\\r\\nSUM(CASE WHEN t.nm_reg_apuracao = 'SIMPLES NACIONAL' THEN 1 ELSE 0 END) AS qntd_sn\\r\\nFROM gessimples.gei_cnpj g\\r\\nJOIN gessimples.gei_cadastro t\\r\\nON g.cnpj = t.nu_cnpj\\r\\nGROUP BY g.num_grupo\\r\\n)\\r\\n-- Tabela intermedi\\u00e1ria com os resultados dos c\\u00e1lculos pesados\\r\\nSELECT\\r\\n    ag.num_grupo,\\r\\n    a.qntd_cnpj,\\r\\n    pc.perc_cliente,\\r\\n    perc_email.perc_email,\\r\\n    ptd.perc_tel_dest,\\r\\n    pte.perc_tel_emit,\\r\\n    pcp.perc_codigo_produto,\\r\\n    pf.perc_fornecedor,\\r\\n    pee.perc_end_emit,\\r\\n    ptdest.perc_end_dest,\\r\\n    pdp.perc_descricao_produto,\\r\\n    pit.perc_ip_transmissao,\\r\\n    ROUND(\\r\\n        COALESCE(pc.perc_cliente, 0) +\\r\\n        COALESCE(perc_email.perc_email, 0) +\\r\\n        COALESCE(ptd.perc_tel_dest, 0) +\\r\\n        COALESCE(pte.perc_tel_emit, 0) +\\r\\n        COALESCE(pcp.perc_codigo_produto, 0) +\\r\\n        COALESCE(pf.perc_fornecedor, 0) +\\r\\n        COALESCE(pee.perc_end_emit, 0) +\\r\\n        COALESCE(ptdest.perc_end_dest, 0) +\\r\\n        COALESCE(pdp.perc_descricao_produto, 0) +\\r\\n        COALESCE(pit.perc_ip_transmissao, 0)\\r\\n    , 2) AS total_incons,\\r\\n    nce.distinct_nfe,\\r\\n    nce.total_itens,\\r\\n    COALESCE(ac.nm_razao_social, a.nm_razao_social) AS nm_razao_social,\\r\\n    COALESCE(ac.nm_fantasia, a.nm_fantasia) AS nm_fantasia,\\r\\n    COALESCE(ac.cd_cnae, a.cd_cnae) AS cd_cnae,\\r\\n    COALESCE(ac.nm_contador, a.nm_contador) AS nm_contador,\\r\\n    COALESCE(ac.endereco, a.endereco) AS endereco,\\r\\n    (CASE WHEN COALESCE(ac.nm_razao_social, a.nm_razao_social) = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN COALESCE(ac.nm_fantasia, a.nm_fantasia) = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN COALESCE(ac.cd_cnae, a.cd_cnae) = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN COALESCE(ac.nm_contador, a.nm_contador) = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN COALESCE(ac.endereco, a.endereco) = 'S' THEN 1 ELSE 0 END) AS qntd_s,\\r\\n    ap.qntd_normal,\\r\\n    ap.qntd_sn,\\r\\n    ROUND(\\r\\n        COALESCE(pc.perc_cliente, 0) +\\r\\n        COALESCE(perc_email.perc_email, 0) +\\r\\n        COALESCE(ptd.perc_tel_dest, 0) +\\r\\n        COALESCE(pte.perc_tel_emit, 0) +\\r\\n        COALESCE(pcp.perc_codigo_produto, 0) +\\r\\n        COALESCE(pf.perc_fornecedor, 0) +\\r\\n        COALESCE(pee.perc_end_emit, 0) +\\r\\n        COALESCE(ptdest.perc_end_dest, 0) +\\r\\n        COALESCE(pdp.perc_descricao_produto, 0) +\\r\\n        COALESCE(pit.perc_ip_transmissao, 0)\\r\\n        +\\r\\n        (CASE WHEN COALESCE(ac.nm_razao_social, a.nm_razao_social) = 'S' THEN 1 ELSE 0 END) +\\r\\n        (CASE WHEN COALESCE(ac.nm_fantasia, a.nm_fantasia) = 'S' THEN 1 ELSE 0 END) +\\r\\n        (CASE WHEN COALESCE(ac.cd_cnae, a.cd_cnae) = 'S' THEN 1 ELSE 0 END) +\\r\\n        (CASE WHEN COALESCE(ac.nm_contador, a.nm_contador) = 'S' THEN 1 ELSE 0 END) +\\r\\n        (CASE WHEN COALESCE(ac.endereco, a.endereco) = 'S' THEN 1 ELSE 0 END)\\r\\n    , 2) AS     total_cadastro,\\r\\n    COALESCE(sm.qtd_socios_compartilhados, 0) AS qtd_socios_compartilhados,\\r\\n    COALESCE(sm.max_empresas_por_socio, 0) AS max_empresas_por_socio,\\r\\n    COALESCE(sm.qtd_cnpjs_com_socios_compartilhados, 0) AS qtd_cnpjs_com_socios_compartilhados,\\r\\n    COALESCE(sm.qtd_pares_cnpjs_relacionados, 0) AS qtd_pares_cnpjs_relacionados,\\r\\n    COALESCE(sm.perc_cnpjs_com_socios, 0) AS perc_cnpjs_com_socios,\\r\\n    COALESCE(sm.indice_interconexao, 0) AS indice_interconexao\\r\\nFROM all_groups ag\\r\\nLEFT JOIN perc_cliente pc ON ag.num_grupo = pc.num_grupo\\r\\nLEFT JOIN perc_email ON ag.num_grupo = perc_email.num_grupo\\r\\nLEFT JOIN perc_tel_dest ptd ON ag.num_grupo = ptd.num_grupo\\r\\nLEFT JOIN perc_tel_emit pte ON ag.num_grupo = pte.num_grupo\\r\\nLEFT JOIN perc_codigo_produto pcp ON ag.num_grupo = pcp.num_grupo\\r\\nLEFT JOIN perc_fornecedor pf ON ag.num_grupo = pf.num_grupo\\r\\nLEFT JOIN perc_end_emit pee ON ag.num_grupo = pee.num_grupo\\r\\nLEFT JOIN perc_end_dest ptdest ON ag.num_grupo = ptdest.num_grupo\\r\\nLEFT JOIN perc_descricao_produto pdp ON ag.num_grupo = pdp.num_grupo\\r\\nLEFT JOIN perc_ip_transmissao pit ON ag.num_grupo = pit.num_grupo\\r\\nLEFT JOIN nfe_counts nce ON ag.num_grupo = nce.num_grupo\\r\\nLEFT JOIN analise a ON ag.num_grupo = a.num_grupo\\r\\nLEFT JOIN analise_consistencia ac ON ag.num_grupo = ac.num_grupo\\r\\nLEFT JOIN apuracao ap ON ag.num_grupo = ap.num_grupo\\r\\nLEFT JOIN gessimples.gei_socios_metricas sm ON ag.num_grupo = sm.num_grupo;\", \"statementsList\": [\"-- Parte 1: Cria\\u00e7\\u00e3o da tabela intermedi\\u00e1ria com os c\\u00e1lculos pesados\\r\\nDROP TABLE IF EXISTS gessimples.gei_percent_intermediario;\", \"\\r\\nSET REQUEST_POOL = 'default';\", \"\\r\\nSET MEM_LIMIT = 20G;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_percent_intermediario AS\\r\\nWITH analise_consistencia AS (\\r\\n  -- CTE para dados de consist\\u00eancia que antes estavam no UPDATE\\r\\n  SELECT\\r\\n    g.num_grupo,\\r\\n    CASE WHEN COUNT(DISTINCT t.nm_razao_social) = 1 AND COUNT(t.nm_razao_social) > 0 THEN 'S' ELSE 'N' END AS nm_razao_social,\\r\\n    CASE WHEN COUNT(DISTINCT t.nm_fantasia) = 1 AND COUNT(t.nm_fantasia) > 0 THEN 'S' ELSE 'N' END AS nm_fantasia,\\r\\n    CASE WHEN COUNT(DISTINCT t.cd_cnae) = 1 AND COUNT(t.cd_cnae) > 0 THEN 'S' ELSE 'N' END AS cd_cnae,\\r\\n    CASE WHEN COUNT(DISTINCT t.nm_contador) = 1 AND COUNT(t.nm_contador) > 0 THEN 'S' ELSE 'N' END AS nm_contador,\\r\\n    CASE WHEN COUNT(DISTINCT concat_ws(' ', t.nm_logradouro, t.nu_logradouro, t.tx_complemento, t.nm_bairro, t.nm_munic)) = 1 \\r\\n        AND COUNT(concat_ws(' ', t.nm_logradouro, t.nu_logradouro, t.tx_complemento, t.nm_bairro, t.nm_munic)) > 0\\r\\n        THEN 'S' ELSE 'N' END AS endereco\\r\\n  FROM gessimples.gei_cnpj g\\r\\n  LEFT JOIN gessimples.gei_cadastro t ON g.cnpj = t.nu_cnpj\\r\\n  GROUP BY g.num_grupo\\r\\n),\\r\\n-- Base para as inconsist\\u00eancias da NFe\\r\\nbase AS (\\r\\nSELECT\\r\\nnfe_nu_chave_acesso,\\r\\ngrupo_emit,\\r\\ngrupo_dest,\\r\\nCASE WHEN MAX(CASE WHEN cliente_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS cliente_incons,\\r\\nCASE WHEN MAX(CASE WHEN email_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS email_incons,\\r\\nCASE WHEN MAX(CASE WHEN tel_dest_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS tel_dest_incons,\\r\\nCASE WHEN MAX(CASE WHEN tel_emit_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS tel_emit_incons,\\r\\nCASE WHEN MAX(CASE WHEN codigo_produto_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS codigo_produto_incons,\\r\\nCASE WHEN MAX(CASE WHEN fornecedor_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS fornecedor_incons,\\r\\nCASE WHEN MAX(CASE WHEN end_emit_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS end_emit_incons,\\r\\nCASE WHEN MAX(CASE WHEN end_dest_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS end_dest_incons,\\r\\nCASE WHEN MAX(CASE WHEN descricao_produto_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS descricao_produto_incons,\\r\\nCASE WHEN MAX(CASE WHEN ip_transmissao_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS ip_transmissao_incons\\r\\nFROM gessimples.gei_nfe_completo\\r\\nGROUP BY nfe_nu_chave_acesso, grupo_emit, grupo_dest\\r\\n),\\r\\n-- C\\u00e1lculo dos percentuais por grupo\\r\\nperc_cliente AS (\\r\\nSELECT\\r\\ngrupo_emit AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN cliente_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_cliente\\r\\nFROM base\\r\\nWHERE grupo_emit IS NOT NULL\\r\\nGROUP BY grupo_emit\\r\\n),\\r\\nperc_email AS (\\r\\nSELECT\\r\\ngrupo_dest AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN email_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_email\\r\\nFROM base\\r\\nWHERE grupo_dest IS NOT NULL\\r\\nGROUP BY grupo_dest\\r\\n),\\r\\nperc_tel_dest AS (\\r\\nSELECT\\r\\ngrupo_dest AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN tel_dest_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_tel_dest\\r\\nFROM base\\r\\nWHERE grupo_dest IS NOT NULL\\r\\nGROUP BY grupo_dest\\r\\n),\\r\\nperc_tel_emit AS (\\r\\nSELECT\\r\\ngrupo_emit AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN tel_emit_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_tel_emit\\r\\nFROM base\\r\\nWHERE grupo_emit IS NOT NULL\\r\\nGROUP BY grupo_emit\\r\\n),\\r\\nperc_codigo_produto AS (\\r\\nSELECT\\r\\ngrupo_emit AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN codigo_produto_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_codigo_produto\\r\\nFROM base\\r\\nWHERE grupo_emit IS NOT NULL\\r\\nGROUP BY grupo_emit\\r\\n),\\r\\nperc_fornecedor AS (\\r\\nSELECT\\r\\ngrupo_dest AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN fornecedor_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_fornecedor\\r\\nFROM base\\r\\nWHERE grupo_dest IS NOT NULL\\r\\nGROUP BY grupo_dest\\r\\n),\\r\\nperc_end_emit AS (\\r\\nSELECT\\r\\ngrupo_emit AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN end_emit_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_end_emit\\r\\nFROM base\\r\\nWHERE grupo_emit IS NOT NULL\\r\\nGROUP BY grupo_emit\\r\\n),\\r\\nperc_end_dest AS (\\r\\nSELECT\\r\\ngrupo_dest AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN end_dest_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_end_dest\\r\\nFROM base\\r\\nWHERE grupo_dest IS NOT NULL\\r\\nGROUP BY grupo_dest\\r\\n),\\r\\nperc_descricao_produto AS (\\r\\nSELECT\\r\\ngrupo_emit AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN descricao_produto_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_descricao_produto\\r\\nFROM base\\r\\nWHERE grupo_emit IS NOT NULL\\r\\nGROUP BY grupo_emit\\r\\n),\\r\\nperc_ip_transmissao AS (\\r\\nSELECT\\r\\ngrupo_emit AS num_grupo,\\r\\nCASE\\r\\nWHEN COUNT(nfe_nu_chave_acesso) = 0 THEN 0\\r\\nELSE ROUND(SUM(CASE WHEN ip_transmissao_incons = 'S' THEN 1 ELSE 0 END) / COUNT(nfe_nu_chave_acesso), 2)\\r\\nEND AS perc_ip_transmissao\\r\\nFROM base\\r\\nWHERE grupo_emit IS NOT NULL\\r\\nGROUP BY grupo_emit\\r\\n),\\r\\n-- Contagem de NFe distintas e total de itens por grupo\\r\\nnfe_counts AS (\\r\\nSELECT num_grupo,\\r\\nCOUNT(DISTINCT nfe_nu_chave_acesso) AS distinct_nfe,\\r\\nCOUNT(*) AS total_itens\\r\\nFROM (\\r\\nSELECT nfe_nu_chave_acesso, grupo_emit AS num_grupo FROM base WHERE grupo_emit IS NOT NULL\\r\\nUNION ALL\\r\\nSELECT nfe_nu_chave_acesso, grupo_dest AS num_grupo FROM base WHERE grupo_dest IS NOT NULL\\r\\n) t\\r\\nGROUP BY num_grupo\\r\\n),\\r\\n-- Lista de todos os grupos presentes\\r\\nall_groups AS (\\r\\nSELECT num_grupo FROM perc_cliente\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_email\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_tel_dest\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_tel_emit\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_codigo_produto\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_fornecedor\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_end_emit\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_end_dest\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_descricao_produto\\r\\nUNION\\r\\nSELECT num_grupo FROM perc_ip_transmissao\\r\\n),\\r\\n-- An\\u00e1lises intragrupo dos CNPJs e contagem de CNPJs distintos\\r\\nanalise AS (\\r\\nSELECT\\r\\ng.num_grupo,\\r\\nCASE WHEN COUNT(DISTINCT t.nm_razao_social) = 1 AND COUNT(t.nm_razao_social) > 0 THEN 'S' ELSE 'N' END AS nm_razao_social,\\r\\nCASE WHEN COUNT(DISTINCT t.nm_fantasia) = 1 AND COUNT(t.nm_fantasia) > 0 THEN 'S' ELSE 'N' END AS nm_fantasia,\\r\\nCASE WHEN COUNT(DISTINCT t.cd_cnae) = 1 AND COUNT(t.cd_cnae) > 0 THEN 'S' ELSE 'N' END AS cd_cnae,\\r\\nCASE WHEN COUNT(DISTINCT t.nm_contador) = 1 AND COUNT(t.nm_contador) > 0 THEN 'S' ELSE 'N' END AS nm_contador,\\r\\nCASE WHEN COUNT(DISTINCT concat_ws(' ', t.nm_logradouro, t.nu_logradouro, t.tx_complemento, t.nm_bairro, t.nm_munic)) = 1\\r\\nAND COUNT(concat_ws(' ', t.nm_logradouro, t.nu_logradouro, t.tx_complemento, t.nm_bairro, t.nm_munic)) > 0\\r\\nTHEN 'S' ELSE 'N' END AS endereco,\\r\\nCOUNT(DISTINCT g.cnpj) AS qntd_cnpj\\r\\nFROM gessimples.gei_cnpj g\\r\\nLEFT JOIN gessimples.gei_cadastro t\\r\\nON g.cnpj = t.nu_cnpj\\r\\nGROUP BY g.num_grupo\\r\\n),\\r\\n-- Apura\\u00e7\\u00e3o dos registros de apura\\u00e7\\u00e3o\\r\\napuracao AS (\\r\\nSELECT\\r\\ng.num_grupo,\\r\\nSUM(CASE WHEN t.nm_reg_apuracao = 'NORMAL' THEN 1 ELSE 0 END) AS qntd_normal,\\r\\nSUM(CASE WHEN t.nm_reg_apuracao = 'SIMPLES NACIONAL' THEN 1 ELSE 0 END) AS qntd_sn\\r\\nFROM gessimples.gei_cnpj g\\r\\nJOIN gessimples.gei_cadastro t\\r\\nON g.cnpj = t.nu_cnpj\\r\\nGROUP BY g.num_grupo\\r\\n)\\r\\n-- Tabela intermedi\\u00e1ria com os resultados dos c\\u00e1lculos pesados\\r\\nSELECT\\r\\n    ag.num_grupo,\\r\\n    a.qntd_cnpj,\\r\\n    pc.perc_cliente,\\r\\n    perc_email.perc_email,\\r\\n    ptd.perc_tel_dest,\\r\\n    pte.perc_tel_emit,\\r\\n    pcp.perc_codigo_produto,\\r\\n    pf.perc_fornecedor,\\r\\n    pee.perc_end_emit,\\r\\n    ptdest.perc_end_dest,\\r\\n    pdp.perc_descricao_produto,\\r\\n    pit.perc_ip_transmissao,\\r\\n    ROUND(\\r\\n        COALESCE(pc.perc_cliente, 0) +\\r\\n        COALESCE(perc_email.perc_email, 0) +\\r\\n        COALESCE(ptd.perc_tel_dest, 0) +\\r\\n        COALESCE(pte.perc_tel_emit, 0) +\\r\\n        COALESCE(pcp.perc_codigo_produto, 0) +\\r\\n        COALESCE(pf.perc_fornecedor, 0) +\\r\\n        COALESCE(pee.perc_end_emit, 0) +\\r\\n        COALESCE(ptdest.perc_end_dest, 0) +\\r\\n        COALESCE(pdp.perc_descricao_produto, 0) +\\r\\n        COALESCE(pit.perc_ip_transmissao, 0)\\r\\n    , 2) AS total_incons,\\r\\n    nce.distinct_nfe,\\r\\n    nce.total_itens,\\r\\n    COALESCE(ac.nm_razao_social, a.nm_razao_social) AS nm_razao_social,\\r\\n    COALESCE(ac.nm_fantasia, a.nm_fantasia) AS nm_fantasia,\\r\\n    COALESCE(ac.cd_cnae, a.cd_cnae) AS cd_cnae,\\r\\n    COALESCE(ac.nm_contador, a.nm_contador) AS nm_contador,\\r\\n    COALESCE(ac.endereco, a.endereco) AS endereco,\\r\\n    (CASE WHEN COALESCE(ac.nm_razao_social, a.nm_razao_social) = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN COALESCE(ac.nm_fantasia, a.nm_fantasia) = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN COALESCE(ac.cd_cnae, a.cd_cnae) = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN COALESCE(ac.nm_contador, a.nm_contador) = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN COALESCE(ac.endereco, a.endereco) = 'S' THEN 1 ELSE 0 END) AS qntd_s,\\r\\n    ap.qntd_normal,\\r\\n    ap.qntd_sn,\\r\\n    ROUND(\\r\\n        COALESCE(pc.perc_cliente, 0) +\\r\\n        COALESCE(perc_email.perc_email, 0) +\\r\\n        COALESCE(ptd.perc_tel_dest, 0) +\\r\\n        COALESCE(pte.perc_tel_emit, 0) +\\r\\n        COALESCE(pcp.perc_codigo_produto, 0) +\\r\\n        COALESCE(pf.perc_fornecedor, 0) +\\r\\n        COALESCE(pee.perc_end_emit, 0) +\\r\\n        COALESCE(ptdest.perc_end_dest, 0) +\\r\\n        COALESCE(pdp.perc_descricao_produto, 0) +\\r\\n        COALESCE(pit.perc_ip_transmissao, 0)\\r\\n        +\\r\\n        (CASE WHEN COALESCE(ac.nm_razao_social, a.nm_razao_social) = 'S' THEN 1 ELSE 0 END) +\\r\\n        (CASE WHEN COALESCE(ac.nm_fantasia, a.nm_fantasia) = 'S' THEN 1 ELSE 0 END) +\\r\\n        (CASE WHEN COALESCE(ac.cd_cnae, a.cd_cnae) = 'S' THEN 1 ELSE 0 END) +\\r\\n        (CASE WHEN COALESCE(ac.nm_contador, a.nm_contador) = 'S' THEN 1 ELSE 0 END) +\\r\\n        (CASE WHEN COALESCE(ac.endereco, a.endereco) = 'S' THEN 1 ELSE 0 END)\\r\\n    , 2) AS     total_cadastro,\\r\\n    COALESCE(sm.qtd_socios_compartilhados, 0) AS qtd_socios_compartilhados,\\r\\n    COALESCE(sm.max_empresas_por_socio, 0) AS max_empresas_por_socio,\\r\\n    COALESCE(sm.qtd_cnpjs_com_socios_compartilhados, 0) AS qtd_cnpjs_com_socios_compartilhados,\\r\\n    COALESCE(sm.qtd_pares_cnpjs_relacionados, 0) AS qtd_pares_cnpjs_relacionados,\\r\\n    COALESCE(sm.perc_cnpjs_com_socios, 0) AS perc_cnpjs_com_socios,\\r\\n    COALESCE(sm.indice_interconexao, 0) AS indice_interconexao\\r\\nFROM all_groups ag\\r\\nLEFT JOIN perc_cliente pc ON ag.num_grupo = pc.num_grupo\\r\\nLEFT JOIN perc_email ON ag.num_grupo = perc_email.num_grupo\\r\\nLEFT JOIN perc_tel_dest ptd ON ag.num_grupo = ptd.num_grupo\\r\\nLEFT JOIN perc_tel_emit pte ON ag.num_grupo = pte.num_grupo\\r\\nLEFT JOIN perc_codigo_produto pcp ON ag.num_grupo = pcp.num_grupo\\r\\nLEFT JOIN perc_fornecedor pf ON ag.num_grupo = pf.num_grupo\\r\\nLEFT JOIN perc_end_emit pee ON ag.num_grupo = pee.num_grupo\\r\\nLEFT JOIN perc_end_dest ptdest ON ag.num_grupo = ptdest.num_grupo\\r\\nLEFT JOIN perc_descricao_produto pdp ON ag.num_grupo = pdp.num_grupo\\r\\nLEFT JOIN perc_ip_transmissao pit ON ag.num_grupo = pit.num_grupo\\r\\nLEFT JOIN nfe_counts nce ON ag.num_grupo = nce.num_grupo\\r\\nLEFT JOIN analise a ON ag.num_grupo = a.num_grupo\\r\\nLEFT JOIN analise_consistencia ac ON ag.num_grupo = ac.num_grupo\\r\\nLEFT JOIN apuracao ap ON ag.num_grupo = ap.num_grupo\\r\\nLEFT JOIN gessimples.gei_socios_metricas sm ON ag.num_grupo = sm.num_grupo;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- Parte 1: Cria\\u00e7\\u00e3o da tabela intermedi\\u00e1ria com os c\\u00e1lculos pesados\\r\\nDROP TABLE IF EXISTS gessimples.gei_percent_intermediario;\", \"result\": {\"id\": \"79fe68a7-f0ee-97d9-9741-715a4a17e1c2\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {}, \"meta\": [], \"rows\": null, \"hasMore\": false, \"statement_id\": 0, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-03-26T21:39:10.211Z\", \"endTime\": \"2025-03-26T21:39:10.211Z\", \"executionTime\": 0, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 0, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 100, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- Parte 1: CriaÃ§Ã£o da tabela intermediÃ¡ria com os cÃ¡lculos pesados\r\nDROP TABLE IF EXISTS gessimples.gei_percent_intermediario;\r\nSET REQUEST_POOL = 'default';\r\nSET MEM_LIMIT = 20G;\r\n\r\nCREATE TABLE gessimples.gei_percent_intermediario AS\r\nWITH analise_consistencia AS (\r\n  -- CTE para dados de consistÃªncia que antes estavam no UPDATE\r\n  SELECT\r\n    g.num_grupo,\r\n    CASE WHEN COUNT(DISTINCT t.nm_razao_social) = 1 AND COUNT(t.nm_razao_social) > 0 THEN 'S' ELSE 'N' END AS nm_razao_social,\r\n    CASE WHEN COUNT(DISTINCT t.nm_fantasia) = 1 AND COUNT(t.nm_fantasia) > 0 THEN 'S' ELSE 'N' END AS nm_fantasia,\r\n    CASE WHEN COUNT(DISTINCT t.cd_cnae) = 1 AND COUNT(t.cd_cnae) > 0 THEN 'S' ELSE 'N' END AS cd_cnae,\r\n    CASE WHEN COUNT(DISTINCT t.nm_contador) = 1 AND COUNT(t.nm_contador) > 0 THEN 'S' ELSE 'N' END AS nm_contador,\r\n    CASE WHEN COUNT(DISTINCT concat_ws(' ', t.nm_logradouro, t.nu_logradouro, t.tx_complemento, t.nm_bairro, t.nm_munic)) = 1 \r\n        AND COUNT(concat_ws(' ', t.nm_logradouro, t.nu_logradouro, t.tx_complemento, t.nm_bairro, t.nm_munic)) > 0\r\n        THEN 'S' ELSE 'N' END AS endereco\r\n  FROM gessimples.gei_cnpj g\r\n  LEFT JOIN gessimples.gei_cadastro t ON g.cnpj = t.nu_cnpj\r\n  GROUP BY g.num_grupo\r\n),\r\n-- Base para as inconsistÃªncias da NFe\r\nbase AS (\r\nSELECT\r\nnfe_nu_chave_acesso,\r\ngrupo_emit,\r\ngrupo_dest,\r\nCASE WHEN MAX(CASE WHEN cliente_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS cliente_incons,\r\nCASE WHEN MAX(CASE WHEN email_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS email_incons,\r\nCASE WHEN MAX(CASE WHEN tel_dest_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS tel_dest_incons,\r\nCASE WHEN MAX(CASE WHEN tel_emit_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS tel_emit_incons,\r\nCASE WHEN MAX(CASE WHEN codigo_produto_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS codigo_produto_incons,\r\nCASE WHEN MAX(CASE WHEN fornecedor_incons = 'S' THEN 1 ELSE 0 END) = 1 THEN 'S' ELSE 'N' END AS ",
    "last_modified": "2025-10-02T17:46:42.110",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 109910,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: PERCENT 2",
    "description": "",
    "uuid": "69e4feeb-4b49-5cfd-37dd-91e66e1cb7e6",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 109910, \"uuid\": \"1e9bb142-e6aa-40eb-9ec7-b0d0dee58573\", \"name\": \"GEI: PERCENT 2\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"69e4feeb-4b49-5cfd-37dd-91e66e1cb7e6\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"317c8b8c-647b-2ef4-cd08-bb96538661d8\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Query\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 337, \"column\": 12}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"gessimples\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- Parte 2: Processamento dos dados do PGDAS + DIME e cria\\u00e7\\u00e3o da tabela final\\r\\nDROP TABLE IF EXISTS gessimples.gei_percent;\\r\\nSET REQUEST_POOL = 'default';\\r\\nSET MEM_LIMIT = 20G;\\r\\n\\r\\nCREATE TABLE gessimples.gei_percent AS\\r\\nWITH faturamento_consolidado AS (\\r\\n    -- ============================================================================\\r\\n    -- >> CONSOLIDA\\u00c7\\u00c3O PGDAS + DIME (NOVO)\\r\\n    -- ============================================================================\\r\\n    -- Dados do PGDAS (Simples Nacional)\\r\\n    SELECT\\r\\n        gc.num_grupo,\\r\\n        gc.cnpj,\\r\\n        COALESCE(pg.jan2021, 0) AS jan2021, COALESCE(pg.fev2021, 0) AS fev2021, COALESCE(pg.mar2021, 0) AS mar2021,\\r\\n        COALESCE(pg.abr2021, 0) AS abr2021, COALESCE(pg.mai2021, 0) AS mai2021, COALESCE(pg.jun2021, 0) AS jun2021,\\r\\n        COALESCE(pg.jul2021, 0) AS jul2021, COALESCE(pg.ago2021, 0) AS ago2021, COALESCE(pg.set2021, 0) AS set2021,\\r\\n        COALESCE(pg.out2021, 0) AS out2021, COALESCE(pg.nov2021, 0) AS nov2021, COALESCE(pg.dez2021, 0) AS dez2021,\\r\\n        COALESCE(pg.jan2022, 0) AS jan2022, COALESCE(pg.fev2022, 0) AS fev2022, COALESCE(pg.mar2022, 0) AS mar2022,\\r\\n        COALESCE(pg.abr2022, 0) AS abr2022, COALESCE(pg.mai2022, 0) AS mai2022, COALESCE(pg.jun2022, 0) AS jun2022,\\r\\n        COALESCE(pg.jul2022, 0) AS jul2022, COALESCE(pg.ago2022, 0) AS ago2022, COALESCE(pg.set2022, 0) AS set2022,\\r\\n        COALESCE(pg.out2022, 0) AS out2022, COALESCE(pg.nov2022, 0) AS nov2022, COALESCE(pg.dez2022, 0) AS dez2022,\\r\\n        COALESCE(pg.jan2023, 0) AS jan2023, COALESCE(pg.fev2023, 0) AS fev2023, COALESCE(pg.mar2023, 0) AS mar2023,\\r\\n        COALESCE(pg.abr2023, 0) AS abr2023, COALESCE(pg.mai2023, 0) AS mai2023, COALESCE(pg.jun2023, 0) AS jun2023,\\r\\n        COALESCE(pg.jul2023, 0) AS jul2023, COALESCE(pg.ago2023, 0) AS ago2023, COALESCE(pg.set2023, 0) AS set2023,\\r\\n        COALESCE(pg.out2023, 0) AS out2023, COALESCE(pg.nov2023, 0) AS nov2023, COALESCE(pg.dez2023, 0) AS dez2023,\\r\\n        COALESCE(pg.jan2024, 0) AS jan2024, COALESCE(pg.fev2024, 0) AS fev2024, COALESCE(pg.mar2024, 0) AS mar2024,\\r\\n        COALESCE(pg.abr2024, 0) AS abr2024, COALESCE(pg.mai2024, 0) AS mai2024, COALESCE(pg.jun2024, 0) AS jun2024,\\r\\n        COALESCE(pg.jul2024, 0) AS jul2024, COALESCE(pg.ago2024, 0) AS ago2024, COALESCE(pg.set2024, 0) AS set2024,\\r\\n        COALESCE(pg.out2024, 0) AS out2024, COALESCE(pg.nov2024, 0) AS nov2024, COALESCE(pg.dez2024, 0) AS dez2024,\\r\\n        COALESCE(pg.jan2025, 0) AS jan2025, COALESCE(pg.fev2025, 0) AS fev2025, COALESCE(pg.mar2025, 0) AS mar2025,\\r\\n        COALESCE(pg.abr2025, 0) AS abr2025, COALESCE(pg.mai2025, 0) AS mai2025, COALESCE(pg.jun2025, 0) AS jun2025,\\r\\n        COALESCE(pg.jul2025, 0) AS jul2025, COALESCE(pg.ago2025, 0) AS ago2025, COALESCE(pg.set2025, 0) AS set2025\\r\\n    FROM gessimples.gei_cnpj gc\\r\\n    JOIN gessimples.gei_pgdas pg ON gc.cnpj = pg.cnpj\\r\\n    \\r\\n    UNION ALL\\r\\n    \\r\\n    -- Dados da DIME (Regime Normal)\\r\\n    SELECT\\r\\n        gc.num_grupo,\\r\\n        gc.cnpj,\\r\\n        COALESCE(dm.jan2021, 0) AS jan2021, COALESCE(dm.fev2021, 0) AS fev2021, COALESCE(dm.mar2021, 0) AS mar2021,\\r\\n        COALESCE(dm.abr2021, 0) AS abr2021, COALESCE(dm.mai2021, 0) AS mai2021, COALESCE(dm.jun2021, 0) AS jun2021,\\r\\n        COALESCE(dm.jul2021, 0) AS jul2021, COALESCE(dm.ago2021, 0) AS ago2021, COALESCE(dm.set2021, 0) AS set2021,\\r\\n        COALESCE(dm.out2021, 0) AS out2021, COALESCE(dm.nov2021, 0) AS nov2021, COALESCE(dm.dez2021, 0) AS dez2021,\\r\\n        COALESCE(dm.jan2022, 0) AS jan2022, COALESCE(dm.fev2022, 0) AS fev2022, COALESCE(dm.mar2022, 0) AS mar2022,\\r\\n        COALESCE(dm.abr2022, 0) AS abr2022, COALESCE(dm.mai2022, 0) AS mai2022, COALESCE(dm.jun2022, 0) AS jun2022,\\r\\n        COALESCE(dm.jul2022, 0) AS jul2022, COALESCE(dm.ago2022, 0) AS ago2022, COALESCE(dm.set2022, 0) AS set2022,\\r\\n        COALESCE(dm.out2022, 0) AS out2022, COALESCE(dm.nov2022, 0) AS nov2022, COALESCE(dm.dez2022, 0) AS dez2022,\\r\\n        COALESCE(dm.jan2023, 0) AS jan2023, COALESCE(dm.fev2023, 0) AS fev2023, COALESCE(dm.mar2023, 0) AS mar2023,\\r\\n        COALESCE(dm.abr2023, 0) AS abr2023, COALESCE(dm.mai2023, 0) AS mai2023, COALESCE(dm.jun2023, 0) AS jun2023,\\r\\n        COALESCE(dm.jul2023, 0) AS jul2023, COALESCE(dm.ago2023, 0) AS ago2023, COALESCE(dm.set2023, 0) AS set2023,\\r\\n        COALESCE(dm.out2023, 0) AS out2023, COALESCE(dm.nov2023, 0) AS nov2023, COALESCE(dm.dez2023, 0) AS dez2023,\\r\\n        COALESCE(dm.jan2024, 0) AS jan2024, COALESCE(dm.fev2024, 0) AS fev2024, COALESCE(dm.mar2024, 0) AS mar2024,\\r\\n        COALESCE(dm.abr2024, 0) AS abr2024, COALESCE(dm.mai2024, 0) AS mai2024, COALESCE(dm.jun2024, 0) AS jun2024,\\r\\n        COALESCE(dm.jul2024, 0) AS jul2024, COALESCE(dm.ago2024, 0) AS ago2024, COALESCE(dm.set2024, 0) AS set2024,\\r\\n        COALESCE(dm.out2024, 0) AS out2024, COALESCE(dm.nov2024, 0) AS nov2024, COALESCE(dm.dez2024, 0) AS dez2024,\\r\\n        COALESCE(dm.jan2025, 0) AS jan2025, COALESCE(dm.fev2025, 0) AS fev2025, COALESCE(dm.mar2025, 0) AS mar2025,\\r\\n        COALESCE(dm.abr2025, 0) AS abr2025, COALESCE(dm.mai2025, 0) AS mai2025, COALESCE(dm.jun2025, 0) AS jun2025,\\r\\n        COALESCE(dm.jul2025, 0) AS jul2025, COALESCE(dm.ago2025, 0) AS ago2025, COALESCE(dm.set2025, 0) AS set2025\\r\\n    FROM gessimples.gei_cnpj gc\\r\\n    JOIN gessimples.gei_dime dm ON gc.cnpj = dm.cnpj\\r\\n),\\r\\ngrupo AS (\\r\\n    -- Agora soma os valores consolidados (PGDAS + DIME) por grupo\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        SUM(jan2021) AS jan2021, SUM(fev2021) AS fev2021, SUM(mar2021) AS mar2021,\\r\\n        SUM(abr2021) AS abr2021, SUM(mai2021) AS mai2021, SUM(jun2021) AS jun2021,\\r\\n        SUM(jul2021) AS jul2021, SUM(ago2021) AS ago2021, SUM(set2021) AS set2021,\\r\\n        SUM(out2021) AS out2021, SUM(nov2021) AS nov2021, SUM(dez2021) AS dez2021,\\r\\n        SUM(jan2022) AS jan2022, SUM(fev2022) AS fev2022, SUM(mar2022) AS mar2022,\\r\\n        SUM(abr2022) AS abr2022, SUM(mai2022) AS mai2022, SUM(jun2022) AS jun2022,\\r\\n        SUM(jul2022) AS jul2022, SUM(ago2022) AS ago2022, SUM(set2022) AS set2022,\\r\\n        SUM(out2022) AS out2022, SUM(nov2022) AS nov2022, SUM(dez2022) AS dez2022,\\r\\n        SUM(jan2023) AS jan2023, SUM(fev2023) AS fev2023, SUM(mar2023) AS mar2023,\\r\\n        SUM(abr2023) AS abr2023, SUM(mai2023) AS mai2023, SUM(jun2023) AS jun2023,\\r\\n        SUM(jul2023) AS jul2023, SUM(ago2023) AS ago2023, SUM(set2023) AS set2023,\\r\\n        SUM(out2023) AS out2023, SUM(nov2023) AS nov2023, SUM(dez2023) AS dez2023,\\r\\n        SUM(jan2024) AS jan2024, SUM(fev2024) AS fev2024, SUM(mar2024) AS mar2024,\\r\\n        SUM(abr2024) AS abr2024, SUM(mai2024) AS mai2024, SUM(jun2024) AS jun2024,\\r\\n        SUM(jul2024) AS jul2024, SUM(ago2024) AS ago2024, SUM(set2024) AS set2024,\\r\\n        SUM(out2024) AS out2024, SUM(nov2024) AS nov2024, SUM(dez2024) AS dez2024,\\r\\n        SUM(jan2025) AS jan2025, SUM(fev2025) AS fev2025, SUM(mar2025) AS mar2025,\\r\\n        SUM(abr2025) AS abr2025, SUM(mai2025) AS mai2025, SUM(jun2025) AS jun2025,\\r\\n        SUM(jul2025) AS jul2025, SUM(ago2025) AS ago2025, SUM(set2025) AS set2025\\r\\n    FROM faturamento_consolidado\\r\\n    GROUP BY num_grupo\\r\\n),\\r\\nunpivoted AS (\\r\\n    -- CTE 'unpivoted' (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT num_grupo, 'jan2021' AS periodo, jan2021 AS valor, 1 AS ord FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2021', fev2021, 2 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2021', mar2021, 3 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2021', abr2021, 4 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2021', mai2021, 5 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2021', jun2021, 6 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2021', jul2021, 7 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2021', ago2021, 8 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2021', set2021, 9 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2021', out2021, 10 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2021', nov2021, 11 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2021', dez2021, 12 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2022', jan2022, 13 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2022', fev2022, 14 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2022', mar2022, 15 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2022', abr2022, 16 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2022', mai2022, 17 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2022', jun2022, 18 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2022', jul2022, 19 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2022', ago2022, 20 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2022', set2022, 21 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2022', out2022, 22 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2022', nov2022, 23 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2022', dez2022, 24 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2023', jan2023, 25 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2023', fev2023, 26 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2023', mar2023, 27 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2023', abr2023, 28 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2023', mai2023, 29 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2023', jun2023, 30 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2023', jul2023, 31 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2023', ago2023, 32 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2023', set2023, 33 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2023', out2023, 34 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2023', nov2023, 35 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2023', dez2023, 36 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2024', jan2024, 37 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2024', fev2024, 38 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2024', mar2024, 39 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2024', abr2024, 40 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2024', mai2024, 41 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2024', jun2024, 42 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2024', jul2024, 43 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2024', ago2024, 44 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2024', set2024, 45 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2024', out2024, 46 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2024', nov2024, 47 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2024', dez2024, 48 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2025', jan2025, 49 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2025', fev2025, 50 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2025', mar2025, 51 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2025', abr2025, 52 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2025', mai2025, 53 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2025', jun2025, 54 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2025', jul2025, 55 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2025', ago2025, 56 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2025', set2025, 57 FROM grupo\\r\\n),\\r\\nprimeiro_excesso AS (\\r\\n    -- CTE 'primeiro_excesso' (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT num_grupo, periodo FROM (\\r\\n        SELECT num_grupo, periodo, valor, ord, ROW_NUMBER() OVER (PARTITION BY num_grupo ORDER BY ord) AS rn\\r\\n        FROM unpivoted WHERE valor >= 4800000\\r\\n    ) t WHERE rn = 1\\r\\n),\\r\\nmaximos AS (\\r\\n    -- CTE 'maximos' (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT num_grupo, valor AS valor_max, periodo AS periodo_max FROM (\\r\\n        SELECT num_grupo, periodo, valor, ROW_NUMBER() OVER (PARTITION BY num_grupo ORDER BY valor DESC) AS rn\\r\\n        FROM unpivoted\\r\\n    ) t WHERE rn = 1\\r\\n),\\r\\nc115_ranking AS (\\r\\n    -- CTE C115 (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT * FROM gessimples.gei_c115_ranking_risco_grupo_economico\\r\\n),\\r\\nc115_metricas AS (\\r\\n    -- CTE C115 (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT * FROM gessimples.gei_c115_metricas_grupos\\r\\n)\\r\\n-- Consulta final unindo todas as fontes de dados\\r\\nSELECT \\r\\n    -- COLUNAS ORIGINAIS\\r\\n    i.num_grupo,\\r\\n    i.qntd_cnpj,\\r\\n    i.perc_cliente, i.perc_email, i.perc_tel_dest, i.perc_tel_emit,\\r\\n    i.perc_codigo_produto, i.perc_fornecedor, i.perc_end_emit, i.perc_end_dest,\\r\\n    i.perc_descricao_produto, i.perc_ip_transmissao,\\r\\n    i.total_incons AS total,\\r\\n    i.distinct_nfe,\\r\\n    i.total_itens,\\r\\n    i.nm_razao_social, i.nm_fantasia, i.cd_cnae, i.nm_contador, i.endereco,\\r\\n    i.qntd_s, i.qntd_normal, i.qntd_sn,\\r\\n    i.total_cadastro,\\r\\n    primeiro_excesso.periodo AS periodo,\\r\\n    maximos.valor_max,\\r\\n    maximos.periodo_max,\\r\\n    i.qtd_socios_compartilhados, i.max_empresas_por_socio, i.qtd_cnpjs_com_socios_compartilhados,\\r\\n    i.qtd_pares_cnpjs_relacionados, i.perc_cnpjs_com_socios, i.indice_interconexao,\\r\\n    \\r\\n    -- Campos do C115\\r\\n    rk.ranking_risco, rk.qtd_cnpjs_relacionados, rk.perc_cnpjs_relacionados,\\r\\n    rk.max_tipos_identificadores_comuns, rk.max_total_identificadores_comuns,\\r\\n    rk.pares_com_tres_tipos_comum, rk.pares_com_dois_ou_mais_tipos_comum,\\r\\n    rk.nivel_risco_grupo_economico,\\r\\n    mg.total_tomadores, mg.tomadores_com_compartilhamento, mg.tomadores_com_multiplos_compartilhamentos,\\r\\n    mg.total_compartilhamentos, mg.perc_tomadores_com_compartilhamento, mg.indice_risco_grupo_economico,\\r\\n    \\r\\n    -- Campos de Ind\\u00edcios\\r\\n    ind.qtd_total_indicios,\\r\\n    ind.qtd_tipos_indicios_distintos,\\r\\n    ind.qtd_cnpjs_com_indicios,\\r\\n    ind.perc_cnpjs_com_indicios,\\r\\n    ind.indice_risco_indicios,\\r\\n    \\r\\n    -- Campos de Pagamentos e Funcion\\u00e1rios\\r\\n    COALESCE(pag.valor_meios_pagamento_empresas, 0) AS valor_meios_pagamento_empresas,\\r\\n    COALESCE(pag.valor_meios_pagamento_socios, 0) AS valor_meios_pagamento_socios,\\r\\n    COALESCE(func.total_funcionarios, 0) AS total_funcionarios,\\r\\n    CASE\\r\\n        WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0\\r\\n        THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4)\\r\\n        ELSE 0\\r\\n    END AS indice_risco_pagamentos,\\r\\n    CASE\\r\\n        WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0\\r\\n        THEN (1 - (1 / (COALESCE(maximos.valor_max, 0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000)))\\r\\n        ELSE 0\\r\\n    END AS indice_risco_fat_func,\\r\\n\\r\\n    -- ============================================================================\\r\\n    -- >> CAMPOS CCS (NOVOS) \\r\\n    -- ============================================================================\\r\\n    COALESCE(ccs.total_contas_unicas, 0) AS ccs_total_contas_unicas,\\r\\n    COALESCE(ccs.qtd_contas_compartilhadas, 0) AS ccs_qtd_contas_compartilhadas,\\r\\n    COALESCE(ccs.perc_contas_compartilhadas, 0) AS ccs_perc_contas_compartilhadas,\\r\\n    COALESCE(ccs.max_cnpjs_por_conta, 0) AS ccs_max_cnpjs_por_conta,\\r\\n    COALESCE(ccs.qtd_sobreposicoes_responsaveis, 0) AS ccs_qtd_sobreposicoes_responsaveis,\\r\\n    COALESCE(ccs.media_dias_sobreposicao, 0) AS ccs_media_dias_sobreposicao,\\r\\n    COALESCE(ccs.qtd_datas_abertura_coordenada, 0) AS ccs_qtd_datas_abertura_coordenada,\\r\\n    COALESCE(ccs.qtd_datas_encerramento_coordenado, 0) AS ccs_qtd_datas_encerramento_coordenado,\\r\\n    COALESCE(ccs.indice_risco_ccs, 0) AS indice_risco_ccs,\\r\\n    COALESCE(ccs_rk.nivel_risco_ccs, 'INEXISTENTE') AS nivel_risco_ccs,\\r\\n    \\r\\n    -- Scores antigos (mantidos para refer\\u00eancia)\\r\\n    ROUND((COALESCE(i.total_incons, 0) * 0.4) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.4), 2) AS score_combinado,\\r\\n    CASE WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN ROUND((COALESCE(i.total_incons, 0) * 0.3) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.3) + (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.2), 2) ELSE ROUND((COALESCE(i.total_incons, 0) * 0.4) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.4), 2) END AS score_combinado_c115,\\r\\n\\r\\n    -- Score final original (com ind\\u00edcios) - mantido\\r\\n    CASE\\r\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.25) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.15) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.25) +\\r\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.15) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.20)\\r\\n            , 2) \\r\\n        ELSE\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.35) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.15) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.30) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.20)\\r\\n            , 2)\\r\\n    END AS score_final_completo,\\r\\n\\r\\n    -- Score com pagamentos e funcion\\u00e1rios - mantido\\r\\n    CASE\\r\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.20) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.10) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.20) +\\r\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.10) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.15) +\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) ELSE 0 END * 0.15) +\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) ELSE 0 END * 0.10)\\r\\n            , 2)\\r\\n        ELSE\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.25) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.10) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.25) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.15) +\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) ELSE 0 END * 0.15) +\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) ELSE 0 END * 0.10)\\r\\n            , 2)\\r\\n    END AS score_final_avancado,\\r\\n\\r\\n    -- ============================================================================\\r\\n    -- >> NOVO SCORE FINAL COM CCS (15% DE PESO) \\r\\n    -- ============================================================================\\r\\n    CASE\\r\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\r\\n            -- Vers\\u00e3o com TUDO (8 fatores: 7 anteriores + CCS)\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.17) +                              -- 17% (antes 20%)\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.08) +                            -- 8%  (antes 10%)\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.17) +                  -- 17% (antes 20%)\\r\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.08) +             -- 8%  (antes 10%)\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.13) +              -- 13% (antes 15%)\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 \\r\\n                  THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) \\r\\n                  ELSE 0 END * 0.12) +                                              -- 12% (antes 15%)\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 \\r\\n                  THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) \\r\\n                  ELSE 0 END * 0.10) +                                              -- 10% (mantido)\\r\\n                (COALESCE(ccs.indice_risco_ccs, 0) * 0.15)                          -- 15% (NOVO - CCS)\\r\\n            , 2)\\r\\n        ELSE\\r\\n            -- Vers\\u00e3o sem C115 mas com CCS (7 fatores)\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.22) +                              -- 22% (antes 25%)\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.08) +                            -- 8%  (antes 10%)\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.22) +                  -- 22% (antes 25%)\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.13) +              -- 13% (antes 15%)\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 \\r\\n                  THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) \\r\\n                  ELSE 0 END * 0.12) +                                              -- 12% (antes 15%)\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 \\r\\n                  THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) \\r\\n                  ELSE 0 END * 0.08) +                                              -- 8%  (antes 10%)\\r\\n                (COALESCE(ccs.indice_risco_ccs, 0) * 0.15)                          -- 15% (NOVO - CCS)\\r\\n            , 2)\\r\\n    END AS score_final_ccs\\r\\n\\r\\nFROM gessimples.gei_percent_intermediario i\\r\\nLEFT JOIN primeiro_excesso ON i.num_grupo = primeiro_excesso.num_grupo\\r\\nLEFT JOIN maximos ON i.num_grupo = maximos.num_grupo\\r\\nLEFT JOIN c115_ranking rk ON i.num_grupo = rk.num_grupo\\r\\nLEFT JOIN c115_metricas mg ON i.num_grupo = mg.num_grupo\\r\\nLEFT JOIN gessimples.gei_indicios_metricas_grupo ind ON i.num_grupo = ind.num_grupo\\r\\nLEFT JOIN gessimples.gei_pagamentos_metricas_grupo pag ON i.num_grupo = pag.num_grupo\\r\\nLEFT JOIN gessimples.gei_funcionarios_metricas_grupo func ON i.num_grupo = func.num_grupo\\r\\n-- ============================================================================\\r\\n-- >> NOVOS JOINS COM CCS \\r\\n-- ============================================================================\\r\\nLEFT JOIN gessimples.gei_ccs_metricas_grupo ccs ON i.num_grupo = ccs.num_grupo\\r\\nLEFT JOIN gessimples.gei_ccs_ranking_risco ccs_rk ON i.num_grupo = ccs_rk.num_grupo\\r\\n\\r\\nORDER BY \\r\\n    score_final_ccs DESC,\\r\\n    score_final_avancado DESC,\\r\\n    score_final_completo DESC\\r\\nLIMIT 10000;\", \"statementsList\": [\"-- Parte 2: Processamento dos dados do PGDAS + DIME e cria\\u00e7\\u00e3o da tabela final\\r\\nDROP TABLE IF EXISTS gessimples.gei_percent;\", \"\\r\\nSET REQUEST_POOL = 'default';\", \"\\r\\nSET MEM_LIMIT = 20G;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_percent AS\\r\\nWITH faturamento_consolidado AS (\\r\\n    -- ============================================================================\\r\\n    -- >> CONSOLIDA\\u00c7\\u00c3O PGDAS + DIME (NOVO)\\r\\n    -- ============================================================================\\r\\n    -- Dados do PGDAS (Simples Nacional)\\r\\n    SELECT\\r\\n        gc.num_grupo,\\r\\n        gc.cnpj,\\r\\n        COALESCE(pg.jan2021, 0) AS jan2021, COALESCE(pg.fev2021, 0) AS fev2021, COALESCE(pg.mar2021, 0) AS mar2021,\\r\\n        COALESCE(pg.abr2021, 0) AS abr2021, COALESCE(pg.mai2021, 0) AS mai2021, COALESCE(pg.jun2021, 0) AS jun2021,\\r\\n        COALESCE(pg.jul2021, 0) AS jul2021, COALESCE(pg.ago2021, 0) AS ago2021, COALESCE(pg.set2021, 0) AS set2021,\\r\\n        COALESCE(pg.out2021, 0) AS out2021, COALESCE(pg.nov2021, 0) AS nov2021, COALESCE(pg.dez2021, 0) AS dez2021,\\r\\n        COALESCE(pg.jan2022, 0) AS jan2022, COALESCE(pg.fev2022, 0) AS fev2022, COALESCE(pg.mar2022, 0) AS mar2022,\\r\\n        COALESCE(pg.abr2022, 0) AS abr2022, COALESCE(pg.mai2022, 0) AS mai2022, COALESCE(pg.jun2022, 0) AS jun2022,\\r\\n        COALESCE(pg.jul2022, 0) AS jul2022, COALESCE(pg.ago2022, 0) AS ago2022, COALESCE(pg.set2022, 0) AS set2022,\\r\\n        COALESCE(pg.out2022, 0) AS out2022, COALESCE(pg.nov2022, 0) AS nov2022, COALESCE(pg.dez2022, 0) AS dez2022,\\r\\n        COALESCE(pg.jan2023, 0) AS jan2023, COALESCE(pg.fev2023, 0) AS fev2023, COALESCE(pg.mar2023, 0) AS mar2023,\\r\\n        COALESCE(pg.abr2023, 0) AS abr2023, COALESCE(pg.mai2023, 0) AS mai2023, COALESCE(pg.jun2023, 0) AS jun2023,\\r\\n        COALESCE(pg.jul2023, 0) AS jul2023, COALESCE(pg.ago2023, 0) AS ago2023, COALESCE(pg.set2023, 0) AS set2023,\\r\\n        COALESCE(pg.out2023, 0) AS out2023, COALESCE(pg.nov2023, 0) AS nov2023, COALESCE(pg.dez2023, 0) AS dez2023,\\r\\n        COALESCE(pg.jan2024, 0) AS jan2024, COALESCE(pg.fev2024, 0) AS fev2024, COALESCE(pg.mar2024, 0) AS mar2024,\\r\\n        COALESCE(pg.abr2024, 0) AS abr2024, COALESCE(pg.mai2024, 0) AS mai2024, COALESCE(pg.jun2024, 0) AS jun2024,\\r\\n        COALESCE(pg.jul2024, 0) AS jul2024, COALESCE(pg.ago2024, 0) AS ago2024, COALESCE(pg.set2024, 0) AS set2024,\\r\\n        COALESCE(pg.out2024, 0) AS out2024, COALESCE(pg.nov2024, 0) AS nov2024, COALESCE(pg.dez2024, 0) AS dez2024,\\r\\n        COALESCE(pg.jan2025, 0) AS jan2025, COALESCE(pg.fev2025, 0) AS fev2025, COALESCE(pg.mar2025, 0) AS mar2025,\\r\\n        COALESCE(pg.abr2025, 0) AS abr2025, COALESCE(pg.mai2025, 0) AS mai2025, COALESCE(pg.jun2025, 0) AS jun2025,\\r\\n        COALESCE(pg.jul2025, 0) AS jul2025, COALESCE(pg.ago2025, 0) AS ago2025, COALESCE(pg.set2025, 0) AS set2025\\r\\n    FROM gessimples.gei_cnpj gc\\r\\n    JOIN gessimples.gei_pgdas pg ON gc.cnpj = pg.cnpj\\r\\n    \\r\\n    UNION ALL\\r\\n    \\r\\n    -- Dados da DIME (Regime Normal)\\r\\n    SELECT\\r\\n        gc.num_grupo,\\r\\n        gc.cnpj,\\r\\n        COALESCE(dm.jan2021, 0) AS jan2021, COALESCE(dm.fev2021, 0) AS fev2021, COALESCE(dm.mar2021, 0) AS mar2021,\\r\\n        COALESCE(dm.abr2021, 0) AS abr2021, COALESCE(dm.mai2021, 0) AS mai2021, COALESCE(dm.jun2021, 0) AS jun2021,\\r\\n        COALESCE(dm.jul2021, 0) AS jul2021, COALESCE(dm.ago2021, 0) AS ago2021, COALESCE(dm.set2021, 0) AS set2021,\\r\\n        COALESCE(dm.out2021, 0) AS out2021, COALESCE(dm.nov2021, 0) AS nov2021, COALESCE(dm.dez2021, 0) AS dez2021,\\r\\n        COALESCE(dm.jan2022, 0) AS jan2022, COALESCE(dm.fev2022, 0) AS fev2022, COALESCE(dm.mar2022, 0) AS mar2022,\\r\\n        COALESCE(dm.abr2022, 0) AS abr2022, COALESCE(dm.mai2022, 0) AS mai2022, COALESCE(dm.jun2022, 0) AS jun2022,\\r\\n        COALESCE(dm.jul2022, 0) AS jul2022, COALESCE(dm.ago2022, 0) AS ago2022, COALESCE(dm.set2022, 0) AS set2022,\\r\\n        COALESCE(dm.out2022, 0) AS out2022, COALESCE(dm.nov2022, 0) AS nov2022, COALESCE(dm.dez2022, 0) AS dez2022,\\r\\n        COALESCE(dm.jan2023, 0) AS jan2023, COALESCE(dm.fev2023, 0) AS fev2023, COALESCE(dm.mar2023, 0) AS mar2023,\\r\\n        COALESCE(dm.abr2023, 0) AS abr2023, COALESCE(dm.mai2023, 0) AS mai2023, COALESCE(dm.jun2023, 0) AS jun2023,\\r\\n        COALESCE(dm.jul2023, 0) AS jul2023, COALESCE(dm.ago2023, 0) AS ago2023, COALESCE(dm.set2023, 0) AS set2023,\\r\\n        COALESCE(dm.out2023, 0) AS out2023, COALESCE(dm.nov2023, 0) AS nov2023, COALESCE(dm.dez2023, 0) AS dez2023,\\r\\n        COALESCE(dm.jan2024, 0) AS jan2024, COALESCE(dm.fev2024, 0) AS fev2024, COALESCE(dm.mar2024, 0) AS mar2024,\\r\\n        COALESCE(dm.abr2024, 0) AS abr2024, COALESCE(dm.mai2024, 0) AS mai2024, COALESCE(dm.jun2024, 0) AS jun2024,\\r\\n        COALESCE(dm.jul2024, 0) AS jul2024, COALESCE(dm.ago2024, 0) AS ago2024, COALESCE(dm.set2024, 0) AS set2024,\\r\\n        COALESCE(dm.out2024, 0) AS out2024, COALESCE(dm.nov2024, 0) AS nov2024, COALESCE(dm.dez2024, 0) AS dez2024,\\r\\n        COALESCE(dm.jan2025, 0) AS jan2025, COALESCE(dm.fev2025, 0) AS fev2025, COALESCE(dm.mar2025, 0) AS mar2025,\\r\\n        COALESCE(dm.abr2025, 0) AS abr2025, COALESCE(dm.mai2025, 0) AS mai2025, COALESCE(dm.jun2025, 0) AS jun2025,\\r\\n        COALESCE(dm.jul2025, 0) AS jul2025, COALESCE(dm.ago2025, 0) AS ago2025, COALESCE(dm.set2025, 0) AS set2025\\r\\n    FROM gessimples.gei_cnpj gc\\r\\n    JOIN gessimples.gei_dime dm ON gc.cnpj = dm.cnpj\\r\\n),\\r\\ngrupo AS (\\r\\n    -- Agora soma os valores consolidados (PGDAS + DIME) por grupo\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        SUM(jan2021) AS jan2021, SUM(fev2021) AS fev2021, SUM(mar2021) AS mar2021,\\r\\n        SUM(abr2021) AS abr2021, SUM(mai2021) AS mai2021, SUM(jun2021) AS jun2021,\\r\\n        SUM(jul2021) AS jul2021, SUM(ago2021) AS ago2021, SUM(set2021) AS set2021,\\r\\n        SUM(out2021) AS out2021, SUM(nov2021) AS nov2021, SUM(dez2021) AS dez2021,\\r\\n        SUM(jan2022) AS jan2022, SUM(fev2022) AS fev2022, SUM(mar2022) AS mar2022,\\r\\n        SUM(abr2022) AS abr2022, SUM(mai2022) AS mai2022, SUM(jun2022) AS jun2022,\\r\\n        SUM(jul2022) AS jul2022, SUM(ago2022) AS ago2022, SUM(set2022) AS set2022,\\r\\n        SUM(out2022) AS out2022, SUM(nov2022) AS nov2022, SUM(dez2022) AS dez2022,\\r\\n        SUM(jan2023) AS jan2023, SUM(fev2023) AS fev2023, SUM(mar2023) AS mar2023,\\r\\n        SUM(abr2023) AS abr2023, SUM(mai2023) AS mai2023, SUM(jun2023) AS jun2023,\\r\\n        SUM(jul2023) AS jul2023, SUM(ago2023) AS ago2023, SUM(set2023) AS set2023,\\r\\n        SUM(out2023) AS out2023, SUM(nov2023) AS nov2023, SUM(dez2023) AS dez2023,\\r\\n        SUM(jan2024) AS jan2024, SUM(fev2024) AS fev2024, SUM(mar2024) AS mar2024,\\r\\n        SUM(abr2024) AS abr2024, SUM(mai2024) AS mai2024, SUM(jun2024) AS jun2024,\\r\\n        SUM(jul2024) AS jul2024, SUM(ago2024) AS ago2024, SUM(set2024) AS set2024,\\r\\n        SUM(out2024) AS out2024, SUM(nov2024) AS nov2024, SUM(dez2024) AS dez2024,\\r\\n        SUM(jan2025) AS jan2025, SUM(fev2025) AS fev2025, SUM(mar2025) AS mar2025,\\r\\n        SUM(abr2025) AS abr2025, SUM(mai2025) AS mai2025, SUM(jun2025) AS jun2025,\\r\\n        SUM(jul2025) AS jul2025, SUM(ago2025) AS ago2025, SUM(set2025) AS set2025\\r\\n    FROM faturamento_consolidado\\r\\n    GROUP BY num_grupo\\r\\n),\\r\\nunpivoted AS (\\r\\n    -- CTE 'unpivoted' (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT num_grupo, 'jan2021' AS periodo, jan2021 AS valor, 1 AS ord FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2021', fev2021, 2 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2021', mar2021, 3 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2021', abr2021, 4 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2021', mai2021, 5 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2021', jun2021, 6 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2021', jul2021, 7 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2021', ago2021, 8 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2021', set2021, 9 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2021', out2021, 10 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2021', nov2021, 11 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2021', dez2021, 12 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2022', jan2022, 13 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2022', fev2022, 14 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2022', mar2022, 15 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2022', abr2022, 16 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2022', mai2022, 17 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2022', jun2022, 18 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2022', jul2022, 19 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2022', ago2022, 20 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2022', set2022, 21 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2022', out2022, 22 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2022', nov2022, 23 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2022', dez2022, 24 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2023', jan2023, 25 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2023', fev2023, 26 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2023', mar2023, 27 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2023', abr2023, 28 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2023', mai2023, 29 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2023', jun2023, 30 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2023', jul2023, 31 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2023', ago2023, 32 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2023', set2023, 33 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2023', out2023, 34 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2023', nov2023, 35 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2023', dez2023, 36 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2024', jan2024, 37 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2024', fev2024, 38 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2024', mar2024, 39 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2024', abr2024, 40 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2024', mai2024, 41 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2024', jun2024, 42 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2024', jul2024, 43 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2024', ago2024, 44 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2024', set2024, 45 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2024', out2024, 46 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2024', nov2024, 47 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2024', dez2024, 48 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2025', jan2025, 49 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2025', fev2025, 50 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2025', mar2025, 51 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2025', abr2025, 52 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2025', mai2025, 53 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2025', jun2025, 54 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2025', jul2025, 55 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2025', ago2025, 56 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2025', set2025, 57 FROM grupo\\r\\n),\\r\\nprimeiro_excesso AS (\\r\\n    -- CTE 'primeiro_excesso' (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT num_grupo, periodo FROM (\\r\\n        SELECT num_grupo, periodo, valor, ord, ROW_NUMBER() OVER (PARTITION BY num_grupo ORDER BY ord) AS rn\\r\\n        FROM unpivoted WHERE valor >= 4800000\\r\\n    ) t WHERE rn = 1\\r\\n),\\r\\nmaximos AS (\\r\\n    -- CTE 'maximos' (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT num_grupo, valor AS valor_max, periodo AS periodo_max FROM (\\r\\n        SELECT num_grupo, periodo, valor, ROW_NUMBER() OVER (PARTITION BY num_grupo ORDER BY valor DESC) AS rn\\r\\n        FROM unpivoted\\r\\n    ) t WHERE rn = 1\\r\\n),\\r\\nc115_ranking AS (\\r\\n    -- CTE C115 (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT * FROM gessimples.gei_c115_ranking_risco_grupo_economico\\r\\n),\\r\\nc115_metricas AS (\\r\\n    -- CTE C115 (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT * FROM gessimples.gei_c115_metricas_grupos\\r\\n)\\r\\n-- Consulta final unindo todas as fontes de dados\\r\\nSELECT \\r\\n    -- COLUNAS ORIGINAIS\\r\\n    i.num_grupo,\\r\\n    i.qntd_cnpj,\\r\\n    i.perc_cliente, i.perc_email, i.perc_tel_dest, i.perc_tel_emit,\\r\\n    i.perc_codigo_produto, i.perc_fornecedor, i.perc_end_emit, i.perc_end_dest,\\r\\n    i.perc_descricao_produto, i.perc_ip_transmissao,\\r\\n    i.total_incons AS total,\\r\\n    i.distinct_nfe,\\r\\n    i.total_itens,\\r\\n    i.nm_razao_social, i.nm_fantasia, i.cd_cnae, i.nm_contador, i.endereco,\\r\\n    i.qntd_s, i.qntd_normal, i.qntd_sn,\\r\\n    i.total_cadastro,\\r\\n    primeiro_excesso.periodo AS periodo,\\r\\n    maximos.valor_max,\\r\\n    maximos.periodo_max,\\r\\n    i.qtd_socios_compartilhados, i.max_empresas_por_socio, i.qtd_cnpjs_com_socios_compartilhados,\\r\\n    i.qtd_pares_cnpjs_relacionados, i.perc_cnpjs_com_socios, i.indice_interconexao,\\r\\n    \\r\\n    -- Campos do C115\\r\\n    rk.ranking_risco, rk.qtd_cnpjs_relacionados, rk.perc_cnpjs_relacionados,\\r\\n    rk.max_tipos_identificadores_comuns, rk.max_total_identificadores_comuns,\\r\\n    rk.pares_com_tres_tipos_comum, rk.pares_com_dois_ou_mais_tipos_comum,\\r\\n    rk.nivel_risco_grupo_economico,\\r\\n    mg.total_tomadores, mg.tomadores_com_compartilhamento, mg.tomadores_com_multiplos_compartilhamentos,\\r\\n    mg.total_compartilhamentos, mg.perc_tomadores_com_compartilhamento, mg.indice_risco_grupo_economico,\\r\\n    \\r\\n    -- Campos de Ind\\u00edcios\\r\\n    ind.qtd_total_indicios,\\r\\n    ind.qtd_tipos_indicios_distintos,\\r\\n    ind.qtd_cnpjs_com_indicios,\\r\\n    ind.perc_cnpjs_com_indicios,\\r\\n    ind.indice_risco_indicios,\\r\\n    \\r\\n    -- Campos de Pagamentos e Funcion\\u00e1rios\\r\\n    COALESCE(pag.valor_meios_pagamento_empresas, 0) AS valor_meios_pagamento_empresas,\\r\\n    COALESCE(pag.valor_meios_pagamento_socios, 0) AS valor_meios_pagamento_socios,\\r\\n    COALESCE(func.total_funcionarios, 0) AS total_funcionarios,\\r\\n    CASE\\r\\n        WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0\\r\\n        THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4)\\r\\n        ELSE 0\\r\\n    END AS indice_risco_pagamentos,\\r\\n    CASE\\r\\n        WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0\\r\\n        THEN (1 - (1 / (COALESCE(maximos.valor_max, 0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000)))\\r\\n        ELSE 0\\r\\n    END AS indice_risco_fat_func,\\r\\n\\r\\n    -- ============================================================================\\r\\n    -- >> CAMPOS CCS (NOVOS) \\r\\n    -- ============================================================================\\r\\n    COALESCE(ccs.total_contas_unicas, 0) AS ccs_total_contas_unicas,\\r\\n    COALESCE(ccs.qtd_contas_compartilhadas, 0) AS ccs_qtd_contas_compartilhadas,\\r\\n    COALESCE(ccs.perc_contas_compartilhadas, 0) AS ccs_perc_contas_compartilhadas,\\r\\n    COALESCE(ccs.max_cnpjs_por_conta, 0) AS ccs_max_cnpjs_por_conta,\\r\\n    COALESCE(ccs.qtd_sobreposicoes_responsaveis, 0) AS ccs_qtd_sobreposicoes_responsaveis,\\r\\n    COALESCE(ccs.media_dias_sobreposicao, 0) AS ccs_media_dias_sobreposicao,\\r\\n    COALESCE(ccs.qtd_datas_abertura_coordenada, 0) AS ccs_qtd_datas_abertura_coordenada,\\r\\n    COALESCE(ccs.qtd_datas_encerramento_coordenado, 0) AS ccs_qtd_datas_encerramento_coordenado,\\r\\n    COALESCE(ccs.indice_risco_ccs, 0) AS indice_risco_ccs,\\r\\n    COALESCE(ccs_rk.nivel_risco_ccs, 'INEXISTENTE') AS nivel_risco_ccs,\\r\\n    \\r\\n    -- Scores antigos (mantidos para refer\\u00eancia)\\r\\n    ROUND((COALESCE(i.total_incons, 0) * 0.4) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.4), 2) AS score_combinado,\\r\\n    CASE WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN ROUND((COALESCE(i.total_incons, 0) * 0.3) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.3) + (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.2), 2) ELSE ROUND((COALESCE(i.total_incons, 0) * 0.4) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.4), 2) END AS score_combinado_c115,\\r\\n\\r\\n    -- Score final original (com ind\\u00edcios) - mantido\\r\\n    CASE\\r\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.25) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.15) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.25) +\\r\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.15) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.20)\\r\\n            , 2) \\r\\n        ELSE\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.35) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.15) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.30) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.20)\\r\\n            , 2)\\r\\n    END AS score_final_completo,\\r\\n\\r\\n    -- Score com pagamentos e funcion\\u00e1rios - mantido\\r\\n    CASE\\r\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.20) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.10) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.20) +\\r\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.10) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.15) +\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) ELSE 0 END * 0.15) +\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) ELSE 0 END * 0.10)\\r\\n            , 2)\\r\\n        ELSE\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.25) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.10) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.25) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.15) +\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) ELSE 0 END * 0.15) +\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) ELSE 0 END * 0.10)\\r\\n            , 2)\\r\\n    END AS score_final_avancado,\\r\\n\\r\\n    -- ============================================================================\\r\\n    -- >> NOVO SCORE FINAL COM CCS (15% DE PESO) \\r\\n    -- ============================================================================\\r\\n    CASE\\r\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\r\\n            -- Vers\\u00e3o com TUDO (8 fatores: 7 anteriores + CCS)\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.17) +                              -- 17% (antes 20%)\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.08) +                            -- 8%  (antes 10%)\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.17) +                  -- 17% (antes 20%)\\r\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.08) +             -- 8%  (antes 10%)\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.13) +              -- 13% (antes 15%)\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 \\r\\n                  THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) \\r\\n                  ELSE 0 END * 0.12) +                                              -- 12% (antes 15%)\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 \\r\\n                  THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) \\r\\n                  ELSE 0 END * 0.10) +                                              -- 10% (mantido)\\r\\n                (COALESCE(ccs.indice_risco_ccs, 0) * 0.15)                          -- 15% (NOVO - CCS)\\r\\n            , 2)\\r\\n        ELSE\\r\\n            -- Vers\\u00e3o sem C115 mas com CCS (7 fatores)\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.22) +                              -- 22% (antes 25%)\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.08) +                            -- 8%  (antes 10%)\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.22) +                  -- 22% (antes 25%)\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.13) +              -- 13% (antes 15%)\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 \\r\\n                  THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) \\r\\n                  ELSE 0 END * 0.12) +                                              -- 12% (antes 15%)\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 \\r\\n                  THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) \\r\\n                  ELSE 0 END * 0.08) +                                              -- 8%  (antes 10%)\\r\\n                (COALESCE(ccs.indice_risco_ccs, 0) * 0.15)                          -- 15% (NOVO - CCS)\\r\\n            , 2)\\r\\n    END AS score_final_ccs\\r\\n\\r\\nFROM gessimples.gei_percent_intermediario i\\r\\nLEFT JOIN primeiro_excesso ON i.num_grupo = primeiro_excesso.num_grupo\\r\\nLEFT JOIN maximos ON i.num_grupo = maximos.num_grupo\\r\\nLEFT JOIN c115_ranking rk ON i.num_grupo = rk.num_grupo\\r\\nLEFT JOIN c115_metricas mg ON i.num_grupo = mg.num_grupo\\r\\nLEFT JOIN gessimples.gei_indicios_metricas_grupo ind ON i.num_grupo = ind.num_grupo\\r\\nLEFT JOIN gessimples.gei_pagamentos_metricas_grupo pag ON i.num_grupo = pag.num_grupo\\r\\nLEFT JOIN gessimples.gei_funcionarios_metricas_grupo func ON i.num_grupo = func.num_grupo\\r\\n-- ============================================================================\\r\\n-- >> NOVOS JOINS COM CCS \\r\\n-- ============================================================================\\r\\nLEFT JOIN gessimples.gei_ccs_metricas_grupo ccs ON i.num_grupo = ccs.num_grupo\\r\\nLEFT JOIN gessimples.gei_ccs_ranking_risco ccs_rk ON i.num_grupo = ccs_rk.num_grupo\\r\\n\\r\\nORDER BY \\r\\n    score_final_ccs DESC,\\r\\n    score_final_avancado DESC,\\r\\n    score_final_completo DESC\\r\\nLIMIT 10000;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Example: SELECT * FROM tablename, or press CTRL + space\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- Parte 2: Processamento dos dados do PGDAS + DIME e cria\\u00e7\\u00e3o da tabela final\\r\\nDROP TABLE IF EXISTS gessimples.gei_percent;\\r\\nSET REQUEST_POOL = 'default';\\r\\nSET MEM_LIMIT = 20G;\\r\\n\\r\\nCREATE TABLE gessimples.gei_percent AS\\r\\nWITH faturamento_consolidado AS (\\r\\n    -- ============================================================================\\r\\n    -- >> CONSOLIDA\\u00c7\\u00c3O PGDAS + DIME (NOVO)\\r\\n    -- ============================================================================\\r\\n    -- Dados do PGDAS (Simples Nacional)\\r\\n    SELECT\\r\\n        gc.num_grupo,\\r\\n        gc.cnpj,\\r\\n        COALESCE(pg.jan2021, 0) AS jan2021, COALESCE(pg.fev2021, 0) AS fev2021, COALESCE(pg.mar2021, 0) AS mar2021,\\r\\n        COALESCE(pg.abr2021, 0) AS abr2021, COALESCE(pg.mai2021, 0) AS mai2021, COALESCE(pg.jun2021, 0) AS jun2021,\\r\\n        COALESCE(pg.jul2021, 0) AS jul2021, COALESCE(pg.ago2021, 0) AS ago2021, COALESCE(pg.set2021, 0) AS set2021,\\r\\n        COALESCE(pg.out2021, 0) AS out2021, COALESCE(pg.nov2021, 0) AS nov2021, COALESCE(pg.dez2021, 0) AS dez2021,\\r\\n        COALESCE(pg.jan2022, 0) AS jan2022, COALESCE(pg.fev2022, 0) AS fev2022, COALESCE(pg.mar2022, 0) AS mar2022,\\r\\n        COALESCE(pg.abr2022, 0) AS abr2022, COALESCE(pg.mai2022, 0) AS mai2022, COALESCE(pg.jun2022, 0) AS jun2022,\\r\\n        COALESCE(pg.jul2022, 0) AS jul2022, COALESCE(pg.ago2022, 0) AS ago2022, COALESCE(pg.set2022, 0) AS set2022,\\r\\n        COALESCE(pg.out2022, 0) AS out2022, COALESCE(pg.nov2022, 0) AS nov2022, COALESCE(pg.dez2022, 0) AS dez2022,\\r\\n        COALESCE(pg.jan2023, 0) AS jan2023, COALESCE(pg.fev2023, 0) AS fev2023, COALESCE(pg.mar2023, 0) AS mar2023,\\r\\n        COALESCE(pg.abr2023, 0) AS abr2023, COALESCE(pg.mai2023, 0) AS mai2023, COALESCE(pg.jun2023, 0) AS jun2023,\\r\\n        COALESCE(pg.jul2023, 0) AS jul2023, COALESCE(pg.ago2023, 0) AS ago2023, COALESCE(pg.set2023, 0) AS set2023,\\r\\n        COALESCE(pg.out2023, 0) AS out2023, COALESCE(pg.nov2023, 0) AS nov2023, COALESCE(pg.dez2023, 0) AS dez2023,\\r\\n        COALESCE(pg.jan2024, 0) AS jan2024, COALESCE(pg.fev2024, 0) AS fev2024, COALESCE(pg.mar2024, 0) AS mar2024,\\r\\n        COALESCE(pg.abr2024, 0) AS abr2024, COALESCE(pg.mai2024, 0) AS mai2024, COALESCE(pg.jun2024, 0) AS jun2024,\\r\\n        COALESCE(pg.jul2024, 0) AS jul2024, COALESCE(pg.ago2024, 0) AS ago2024, COALESCE(pg.set2024, 0) AS set2024,\\r\\n        COALESCE(pg.out2024, 0) AS out2024, COALESCE(pg.nov2024, 0) AS nov2024, COALESCE(pg.dez2024, 0) AS dez2024,\\r\\n        COALESCE(pg.jan2025, 0) AS jan2025, COALESCE(pg.fev2025, 0) AS fev2025, COALESCE(pg.mar2025, 0) AS mar2025,\\r\\n        COALESCE(pg.abr2025, 0) AS abr2025, COALESCE(pg.mai2025, 0) AS mai2025, COALESCE(pg.jun2025, 0) AS jun2025,\\r\\n        COALESCE(pg.jul2025, 0) AS jul2025, COALESCE(pg.ago2025, 0) AS ago2025, COALESCE(pg.set2025, 0) AS set2025\\r\\n    FROM gessimples.gei_cnpj gc\\r\\n    JOIN gessimples.gei_pgdas pg ON gc.cnpj = pg.cnpj\\r\\n    \\r\\n    UNION ALL\\r\\n    \\r\\n    -- Dados da DIME (Regime Normal)\\r\\n    SELECT\\r\\n        gc.num_grupo,\\r\\n        gc.cnpj,\\r\\n        COALESCE(dm.jan2021, 0) AS jan2021, COALESCE(dm.fev2021, 0) AS fev2021, COALESCE(dm.mar2021, 0) AS mar2021,\\r\\n        COALESCE(dm.abr2021, 0) AS abr2021, COALESCE(dm.mai2021, 0) AS mai2021, COALESCE(dm.jun2021, 0) AS jun2021,\\r\\n        COALESCE(dm.jul2021, 0) AS jul2021, COALESCE(dm.ago2021, 0) AS ago2021, COALESCE(dm.set2021, 0) AS set2021,\\r\\n        COALESCE(dm.out2021, 0) AS out2021, COALESCE(dm.nov2021, 0) AS nov2021, COALESCE(dm.dez2021, 0) AS dez2021,\\r\\n        COALESCE(dm.jan2022, 0) AS jan2022, COALESCE(dm.fev2022, 0) AS fev2022, COALESCE(dm.mar2022, 0) AS mar2022,\\r\\n        COALESCE(dm.abr2022, 0) AS abr2022, COALESCE(dm.mai2022, 0) AS mai2022, COALESCE(dm.jun2022, 0) AS jun2022,\\r\\n        COALESCE(dm.jul2022, 0) AS jul2022, COALESCE(dm.ago2022, 0) AS ago2022, COALESCE(dm.set2022, 0) AS set2022,\\r\\n        COALESCE(dm.out2022, 0) AS out2022, COALESCE(dm.nov2022, 0) AS nov2022, COALESCE(dm.dez2022, 0) AS dez2022,\\r\\n        COALESCE(dm.jan2023, 0) AS jan2023, COALESCE(dm.fev2023, 0) AS fev2023, COALESCE(dm.mar2023, 0) AS mar2023,\\r\\n        COALESCE(dm.abr2023, 0) AS abr2023, COALESCE(dm.mai2023, 0) AS mai2023, COALESCE(dm.jun2023, 0) AS jun2023,\\r\\n        COALESCE(dm.jul2023, 0) AS jul2023, COALESCE(dm.ago2023, 0) AS ago2023, COALESCE(dm.set2023, 0) AS set2023,\\r\\n        COALESCE(dm.out2023, 0) AS out2023, COALESCE(dm.nov2023, 0) AS nov2023, COALESCE(dm.dez2023, 0) AS dez2023,\\r\\n        COALESCE(dm.jan2024, 0) AS jan2024, COALESCE(dm.fev2024, 0) AS fev2024, COALESCE(dm.mar2024, 0) AS mar2024,\\r\\n        COALESCE(dm.abr2024, 0) AS abr2024, COALESCE(dm.mai2024, 0) AS mai2024, COALESCE(dm.jun2024, 0) AS jun2024,\\r\\n        COALESCE(dm.jul2024, 0) AS jul2024, COALESCE(dm.ago2024, 0) AS ago2024, COALESCE(dm.set2024, 0) AS set2024,\\r\\n        COALESCE(dm.out2024, 0) AS out2024, COALESCE(dm.nov2024, 0) AS nov2024, COALESCE(dm.dez2024, 0) AS dez2024,\\r\\n        COALESCE(dm.jan2025, 0) AS jan2025, COALESCE(dm.fev2025, 0) AS fev2025, COALESCE(dm.mar2025, 0) AS mar2025,\\r\\n        COALESCE(dm.abr2025, 0) AS abr2025, COALESCE(dm.mai2025, 0) AS mai2025, COALESCE(dm.jun2025, 0) AS jun2025,\\r\\n        COALESCE(dm.jul2025, 0) AS jul2025, COALESCE(dm.ago2025, 0) AS ago2025, COALESCE(dm.set2025, 0) AS set2025\\r\\n    FROM gessimples.gei_cnpj gc\\r\\n    JOIN gessimples.gei_dime dm ON gc.cnpj = dm.cnpj\\r\\n),\\r\\ngrupo AS (\\r\\n    -- Agora soma os valores consolidados (PGDAS + DIME) por grupo\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        SUM(jan2021) AS jan2021, SUM(fev2021) AS fev2021, SUM(mar2021) AS mar2021,\\r\\n        SUM(abr2021) AS abr2021, SUM(mai2021) AS mai2021, SUM(jun2021) AS jun2021,\\r\\n        SUM(jul2021) AS jul2021, SUM(ago2021) AS ago2021, SUM(set2021) AS set2021,\\r\\n        SUM(out2021) AS out2021, SUM(nov2021) AS nov2021, SUM(dez2021) AS dez2021,\\r\\n        SUM(jan2022) AS jan2022, SUM(fev2022) AS fev2022, SUM(mar2022) AS mar2022,\\r\\n        SUM(abr2022) AS abr2022, SUM(mai2022) AS mai2022, SUM(jun2022) AS jun2022,\\r\\n        SUM(jul2022) AS jul2022, SUM(ago2022) AS ago2022, SUM(set2022) AS set2022,\\r\\n        SUM(out2022) AS out2022, SUM(nov2022) AS nov2022, SUM(dez2022) AS dez2022,\\r\\n        SUM(jan2023) AS jan2023, SUM(fev2023) AS fev2023, SUM(mar2023) AS mar2023,\\r\\n        SUM(abr2023) AS abr2023, SUM(mai2023) AS mai2023, SUM(jun2023) AS jun2023,\\r\\n        SUM(jul2023) AS jul2023, SUM(ago2023) AS ago2023, SUM(set2023) AS set2023,\\r\\n        SUM(out2023) AS out2023, SUM(nov2023) AS nov2023, SUM(dez2023) AS dez2023,\\r\\n        SUM(jan2024) AS jan2024, SUM(fev2024) AS fev2024, SUM(mar2024) AS mar2024,\\r\\n        SUM(abr2024) AS abr2024, SUM(mai2024) AS mai2024, SUM(jun2024) AS jun2024,\\r\\n        SUM(jul2024) AS jul2024, SUM(ago2024) AS ago2024, SUM(set2024) AS set2024,\\r\\n        SUM(out2024) AS out2024, SUM(nov2024) AS nov2024, SUM(dez2024) AS dez2024,\\r\\n        SUM(jan2025) AS jan2025, SUM(fev2025) AS fev2025, SUM(mar2025) AS mar2025,\\r\\n        SUM(abr2025) AS abr2025, SUM(mai2025) AS mai2025, SUM(jun2025) AS jun2025,\\r\\n        SUM(jul2025) AS jul2025, SUM(ago2025) AS ago2025, SUM(set2025) AS set2025\\r\\n    FROM faturamento_consolidado\\r\\n    GROUP BY num_grupo\\r\\n),\\r\\nunpivoted AS (\\r\\n    -- CTE 'unpivoted' (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT num_grupo, 'jan2021' AS periodo, jan2021 AS valor, 1 AS ord FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2021', fev2021, 2 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2021', mar2021, 3 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2021', abr2021, 4 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2021', mai2021, 5 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2021', jun2021, 6 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2021', jul2021, 7 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2021', ago2021, 8 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2021', set2021, 9 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2021', out2021, 10 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2021', nov2021, 11 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2021', dez2021, 12 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2022', jan2022, 13 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2022', fev2022, 14 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2022', mar2022, 15 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2022', abr2022, 16 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2022', mai2022, 17 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2022', jun2022, 18 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2022', jul2022, 19 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2022', ago2022, 20 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2022', set2022, 21 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2022', out2022, 22 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2022', nov2022, 23 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2022', dez2022, 24 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2023', jan2023, 25 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2023', fev2023, 26 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2023', mar2023, 27 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2023', abr2023, 28 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2023', mai2023, 29 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2023', jun2023, 30 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2023', jul2023, 31 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2023', ago2023, 32 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2023', set2023, 33 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2023', out2023, 34 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2023', nov2023, 35 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2023', dez2023, 36 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2024', jan2024, 37 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2024', fev2024, 38 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2024', mar2024, 39 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2024', abr2024, 40 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2024', mai2024, 41 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2024', jun2024, 42 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2024', jul2024, 43 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2024', ago2024, 44 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2024', set2024, 45 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2024', out2024, 46 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2024', nov2024, 47 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2024', dez2024, 48 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2025', jan2025, 49 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2025', fev2025, 50 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2025', mar2025, 51 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2025', abr2025, 52 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2025', mai2025, 53 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2025', jun2025, 54 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2025', jul2025, 55 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2025', ago2025, 56 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2025', set2025, 57 FROM grupo\\r\\n),\\r\\nprimeiro_excesso AS (\\r\\n    -- CTE 'primeiro_excesso' (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT num_grupo, periodo FROM (\\r\\n        SELECT num_grupo, periodo, valor, ord, ROW_NUMBER() OVER (PARTITION BY num_grupo ORDER BY ord) AS rn\\r\\n        FROM unpivoted WHERE valor >= 4800000\\r\\n    ) t WHERE rn = 1\\r\\n),\\r\\nmaximos AS (\\r\\n    -- CTE 'maximos' (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT num_grupo, valor AS valor_max, periodo AS periodo_max FROM (\\r\\n        SELECT num_grupo, periodo, valor, ROW_NUMBER() OVER (PARTITION BY num_grupo ORDER BY valor DESC) AS rn\\r\\n        FROM unpivoted\\r\\n    ) t WHERE rn = 1\\r\\n),\\r\\nc115_ranking AS (\\r\\n    -- CTE C115 (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT * FROM gessimples.gei_c115_ranking_risco_grupo_economico\\r\\n),\\r\\nc115_metricas AS (\\r\\n    -- CTE C115 (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT * FROM gessimples.gei_c115_metricas_grupos\\r\\n)\\r\\n-- Consulta final unindo todas as fontes de dados\\r\\nSELECT \\r\\n    -- COLUNAS ORIGINAIS\\r\\n    i.num_grupo,\\r\\n    i.qntd_cnpj,\\r\\n    i.perc_cliente, i.perc_email, i.perc_tel_dest, i.perc_tel_emit,\\r\\n    i.perc_codigo_produto, i.perc_fornecedor, i.perc_end_emit, i.perc_end_dest,\\r\\n    i.perc_descricao_produto, i.perc_ip_transmissao,\\r\\n    i.total_incons AS total,\\r\\n    i.distinct_nfe,\\r\\n    i.total_itens,\\r\\n    i.nm_razao_social, i.nm_fantasia, i.cd_cnae, i.nm_contador, i.endereco,\\r\\n    i.qntd_s, i.qntd_normal, i.qntd_sn,\\r\\n    i.total_cadastro,\\r\\n    primeiro_excesso.periodo AS periodo,\\r\\n    maximos.valor_max,\\r\\n    maximos.periodo_max,\\r\\n    i.qtd_socios_compartilhados, i.max_empresas_por_socio, i.qtd_cnpjs_com_socios_compartilhados,\\r\\n    i.qtd_pares_cnpjs_relacionados, i.perc_cnpjs_com_socios, i.indice_interconexao,\\r\\n    \\r\\n    -- Campos do C115\\r\\n    rk.ranking_risco, rk.qtd_cnpjs_relacionados, rk.perc_cnpjs_relacionados,\\r\\n    rk.max_tipos_identificadores_comuns, rk.max_total_identificadores_comuns,\\r\\n    rk.pares_com_tres_tipos_comum, rk.pares_com_dois_ou_mais_tipos_comum,\\r\\n    rk.nivel_risco_grupo_economico,\\r\\n    mg.total_tomadores, mg.tomadores_com_compartilhamento, mg.tomadores_com_multiplos_compartilhamentos,\\r\\n    mg.total_compartilhamentos, mg.perc_tomadores_com_compartilhamento, mg.indice_risco_grupo_economico,\\r\\n    \\r\\n    -- Campos de Ind\\u00edcios\\r\\n    ind.qtd_total_indicios,\\r\\n    ind.qtd_tipos_indicios_distintos,\\r\\n    ind.qtd_cnpjs_com_indicios,\\r\\n    ind.perc_cnpjs_com_indicios,\\r\\n    ind.indice_risco_indicios,\\r\\n    \\r\\n    -- Campos de Pagamentos e Funcion\\u00e1rios\\r\\n    COALESCE(pag.valor_meios_pagamento_empresas, 0) AS valor_meios_pagamento_empresas,\\r\\n    COALESCE(pag.valor_meios_pagamento_socios, 0) AS valor_meios_pagamento_socios,\\r\\n    COALESCE(func.total_funcionarios, 0) AS total_funcionarios,\\r\\n    CASE\\r\\n        WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0\\r\\n        THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4)\\r\\n        ELSE 0\\r\\n    END AS indice_risco_pagamentos,\\r\\n    CASE\\r\\n        WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0\\r\\n        THEN (1 - (1 / (COALESCE(maximos.valor_max, 0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000)))\\r\\n        ELSE 0\\r\\n    END AS indice_risco_fat_func,\\r\\n\\r\\n    -- ============================================================================\\r\\n    -- >> CAMPOS CCS (NOVOS) \\r\\n    -- ============================================================================\\r\\n    COALESCE(ccs.total_contas_unicas, 0) AS ccs_total_contas_unicas,\\r\\n    COALESCE(ccs.qtd_contas_compartilhadas, 0) AS ccs_qtd_contas_compartilhadas,\\r\\n    COALESCE(ccs.perc_contas_compartilhadas, 0) AS ccs_perc_contas_compartilhadas,\\r\\n    COALESCE(ccs.max_cnpjs_por_conta, 0) AS ccs_max_cnpjs_por_conta,\\r\\n    COALESCE(ccs.qtd_sobreposicoes_responsaveis, 0) AS ccs_qtd_sobreposicoes_responsaveis,\\r\\n    COALESCE(ccs.media_dias_sobreposicao, 0) AS ccs_media_dias_sobreposicao,\\r\\n    COALESCE(ccs.qtd_datas_abertura_coordenada, 0) AS ccs_qtd_datas_abertura_coordenada,\\r\\n    COALESCE(ccs.qtd_datas_encerramento_coordenado, 0) AS ccs_qtd_datas_encerramento_coordenado,\\r\\n    COALESCE(ccs.indice_risco_ccs, 0) AS indice_risco_ccs,\\r\\n    COALESCE(ccs_rk.nivel_risco_ccs, 'INEXISTENTE') AS nivel_risco_ccs,\\r\\n    \\r\\n    -- Scores antigos (mantidos para refer\\u00eancia)\\r\\n    ROUND((COALESCE(i.total_incons, 0) * 0.4) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.4), 2) AS score_combinado,\\r\\n    CASE WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN ROUND((COALESCE(i.total_incons, 0) * 0.3) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.3) + (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.2), 2) ELSE ROUND((COALESCE(i.total_incons, 0) * 0.4) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.4), 2) END AS score_combinado_c115,\\r\\n\\r\\n    -- Score final original (com ind\\u00edcios) - mantido\\r\\n    CASE\\r\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.25) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.15) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.25) +\\r\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.15) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.20)\\r\\n            , 2) \\r\\n        ELSE\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.35) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.15) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.30) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.20)\\r\\n            , 2)\\r\\n    END AS score_final_completo,\\r\\n\\r\\n    -- Score com pagamentos e funcion\\u00e1rios - mantido\\r\\n    CASE\\r\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.20) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.10) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.20) +\\r\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.10) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.15) +\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) ELSE 0 END * 0.15) +\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) ELSE 0 END * 0.10)\\r\\n            , 2)\\r\\n        ELSE\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.25) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.10) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.25) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.15) +\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) ELSE 0 END * 0.15) +\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) ELSE 0 END * 0.10)\\r\\n            , 2)\\r\\n    END AS score_final_avancado,\\r\\n\\r\\n    -- ============================================================================\\r\\n    -- >> NOVO SCORE FINAL COM CCS (15% DE PESO) \\r\\n    -- ============================================================================\\r\\n    CASE\\r\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\r\\n            -- Vers\\u00e3o com TUDO (8 fatores: 7 anteriores + CCS)\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.17) +                              -- 17% (antes 20%)\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.08) +                            -- 8%  (antes 10%)\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.17) +                  -- 17% (antes 20%)\\r\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.08) +             -- 8%  (antes 10%)\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.13) +              -- 13% (antes 15%)\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 \\r\\n                  THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) \\r\\n                  ELSE 0 END * 0.12) +                                              -- 12% (antes 15%)\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 \\r\\n                  THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) \\r\\n                  ELSE 0 END * 0.10) +                                              -- 10% (mantido)\\r\\n                (COALESCE(ccs.indice_risco_ccs, 0) * 0.15)                          -- 15% (NOVO - CCS)\\r\\n            , 2)\\r\\n        ELSE\\r\\n            -- Vers\\u00e3o sem C115 mas com CCS (7 fatores)\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.22) +                              -- 22% (antes 25%)\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.08) +                            -- 8%  (antes 10%)\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.22) +                  -- 22% (antes 25%)\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.13) +              -- 13% (antes 15%)\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 \\r\\n                  THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) \\r\\n                  ELSE 0 END * 0.12) +                                              -- 12% (antes 15%)\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 \\r\\n                  THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) \\r\\n                  ELSE 0 END * 0.08) +                                              -- 8%  (antes 10%)\\r\\n                (COALESCE(ccs.indice_risco_ccs, 0) * 0.15)                          -- 15% (NOVO - CCS)\\r\\n            , 2)\\r\\n    END AS score_final_ccs\\r\\n\\r\\nFROM gessimples.gei_percent_intermediario i\\r\\nLEFT JOIN primeiro_excesso ON i.num_grupo = primeiro_excesso.num_grupo\\r\\nLEFT JOIN maximos ON i.num_grupo = maximos.num_grupo\\r\\nLEFT JOIN c115_ranking rk ON i.num_grupo = rk.num_grupo\\r\\nLEFT JOIN c115_metricas mg ON i.num_grupo = mg.num_grupo\\r\\nLEFT JOIN gessimples.gei_indicios_metricas_grupo ind ON i.num_grupo = ind.num_grupo\\r\\nLEFT JOIN gessimples.gei_pagamentos_metricas_grupo pag ON i.num_grupo = pag.num_grupo\\r\\nLEFT JOIN gessimples.gei_funcionarios_metricas_grupo func ON i.num_grupo = func.num_grupo\\r\\n-- ============================================================================\\r\\n-- >> NOVOS JOINS COM CCS \\r\\n-- ============================================================================\\r\\nLEFT JOIN gessimples.gei_ccs_metricas_grupo ccs ON i.num_grupo = ccs.num_grupo\\r\\nLEFT JOIN gessimples.gei_ccs_ranking_risco ccs_rk ON i.num_grupo = ccs_rk.num_grupo\\r\\n\\r\\nORDER BY \\r\\n    score_final_ccs DESC,\\r\\n    score_final_avancado DESC,\\r\\n    score_final_completo DESC\\r\\nLIMIT 10000;\", \"result\": {\"id\": \"16676765-8bed-06d6-7125-dcaabab9ab97\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"r11d5IQLTgK/bC2f+1DBdQ==\", \"guid\": \"qr6PrhC8Qt8AAAAAiQ3xkw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"ea4ab28ee9320620:441f6049a7171eb9\", \"session_id\": 23792, \"session_type\": \"impala\", \"statement_id\": 3, \"has_more_statements\": false, \"statements_count\": 4, \"previous_statement_hash\": \"9ef79a31bb7ecb6b90a84204f3edc8168480a14ec6cb374f58a6e157\", \"start\": {\"row\": 5, \"column\": 0}, \"end\": {\"row\": 337, \"column\": 11}, \"statement\": \"CREATE TABLE gessimples.gei_percent AS\\nWITH faturamento_consolidado AS (\\n    -- ============================================================================\\n    -- >> CONSOLIDA\\u00c7\\u00c3O PGDAS + DIME (NOVO)\\n    -- ============================================================================\\n    -- Dados do PGDAS (Simples Nacional)\\n    SELECT\\n        gc.num_grupo,\\n        gc.cnpj,\\n        COALESCE(pg.jan2021, 0) AS jan2021, COALESCE(pg.fev2021, 0) AS fev2021, COALESCE(pg.mar2021, 0) AS mar2021,\\n        COALESCE(pg.abr2021, 0) AS abr2021, COALESCE(pg.mai2021, 0) AS mai2021, COALESCE(pg.jun2021, 0) AS jun2021,\\n        COALESCE(pg.jul2021, 0) AS jul2021, COALESCE(pg.ago2021, 0) AS ago2021, COALESCE(pg.set2021, 0) AS set2021,\\n        COALESCE(pg.out2021, 0) AS out2021, COALESCE(pg.nov2021, 0) AS nov2021, COALESCE(pg.dez2021, 0) AS dez2021,\\n        COALESCE(pg.jan2022, 0) AS jan2022, COALESCE(pg.fev2022, 0) AS fev2022, COALESCE(pg.mar2022, 0) AS mar2022,\\n        COALESCE(pg.abr2022, 0) AS abr2022, COALESCE(pg.mai2022, 0) AS mai2022, COALESCE(pg.jun2022, 0) AS jun2022,\\n        COALESCE(pg.jul2022, 0) AS jul2022, COALESCE(pg.ago2022, 0) AS ago2022, COALESCE(pg.set2022, 0) AS set2022,\\n        COALESCE(pg.out2022, 0) AS out2022, COALESCE(pg.nov2022, 0) AS nov2022, COALESCE(pg.dez2022, 0) AS dez2022,\\n        COALESCE(pg.jan2023, 0) AS jan2023, COALESCE(pg.fev2023, 0) AS fev2023, COALESCE(pg.mar2023, 0) AS mar2023,\\n        COALESCE(pg.abr2023, 0) AS abr2023, COALESCE(pg.mai2023, 0) AS mai2023, COALESCE(pg.jun2023, 0) AS jun2023,\\n        COALESCE(pg.jul2023, 0) AS jul2023, COALESCE(pg.ago2023, 0) AS ago2023, COALESCE(pg.set2023, 0) AS set2023,\\n        COALESCE(pg.out2023, 0) AS out2023, COALESCE(pg.nov2023, 0) AS nov2023, COALESCE(pg.dez2023, 0) AS dez2023,\\n        COALESCE(pg.jan2024, 0) AS jan2024, COALESCE(pg.fev2024, 0) AS fev2024, COALESCE(pg.mar2024, 0) AS mar2024,\\n        COALESCE(pg.abr2024, 0) AS abr2024, COALESCE(pg.mai2024, 0) AS mai2024, COALESCE(pg.jun2024, 0) AS jun2024,\\n        COALESCE(pg.jul2024, 0) AS jul2024, COALESCE(pg.ago2024, 0) AS ago2024, COALESCE(pg.set2024, 0) AS set2024,\\n        COALESCE(pg.out2024, 0) AS out2024, COALESCE(pg.nov2024, 0) AS nov2024, COALESCE(pg.dez2024, 0) AS dez2024,\\n        COALESCE(pg.jan2025, 0) AS jan2025, COALESCE(pg.fev2025, 0) AS fev2025, COALESCE(pg.mar2025, 0) AS mar2025,\\n        COALESCE(pg.abr2025, 0) AS abr2025, COALESCE(pg.mai2025, 0) AS mai2025, COALESCE(pg.jun2025, 0) AS jun2025,\\n        COALESCE(pg.jul2025, 0) AS jul2025, COALESCE(pg.ago2025, 0) AS ago2025, COALESCE(pg.set2025, 0) AS set2025\\n    FROM gessimples.gei_cnpj gc\\n    JOIN gessimples.gei_pgdas pg ON gc.cnpj = pg.cnpj\\n    \\n    UNION ALL\\n    \\n    -- Dados da DIME (Regime Normal)\\n    SELECT\\n        gc.num_grupo,\\n        gc.cnpj,\\n        COALESCE(dm.jan2021, 0) AS jan2021, COALESCE(dm.fev2021, 0) AS fev2021, COALESCE(dm.mar2021, 0) AS mar2021,\\n        COALESCE(dm.abr2021, 0) AS abr2021, COALESCE(dm.mai2021, 0) AS mai2021, COALESCE(dm.jun2021, 0) AS jun2021,\\n        COALESCE(dm.jul2021, 0) AS jul2021, COALESCE(dm.ago2021, 0) AS ago2021, COALESCE(dm.set2021, 0) AS set2021,\\n        COALESCE(dm.out2021, 0) AS out2021, COALESCE(dm.nov2021, 0) AS nov2021, COALESCE(dm.dez2021, 0) AS dez2021,\\n        COALESCE(dm.jan2022, 0) AS jan2022, COALESCE(dm.fev2022, 0) AS fev2022, COALESCE(dm.mar2022, 0) AS mar2022,\\n        COALESCE(dm.abr2022, 0) AS abr2022, COALESCE(dm.mai2022, 0) AS mai2022, COALESCE(dm.jun2022, 0) AS jun2022,\\n        COALESCE(dm.jul2022, 0) AS jul2022, COALESCE(dm.ago2022, 0) AS ago2022, COALESCE(dm.set2022, 0) AS set2022,\\n        COALESCE(dm.out2022, 0) AS out2022, COALESCE(dm.nov2022, 0) AS nov2022, COALESCE(dm.dez2022, 0) AS dez2022,\\n        COALESCE(dm.jan2023, 0) AS jan2023, COALESCE(dm.fev2023, 0) AS fev2023, COALESCE(dm.mar2023, 0) AS mar2023,\\n        COALESCE(dm.abr2023, 0) AS abr2023, COALESCE(dm.mai2023, 0) AS mai2023, COALESCE(dm.jun2023, 0) AS jun2023,\\n        COALESCE(dm.jul2023, 0) AS jul2023, COALESCE(dm.ago2023, 0) AS ago2023, COALESCE(dm.set2023, 0) AS set2023,\\n        COALESCE(dm.out2023, 0) AS out2023, COALESCE(dm.nov2023, 0) AS nov2023, COALESCE(dm.dez2023, 0) AS dez2023,\\n        COALESCE(dm.jan2024, 0) AS jan2024, COALESCE(dm.fev2024, 0) AS fev2024, COALESCE(dm.mar2024, 0) AS mar2024,\\n        COALESCE(dm.abr2024, 0) AS abr2024, COALESCE(dm.mai2024, 0) AS mai2024, COALESCE(dm.jun2024, 0) AS jun2024,\\n        COALESCE(dm.jul2024, 0) AS jul2024, COALESCE(dm.ago2024, 0) AS ago2024, COALESCE(dm.set2024, 0) AS set2024,\\n        COALESCE(dm.out2024, 0) AS out2024, COALESCE(dm.nov2024, 0) AS nov2024, COALESCE(dm.dez2024, 0) AS dez2024,\\n        COALESCE(dm.jan2025, 0) AS jan2025, COALESCE(dm.fev2025, 0) AS fev2025, COALESCE(dm.mar2025, 0) AS mar2025,\\n        COALESCE(dm.abr2025, 0) AS abr2025, COALESCE(dm.mai2025, 0) AS mai2025, COALESCE(dm.jun2025, 0) AS jun2025,\\n        COALESCE(dm.jul2025, 0) AS jul2025, COALESCE(dm.ago2025, 0) AS ago2025, COALESCE(dm.set2025, 0) AS set2025\\n    FROM gessimples.gei_cnpj gc\\n    JOIN gessimples.gei_dime dm ON gc.cnpj = dm.cnpj\\n),\\ngrupo AS (\\n    -- Agora soma os valores consolidados (PGDAS + DIME) por grupo\\n    SELECT\\n        num_grupo,\\n        SUM(jan2021) AS jan2021, SUM(fev2021) AS fev2021, SUM(mar2021) AS mar2021,\\n        SUM(abr2021) AS abr2021, SUM(mai2021) AS mai2021, SUM(jun2021) AS jun2021,\\n        SUM(jul2021) AS jul2021, SUM(ago2021) AS ago2021, SUM(set2021) AS set2021,\\n        SUM(out2021) AS out2021, SUM(nov2021) AS nov2021, SUM(dez2021) AS dez2021,\\n        SUM(jan2022) AS jan2022, SUM(fev2022) AS fev2022, SUM(mar2022) AS mar2022,\\n        SUM(abr2022) AS abr2022, SUM(mai2022) AS mai2022, SUM(jun2022) AS jun2022,\\n        SUM(jul2022) AS jul2022, SUM(ago2022) AS ago2022, SUM(set2022) AS set2022,\\n        SUM(out2022) AS out2022, SUM(nov2022) AS nov2022, SUM(dez2022) AS dez2022,\\n        SUM(jan2023) AS jan2023, SUM(fev2023) AS fev2023, SUM(mar2023) AS mar2023,\\n        SUM(abr2023) AS abr2023, SUM(mai2023) AS mai2023, SUM(jun2023) AS jun2023,\\n        SUM(jul2023) AS jul2023, SUM(ago2023) AS ago2023, SUM(set2023) AS set2023,\\n        SUM(out2023) AS out2023, SUM(nov2023) AS nov2023, SUM(dez2023) AS dez2023,\\n        SUM(jan2024) AS jan2024, SUM(fev2024) AS fev2024, SUM(mar2024) AS mar2024,\\n        SUM(abr2024) AS abr2024, SUM(mai2024) AS mai2024, SUM(jun2024) AS jun2024,\\n        SUM(jul2024) AS jul2024, SUM(ago2024) AS ago2024, SUM(set2024) AS set2024,\\n        SUM(out2024) AS out2024, SUM(nov2024) AS nov2024, SUM(dez2024) AS dez2024,\\n        SUM(jan2025) AS jan2025, SUM(fev2025) AS fev2025, SUM(mar2025) AS mar2025,\\n        SUM(abr2025) AS abr2025, SUM(mai2025) AS mai2025, SUM(jun2025) AS jun2025,\\n        SUM(jul2025) AS jul2025, SUM(ago2025) AS ago2025, SUM(set2025) AS set2025\\n    FROM faturamento_consolidado\\n    GROUP BY num_grupo\\n),\\nunpivoted AS (\\n    -- CTE 'unpivoted' (sem altera\\u00e7\\u00f5es)\\n    SELECT num_grupo, 'jan2021' AS periodo, jan2021 AS valor, 1 AS ord FROM grupo\\n    UNION ALL SELECT num_grupo, 'fev2021', fev2021, 2 FROM grupo\\n    UNION ALL SELECT num_grupo, 'mar2021', mar2021, 3 FROM grupo\\n    UNION ALL SELECT num_grupo, 'abr2021', abr2021, 4 FROM grupo\\n    UNION ALL SELECT num_grupo, 'mai2021', mai2021, 5 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jun2021', jun2021, 6 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jul2021', jul2021, 7 FROM grupo\\n    UNION ALL SELECT num_grupo, 'ago2021', ago2021, 8 FROM grupo\\n    UNION ALL SELECT num_grupo, 'set2021', set2021, 9 FROM grupo\\n    UNION ALL SELECT num_grupo, 'out2021', out2021, 10 FROM grupo\\n    UNION ALL SELECT num_grupo, 'nov2021', nov2021, 11 FROM grupo\\n    UNION ALL SELECT num_grupo, 'dez2021', dez2021, 12 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jan2022', jan2022, 13 FROM grupo\\n    UNION ALL SELECT num_grupo, 'fev2022', fev2022, 14 FROM grupo\\n    UNION ALL SELECT num_grupo, 'mar2022', mar2022, 15 FROM grupo\\n    UNION ALL SELECT num_grupo, 'abr2022', abr2022, 16 FROM grupo\\n    UNION ALL SELECT num_grupo, 'mai2022', mai2022, 17 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jun2022', jun2022, 18 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jul2022', jul2022, 19 FROM grupo\\n    UNION ALL SELECT num_grupo, 'ago2022', ago2022, 20 FROM grupo\\n    UNION ALL SELECT num_grupo, 'set2022', set2022, 21 FROM grupo\\n    UNION ALL SELECT num_grupo, 'out2022', out2022, 22 FROM grupo\\n    UNION ALL SELECT num_grupo, 'nov2022', nov2022, 23 FROM grupo\\n    UNION ALL SELECT num_grupo, 'dez2022', dez2022, 24 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jan2023', jan2023, 25 FROM grupo\\n    UNION ALL SELECT num_grupo, 'fev2023', fev2023, 26 FROM grupo\\n    UNION ALL SELECT num_grupo, 'mar2023', mar2023, 27 FROM grupo\\n    UNION ALL SELECT num_grupo, 'abr2023', abr2023, 28 FROM grupo\\n    UNION ALL SELECT num_grupo, 'mai2023', mai2023, 29 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jun2023', jun2023, 30 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jul2023', jul2023, 31 FROM grupo\\n    UNION ALL SELECT num_grupo, 'ago2023', ago2023, 32 FROM grupo\\n    UNION ALL SELECT num_grupo, 'set2023', set2023, 33 FROM grupo\\n    UNION ALL SELECT num_grupo, 'out2023', out2023, 34 FROM grupo\\n    UNION ALL SELECT num_grupo, 'nov2023', nov2023, 35 FROM grupo\\n    UNION ALL SELECT num_grupo, 'dez2023', dez2023, 36 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jan2024', jan2024, 37 FROM grupo\\n    UNION ALL SELECT num_grupo, 'fev2024', fev2024, 38 FROM grupo\\n    UNION ALL SELECT num_grupo, 'mar2024', mar2024, 39 FROM grupo\\n    UNION ALL SELECT num_grupo, 'abr2024', abr2024, 40 FROM grupo\\n    UNION ALL SELECT num_grupo, 'mai2024', mai2024, 41 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jun2024', jun2024, 42 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jul2024', jul2024, 43 FROM grupo\\n    UNION ALL SELECT num_grupo, 'ago2024', ago2024, 44 FROM grupo\\n    UNION ALL SELECT num_grupo, 'set2024', set2024, 45 FROM grupo\\n    UNION ALL SELECT num_grupo, 'out2024', out2024, 46 FROM grupo\\n    UNION ALL SELECT num_grupo, 'nov2024', nov2024, 47 FROM grupo\\n    UNION ALL SELECT num_grupo, 'dez2024', dez2024, 48 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jan2025', jan2025, 49 FROM grupo\\n    UNION ALL SELECT num_grupo, 'fev2025', fev2025, 50 FROM grupo\\n    UNION ALL SELECT num_grupo, 'mar2025', mar2025, 51 FROM grupo\\n    UNION ALL SELECT num_grupo, 'abr2025', abr2025, 52 FROM grupo\\n    UNION ALL SELECT num_grupo, 'mai2025', mai2025, 53 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jun2025', jun2025, 54 FROM grupo\\n    UNION ALL SELECT num_grupo, 'jul2025', jul2025, 55 FROM grupo\\n    UNION ALL SELECT num_grupo, 'ago2025', ago2025, 56 FROM grupo\\n    UNION ALL SELECT num_grupo, 'set2025', set2025, 57 FROM grupo\\n),\\nprimeiro_excesso AS (\\n    -- CTE 'primeiro_excesso' (sem altera\\u00e7\\u00f5es)\\n    SELECT num_grupo, periodo FROM (\\n        SELECT num_grupo, periodo, valor, ord, ROW_NUMBER() OVER (PARTITION BY num_grupo ORDER BY ord) AS rn\\n        FROM unpivoted WHERE valor >= 4800000\\n    ) t WHERE rn = 1\\n),\\nmaximos AS (\\n    -- CTE 'maximos' (sem altera\\u00e7\\u00f5es)\\n    SELECT num_grupo, valor AS valor_max, periodo AS periodo_max FROM (\\n        SELECT num_grupo, periodo, valor, ROW_NUMBER() OVER (PARTITION BY num_grupo ORDER BY valor DESC) AS rn\\n        FROM unpivoted\\n    ) t WHERE rn = 1\\n),\\nc115_ranking AS (\\n    -- CTE C115 (sem altera\\u00e7\\u00f5es)\\n    SELECT * FROM gessimples.gei_c115_ranking_risco_grupo_economico\\n),\\nc115_metricas AS (\\n    -- CTE C115 (sem altera\\u00e7\\u00f5es)\\n    SELECT * FROM gessimples.gei_c115_metricas_grupos\\n)\\n-- Consulta final unindo todas as fontes de dados\\nSELECT \\n    -- COLUNAS ORIGINAIS\\n    i.num_grupo,\\n    i.qntd_cnpj,\\n    i.perc_cliente, i.perc_email, i.perc_tel_dest, i.perc_tel_emit,\\n    i.perc_codigo_produto, i.perc_fornecedor, i.perc_end_emit, i.perc_end_dest,\\n    i.perc_descricao_produto, i.perc_ip_transmissao,\\n    i.total_incons AS total,\\n    i.distinct_nfe,\\n    i.total_itens,\\n    i.nm_razao_social, i.nm_fantasia, i.cd_cnae, i.nm_contador, i.endereco,\\n    i.qntd_s, i.qntd_normal, i.qntd_sn,\\n    i.total_cadastro,\\n    primeiro_excesso.periodo AS periodo,\\n    maximos.valor_max,\\n    maximos.periodo_max,\\n    i.qtd_socios_compartilhados, i.max_empresas_por_socio, i.qtd_cnpjs_com_socios_compartilhados,\\n    i.qtd_pares_cnpjs_relacionados, i.perc_cnpjs_com_socios, i.indice_interconexao,\\n    \\n    -- Campos do C115\\n    rk.ranking_risco, rk.qtd_cnpjs_relacionados, rk.perc_cnpjs_relacionados,\\n    rk.max_tipos_identificadores_comuns, rk.max_total_identificadores_comuns,\\n    rk.pares_com_tres_tipos_comum, rk.pares_com_dois_ou_mais_tipos_comum,\\n    rk.nivel_risco_grupo_economico,\\n    mg.total_tomadores, mg.tomadores_com_compartilhamento, mg.tomadores_com_multiplos_compartilhamentos,\\n    mg.total_compartilhamentos, mg.perc_tomadores_com_compartilhamento, mg.indice_risco_grupo_economico,\\n    \\n    -- Campos de Ind\\u00edcios\\n    ind.qtd_total_indicios,\\n    ind.qtd_tipos_indicios_distintos,\\n    ind.qtd_cnpjs_com_indicios,\\n    ind.perc_cnpjs_com_indicios,\\n    ind.indice_risco_indicios,\\n    \\n    -- Campos de Pagamentos e Funcion\\u00e1rios\\n    COALESCE(pag.valor_meios_pagamento_empresas, 0) AS valor_meios_pagamento_empresas,\\n    COALESCE(pag.valor_meios_pagamento_socios, 0) AS valor_meios_pagamento_socios,\\n    COALESCE(func.total_funcionarios, 0) AS total_funcionarios,\\n    CASE\\n        WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0\\n        THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4)\\n        ELSE 0\\n    END AS indice_risco_pagamentos,\\n    CASE\\n        WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0\\n        THEN (1 - (1 / (COALESCE(maximos.valor_max, 0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000)))\\n        ELSE 0\\n    END AS indice_risco_fat_func,\\n\\n    -- ============================================================================\\n    -- >> CAMPOS CCS (NOVOS) \\n    -- ============================================================================\\n    COALESCE(ccs.total_contas_unicas, 0) AS ccs_total_contas_unicas,\\n    COALESCE(ccs.qtd_contas_compartilhadas, 0) AS ccs_qtd_contas_compartilhadas,\\n    COALESCE(ccs.perc_contas_compartilhadas, 0) AS ccs_perc_contas_compartilhadas,\\n    COALESCE(ccs.max_cnpjs_por_conta, 0) AS ccs_max_cnpjs_por_conta,\\n    COALESCE(ccs.qtd_sobreposicoes_responsaveis, 0) AS ccs_qtd_sobreposicoes_responsaveis,\\n    COALESCE(ccs.media_dias_sobreposicao, 0) AS ccs_media_dias_sobreposicao,\\n    COALESCE(ccs.qtd_datas_abertura_coordenada, 0) AS ccs_qtd_datas_abertura_coordenada,\\n    COALESCE(ccs.qtd_datas_encerramento_coordenado, 0) AS ccs_qtd_datas_encerramento_coordenado,\\n    COALESCE(ccs.indice_risco_ccs, 0) AS indice_risco_ccs,\\n    COALESCE(ccs_rk.nivel_risco_ccs, 'INEXISTENTE') AS nivel_risco_ccs,\\n    \\n    -- Scores antigos (mantidos para refer\\u00eancia)\\n    ROUND((COALESCE(i.total_incons, 0) * 0.4) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.4), 2) AS score_combinado,\\n    CASE WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN ROUND((COALESCE(i.total_incons, 0) * 0.3) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.3) + (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.2), 2) ELSE ROUND((COALESCE(i.total_incons, 0) * 0.4) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.4), 2) END AS score_combinado_c115,\\n\\n    -- Score final original (com ind\\u00edcios) - mantido\\n    CASE\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\n            ROUND(\\n                (COALESCE(i.total_incons, 0) * 0.25) +\\n                (COALESCE(i.total_cadastro, 0) * 0.15) +\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.25) +\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.15) +\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.20)\\n            , 2) \\n        ELSE\\n            ROUND(\\n                (COALESCE(i.total_incons, 0) * 0.35) +\\n                (COALESCE(i.total_cadastro, 0) * 0.15) +\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.30) +\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.20)\\n            , 2)\\n    END AS score_final_completo,\\n\\n    -- Score com pagamentos e funcion\\u00e1rios - mantido\\n    CASE\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\n            ROUND(\\n                (COALESCE(i.total_incons, 0) * 0.20) +\\n                (COALESCE(i.total_cadastro, 0) * 0.10) +\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.20) +\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.10) +\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.15) +\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) ELSE 0 END * 0.15) +\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) ELSE 0 END * 0.10)\\n            , 2)\\n        ELSE\\n            ROUND(\\n                (COALESCE(i.total_incons, 0) * 0.25) +\\n                (COALESCE(i.total_cadastro, 0) * 0.10) +\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.25) +\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.15) +\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) ELSE 0 END * 0.15) +\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) ELSE 0 END * 0.10)\\n            , 2)\\n    END AS score_final_avancado,\\n\\n    -- ============================================================================\\n    -- >> NOVO SCORE FINAL COM CCS (15% DE PESO) \\n    -- ============================================================================\\n    CASE\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\n            -- Vers\\u00e3o com TUDO (8 fatores: 7 anteriores + CCS)\\n            ROUND(\\n                (COALESCE(i.total_incons, 0) * 0.17) +                              -- 17% (antes 20%)\\n                (COALESCE(i.total_cadastro, 0) * 0.08) +                            -- 8%  (antes 10%)\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.17) +                  -- 17% (antes 20%)\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.08) +             -- 8%  (antes 10%)\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.13) +              -- 13% (antes 15%)\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 \\n                  THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) \\n                  ELSE 0 END * 0.12) +                                              -- 12% (antes 15%)\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 \\n                  THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) \\n                  ELSE 0 END * 0.10) +                                              -- 10% (mantido)\\n                (COALESCE(ccs.indice_risco_ccs, 0) * 0.15)                          -- 15% (NOVO - CCS)\\n            , 2)\\n        ELSE\\n            -- Vers\\u00e3o sem C115 mas com CCS (7 fatores)\\n            ROUND(\\n                (COALESCE(i.total_incons, 0) * 0.22) +                              -- 22% (antes 25%)\\n                (COALESCE(i.total_cadastro, 0) * 0.08) +                            -- 8%  (antes 10%)\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.22) +                  -- 22% (antes 25%)\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.13) +              -- 13% (antes 15%)\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 \\n                  THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) \\n                  ELSE 0 END * 0.12) +                                              -- 12% (antes 15%)\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 \\n                  THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) \\n                  ELSE 0 END * 0.08) +                                              -- 8%  (antes 10%)\\n                (COALESCE(ccs.indice_risco_ccs, 0) * 0.15)                          -- 15% (NOVO - CCS)\\n            , 2)\\n    END AS score_final_ccs\\n\\nFROM gessimples.gei_percent_intermediario i\\nLEFT JOIN primeiro_excesso ON i.num_grupo = primeiro_excesso.num_grupo\\nLEFT JOIN maximos ON i.num_grupo = maximos.num_grupo\\nLEFT JOIN c115_ranking rk ON i.num_grupo = rk.num_grupo\\nLEFT JOIN c115_metricas mg ON i.num_grupo = mg.num_grupo\\nLEFT JOIN gessimples.gei_indicios_metricas_grupo ind ON i.num_grupo = ind.num_grupo\\nLEFT JOIN gessimples.gei_pagamentos_metricas_grupo pag ON i.num_grupo = pag.num_grupo\\nLEFT JOIN gessimples.gei_funcionarios_metricas_grupo func ON i.num_grupo = func.num_grupo\\n-- ============================================================================\\n-- >> NOVOS JOINS COM CCS \\n-- ============================================================================\\nLEFT JOIN gessimples.gei_ccs_metricas_grupo ccs ON i.num_grupo = ccs.num_grupo\\nLEFT JOIN gessimples.gei_ccs_ranking_risco ccs_rk ON i.num_grupo = ccs_rk.num_grupo\\n\\nORDER BY \\n    score_final_ccs DESC,\\n    score_final_avancado DESC,\\n    score_final_completo DESC\\nLIMIT 10000\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 3, \"statement_range\": {\"start\": {\"row\": 5, \"column\": 0}, \"end\": {\"row\": 337, \"column\": 11}}, \"statements_count\": 4, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"summary\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-12-10T19:50:39.852Z\", \"endTime\": \"2025-12-10T19:50:57.841Z\", \"executionTime\": 17989, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 15, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 11645, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"option\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 12254, \"getLogsTimeout\": 12434, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1765396235998, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- Parte 2: Processamento dos dados do PGDAS + DIME e cria\\u00e7\\u00e3o da tabela final\\r\\nDROP TABLE IF EXISTS gessimples.gei_percent;\\r\\nSET REQUEST_POOL = 'default';\\r\\nSET MEM_LIMIT = 20G;\\r\\n\\r\\nCREATE TABLE gessimples.gei_percent AS\\r\\nWITH faturamento_consolidado AS (\\r\\n    -- ============================================================================\\r\\n    -- >> CONSOLIDA\\u00c7\\u00c3O PGDAS + DIME (NOVO)\\r\\n    -- ============================================================================\\r\\n    -- Dados do PGDAS (Simples Nacional)\\r\\n    SELECT\\r\\n        gc.num_grupo,\\r\\n        gc.cnpj,\\r\\n        COALESCE(pg.jan2021, 0) AS jan2021, COALESCE(pg.fev2021, 0) AS fev2021, COALESCE(pg.mar2021, 0) AS mar2021,\\r\\n        COALESCE(pg.abr2021, 0) AS abr2021, COALESCE(pg.mai2021, 0) AS mai2021, COALESCE(pg.jun2021, 0) AS jun2021,\\r\\n        COALESCE(pg.jul2021, 0) AS jul2021, COALESCE(pg.ago2021, 0) AS ago2021, COALESCE(pg.set2021, 0) AS set2021,\\r\\n        COALESCE(pg.out2021, 0) AS out2021, COALESCE(pg.nov2021, 0) AS nov2021, COALESCE(pg.dez2021, 0) AS dez2021,\\r\\n        COALESCE(pg.jan2022, 0) AS jan2022, COALESCE(pg.fev2022, 0) AS fev2022, COALESCE(pg.mar2022, 0) AS mar2022,\\r\\n        COALESCE(pg.abr2022, 0) AS abr2022, COALESCE(pg.mai2022, 0) AS mai2022, COALESCE(pg.jun2022, 0) AS jun2022,\\r\\n        COALESCE(pg.jul2022, 0) AS jul2022, COALESCE(pg.ago2022, 0) AS ago2022, COALESCE(pg.set2022, 0) AS set2022,\\r\\n        COALESCE(pg.out2022, 0) AS out2022, COALESCE(pg.nov2022, 0) AS nov2022, COALESCE(pg.dez2022, 0) AS dez2022,\\r\\n        COALESCE(pg.jan2023, 0) AS jan2023, COALESCE(pg.fev2023, 0) AS fev2023, COALESCE(pg.mar2023, 0) AS mar2023,\\r\\n        COALESCE(pg.abr2023, 0) AS abr2023, COALESCE(pg.mai2023, 0) AS mai2023, COALESCE(pg.jun2023, 0) AS jun2023,\\r\\n        COALESCE(pg.jul2023, 0) AS jul2023, COALESCE(pg.ago2023, 0) AS ago2023, COALESCE(pg.set2023, 0) AS set2023,\\r\\n        COALESCE(pg.out2023, 0) AS out2023, COALESCE(pg.nov2023, 0) AS nov2023, COALESCE(pg.dez2023, 0) AS dez2023,\\r\\n        COALESCE(pg.jan2024, 0) AS jan2024, COALESCE(pg.fev2024, 0) AS fev2024, COALESCE(pg.mar2024, 0) AS mar2024,\\r\\n        COALESCE(pg.abr2024, 0) AS abr2024, COALESCE(pg.mai2024, 0) AS mai2024, COALESCE(pg.jun2024, 0) AS jun2024,\\r\\n        COALESCE(pg.jul2024, 0) AS jul2024, COALESCE(pg.ago2024, 0) AS ago2024, COALESCE(pg.set2024, 0) AS set2024,\\r\\n        COALESCE(pg.out2024, 0) AS out2024, COALESCE(pg.nov2024, 0) AS nov2024, COALESCE(pg.dez2024, 0) AS dez2024,\\r\\n        COALESCE(pg.jan2025, 0) AS jan2025, COALESCE(pg.fev2025, 0) AS fev2025, COALESCE(pg.mar2025, 0) AS mar2025,\\r\\n        COALESCE(pg.abr2025, 0) AS abr2025, COALESCE(pg.mai2025, 0) AS mai2025, COALESCE(pg.jun2025, 0) AS jun2025,\\r\\n        COALESCE(pg.jul2025, 0) AS jul2025, COALESCE(pg.ago2025, 0) AS ago2025, COALESCE(pg.set2025, 0) AS set2025\\r\\n    FROM gessimples.gei_cnpj gc\\r\\n    JOIN gessimples.gei_pgdas pg ON gc.cnpj = pg.cnpj\\r\\n    \\r\\n    UNION ALL\\r\\n    \\r\\n    -- Dados da DIME (Regime Normal)\\r\\n    SELECT\\r\\n        gc.num_grupo,\\r\\n        gc.cnpj,\\r\\n        COALESCE(dm.jan2021, 0) AS jan2021, COALESCE(dm.fev2021, 0) AS fev2021, COALESCE(dm.mar2021, 0) AS mar2021,\\r\\n        COALESCE(dm.abr2021, 0) AS abr2021, COALESCE(dm.mai2021, 0) AS mai2021, COALESCE(dm.jun2021, 0) AS jun2021,\\r\\n        COALESCE(dm.jul2021, 0) AS jul2021, COALESCE(dm.ago2021, 0) AS ago2021, COALESCE(dm.set2021, 0) AS set2021,\\r\\n        COALESCE(dm.out2021, 0) AS out2021, COALESCE(dm.nov2021, 0) AS nov2021, COALESCE(dm.dez2021, 0) AS dez2021,\\r\\n        COALESCE(dm.jan2022, 0) AS jan2022, COALESCE(dm.fev2022, 0) AS fev2022, COALESCE(dm.mar2022, 0) AS mar2022,\\r\\n        COALESCE(dm.abr2022, 0) AS abr2022, COALESCE(dm.mai2022, 0) AS mai2022, COALESCE(dm.jun2022, 0) AS jun2022,\\r\\n        COALESCE(dm.jul2022, 0) AS jul2022, COALESCE(dm.ago2022, 0) AS ago2022, COALESCE(dm.set2022, 0) AS set2022,\\r\\n        COALESCE(dm.out2022, 0) AS out2022, COALESCE(dm.nov2022, 0) AS nov2022, COALESCE(dm.dez2022, 0) AS dez2022,\\r\\n        COALESCE(dm.jan2023, 0) AS jan2023, COALESCE(dm.fev2023, 0) AS fev2023, COALESCE(dm.mar2023, 0) AS mar2023,\\r\\n        COALESCE(dm.abr2023, 0) AS abr2023, COALESCE(dm.mai2023, 0) AS mai2023, COALESCE(dm.jun2023, 0) AS jun2023,\\r\\n        COALESCE(dm.jul2023, 0) AS jul2023, COALESCE(dm.ago2023, 0) AS ago2023, COALESCE(dm.set2023, 0) AS set2023,\\r\\n        COALESCE(dm.out2023, 0) AS out2023, COALESCE(dm.nov2023, 0) AS nov2023, COALESCE(dm.dez2023, 0) AS dez2023,\\r\\n        COALESCE(dm.jan2024, 0) AS jan2024, COALESCE(dm.fev2024, 0) AS fev2024, COALESCE(dm.mar2024, 0) AS mar2024,\\r\\n        COALESCE(dm.abr2024, 0) AS abr2024, COALESCE(dm.mai2024, 0) AS mai2024, COALESCE(dm.jun2024, 0) AS jun2024,\\r\\n        COALESCE(dm.jul2024, 0) AS jul2024, COALESCE(dm.ago2024, 0) AS ago2024, COALESCE(dm.set2024, 0) AS set2024,\\r\\n        COALESCE(dm.out2024, 0) AS out2024, COALESCE(dm.nov2024, 0) AS nov2024, COALESCE(dm.dez2024, 0) AS dez2024,\\r\\n        COALESCE(dm.jan2025, 0) AS jan2025, COALESCE(dm.fev2025, 0) AS fev2025, COALESCE(dm.mar2025, 0) AS mar2025,\\r\\n        COALESCE(dm.abr2025, 0) AS abr2025, COALESCE(dm.mai2025, 0) AS mai2025, COALESCE(dm.jun2025, 0) AS jun2025,\\r\\n        COALESCE(dm.jul2025, 0) AS jul2025, COALESCE(dm.ago2025, 0) AS ago2025, COALESCE(dm.set2025, 0) AS set2025\\r\\n    FROM gessimples.gei_cnpj gc\\r\\n    JOIN gessimples.gei_dime dm ON gc.cnpj = dm.cnpj\\r\\n),\\r\\ngrupo AS (\\r\\n    -- Agora soma os valores consolidados (PGDAS + DIME) por grupo\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        SUM(jan2021) AS jan2021, SUM(fev2021) AS fev2021, SUM(mar2021) AS mar2021,\\r\\n        SUM(abr2021) AS abr2021, SUM(mai2021) AS mai2021, SUM(jun2021) AS jun2021,\\r\\n        SUM(jul2021) AS jul2021, SUM(ago2021) AS ago2021, SUM(set2021) AS set2021,\\r\\n        SUM(out2021) AS out2021, SUM(nov2021) AS nov2021, SUM(dez2021) AS dez2021,\\r\\n        SUM(jan2022) AS jan2022, SUM(fev2022) AS fev2022, SUM(mar2022) AS mar2022,\\r\\n        SUM(abr2022) AS abr2022, SUM(mai2022) AS mai2022, SUM(jun2022) AS jun2022,\\r\\n        SUM(jul2022) AS jul2022, SUM(ago2022) AS ago2022, SUM(set2022) AS set2022,\\r\\n        SUM(out2022) AS out2022, SUM(nov2022) AS nov2022, SUM(dez2022) AS dez2022,\\r\\n        SUM(jan2023) AS jan2023, SUM(fev2023) AS fev2023, SUM(mar2023) AS mar2023,\\r\\n        SUM(abr2023) AS abr2023, SUM(mai2023) AS mai2023, SUM(jun2023) AS jun2023,\\r\\n        SUM(jul2023) AS jul2023, SUM(ago2023) AS ago2023, SUM(set2023) AS set2023,\\r\\n        SUM(out2023) AS out2023, SUM(nov2023) AS nov2023, SUM(dez2023) AS dez2023,\\r\\n        SUM(jan2024) AS jan2024, SUM(fev2024) AS fev2024, SUM(mar2024) AS mar2024,\\r\\n        SUM(abr2024) AS abr2024, SUM(mai2024) AS mai2024, SUM(jun2024) AS jun2024,\\r\\n        SUM(jul2024) AS jul2024, SUM(ago2024) AS ago2024, SUM(set2024) AS set2024,\\r\\n        SUM(out2024) AS out2024, SUM(nov2024) AS nov2024, SUM(dez2024) AS dez2024,\\r\\n        SUM(jan2025) AS jan2025, SUM(fev2025) AS fev2025, SUM(mar2025) AS mar2025,\\r\\n        SUM(abr2025) AS abr2025, SUM(mai2025) AS mai2025, SUM(jun2025) AS jun2025,\\r\\n        SUM(jul2025) AS jul2025, SUM(ago2025) AS ago2025, SUM(set2025) AS set2025\\r\\n    FROM faturamento_consolidado\\r\\n    GROUP BY num_grupo\\r\\n),\\r\\nunpivoted AS (\\r\\n    -- CTE 'unpivoted' (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT num_grupo, 'jan2021' AS periodo, jan2021 AS valor, 1 AS ord FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2021', fev2021, 2 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2021', mar2021, 3 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2021', abr2021, 4 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2021', mai2021, 5 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2021', jun2021, 6 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2021', jul2021, 7 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2021', ago2021, 8 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2021', set2021, 9 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2021', out2021, 10 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2021', nov2021, 11 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2021', dez2021, 12 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2022', jan2022, 13 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2022', fev2022, 14 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2022', mar2022, 15 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2022', abr2022, 16 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2022', mai2022, 17 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2022', jun2022, 18 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2022', jul2022, 19 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2022', ago2022, 20 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2022', set2022, 21 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2022', out2022, 22 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2022', nov2022, 23 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2022', dez2022, 24 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2023', jan2023, 25 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2023', fev2023, 26 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2023', mar2023, 27 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2023', abr2023, 28 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2023', mai2023, 29 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2023', jun2023, 30 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2023', jul2023, 31 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2023', ago2023, 32 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2023', set2023, 33 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2023', out2023, 34 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2023', nov2023, 35 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2023', dez2023, 36 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2024', jan2024, 37 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2024', fev2024, 38 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2024', mar2024, 39 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2024', abr2024, 40 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2024', mai2024, 41 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2024', jun2024, 42 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2024', jul2024, 43 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2024', ago2024, 44 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2024', set2024, 45 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'out2024', out2024, 46 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'nov2024', nov2024, 47 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'dez2024', dez2024, 48 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jan2025', jan2025, 49 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'fev2025', fev2025, 50 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mar2025', mar2025, 51 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'abr2025', abr2025, 52 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'mai2025', mai2025, 53 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jun2025', jun2025, 54 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'jul2025', jul2025, 55 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'ago2025', ago2025, 56 FROM grupo\\r\\n    UNION ALL SELECT num_grupo, 'set2025', set2025, 57 FROM grupo\\r\\n),\\r\\nprimeiro_excesso AS (\\r\\n    -- CTE 'primeiro_excesso' (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT num_grupo, periodo FROM (\\r\\n        SELECT num_grupo, periodo, valor, ord, ROW_NUMBER() OVER (PARTITION BY num_grupo ORDER BY ord) AS rn\\r\\n        FROM unpivoted WHERE valor >= 4800000\\r\\n    ) t WHERE rn = 1\\r\\n),\\r\\nmaximos AS (\\r\\n    -- CTE 'maximos' (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT num_grupo, valor AS valor_max, periodo AS periodo_max FROM (\\r\\n        SELECT num_grupo, periodo, valor, ROW_NUMBER() OVER (PARTITION BY num_grupo ORDER BY valor DESC) AS rn\\r\\n        FROM unpivoted\\r\\n    ) t WHERE rn = 1\\r\\n),\\r\\nc115_ranking AS (\\r\\n    -- CTE C115 (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT * FROM gessimples.gei_c115_ranking_risco_grupo_economico\\r\\n),\\r\\nc115_metricas AS (\\r\\n    -- CTE C115 (sem altera\\u00e7\\u00f5es)\\r\\n    SELECT * FROM gessimples.gei_c115_metricas_grupos\\r\\n)\\r\\n-- Consulta final unindo todas as fontes de dados\\r\\nSELECT \\r\\n    -- COLUNAS ORIGINAIS\\r\\n    i.num_grupo,\\r\\n    i.qntd_cnpj,\\r\\n    i.perc_cliente, i.perc_email, i.perc_tel_dest, i.perc_tel_emit,\\r\\n    i.perc_codigo_produto, i.perc_fornecedor, i.perc_end_emit, i.perc_end_dest,\\r\\n    i.perc_descricao_produto, i.perc_ip_transmissao,\\r\\n    i.total_incons AS total,\\r\\n    i.distinct_nfe,\\r\\n    i.total_itens,\\r\\n    i.nm_razao_social, i.nm_fantasia, i.cd_cnae, i.nm_contador, i.endereco,\\r\\n    i.qntd_s, i.qntd_normal, i.qntd_sn,\\r\\n    i.total_cadastro,\\r\\n    primeiro_excesso.periodo AS periodo,\\r\\n    maximos.valor_max,\\r\\n    maximos.periodo_max,\\r\\n    i.qtd_socios_compartilhados, i.max_empresas_por_socio, i.qtd_cnpjs_com_socios_compartilhados,\\r\\n    i.qtd_pares_cnpjs_relacionados, i.perc_cnpjs_com_socios, i.indice_interconexao,\\r\\n    \\r\\n    -- Campos do C115\\r\\n    rk.ranking_risco, rk.qtd_cnpjs_relacionados, rk.perc_cnpjs_relacionados,\\r\\n    rk.max_tipos_identificadores_comuns, rk.max_total_identificadores_comuns,\\r\\n    rk.pares_com_tres_tipos_comum, rk.pares_com_dois_ou_mais_tipos_comum,\\r\\n    rk.nivel_risco_grupo_economico,\\r\\n    mg.total_tomadores, mg.tomadores_com_compartilhamento, mg.tomadores_com_multiplos_compartilhamentos,\\r\\n    mg.total_compartilhamentos, mg.perc_tomadores_com_compartilhamento, mg.indice_risco_grupo_economico,\\r\\n    \\r\\n    -- Campos de Ind\\u00edcios\\r\\n    ind.qtd_total_indicios,\\r\\n    ind.qtd_tipos_indicios_distintos,\\r\\n    ind.qtd_cnpjs_com_indicios,\\r\\n    ind.perc_cnpjs_com_indicios,\\r\\n    ind.indice_risco_indicios,\\r\\n    \\r\\n    -- Campos de Pagamentos e Funcion\\u00e1rios\\r\\n    COALESCE(pag.valor_meios_pagamento_empresas, 0) AS valor_meios_pagamento_empresas,\\r\\n    COALESCE(pag.valor_meios_pagamento_socios, 0) AS valor_meios_pagamento_socios,\\r\\n    COALESCE(func.total_funcionarios, 0) AS total_funcionarios,\\r\\n    CASE\\r\\n        WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0\\r\\n        THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4)\\r\\n        ELSE 0\\r\\n    END AS indice_risco_pagamentos,\\r\\n    CASE\\r\\n        WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0\\r\\n        THEN (1 - (1 / (COALESCE(maximos.valor_max, 0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000)))\\r\\n        ELSE 0\\r\\n    END AS indice_risco_fat_func,\\r\\n\\r\\n    -- ============================================================================\\r\\n    -- >> CAMPOS CCS (NOVOS) \\r\\n    -- ============================================================================\\r\\n    COALESCE(ccs.total_contas_unicas, 0) AS ccs_total_contas_unicas,\\r\\n    COALESCE(ccs.qtd_contas_compartilhadas, 0) AS ccs_qtd_contas_compartilhadas,\\r\\n    COALESCE(ccs.perc_contas_compartilhadas, 0) AS ccs_perc_contas_compartilhadas,\\r\\n    COALESCE(ccs.max_cnpjs_por_conta, 0) AS ccs_max_cnpjs_por_conta,\\r\\n    COALESCE(ccs.qtd_sobreposicoes_responsaveis, 0) AS ccs_qtd_sobreposicoes_responsaveis,\\r\\n    COALESCE(ccs.media_dias_sobreposicao, 0) AS ccs_media_dias_sobreposicao,\\r\\n    COALESCE(ccs.qtd_datas_abertura_coordenada, 0) AS ccs_qtd_datas_abertura_coordenada,\\r\\n    COALESCE(ccs.qtd_datas_encerramento_coordenado, 0) AS ccs_qtd_datas_encerramento_coordenado,\\r\\n    COALESCE(ccs.indice_risco_ccs, 0) AS indice_risco_ccs,\\r\\n    COALESCE(ccs_rk.nivel_risco_ccs, 'INEXISTENTE') AS nivel_risco_ccs,\\r\\n    \\r\\n    -- Scores antigos (mantidos para refer\\u00eancia)\\r\\n    ROUND((COALESCE(i.total_incons, 0) * 0.4) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.4), 2) AS score_combinado,\\r\\n    CASE WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN ROUND((COALESCE(i.total_incons, 0) * 0.3) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.3) + (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.2), 2) ELSE ROUND((COALESCE(i.total_incons, 0) * 0.4) + (COALESCE(i.total_cadastro, 0) * 0.2) + (COALESCE(i.indice_interconexao * 10, 0) * 0.4), 2) END AS score_combinado_c115,\\r\\n\\r\\n    -- Score final original (com ind\\u00edcios) - mantido\\r\\n    CASE\\r\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.25) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.15) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.25) +\\r\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.15) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.20)\\r\\n            , 2) \\r\\n        ELSE\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.35) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.15) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.30) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.20)\\r\\n            , 2)\\r\\n    END AS score_final_completo,\\r\\n\\r\\n    -- Score com pagamentos e funcion\\u00e1rios - mantido\\r\\n    CASE\\r\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.20) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.10) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.20) +\\r\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.10) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.15) +\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) ELSE 0 END * 0.15) +\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) ELSE 0 END * 0.10)\\r\\n            , 2)\\r\\n        ELSE\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.25) +\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.10) +\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.25) +\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.15) +\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) ELSE 0 END * 0.15) +\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) ELSE 0 END * 0.10)\\r\\n            , 2)\\r\\n    END AS score_final_avancado,\\r\\n\\r\\n    -- ============================================================================\\r\\n    -- >> NOVO SCORE FINAL COM CCS (15% DE PESO) \\r\\n    -- ============================================================================\\r\\n    CASE\\r\\n        WHEN mg.indice_risco_grupo_economico IS NOT NULL THEN\\r\\n            -- Vers\\u00e3o com TUDO (8 fatores: 7 anteriores + CCS)\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.17) +                              -- 17% (antes 20%)\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.08) +                            -- 8%  (antes 10%)\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.17) +                  -- 17% (antes 20%)\\r\\n                (COALESCE(mg.indice_risco_grupo_economico, 0) * 0.08) +             -- 8%  (antes 10%)\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.13) +              -- 13% (antes 15%)\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 \\r\\n                  THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) \\r\\n                  ELSE 0 END * 0.12) +                                              -- 12% (antes 15%)\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 \\r\\n                  THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) \\r\\n                  ELSE 0 END * 0.10) +                                              -- 10% (mantido)\\r\\n                (COALESCE(ccs.indice_risco_ccs, 0) * 0.15)                          -- 15% (NOVO - CCS)\\r\\n            , 2)\\r\\n        ELSE\\r\\n            -- Vers\\u00e3o sem C115 mas com CCS (7 fatores)\\r\\n            ROUND(\\r\\n                (COALESCE(i.total_incons, 0) * 0.22) +                              -- 22% (antes 25%)\\r\\n                (COALESCE(i.total_cadastro, 0) * 0.08) +                            -- 8%  (antes 10%)\\r\\n                (COALESCE(i.indice_interconexao, 0) * 10 * 0.22) +                  -- 22% (antes 25%)\\r\\n                (COALESCE(ind.indice_risco_indicios, 0) * 20 * 0.13) +              -- 13% (antes 15%)\\r\\n                (CASE WHEN COALESCE(pag.valor_meios_pagamento_empresas, 0) > 0 \\r\\n                  THEN ROUND(COALESCE(pag.valor_meios_pagamento_socios, 0) / pag.valor_meios_pagamento_empresas, 4) \\r\\n                  ELSE 0 END * 0.12) +                                              -- 12% (antes 15%)\\r\\n                (CASE WHEN COALESCE(maximos.valor_max, 0) > 0 AND (COALESCE(func.total_funcionarios, 0) + 1) > 0 \\r\\n                  THEN (1 - (1 / (COALESCE(maximos.valor_max,0) / (COALESCE(func.total_funcionarios, 0) + 1) / 100000))) \\r\\n                  ELSE 0 END * 0.08) +                                              -- 8%  (antes 10%)\\r\\n                (COALESCE(ccs.indice_risco_ccs, 0) * 0.15)                          -- 15% (NOVO - CCS)\\r\\n            , 2)\\r\\n    END AS score_final_ccs\\r\\n\\r\\nFROM gessimples.gei_percent_intermediario i\\r\\nLEFT JOIN primeiro_excesso ON i.num_grupo = primeiro_excesso.num_grupo\\r\\nLEFT JOIN maximos ON i.num_grupo = maximos.num_grupo\\r\\nLEFT JOIN c115_ranking rk ON i.num_grupo = rk.num_grupo\\r\\nLEFT JOIN c115_metricas mg ON i.num_grupo = mg.num_grupo\\r\\nLEFT JOIN gessimples.gei_indicios_metricas_grupo ind ON i.num_grupo = ind.num_grupo\\r\\nLEFT JOIN gessimples.gei_pagamentos_metricas_grupo pag ON i.num_grupo = pag.num_grupo\\r\\nLEFT JOIN gessimples.gei_funcionarios_metricas_grupo func ON i.num_grupo = func.num_grupo\\r\\n-- ============================================================================\\r\\n-- >> NOVOS JOINS COM CCS \\r\\n-- ============================================================================\\r\\nLEFT JOIN gessimples.gei_ccs_metricas_grupo ccs ON i.num_grupo = ccs.num_grupo\\r\\nLEFT JOIN gessimples.gei_ccs_ranking_risco ccs_rk ON i.num_grupo = ccs_rk.num_grupo\\r\\n\\r\\nORDER BY \\r\\n    score_final_ccs DESC,\\r\\n    score_final_avancado DESC,\\r\\n    score_final_completo DESC\\r\\nLIMIT 10000;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 337, \"column\": 12}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query df42bc10ae8fbeaa:93f10d8900000000 100% Complete (2083 out of 2083)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"df42bc10ae8fbeaa:93f10d8900000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=df42bc10ae8fbeaa:93f10d8900000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query df42bc10ae8fbeaa:93f10d8900000000 100% Complete (2083 out of 2083)\", \"progress\": 100, \"jobs\": [{\"name\": \"df42bc10ae8fbeaa:93f10d8900000000\", \"url\": \"/hue/jobbrowser#!id=df42bc10ae8fbeaa:93f10d8900000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 12754, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 222, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- Parte 2: Processamento dos dados do PGDAS + DIME e criaÃ§Ã£o da tabela final\r\nDROP TABLE IF EXISTS gessimples.gei_percent;\r\nSET REQUEST_POOL = 'default';\r\nSET MEM_LIMIT = 20G;\r\n\r\nCREATE TABLE gessimples.gei_percent AS\r\nWITH faturamento_consolidado AS (\r\n    -- ============================================================================\r\n    -- >> CONSOLIDAÃÃO PGDAS + DIME (NOVO)\r\n    -- ============================================================================\r\n    -- Dados do PGDAS (Simples Nacional)\r\n    SELECT\r\n        gc.num_grupo,\r\n        gc.cnpj,\r\n        COALESCE(pg.jan2021, 0) AS jan2021, COALESCE(pg.fev2021, 0) AS fev2021, COALESCE(pg.mar2021, 0) AS mar2021,\r\n        COALESCE(pg.abr2021, 0) AS abr2021, COALESCE(pg.mai2021, 0) AS mai2021, COALESCE(pg.jun2021, 0) AS jun2021,\r\n        COALESCE(pg.jul2021, 0) AS jul2021, COALESCE(pg.ago2021, 0) AS ago2021, COALESCE(pg.set2021, 0) AS set2021,\r\n        COALESCE(pg.out2021, 0) AS out2021, COALESCE(pg.nov2021, 0) AS nov2021, COALESCE(pg.dez2021, 0) AS dez2021,\r\n        COALESCE(pg.jan2022, 0) AS jan2022, COALESCE(pg.fev2022, 0) AS fev2022, COALESCE(pg.mar2022, 0) AS mar2022,\r\n        COALESCE(pg.abr2022, 0) AS abr2022, COALESCE(pg.mai2022, 0) AS mai2022, COALESCE(pg.jun2022, 0) AS jun2022,\r\n        COALESCE(pg.jul2022, 0) AS jul2022, COALESCE(pg.ago2022, 0) AS ago2022, COALESCE(pg.set2022, 0) AS set2022,\r\n        COALESCE(pg.out2022, 0) AS out2022, COALESCE(pg.nov2022, 0) AS nov2022, COALESCE(pg.dez2022, 0) AS dez2022,\r\n        COALESCE(pg.jan2023, 0) AS jan2023, COALESCE(pg.fev2023, 0) AS fev2023, COALESCE(pg.mar2023, 0) AS mar2023,\r\n        COALESCE(pg.abr2023, 0) AS abr2023, COALESCE(pg.mai2023, 0) AS mai2023, COALESCE(pg.jun2023, 0) AS jun2023,\r\n        COALESCE(pg.jul2023, 0) AS jul2023, COALESCE(pg.ago2023, 0) AS ago2023, COALESCE(pg.set2023, 0) AS set2023,\r\n        COALESCE(pg.out2023, 0) AS out2023, COALESCE(pg.nov2023, 0) AS nov2023, COALESCE(pg.dez2023, 0) AS dez2023,\r\n        COALESCE(pg.jan2024, 0) ",
    "last_modified": "2025-12-10T16:52:04.274",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 116515,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: C115",
    "description": "",
    "uuid": "5ad40b89-f0c8-c1a6-dfa6-dc55f75e9134",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 116515, \"uuid\": \"5ad40b89-f0c8-c1a6-dfa6-dc55f75e9134\", \"name\": \"GEI: C115\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"5ad40b89-f0c8-c1a6-dfa6-dc55f75e9134\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"8ee71f19-8b81-10d4-8cf9-96710fc5c197\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"c115\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ========================================================================\\r\\n-- PARTE 1: Cria\\u00e7\\u00e3o da tabela base de relacionamentos entre CNPJs e seus identificadores\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_c115_identificadores;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_c115_identificadores AS\\r\\nWITH empresas_identificadores AS (\\r\\n    SELECT \\r\\n        g.num_grupo,\\r\\n        g.cnpj AS cnpj_emitente,\\r\\n        c.nu_cnpj_cpf_tomador AS cnpj_tomador,\\r\\n        c.nm_razao_social_tomador,\\r\\n        c.nm_municipio,\\r\\n        c.cd_uf,\\r\\n        c.nu_tel_contato,\\r\\n        c.nu_identificador_tomador,\\r\\n        c.nu_tel_ou_unidade_consumidora,\\r\\n        c.dt_emissao\\r\\n    FROM \\r\\n        gessimples.gei_cnpj g\\r\\n    JOIN \\r\\n        c115.c115_dados_cadastrais_dest c ON g.cnpj = c.nu_cnpj_cpf_tomador\\r\\n    WHERE \\r\\n        c.nu_cnpj_cpf_tomador IS NOT NULL \\r\\n        AND c.nu_cnpj_cpf_tomador != 'ISENTO'\\r\\n)\\r\\nSELECT * FROM empresas_identificadores;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 2: Identifica\\u00e7\\u00e3o de telefones de contato compartilhados\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_c115_tel_contato_compartilhado;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_c115_tel_contato_compartilhado AS\\r\\nWITH tel_contato_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nu_tel_contato,\\r\\n        COUNT(DISTINCT cnpj_tomador) AS qtd_tomadores_distintos\\r\\n    FROM\\r\\n        gessimples.gei_c115_identificadores\\r\\n    WHERE \\r\\n        nu_tel_contato IS NOT NULL\\r\\n        AND nu_tel_contato != 'NULL'\\r\\n    GROUP BY\\r\\n        num_grupo, nu_tel_contato\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj_tomador) > 1\\r\\n)\\r\\nSELECT\\r\\n    tc.num_grupo,\\r\\n    tc.nu_tel_contato,\\r\\n    tc.qtd_tomadores_distintos,\\r\\n    i.cnpj_tomador,\\r\\n    i.nm_razao_social_tomador,\\r\\n    i.cnpj_emitente,\\r\\n    i.nm_municipio,\\r\\n    i.cd_uf,\\r\\n    COUNT(*) AS qtd_documentos,\\r\\n    MIN(i.dt_emissao) AS primeira_operacao,\\r\\n    MAX(i.dt_emissao) AS ultima_operacao\\r\\nFROM\\r\\n    tel_contato_count tc\\r\\nJOIN\\r\\n    gessimples.gei_c115_identificadores i\\r\\n    ON tc.num_grupo = i.num_grupo \\r\\n    AND tc.nu_tel_contato = i.nu_tel_contato\\r\\nGROUP BY\\r\\n    tc.num_grupo,\\r\\n    tc.nu_tel_contato,\\r\\n    tc.qtd_tomadores_distintos,\\r\\n    i.cnpj_tomador,\\r\\n    i.nm_razao_social_tomador,\\r\\n    i.cnpj_emitente,\\r\\n    i.nm_municipio,\\r\\n    i.cd_uf;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 3: Identifica\\u00e7\\u00e3o de identificadores de tomador compartilhados\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_c115_identificador_tomador_compartilhado;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_c115_identificador_tomador_compartilhado AS\\r\\nWITH identificador_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nu_identificador_tomador,\\r\\n        COUNT(DISTINCT cnpj_tomador) AS qtd_tomadores_distintos\\r\\n    FROM\\r\\n        gessimples.gei_c115_identificadores\\r\\n    WHERE \\r\\n        nu_identificador_tomador IS NOT NULL\\r\\n        AND nu_identificador_tomador != 'NULL'\\r\\n    GROUP BY\\r\\n        num_grupo, nu_identificador_tomador\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj_tomador) > 1\\r\\n)\\r\\nSELECT\\r\\n    ic.num_grupo,\\r\\n    ic.nu_identificador_tomador,\\r\\n    ic.qtd_tomadores_distintos,\\r\\n    i.cnpj_tomador,\\r\\n    i.nm_razao_social_tomador,\\r\\n    i.cnpj_emitente,\\r\\n    i.nm_municipio,\\r\\n    i.cd_uf,\\r\\n    COUNT(*) AS qtd_documentos,\\r\\n    MIN(i.dt_emissao) AS primeira_operacao,\\r\\n    MAX(i.dt_emissao) AS ultima_operacao\\r\\nFROM\\r\\n    identificador_count ic\\r\\nJOIN\\r\\n    gessimples.gei_c115_identificadores i\\r\\n    ON ic.num_grupo = i.num_grupo \\r\\n    AND ic.nu_identificador_tomador = i.nu_identificador_tomador\\r\\nGROUP BY\\r\\n    ic.num_grupo,\\r\\n    ic.nu_identificador_tomador,\\r\\n    ic.qtd_tomadores_distintos,\\r\\n    i.cnpj_tomador,\\r\\n    i.nm_razao_social_tomador,\\r\\n    i.cnpj_emitente,\\r\\n    i.nm_municipio,\\r\\n    i.cd_uf;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 4: Identifica\\u00e7\\u00e3o de telefones/unidades consumidoras compartilhados\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_c115_tel_unidade_compartilhado;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_c115_tel_unidade_compartilhado AS\\r\\nWITH tel_unidade_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nu_tel_ou_unidade_consumidora,\\r\\n        COUNT(DISTINCT cnpj_tomador) AS qtd_tomadores_distintos\\r\\n    FROM\\r\\n        gessimples.gei_c115_identificadores\\r\\n    WHERE \\r\\n        nu_tel_ou_unidade_consumidora IS NOT NULL\\r\\n        AND nu_tel_ou_unidade_consumidora != 'NULL'\\r\\n    GROUP BY\\r\\n        num_grupo, nu_tel_ou_unidade_consumidora\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj_tomador) > 1\\r\\n)\\r\\nSELECT\\r\\n    tuc.num_grupo,\\r\\n    tuc.nu_tel_ou_unidade_consumidora,\\r\\n    tuc.qtd_tomadores_distintos,\\r\\n    i.cnpj_tomador,\\r\\n    i.nm_razao_social_tomador,\\r\\n    i.cnpj_emitente,\\r\\n    i.nm_municipio,\\r\\n    i.cd_uf,\\r\\n    COUNT(*) AS qtd_documentos,\\r\\n    MIN(i.dt_emissao) AS primeira_operacao,\\r\\n    MAX(i.dt_emissao) AS ultima_operacao\\r\\nFROM\\r\\n    tel_unidade_count tuc\\r\\nJOIN\\r\\n    gessimples.gei_c115_identificadores i\\r\\n    ON tuc.num_grupo = i.num_grupo \\r\\n    AND tuc.nu_tel_ou_unidade_consumidora = i.nu_tel_ou_unidade_consumidora\\r\\nGROUP BY\\r\\n    tuc.num_grupo,\\r\\n    tuc.nu_tel_ou_unidade_consumidora,\\r\\n    tuc.qtd_tomadores_distintos,\\r\\n    i.cnpj_tomador,\\r\\n    i.nm_razao_social_tomador,\\r\\n    i.cnpj_emitente,\\r\\n    i.nm_municipio,\\r\\n    i.cd_uf;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 5: Consolida\\u00e7\\u00e3o de m\\u00e9tricas por grupo e CNPJ tomador\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_c115_metricas_identificadores;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_c115_metricas_identificadores AS\\r\\nWITH cnpjs_por_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        cnpj_tomador,\\r\\n        COUNT(DISTINCT nu_tel_contato) AS qtd_tel_contato,\\r\\n        COUNT(DISTINCT nu_identificador_tomador) AS qtd_identificadores,\\r\\n        COUNT(DISTINCT nu_tel_ou_unidade_consumidora) AS qtd_tel_unidade\\r\\n    FROM\\r\\n        gessimples.gei_c115_identificadores\\r\\n    WHERE \\r\\n        (nu_tel_contato IS NOT NULL AND nu_tel_contato != 'NULL') OR\\r\\n        (nu_identificador_tomador IS NOT NULL AND nu_identificador_tomador != 'NULL') OR\\r\\n        (nu_tel_ou_unidade_consumidora IS NOT NULL AND nu_tel_ou_unidade_consumidora != 'NULL')\\r\\n    GROUP BY\\r\\n        num_grupo, cnpj_tomador\\r\\n),\\r\\ntel_contato_shared AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        cnpj_tomador,\\r\\n        COUNT(DISTINCT nu_tel_contato) AS qtd_tel_contato_compartilhados\\r\\n    FROM\\r\\n        gessimples.gei_c115_tel_contato_compartilhado\\r\\n    GROUP BY\\r\\n        num_grupo, cnpj_tomador\\r\\n),\\r\\nidentificador_shared AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        cnpj_tomador,\\r\\n        COUNT(DISTINCT nu_identificador_tomador) AS qtd_identificadores_compartilhados\\r\\n    FROM\\r\\n        gessimples.gei_c115_identificador_tomador_compartilhado\\r\\n    GROUP BY\\r\\n        num_grupo, cnpj_tomador\\r\\n),\\r\\ntel_unidade_shared AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        cnpj_tomador,\\r\\n        COUNT(DISTINCT nu_tel_ou_unidade_consumidora) AS qtd_tel_unidade_compartilhados\\r\\n    FROM\\r\\n        gessimples.gei_c115_tel_unidade_compartilhado\\r\\n    GROUP BY\\r\\n        num_grupo, cnpj_tomador\\r\\n)\\r\\nSELECT\\r\\n    c.num_grupo,\\r\\n    c.cnpj_tomador,\\r\\n    MAX(i.nm_razao_social_tomador) AS razao_social_tomador,\\r\\n    c.qtd_tel_contato,\\r\\n    COALESCE(tc.qtd_tel_contato_compartilhados, 0) AS qtd_tel_contato_compartilhados,\\r\\n    c.qtd_identificadores,\\r\\n    COALESCE(id.qtd_identificadores_compartilhados, 0) AS qtd_identificadores_compartilhados,\\r\\n    c.qtd_tel_unidade,\\r\\n    COALESCE(tu.qtd_tel_unidade_compartilhados, 0) AS qtd_tel_unidade_compartilhados,\\r\\n    (\\r\\n        CASE WHEN COALESCE(tc.qtd_tel_contato_compartilhados, 0) > 0 THEN 1 ELSE 0 END +\\r\\n        CASE WHEN COALESCE(id.qtd_identificadores_compartilhados, 0) > 0 THEN 1 ELSE 0 END +\\r\\n        CASE WHEN COALESCE(tu.qtd_tel_unidade_compartilhados, 0) > 0 THEN 1 ELSE 0 END\\r\\n    ) AS qtd_tipos_identificadores_compartilhados\\r\\nFROM\\r\\n    cnpjs_por_grupo c\\r\\nLEFT JOIN\\r\\n    tel_contato_shared tc ON c.num_grupo = tc.num_grupo AND c.cnpj_tomador = tc.cnpj_tomador\\r\\nLEFT JOIN\\r\\n    identificador_shared id ON c.num_grupo = id.num_grupo AND c.cnpj_tomador = id.cnpj_tomador\\r\\nLEFT JOIN\\r\\n    tel_unidade_shared tu ON c.num_grupo = tu.num_grupo AND c.cnpj_tomador = tu.cnpj_tomador\\r\\nLEFT JOIN\\r\\n    gessimples.gei_c115_identificadores i ON c.num_grupo = i.num_grupo AND c.cnpj_tomador = i.cnpj_tomador\\r\\nGROUP BY\\r\\n    c.num_grupo,\\r\\n    c.cnpj_tomador,\\r\\n    c.qtd_tel_contato,\\r\\n    tc.qtd_tel_contato_compartilhados,\\r\\n    c.qtd_identificadores,\\r\\n    id.qtd_identificadores_compartilhados,\\r\\n    c.qtd_tel_unidade,\\r\\n    tu.qtd_tel_unidade_compartilhados;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 6: Consolida\\u00e7\\u00e3o de m\\u00e9tricas gerais por grupo\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_c115_metricas_grupos;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_c115_metricas_grupos AS\\r\\nWITH grupo_cnpj_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs\\r\\n    FROM\\r\\n        gessimples.gei_cnpj\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ntomadores_por_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj_tomador) AS total_tomadores,\\r\\n        COUNT(DISTINCT CASE WHEN qtd_tipos_identificadores_compartilhados > 0 THEN cnpj_tomador END) AS tomadores_com_compartilhamento,\\r\\n        COUNT(DISTINCT CASE WHEN qtd_tipos_identificadores_compartilhados > 1 THEN cnpj_tomador END) AS tomadores_com_multiplos_compartilhamentos,\\r\\n        SUM(qtd_tipos_identificadores_compartilhados) AS total_compartilhamentos\\r\\n    FROM\\r\\n        gessimples.gei_c115_metricas_identificadores\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n)\\r\\nSELECT\\r\\n    g.num_grupo,\\r\\n    g.total_cnpjs,\\r\\n    COALESCE(t.total_tomadores, 0) AS total_tomadores,\\r\\n    COALESCE(t.tomadores_com_compartilhamento, 0) AS tomadores_com_compartilhamento,\\r\\n    COALESCE(t.tomadores_com_multiplos_compartilhamentos, 0) AS tomadores_com_multiplos_compartilhamentos,\\r\\n    COALESCE(t.total_compartilhamentos, 0) AS total_compartilhamentos,\\r\\n    CASE \\r\\n        WHEN COALESCE(t.total_tomadores, 0) > 0 THEN \\r\\n            ROUND(COALESCE(t.tomadores_com_compartilhamento, 0) * 100.0 / t.total_tomadores, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_tomadores_com_compartilhamento,\\r\\n    CASE\\r\\n        WHEN g.total_cnpjs > 1 AND COALESCE(t.total_tomadores, 0) > 0 THEN\\r\\n            ROUND(COALESCE(t.total_compartilhamentos, 0) * 1.0 / (g.total_cnpjs * t.total_tomadores), 4) * 100\\r\\n        ELSE 0\\r\\n    END AS indice_risco_grupo_economico\\r\\nFROM\\r\\n    grupo_cnpj_count g\\r\\nLEFT JOIN\\r\\n    tomadores_por_grupo t ON g.num_grupo = t.num_grupo;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 7: View para pares de CNPJs com identificadores compartilhados\\r\\n-- ========================================================================\\r\\nDROP VIEW IF EXISTS gessimples.gei_c115_pares_cnpjs_relacionados;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE VIEW gessimples.gei_c115_pares_cnpjs_relacionados AS\\r\\nWITH pares_tel_contato AS (\\r\\n    SELECT\\r\\n        t1.num_grupo,\\r\\n        t1.cnpj_tomador AS cnpj1,\\r\\n        t2.cnpj_tomador AS cnpj2,\\r\\n        COUNT(DISTINCT t1.nu_tel_contato) AS qtd_tel_contato_comuns\\r\\n    FROM \\r\\n        gessimples.gei_c115_tel_contato_compartilhado t1\\r\\n    JOIN \\r\\n        gessimples.gei_c115_tel_contato_compartilhado t2\\r\\n        ON t1.num_grupo = t2.num_grupo\\r\\n        AND t1.nu_tel_contato = t2.nu_tel_contato\\r\\n        AND t1.cnpj_tomador < t2.cnpj_tomador\\r\\n    GROUP BY\\r\\n        t1.num_grupo, t1.cnpj_tomador, t2.cnpj_tomador\\r\\n),\\r\\npares_identificador AS (\\r\\n    SELECT\\r\\n        i1.num_grupo,\\r\\n        i1.cnpj_tomador AS cnpj1,\\r\\n        i2.cnpj_tomador AS cnpj2,\\r\\n        COUNT(DISTINCT i1.nu_identificador_tomador) AS qtd_identificadores_comuns\\r\\n    FROM \\r\\n        gessimples.gei_c115_identificador_tomador_compartilhado i1\\r\\n    JOIN \\r\\n        gessimples.gei_c115_identificador_tomador_compartilhado i2\\r\\n        ON i1.num_grupo = i2.num_grupo\\r\\n        AND i1.nu_identificador_tomador = i2.nu_identificador_tomador\\r\\n        AND i1.cnpj_tomador < i2.cnpj_tomador\\r\\n    GROUP BY\\r\\n        i1.num_grupo, i1.cnpj_tomador, i2.cnpj_tomador\\r\\n),\\r\\npares_tel_unidade AS (\\r\\n    SELECT\\r\\n        u1.num_grupo,\\r\\n        u1.cnpj_tomador AS cnpj1,\\r\\n        u2.cnpj_tomador AS cnpj2,\\r\\n        COUNT(DISTINCT u1.nu_tel_ou_unidade_consumidora) AS qtd_tel_unidade_comuns\\r\\n    FROM \\r\\n        gessimples.gei_c115_tel_unidade_compartilhado u1\\r\\n    JOIN \\r\\n        gessimples.gei_c115_tel_unidade_compartilhado u2\\r\\n        ON u1.num_grupo = u2.num_grupo\\r\\n        AND u1.nu_tel_ou_unidade_consumidora = u2.nu_tel_ou_unidade_consumidora\\r\\n        AND u1.cnpj_tomador < u2.cnpj_tomador\\r\\n    GROUP BY\\r\\n        u1.num_grupo, u1.cnpj_tomador, u2.cnpj_tomador\\r\\n),\\r\\ntodos_pares AS (\\r\\n    SELECT \\r\\n        COALESCE(pt.num_grupo, pi.num_grupo, pu.num_grupo) AS num_grupo,\\r\\n        COALESCE(pt.cnpj1, pi.cnpj1, pu.cnpj1) AS cnpj1,\\r\\n        COALESCE(pt.cnpj2, pi.cnpj2, pu.cnpj2) AS cnpj2,\\r\\n        COALESCE(pt.qtd_tel_contato_comuns, 0) AS qtd_tel_contato_comuns,\\r\\n        COALESCE(pi.qtd_identificadores_comuns, 0) AS qtd_identificadores_comuns,\\r\\n        COALESCE(pu.qtd_tel_unidade_comuns, 0) AS qtd_tel_unidade_comuns\\r\\n    FROM \\r\\n        pares_tel_contato pt\\r\\n    FULL OUTER JOIN \\r\\n        pares_identificador pi \\r\\n        ON pt.num_grupo = pi.num_grupo AND pt.cnpj1 = pi.cnpj1 AND pt.cnpj2 = pi.cnpj2\\r\\n    FULL OUTER JOIN \\r\\n        pares_tel_unidade pu \\r\\n        ON COALESCE(pt.num_grupo, pi.num_grupo) = pu.num_grupo \\r\\n        AND COALESCE(pt.cnpj1, pi.cnpj1) = pu.cnpj1 \\r\\n        AND COALESCE(pt.cnpj2, pi.cnpj2) = pu.cnpj2\\r\\n)\\r\\nSELECT\\r\\n    tp.num_grupo,\\r\\n    tp.cnpj1,\\r\\n    MAX(i1.nm_razao_social_tomador) AS razao_social1,\\r\\n    tp.cnpj2,\\r\\n    MAX(i2.nm_razao_social_tomador) AS razao_social2,\\r\\n    tp.qtd_tel_contato_comuns,\\r\\n    tp.qtd_identificadores_comuns,\\r\\n    tp.qtd_tel_unidade_comuns,\\r\\n    (tp.qtd_tel_contato_comuns + tp.qtd_identificadores_comuns + tp.qtd_tel_unidade_comuns) AS total_identificadores_comuns,\\r\\n    CASE \\r\\n        WHEN tp.qtd_tel_contato_comuns > 0 THEN 1 ELSE 0 \\r\\n    END +\\r\\n    CASE \\r\\n        WHEN tp.qtd_identificadores_comuns > 0 THEN 1 ELSE 0 \\r\\n    END +\\r\\n    CASE \\r\\n        WHEN tp.qtd_tel_unidade_comuns > 0 THEN 1 ELSE 0 \\r\\n    END AS qtd_tipos_identificadores_comuns\\r\\nFROM\\r\\n    todos_pares tp\\r\\nLEFT JOIN\\r\\n    gessimples.gei_c115_identificadores i1 ON tp.num_grupo = i1.num_grupo AND tp.cnpj1 = i1.cnpj_tomador\\r\\nLEFT JOIN\\r\\n    gessimples.gei_c115_identificadores i2 ON tp.num_grupo = i2.num_grupo AND tp.cnpj2 = i2.cnpj_tomador\\r\\nGROUP BY\\r\\n    tp.num_grupo,\\r\\n    tp.cnpj1,\\r\\n    tp.cnpj2,\\r\\n    tp.qtd_tel_contato_comuns,\\r\\n    tp.qtd_identificadores_comuns,\\r\\n    tp.qtd_tel_unidade_comuns;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 8: Ranking de grupos por risco de forma\\u00e7\\u00e3o de grupo econ\\u00f4mico (VERS\\u00c3O CORRIGIDA)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_c115_ranking_risco_grupo_economico;\\r\\nSET REQUEST_POOL = 'medium';\\r\\nSET MEM_LIMIT = 8g;\\r\\nSET QUERY_TIMEOUT_S = 3600;\\r\\n\\r\\nCREATE TABLE gessimples.gei_c115_ranking_risco_grupo_economico AS\\r\\nWITH cnpjs_relacionados_por_grupo AS (\\r\\n    -- ETAPA CORRIGIDA: Contagem correta de CNPJs \\u00fanicos envolvidos em relacionamentos.\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_relacionados\\r\\n    FROM (\\r\\n        SELECT num_grupo, cnpj1 AS cnpj FROM gessimples.gei_c115_pares_cnpjs_relacionados\\r\\n        UNION\\r\\n        SELECT num_grupo, cnpj2 AS cnpj FROM gessimples.gei_c115_pares_cnpjs_relacionados\\r\\n    ) all_cnpjs\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\nmetricas_pares AS (\\r\\n    -- Consolida as m\\u00e9tricas dos pares de CNPJs por grupo\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        MAX(qtd_tipos_identificadores_comuns) AS max_tipos_identificadores_comuns,\\r\\n        MAX(total_identificadores_comuns) AS max_total_identificadores_comuns,\\r\\n        SUM(CASE WHEN qtd_tipos_identificadores_comuns = 3 THEN 1 ELSE 0 END) AS pares_com_tres_tipos_comum,\\r\\n        SUM(CASE WHEN qtd_tipos_identificadores_comuns >= 2 THEN 1 ELSE 0 END) AS pares_com_dois_ou_mais_tipos_comum\\r\\n    FROM\\r\\n        gessimples.gei_c115_pares_cnpjs_relacionados\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ndetalhes_grupos AS (\\r\\n    -- Junta as m\\u00e9tricas de grupo com as novas m\\u00e9tricas corrigidas\\r\\n    SELECT\\r\\n        m.num_grupo,\\r\\n        m.total_cnpjs,\\r\\n        m.total_tomadores,\\r\\n        m.tomadores_com_compartilhamento,\\r\\n        m.tomadores_com_multiplos_compartilhamentos,\\r\\n        m.total_compartilhamentos,\\r\\n        m.perc_tomadores_com_compartilhamento,\\r\\n        m.indice_risco_grupo_economico,\\r\\n        COALESCE(cr.qtd_cnpjs_relacionados, 0) AS qtd_cnpjs_relacionados, -- Usa a contagem correta\\r\\n        COALESCE(mp.max_tipos_identificadores_comuns, 0) AS max_tipos_identificadores_comuns,\\r\\n        COALESCE(mp.max_total_identificadores_comuns, 0) AS max_total_identificadores_comuns,\\r\\n        COALESCE(mp.pares_com_tres_tipos_comum, 0) AS pares_com_tres_tipos_comum,\\r\\n        COALESCE(mp.pares_com_dois_ou_mais_tipos_comum, 0) AS pares_com_dois_ou_mais_tipos_comum\\r\\n    FROM\\r\\n        gessimples.gei_c115_metricas_grupos m\\r\\n    LEFT JOIN\\r\\n        cnpjs_relacionados_por_grupo cr ON m.num_grupo = cr.num_grupo\\r\\n    LEFT JOIN\\r\\n        metricas_pares mp ON m.num_grupo = mp.num_grupo\\r\\n)\\r\\n-- Sele\\u00e7\\u00e3o final para criar a tabela de ranking\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    RANK() OVER(ORDER BY indice_risco_grupo_economico DESC, qtd_cnpjs_relacionados DESC) AS ranking_risco,\\r\\n    indice_risco_grupo_economico,\\r\\n    total_cnpjs,\\r\\n    qtd_cnpjs_relacionados,\\r\\n    CASE \\r\\n        WHEN total_cnpjs > 0 THEN \\r\\n            ROUND(qtd_cnpjs_relacionados * 100.0 / total_cnpjs, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_cnpjs_relacionados,\\r\\n    total_tomadores,\\r\\n    tomadores_com_compartilhamento,\\r\\n    tomadores_com_multiplos_compartilhamentos,\\r\\n    perc_tomadores_com_compartilhamento,\\r\\n    total_compartilhamentos,\\r\\n    max_tipos_identificadores_comuns,\\r\\n    max_total_identificadores_comuns,\\r\\n    pares_com_tres_tipos_comum,\\r\\n    pares_com_dois_ou_mais_tipos_comum,\\r\\n    CASE\\r\\n        WHEN indice_risco_grupo_economico >= 25 AND max_tipos_identificadores_comuns = 3 THEN 'CR\\u00cdTICO'\\r\\n        WHEN indice_risco_grupo_economico >= 15 OR (max_tipos_identificadores_comuns >= 2 AND pares_com_dois_ou_mais_tipos_comum >= 3) THEN 'ALTO'\\r\\n        WHEN indice_risco_grupo_economico >= 5 OR max_tipos_identificadores_comuns >= 2 THEN 'M\\u00c9DIO'\\r\\n        WHEN indice_risco_grupo_economico > 0 THEN 'BAIXO'\\r\\n        ELSE 'INEXISTENTE'\\r\\n    END AS nivel_risco_grupo_economico\\r\\nFROM\\r\\n    detalhes_grupos;\", \"statementsList\": [\"-- ========================================================================\\r\\n-- PARTE 1: Cria\\u00e7\\u00e3o da tabela base de relacionamentos entre CNPJs e seus identificadores\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_c115_identificadores;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_c115_identificadores AS\\r\\nWITH empresas_identificadores AS (\\r\\n    SELECT \\r\\n        g.num_grupo,\\r\\n        g.cnpj AS cnpj_emitente,\\r\\n        c.nu_cnpj_cpf_tomador AS cnpj_tomador,\\r\\n        c.nm_razao_social_tomador,\\r\\n        c.nm_municipio,\\r\\n        c.cd_uf,\\r\\n        c.nu_tel_contato,\\r\\n        c.nu_identificador_tomador,\\r\\n        c.nu_tel_ou_unidade_consumidora,\\r\\n        c.dt_emissao\\r\\n    FROM \\r\\n        gessimples.gei_cnpj g\\r\\n    JOIN \\r\\n        c115.c115_dados_cadastrais_dest c ON g.cnpj = c.nu_cnpj_cpf_tomador\\r\\n    WHERE \\r\\n        c.nu_cnpj_cpf_tomador IS NOT NULL \\r\\n        AND c.nu_cnpj_cpf_tomador != 'ISENTO'\\r\\n)\\r\\nSELECT * FROM empresas_identificadores;\", \"\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 2: Identifica\\u00e7\\u00e3o de telefones de contato compartilhados\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_c115_tel_contato_compartilhado;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_c115_tel_contato_compartilhado AS\\r\\nWITH tel_contato_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nu_tel_contato,\\r\\n        COUNT(DISTINCT cnpj_tomador) AS qtd_tomadores_distintos\\r\\n    FROM\\r\\n        gessimples.gei_c115_identificadores\\r\\n    WHERE \\r\\n        nu_tel_contato IS NOT NULL\\r\\n        AND nu_tel_contato != 'NULL'\\r\\n    GROUP BY\\r\\n        num_grupo, nu_tel_contato\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj_tomador) > 1\\r\\n)\\r\\nSELECT\\r\\n    tc.num_grupo,\\r\\n    tc.nu_tel_contato,\\r\\n    tc.qtd_tomadores_distintos,\\r\\n    i.cnpj_tomador,\\r\\n    i.nm_razao_social_tomador,\\r\\n    i.cnpj_emitente,\\r\\n    i.nm_municipio,\\r\\n    i.cd_uf,\\r\\n    COUNT(*) AS qtd_documentos,\\r\\n    MIN(i.dt_emissao) AS primeira_operacao,\\r\\n    MAX(i.dt_emissao) AS ultima_operacao\\r\\nFROM\\r\\n    tel_contato_count tc\\r\\nJOIN\\r\\n    gessimples.gei_c115_identificadores i\\r\\n    ON tc.num_grupo = i.num_grupo \\r\\n    AND tc.nu_tel_contato = i.nu_tel_contato\\r\\nGROUP BY\\r\\n    tc.num_grupo,\\r\\n    tc.nu_tel_contato,\\r\\n    tc.qtd_tomadores_distintos,\\r\\n    i.cnpj_tomador,\\r\\n    i.nm_razao_social_tomador,\\r\\n    i.cnpj_emitente,\\r\\n    i.nm_municipio,\\r\\n    i.cd_uf;\", \"\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 3: Identifica\\u00e7\\u00e3o de identificadores de tomador compartilhados\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_c115_identificador_tomador_compartilhado;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_c115_identificador_tomador_compartilhado AS\\r\\nWITH identificador_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nu_identificador_tomador,\\r\\n        COUNT(DISTINCT cnpj_tomador) AS qtd_tomadores_distintos\\r\\n    FROM\\r\\n        gessimples.gei_c115_identificadores\\r\\n    WHERE \\r\\n        nu_identificador_tomador IS NOT NULL\\r\\n        AND nu_identificador_tomador != 'NULL'\\r\\n    GROUP BY\\r\\n        num_grupo, nu_identificador_tomador\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj_tomador) > 1\\r\\n)\\r\\nSELECT\\r\\n    ic.num_grupo,\\r\\n    ic.nu_identificador_tomador,\\r\\n    ic.qtd_tomadores_distintos,\\r\\n    i.cnpj_tomador,\\r\\n    i.nm_razao_social_tomador,\\r\\n    i.cnpj_emitente,\\r\\n    i.nm_municipio,\\r\\n    i.cd_uf,\\r\\n    COUNT(*) AS qtd_documentos,\\r\\n    MIN(i.dt_emissao) AS primeira_operacao,\\r\\n    MAX(i.dt_emissao) AS ultima_operacao\\r\\nFROM\\r\\n    identificador_count ic\\r\\nJOIN\\r\\n    gessimples.gei_c115_identificadores i\\r\\n    ON ic.num_grupo = i.num_grupo \\r\\n    AND ic.nu_identificador_tomador = i.nu_identificador_tomador\\r\\nGROUP BY\\r\\n    ic.num_grupo,\\r\\n    ic.nu_identificador_tomador,\\r\\n    ic.qtd_tomadores_distintos,\\r\\n    i.cnpj_tomador,\\r\\n    i.nm_razao_social_tomador,\\r\\n    i.cnpj_emitente,\\r\\n    i.nm_municipio,\\r\\n    i.cd_uf;\", \"\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 4: Identifica\\u00e7\\u00e3o de telefones/unidades consumidoras compartilhados\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_c115_tel_unidade_compartilhado;\", \"\\r\\nSET REQUEST_POOL = 'medium';\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ========================================================================\\r\\n-- PARTE 1: Cria\\u00e7\\u00e3o da tabela base de relacionamentos entre CNPJs e seus identificadores\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_c115_identificadores;\", \"result\": {\"id\": \"e38e9d6b-1a42-69fb-231a-fdfdf39d0667\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"3wUOdwUCRCivYBwx1afSHQ==\", \"guid\": \"dNggIFM0STMAAAAAp+ITnw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"3345bfd907de2a28:b9695806e7b0bb9c\", \"session_id\": 20613, \"session_type\": \"impala\", \"statement_id\": 25, \"has_more_statements\": false, \"statements_count\": 26, \"previous_statement_hash\": \"eca528bcb58ef4cc4a11d5185e644270c4b860218e4a535fd1eb0b2e\", \"start\": {\"row\": 432, \"column\": 0}, \"end\": {\"row\": 511, \"column\": 19}, \"statement\": \"CREATE TABLE gessimples.gei_c115_ranking_risco_grupo_economico AS\\nWITH cnpjs_relacionados_por_grupo AS (\\n    -- ETAPA CORRIGIDA: Contagem correta de CNPJs \\u00fanicos envolvidos em relacionamentos.\\n    SELECT\\n        num_grupo,\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_relacionados\\n    FROM (\\n        SELECT num_grupo, cnpj1 AS cnpj FROM gessimples.gei_c115_pares_cnpjs_relacionados\\n        UNION\\n        SELECT num_grupo, cnpj2 AS cnpj FROM gessimples.gei_c115_pares_cnpjs_relacionados\\n    ) all_cnpjs\\n    GROUP BY\\n        num_grupo\\n),\\nmetricas_pares AS (\\n    -- Consolida as m\\u00e9tricas dos pares de CNPJs por grupo\\n    SELECT\\n        num_grupo,\\n        MAX(qtd_tipos_identificadores_comuns) AS max_tipos_identificadores_comuns,\\n        MAX(total_identificadores_comuns) AS max_total_identificadores_comuns,\\n        SUM(CASE WHEN qtd_tipos_identificadores_comuns = 3 THEN 1 ELSE 0 END) AS pares_com_tres_tipos_comum,\\n        SUM(CASE WHEN qtd_tipos_identificadores_comuns >= 2 THEN 1 ELSE 0 END) AS pares_com_dois_ou_mais_tipos_comum\\n    FROM\\n        gessimples.gei_c115_pares_cnpjs_relacionados\\n    GROUP BY\\n        num_grupo\\n),\\ndetalhes_grupos AS (\\n    -- Junta as m\\u00e9tricas de grupo com as novas m\\u00e9tricas corrigidas\\n    SELECT\\n        m.num_grupo,\\n        m.total_cnpjs,\\n        m.total_tomadores,\\n        m.tomadores_com_compartilhamento,\\n        m.tomadores_com_multiplos_compartilhamentos,\\n        m.total_compartilhamentos,\\n        m.perc_tomadores_com_compartilhamento,\\n        m.indice_risco_grupo_economico,\\n        COALESCE(cr.qtd_cnpjs_relacionados, 0) AS qtd_cnpjs_relacionados, -- Usa a contagem correta\\n        COALESCE(mp.max_tipos_identificadores_comuns, 0) AS max_tipos_identificadores_comuns,\\n        COALESCE(mp.max_total_identificadores_comuns, 0) AS max_total_identificadores_comuns,\\n        COALESCE(mp.pares_com_tres_tipos_comum, 0) AS pares_com_tres_tipos_comum,\\n        COALESCE(mp.pares_com_dois_ou_mais_tipos_comum, 0) AS pares_com_dois_ou_mais_tipos_comum\\n    FROM\\n        gessimples.gei_c115_metricas_grupos m\\n    LEFT JOIN\\n        cnpjs_relacionados_por_grupo cr ON m.num_grupo = cr.num_grupo\\n    LEFT JOIN\\n        metricas_pares mp ON m.num_grupo = mp.num_grupo\\n)\\n-- Sele\\u00e7\\u00e3o final para criar a tabela de ranking\\nSELECT\\n    num_grupo,\\n    RANK() OVER(ORDER BY indice_risco_grupo_economico DESC, qtd_cnpjs_relacionados DESC) AS ranking_risco,\\n    indice_risco_grupo_economico,\\n    total_cnpjs,\\n    qtd_cnpjs_relacionados,\\n    CASE \\n        WHEN total_cnpjs > 0 THEN \\n            ROUND(qtd_cnpjs_relacionados * 100.0 / total_cnpjs, 2)\\n        ELSE 0\\n    END AS perc_cnpjs_relacionados,\\n    total_tomadores,\\n    tomadores_com_compartilhamento,\\n    tomadores_com_multiplos_compartilhamentos,\\n    perc_tomadores_com_compartilhamento,\\n    total_compartilhamentos,\\n    max_tipos_identificadores_comuns,\\n    max_total_identificadores_comuns,\\n    pares_com_tres_tipos_comum,\\n    pares_com_dois_ou_mais_tipos_comum,\\n    CASE\\n        WHEN indice_risco_grupo_economico >= 25 AND max_tipos_identificadores_comuns = 3 THEN 'CR\\u00cdTICO'\\n        WHEN indice_risco_grupo_economico >= 15 OR (max_tipos_identificadores_comuns >= 2 AND pares_com_dois_ou_mais_tipos_comum >= 3) THEN 'ALTO'\\n        WHEN indice_risco_grupo_economico >= 5 OR max_tipos_identificadores_comuns >= 2 THEN 'M\\u00c9DIO'\\n        WHEN indice_risco_grupo_economico > 0 THEN 'BAIXO'\\n        ELSE 'INEXISTENTE'\\n    END AS nivel_risco_grupo_economico\\nFROM\\n    detalhes_grupos\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 25, \"statement_range\": {\"start\": {\"row\": 432, \"column\": 0}, \"end\": {\"row\": 511, \"column\": 19}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-09-19T14:28:18.052Z\", \"endTime\": \"2025-09-19T14:28:19.945Z\", \"executionTime\": 1893, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1758292097647, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 100, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false, \"is_history\": false}",
    "extra": "",
    "search": "-- ========================================================================\r\n-- PARTE 1: CriaÃ§Ã£o da tabela base de relacionamentos entre CNPJs e seus identificadores\r\n-- ========================================================================\r\nDROP TABLE IF EXISTS gessimples.gei_c115_identificadores;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_c115_identificadores AS\r\nWITH empresas_identificadores AS (\r\n    SELECT \r\n        g.num_grupo,\r\n        g.cnpj AS cnpj_emitente,\r\n        c.nu_cnpj_cpf_tomador AS cnpj_tomador,\r\n        c.nm_razao_social_tomador,\r\n        c.nm_municipio,\r\n        c.cd_uf,\r\n        c.nu_tel_contato,\r\n        c.nu_identificador_tomador,\r\n        c.nu_tel_ou_unidade_consumidora,\r\n        c.dt_emissao\r\n    FROM \r\n        gessimples.gei_cnpj g\r\n    JOIN \r\n        c115.c115_dados_cadastrais_dest c ON g.cnpj = c.nu_cnpj_cpf_tomador\r\n    WHERE \r\n        c.nu_cnpj_cpf_tomador IS NOT NULL \r\n        AND c.nu_cnpj_cpf_tomador != 'ISENTO'\r\n)\r\nSELECT * FROM empresas_identificadores;\r\n\r\n-- ========================================================================\r\n-- PARTE 2: IdentificaÃ§Ã£o de telefones de contato compartilhados\r\n-- ========================================================================\r\nDROP TABLE IF EXISTS gessimples.gei_c115_tel_contato_compartilhado;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_c115_tel_contato_compartilhado AS\r\nWITH tel_contato_count AS (\r\n    SELECT\r\n        num_grupo,\r\n        nu_tel_contato,\r\n        COUNT(DISTINCT cnpj_tomador) AS qtd_tomadores_distintos\r\n    FROM\r\n        gessimples.gei_c115_identificadores\r\n    WHERE \r\n        nu_tel_contato IS NOT NULL\r\n        AND nu_tel_contato != 'NULL'\r\n    GROUP BY\r\n        num_grupo, nu_tel_contato\r\n    HAVING\r\n        COUNT(DISTINCT cnpj_tomador) > 1\r\n)\r\nSELECT\r\n    tc.num_grupo,\r\n    tc.nu_tel_contato,\r\n    tc.qtd_tomadores_distintos,\r\n    i.cnpj_tomador,\r\n    i.nm_razao_social_tomador,\r\n    i.cnpj_emitente,\r\n    i.nm_municipio,\r\n    i.cd_uf",
    "last_modified": "2025-10-02T17:44:21.258",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 122424,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI",
    "description": "",
    "uuid": "73079828-6334-4071-9c44-0b48b8d62ba7",
    "type": "directory",
    "connector": null,
    "data": "{}",
    "extra": "",
    "search": null,
    "last_modified": "2025-05-13T14:13:11.774",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a8280168-7cf2-40b1-bc5d-733014ae6ba9",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 153574,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: INDICIOS",
    "description": "",
    "uuid": "40477963-ada5-c64a-ca95-907c36ee5277",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 153574, \"uuid\": \"40477963-ada5-c64a-ca95-907c36ee5277\", \"name\": \"GEI: INDICIOS\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"3a60f12c-6ef2-1825-c96b-17d0c21ff97c\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"rais_caged\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ========================================================================\\r\\n-- PARTE NOVA: Cria\\u00e7\\u00e3o da tabela de ind\\u00edcios detalhados por CNPJ e Grupo\\r\\n-- [VERS\\u00c3O CORRIGIDA PARA O SEU SISTEMA]\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_indicios;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_indicios AS\\r\\nSELECT\\r\\n    g.num_grupo,\\r\\n    t.nu_cpf_cnpj AS cnpj,\\r\\n    t.tx_descricao_indicio,\\r\\n    p.tx_descricao_complemento\\r\\nFROM\\r\\n    neaf.empresa_indicio t\\r\\n--  CORRE\\u00c7\\u00c3O FINAL: Fazemos o JOIN diretamente com a coluna do array, sem UNNEST()\\r\\nJOIN\\r\\n    t.indicio_complemento p\\r\\nJOIN\\r\\n    gessimples.gei_cnpj g ON t.nu_cpf_cnpj = g.cnpj\\r\\nWHERE\\r\\n    t.cd_atual = 1;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE NOVA: Cria\\u00e7\\u00e3o de m\\u00e9tricas de ind\\u00edcios agregadas por grupo\\r\\n-- [ESTE SCRIPT EST\\u00c1 CORRETO E DEVE RODAR AP\\u00d3S A CORRE\\u00c7\\u00c3O ACIMA]\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_indicios_metricas_grupo;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_indicios_metricas_grupo AS\\r\\nWITH metricas_base AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(*) AS qtd_total_indicios,\\r\\n        COUNT(DISTINCT tx_descricao_indicio) AS qtd_tipos_indicios_distintos,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_com_indicios\\r\\n    FROM\\r\\n        gessimples.gei_indicios\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ntotal_cnpjs_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs\\r\\n    FROM\\r\\n        gessimples.gei_cnpj\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n)\\r\\nSELECT\\r\\n    m.num_grupo,\\r\\n    m.qtd_total_indicios,\\r\\n    m.qtd_tipos_indicios_distintos,\\r\\n    m.qtd_cnpjs_com_indicios,\\r\\n    COALESCE(t.total_cnpjs, 0) AS total_cnpjs_grupo,\\r\\n    CASE\\r\\n        WHEN COALESCE(t.total_cnpjs, 0) > 0 THEN\\r\\n            ROUND(m.qtd_cnpjs_com_indicios * 100.0 / t.total_cnpjs, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_cnpjs_com_indicios,\\r\\n    ROUND(\\r\\n        (m.qtd_tipos_indicios_distintos * (CASE WHEN COALESCE(t.total_cnpjs, 0) > 0 THEN (m.qtd_cnpjs_com_indicios * 1.0 / t.total_cnpjs) ELSE 0 END))\\r\\n    , 4) AS indice_risco_indicios\\r\\nFROM\\r\\n    metricas_base m\\r\\nLEFT JOIN\\r\\n    total_cnpjs_grupo t ON m.num_grupo = t.num_grupo;\", \"statementsList\": [\"-- ========================================================================\\r\\n-- PARTE NOVA: Cria\\u00e7\\u00e3o da tabela de ind\\u00edcios detalhados por CNPJ e Grupo\\r\\n-- [VERS\\u00c3O CORRIGIDA PARA O SEU SISTEMA]\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_indicios;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_indicios AS\\r\\nSELECT\\r\\n    g.num_grupo,\\r\\n    t.nu_cpf_cnpj AS cnpj,\\r\\n    t.tx_descricao_indicio,\\r\\n    p.tx_descricao_complemento\\r\\nFROM\\r\\n    neaf.empresa_indicio t\\r\\n--  CORRE\\u00c7\\u00c3O FINAL: Fazemos o JOIN diretamente com a coluna do array, sem UNNEST()\\r\\nJOIN\\r\\n    t.indicio_complemento p\\r\\nJOIN\\r\\n    gessimples.gei_cnpj g ON t.nu_cpf_cnpj = g.cnpj\\r\\nWHERE\\r\\n    t.cd_atual = 1;\", \"\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE NOVA: Cria\\u00e7\\u00e3o de m\\u00e9tricas de ind\\u00edcios agregadas por grupo\\r\\n-- [ESTE SCRIPT EST\\u00c1 CORRETO E DEVE RODAR AP\\u00d3S A CORRE\\u00c7\\u00c3O ACIMA]\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_indicios_metricas_grupo;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_indicios_metricas_grupo AS\\r\\nWITH metricas_base AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(*) AS qtd_total_indicios,\\r\\n        COUNT(DISTINCT tx_descricao_indicio) AS qtd_tipos_indicios_distintos,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_com_indicios\\r\\n    FROM\\r\\n        gessimples.gei_indicios\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ntotal_cnpjs_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs\\r\\n    FROM\\r\\n        gessimples.gei_cnpj\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n)\\r\\nSELECT\\r\\n    m.num_grupo,\\r\\n    m.qtd_total_indicios,\\r\\n    m.qtd_tipos_indicios_distintos,\\r\\n    m.qtd_cnpjs_com_indicios,\\r\\n    COALESCE(t.total_cnpjs, 0) AS total_cnpjs_grupo,\\r\\n    CASE\\r\\n        WHEN COALESCE(t.total_cnpjs, 0) > 0 THEN\\r\\n            ROUND(m.qtd_cnpjs_com_indicios * 100.0 / t.total_cnpjs, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_cnpjs_com_indicios,\\r\\n    ROUND(\\r\\n        (m.qtd_tipos_indicios_distintos * (CASE WHEN COALESCE(t.total_cnpjs, 0) > 0 THEN (m.qtd_cnpjs_com_indicios * 1.0 / t.total_cnpjs) ELSE 0 END))\\r\\n    , 4) AS indice_risco_indicios\\r\\nFROM\\r\\n    metricas_base m\\r\\nLEFT JOIN\\r\\n    total_cnpjs_grupo t ON m.num_grupo = t.num_grupo;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ========================================================================\\r\\n-- PARTE NOVA: Cria\\u00e7\\u00e3o da tabela de ind\\u00edcios detalhados por CNPJ e Grupo\\r\\n-- [VERS\\u00c3O CORRIGIDA PARA O SEU SISTEMA]\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_indicios;\", \"result\": {\"id\": \"66c2c001-356f-6af6-5071-08ea16662a75\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"KljfpJyPTciKebhtTr6n/Q==\", \"guid\": \"T8EUM3c0RcAAAAAAx3Dmmw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"ce41338f943d8df0:fe12f01c7872c58d\", \"session_id\": 20301, \"session_type\": \"impala\", \"statement_id\": 5, \"has_more_statements\": false, \"statements_count\": 6, \"previous_statement_hash\": \"60175fb8aa56cec3cf2584f73306ff16f8b2254b6cd7118e966d33e6\", \"start\": {\"row\": 30, \"column\": 0}, \"end\": {\"row\": 68, \"column\": 52}, \"statement\": \"CREATE TABLE gessimples.gei_indicios_metricas_grupo AS\\nWITH metricas_base AS (\\n    SELECT\\n        num_grupo,\\n        COUNT(*) AS qtd_total_indicios,\\n        COUNT(DISTINCT tx_descricao_indicio) AS qtd_tipos_indicios_distintos,\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_com_indicios\\n    FROM\\n        gessimples.gei_indicios\\n    GROUP BY\\n        num_grupo\\n),\\ntotal_cnpjs_grupo AS (\\n    SELECT\\n        num_grupo,\\n        COUNT(DISTINCT cnpj) AS total_cnpjs\\n    FROM\\n        gessimples.gei_cnpj\\n    GROUP BY\\n        num_grupo\\n)\\nSELECT\\n    m.num_grupo,\\n    m.qtd_total_indicios,\\n    m.qtd_tipos_indicios_distintos,\\n    m.qtd_cnpjs_com_indicios,\\n    COALESCE(t.total_cnpjs, 0) AS total_cnpjs_grupo,\\n    CASE\\n        WHEN COALESCE(t.total_cnpjs, 0) > 0 THEN\\n            ROUND(m.qtd_cnpjs_com_indicios * 100.0 / t.total_cnpjs, 2)\\n        ELSE 0\\n    END AS perc_cnpjs_com_indicios,\\n    ROUND(\\n        (m.qtd_tipos_indicios_distintos * (CASE WHEN COALESCE(t.total_cnpjs, 0) > 0 THEN (m.qtd_cnpjs_com_indicios * 1.0 / t.total_cnpjs) ELSE 0 END))\\n    , 4) AS indice_risco_indicios\\nFROM\\n    metricas_base m\\nLEFT JOIN\\n    total_cnpjs_grupo t ON m.num_grupo = t.num_grupo\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 5, \"statement_range\": {\"start\": {\"row\": 30, \"column\": 0}, \"end\": {\"row\": 68, \"column\": 52}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-09-10T20:29:36.016Z\", \"endTime\": \"2025-09-10T20:29:38.550Z\", \"executionTime\": 2534, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1757536175787, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 100, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ========================================================================\r\n-- PARTE NOVA: CriaÃ§Ã£o da tabela de indÃ­cios detalhados por CNPJ e Grupo\r\n-- [VERSÃO CORRIGIDA PARA O SEU SISTEMA]\r\n-- ========================================================================\r\nDROP TABLE IF EXISTS gessimples.gei_indicios;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_indicios AS\r\nSELECT\r\n    g.num_grupo,\r\n    t.nu_cpf_cnpj AS cnpj,\r\n    t.tx_descricao_indicio,\r\n    p.tx_descricao_complemento\r\nFROM\r\n    neaf.empresa_indicio t\r\n--  CORREÃÃO FINAL: Fazemos o JOIN diretamente com a coluna do array, sem UNNEST()\r\nJOIN\r\n    t.indicio_complemento p\r\nJOIN\r\n    gessimples.gei_cnpj g ON t.nu_cpf_cnpj = g.cnpj\r\nWHERE\r\n    t.cd_atual = 1;\r\n\r\n-- ========================================================================\r\n-- PARTE NOVA: CriaÃ§Ã£o de mÃ©tricas de indÃ­cios agregadas por grupo\r\n-- [ESTE SCRIPT ESTÃ CORRETO E DEVE RODAR APÃS A CORREÃÃO ACIMA]\r\n-- ========================================================================\r\nDROP TABLE IF EXISTS gessimples.gei_indicios_metricas_grupo;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_indicios_metricas_grupo AS\r\nWITH metricas_base AS (\r\n    SELECT\r\n        num_grupo,\r\n        COUNT(*) AS qtd_total_indicios,\r\n        COUNT(DISTINCT tx_descricao_indicio) AS qtd_tipos_indicios_distintos,\r\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_com_indicios\r\n    FROM\r\n        gessimples.gei_indicios\r\n    GROUP BY\r\n        num_grupo\r\n),\r\ntotal_cnpjs_grupo AS (\r\n    SELECT\r\n        num_grupo,\r\n        COUNT(DISTINCT cnpj) AS total_cnpjs\r\n    FROM\r\n        gessimples.gei_cnpj\r\n    GROUP BY\r\n        num_grupo\r\n)\r\nSELECT\r\n    m.num_grupo,\r\n    m.qtd_total_indicios,\r\n    m.qtd_tipos_indicios_distintos,\r\n    m.qtd_cnpjs_com_indicios,\r\n    COALESCE(t.total_cnpjs, 0) AS total_cnpjs_grupo,\r\n    CASE\r\n        WHEN COALESCE(t.total_cnpjs, 0) > 0 THEN\r\n            ROUND(m.qtd_cnpjs_com_indicios * 100.0 / t.total_cnpjs, 2)\r\n        ELSE 0\r\n   ",
    "last_modified": "2025-10-02T17:45:01.600",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 154766,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: MEIOS PAGTOS + RAIS_CAGED",
    "description": "",
    "uuid": "b11b0408-cdcd-4307-67f8-46142019dc3e",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 154766, \"uuid\": \"e04c7673-651c-4eea-a80a-9b2a40424b9c\", \"name\": \"GEI: MEIOS PAGTOS + RAIS_CAGED\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"b11b0408-cdcd-4307-67f8-46142019dc3e\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"2bfe4c6c-df36-295b-20c1-00154aade98c\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 44, \"column\": 19}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ========================================================================\\r\\n-- PARTE 1: Tabela de Dados Brutos - Funcion\\u00e1rios (RAIS/CAGED)\\r\\n-- MELHORADO: L\\u00f3gica de filtro para buscar v\\u00ednculos ATIVOS mais recentes (RAIS + CAGED)\\r\\n--            e desduplicar registros por funcion\\u00e1rio/empresa.\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_funcionarios_detalhe;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_funcionarios_detalhe AS\\r\\nSELECT\\r\\n    gc.num_grupo,\\r\\n    r.cnpj_cei,\\r\\n    r.cpf,\\r\\n    -- Usamos MAX/MIN para garantir um \\u00fanico valor no agrupamento\\r\\n    MAX(r.nome_trabalhador) AS nome_trabalhador,        -- O nome n\\u00e3o deve mudar\\r\\n    MAX(r.cbo_ocupacao_2002) AS cbo_ocupacao,         -- Pega a CBO mais recente\\r\\n    MAX(r.vl_remun_media_nom) AS remuneracao_media,   -- Pega a remunera\\u00e7\\u00e3o mais recente\\r\\n    MIN(r.data_admissao_declarada) AS data_admissao    -- Pega a data de admiss\\u00e3o original\\r\\nFROM rais_caged.vw_rais_vinculos r\\r\\nJOIN gessimples.gei_cnpj gc ON r.cnpj_cei = gc.cnpj\\r\\nWHERE \\r\\n    -- Filtros para buscar apenas v\\u00ednculos ATIVOS e RECENTES\\r\\n    r.vinculo_ativo_31_12 = 1\\r\\n    AND TRIM(r.mes_desligamento) = \\\"ignorado\\\"\\r\\n    AND r.ano_arquivo >= 2023  -- Foca nos dados de 2023 e 2024 (RAIS) + 2025 (CAGED)\\r\\nGROUP BY \\r\\n    gc.num_grupo,\\r\\n    r.cnpj_cei,\\r\\n    r.cpf;\\r\\n\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 2: Tabela de M\\u00e9tricas - Funcion\\u00e1rios (Agregado por Grupo)\\r\\n-- (Sem altera\\u00e7\\u00f5es)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_funcionarios_metricas_grupo;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_funcionarios_metricas_grupo AS\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    COUNT(DISTINCT cpf) AS total_funcionarios,\\r\\n    COUNT(DISTINCT cnpj_cei) AS cnpjs_com_funcionarios\\r\\nFROM gessimples.gei_funcionarios_detalhe\\r\\nGROUP BY num_grupo;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 3: Tabela de Dados Brutos - Meios de Pagamento\\r\\n-- (Sem altera\\u00e7\\u00f5es, j\\u00e1 estava correto)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_pagamentos_detalhe;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_pagamentos_detalhe AS\\r\\nWITH\\r\\n-- CTE para encontrar todos os s\\u00f3cios ativos dos grupos monitorados\\r\\nsocios_ativos_grupo AS (\\r\\n    SELECT DISTINCT\\r\\n        g.num_grupo,\\r\\n        TRIM(v.nu_cnpj_cpf_secund) AS cpf_socio\\r\\n    FROM gessimples.gei_cnpj g\\r\\n    JOIN usr_sat_ods.vw_cad_vinculo v ON g.cnpj = v.nu_cnpj_princ\\r\\n    WHERE v.sn_relacao_ativa = 1\\r\\n      AND v.nm_relacao != 'CONTABILISTA'\\r\\n      AND LENGTH(TRIM(v.nu_cnpj_cpf_secund)) = 11\\r\\n)\\r\\n\\r\\n-- Seleciona e une os dois tipos de pagamento (Empresa e S\\u00f3cio)\\r\\n-- Pagamentos das Empresas (CNPJ)\\r\\nSELECT\\r\\n    g.num_grupo,\\r\\n    p.ato_nu_cnpjmf AS identificador,\\r\\n    'CNPJ' AS tipo_identificador,\\r\\n    p.ato_dt_referencia,\\r\\n    (p.ato_vl_credito + p.ato_vl_debito + p.ato_vl_pix) AS valor_meio_pagamento\\r\\nFROM usr_sat_admcc.acc_r66_totalestab p\\r\\nJOIN gessimples.gei_cnpj g ON p.ato_nu_cnpjmf = g.cnpj\\r\\nWHERE p.ato_dt_referencia BETWEEN 202501 AND 202509\\r\\n  AND LENGTH(TRIM(p.ato_nu_cnpjmf)) = 14\\r\\n\\r\\nUNION ALL\\r\\n\\r\\n-- Pagamentos dos S\\u00f3cios (CPF)\\r\\nSELECT\\r\\n    s.num_grupo,\\r\\n    p.ato_nu_cnpjmf AS identificador,\\r\\n    'CPF' AS tipo_identificador,\\r\\n    p.ato_dt_referencia,\\r\\n    (p.ato_vl_credito + p.ato_vl_debito + p.ato_vl_pix) AS valor_meio_pagamento\\r\\nFROM usr_sat_admcc.acc_r66_totalestab p\\r\\nJOIN socios_ativos_grupo s ON TRIM(p.ato_nu_cnpjmf) = s.cpf_socio\\r\\nWHERE p.ato_dt_referencia BETWEEN 202501 AND 202509\\r\\n  AND LENGTH(TRIM(p.ato_nu_cnpjmf)) = 11;\\r\\n\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 4: Tabela de M\\u00e9tricas - Meios de Pagamento (Agregado por Grupo)\\r\\n-- (Sem altera\\u00e7\\u00f5es, j\\u00e1 estava correto)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_pagamentos_metricas_grupo;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_pagamentos_metricas_grupo AS\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    SUM(CASE WHEN tipo_identificador = 'CNPJ' THEN valor_meio_pagamento ELSE 0 END) AS valor_meios_pagamento_empresas,\\r\\n    SUM(CASE WHEN tipo_identificador = 'CPF' THEN valor_meio_pagamento ELSE 0 END) AS valor_meios_pagamento_socios\\r\\nFROM gessimples.gei_pagamentos_detalhe\\r\\nGROUP BY num_grupo;\", \"statementsList\": [\"-- ========================================================================\\r\\n-- PARTE 1: Tabela de Dados Brutos - Funcion\\u00e1rios (RAIS/CAGED)\\r\\n-- MELHORADO: L\\u00f3gica de filtro para buscar v\\u00ednculos ATIVOS mais recentes (RAIS + CAGED)\\r\\n--            e desduplicar registros por funcion\\u00e1rio/empresa.\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_funcionarios_detalhe;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_funcionarios_detalhe AS\\r\\nSELECT\\r\\n    gc.num_grupo,\\r\\n    r.cnpj_cei,\\r\\n    r.cpf,\\r\\n    -- Usamos MAX/MIN para garantir um \\u00fanico valor no agrupamento\\r\\n    MAX(r.nome_trabalhador) AS nome_trabalhador,        -- O nome n\\u00e3o deve mudar\\r\\n    MAX(r.cbo_ocupacao_2002) AS cbo_ocupacao,         -- Pega a CBO mais recente\\r\\n    MAX(r.vl_remun_media_nom) AS remuneracao_media,   -- Pega a remunera\\u00e7\\u00e3o mais recente\\r\\n    MIN(r.data_admissao_declarada) AS data_admissao    -- Pega a data de admiss\\u00e3o original\\r\\nFROM rais_caged.vw_rais_vinculos r\\r\\nJOIN gessimples.gei_cnpj gc ON r.cnpj_cei = gc.cnpj\\r\\nWHERE \\r\\n    -- Filtros para buscar apenas v\\u00ednculos ATIVOS e RECENTES\\r\\n    r.vinculo_ativo_31_12 = 1\\r\\n    AND TRIM(r.mes_desligamento) = \\\"ignorado\\\"\\r\\n    AND r.ano_arquivo >= 2023  -- Foca nos dados de 2023 e 2024 (RAIS) + 2025 (CAGED)\\r\\nGROUP BY \\r\\n    gc.num_grupo,\\r\\n    r.cnpj_cei,\\r\\n    r.cpf;\", \"\\r\\n\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 2: Tabela de M\\u00e9tricas - Funcion\\u00e1rios (Agregado por Grupo)\\r\\n-- (Sem altera\\u00e7\\u00f5es)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_funcionarios_metricas_grupo;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_funcionarios_metricas_grupo AS\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    COUNT(DISTINCT cpf) AS total_funcionarios,\\r\\n    COUNT(DISTINCT cnpj_cei) AS cnpjs_com_funcionarios\\r\\nFROM gessimples.gei_funcionarios_detalhe\\r\\nGROUP BY num_grupo;\", \"\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 3: Tabela de Dados Brutos - Meios de Pagamento\\r\\n-- (Sem altera\\u00e7\\u00f5es, j\\u00e1 estava correto)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_pagamentos_detalhe;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_pagamentos_detalhe AS\\r\\nWITH\\r\\n-- CTE para encontrar todos os s\\u00f3cios ativos dos grupos monitorados\\r\\nsocios_ativos_grupo AS (\\r\\n    SELECT DISTINCT\\r\\n        g.num_grupo,\\r\\n        TRIM(v.nu_cnpj_cpf_secund) AS cpf_socio\\r\\n    FROM gessimples.gei_cnpj g\\r\\n    JOIN usr_sat_ods.vw_cad_vinculo v ON g.cnpj = v.nu_cnpj_princ\\r\\n    WHERE v.sn_relacao_ativa = 1\\r\\n      AND v.nm_relacao != 'CONTABILISTA'\\r\\n      AND LENGTH(TRIM(v.nu_cnpj_cpf_secund)) = 11\\r\\n)\\r\\n\\r\\n-- Seleciona e une os dois tipos de pagamento (Empresa e S\\u00f3cio)\\r\\n-- Pagamentos das Empresas (CNPJ)\\r\\nSELECT\\r\\n    g.num_grupo,\\r\\n    p.ato_nu_cnpjmf AS identificador,\\r\\n    'CNPJ' AS tipo_identificador,\\r\\n    p.ato_dt_referencia,\\r\\n    (p.ato_vl_credito + p.ato_vl_debito + p.ato_vl_pix) AS valor_meio_pagamento\\r\\nFROM usr_sat_admcc.acc_r66_totalestab p\\r\\nJOIN gessimples.gei_cnpj g ON p.ato_nu_cnpjmf = g.cnpj\\r\\nWHERE p.ato_dt_referencia BETWEEN 202501 AND 202509\\r\\n  AND LENGTH(TRIM(p.ato_nu_cnpjmf)) = 14\\r\\n\\r\\nUNION ALL\\r\\n\\r\\n-- Pagamentos dos S\\u00f3cios (CPF)\\r\\nSELECT\\r\\n    s.num_grupo,\\r\\n    p.ato_nu_cnpjmf AS identificador,\\r\\n    'CPF' AS tipo_identificador,\\r\\n    p.ato_dt_referencia,\\r\\n    (p.ato_vl_credito + p.ato_vl_debito + p.ato_vl_pix) AS valor_meio_pagamento\\r\\nFROM usr_sat_admcc.acc_r66_totalestab p\\r\\nJOIN socios_ativos_grupo s ON TRIM(p.ato_nu_cnpjmf) = s.cpf_socio\\r\\nWHERE p.ato_dt_referencia BETWEEN 202501 AND 202509\\r\\n  AND LENGTH(TRIM(p.ato_nu_cnpjmf)) = 11;\", \"\\r\\n\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 4: Tabela de M\\u00e9tricas - Meios de Pagamento (Agregado por Grupo)\\r\\n-- (Sem altera\\u00e7\\u00f5es, j\\u00e1 estava correto)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_pagamentos_metricas_grupo;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_pagamentos_metricas_grupo AS\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    SUM(CASE WHEN tipo_identificador = 'CNPJ' THEN valor_meio_pagamento ELSE 0 END) AS valor_meios_pagamento_empresas,\\r\\n    SUM(CASE WHEN tipo_identificador = 'CPF' THEN valor_meio_pagamento ELSE 0 END) AS valor_meios_pagamento_socios\\r\\nFROM gessimples.gei_pagamentos_detalhe\\r\\nGROUP BY num_grupo;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"DROP TABLE IF EXISTS gessimples.gei_funcionarios_detalhe;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_funcionarios_detalhe AS\\r\\nSELECT\\r\\n    gc.num_grupo,\\r\\n    r.cnpj_cei,\\r\\n    r.cpf,\\r\\n    -- Usamos MAX/MIN para garantir um \\u00fanico valor no agrupamento\\r\\n    MAX(r.nome_trabalhador) AS nome_trabalhador,        -- O nome n\\u00e3o deve mudar\\r\\n    MAX(r.cbo_ocupacao_2002) AS cbo_ocupacao,         -- Pega a CBO mais recente\\r\\n    MAX(r.vl_remun_media_nom) AS remuneracao_media,   -- Pega a remunera\\u00e7\\u00e3o mais recente\\r\\n    MIN(r.data_admissao_declarada) AS data_admissao    -- Pega a data de admiss\\u00e3o original\\r\\nFROM rais_caged.vw_rais_vinculos r\\r\\nJOIN gessimples.gei_cnpj gc ON r.cnpj_cei = gc.cnpj\\r\\nWHERE \\r\\n    -- Filtros para buscar apenas v\\u00ednculos ATIVOS e RECENTES\\r\\n    r.vinculo_ativo_31_12 = 1\\r\\n    AND TRIM(r.mes_desligamento) = \\\"ignorado\\\"\\r\\n    AND r.ano_arquivo >= 2023  -- Foca nos dados de 2023 e 2024 (RAIS) + 2025 (CAGED)\\r\\nGROUP BY \\r\\n    gc.num_grupo,\\r\\n    r.cnpj_cei,\\r\\n    r.cpf;\\r\\n\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 2: Tabela de M\\u00e9tricas - Funcion\\u00e1rios (Agregado por Grupo)\\r\\n-- (Sem altera\\u00e7\\u00f5es)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_funcionarios_metricas_grupo;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_funcionarios_metricas_grupo AS\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    COUNT(DISTINCT cpf) AS total_funcionarios,\\r\\n    COUNT(DISTINCT cnpj_cei) AS cnpjs_com_funcionarios\\r\\nFROM gessimples.gei_funcionarios_detalhe\\r\\nGROUP BY num_grupo;\", \"result\": {\"id\": \"cfc47d7f-4df8-d073-552c-2ee2d9a7c071\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"mbiDH7FyQnyZ1WFppe7G8A==\", \"guid\": \"DQAy85FrQZcAAAAASUI2jA==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"ef447b70c7a2c442:1b9756581bcbfe80\", \"session_id\": 22010, \"session_type\": \"impala\", \"statement_id\": 5, \"has_more_statements\": false, \"statements_count\": 6, \"previous_statement_hash\": \"f0ed8ddd1c40f33af8260463cc87933f3bdb54af6ffbf265b48c19de\", \"start\": {\"row\": 33, \"column\": 0}, \"end\": {\"row\": 39, \"column\": 18}, \"statement\": \"CREATE TABLE gessimples.gei_funcionarios_metricas_grupo AS\\nSELECT\\n    num_grupo,\\n    COUNT(DISTINCT cpf) AS total_funcionarios,\\n    COUNT(DISTINCT cnpj_cei) AS cnpjs_com_funcionarios\\nFROM gessimples.gei_funcionarios_detalhe\\nGROUP BY num_grupo\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 5, \"statement_range\": {\"start\": {\"row\": 33, \"column\": 0}, \"end\": {\"row\": 39, \"column\": 18}}, \"statements_count\": 6, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"summary\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-10-24T20:59:57.714Z\", \"endTime\": \"2025-10-24T20:59:59.040Z\", \"executionTime\": 1326, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 4, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 3476, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"option\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 3542, \"getLogsTimeout\": 3710, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1761339597480, \"lastAceSelectionRowOffset\": 5, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"DROP TABLE IF EXISTS gessimples.gei_funcionarios_detalhe;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_funcionarios_detalhe AS\\r\\nSELECT\\r\\n    gc.num_grupo,\\r\\n    r.cnpj_cei,\\r\\n    r.cpf,\\r\\n    -- Usamos MAX/MIN para garantir um \\u00fanico valor no agrupamento\\r\\n    MAX(r.nome_trabalhador) AS nome_trabalhador,        -- O nome n\\u00e3o deve mudar\\r\\n    MAX(r.cbo_ocupacao_2002) AS cbo_ocupacao,         -- Pega a CBO mais recente\\r\\n    MAX(r.vl_remun_media_nom) AS remuneracao_media,   -- Pega a remunera\\u00e7\\u00e3o mais recente\\r\\n    MIN(r.data_admissao_declarada) AS data_admissao    -- Pega a data de admiss\\u00e3o original\\r\\nFROM rais_caged.vw_rais_vinculos r\\r\\nJOIN gessimples.gei_cnpj gc ON r.cnpj_cei = gc.cnpj\\r\\nWHERE \\r\\n    -- Filtros para buscar apenas v\\u00ednculos ATIVOS e RECENTES\\r\\n    r.vinculo_ativo_31_12 = 1\\r\\n    AND TRIM(r.mes_desligamento) = \\\"ignorado\\\"\\r\\n    AND r.ano_arquivo >= 2023  -- Foca nos dados de 2023 e 2024 (RAIS) + 2025 (CAGED)\\r\\nGROUP BY \\r\\n    gc.num_grupo,\\r\\n    r.cnpj_cei,\\r\\n    r.cpf;\\r\\n\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 2: Tabela de M\\u00e9tricas - Funcion\\u00e1rios (Agregado por Grupo)\\r\\n-- (Sem altera\\u00e7\\u00f5es)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_funcionarios_metricas_grupo;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_funcionarios_metricas_grupo AS\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    COUNT(DISTINCT cpf) AS total_funcionarios,\\r\\n    COUNT(DISTINCT cnpj_cei) AS cnpjs_com_funcionarios\\r\\nFROM gessimples.gei_funcionarios_detalhe\\r\\nGROUP BY num_grupo;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 5, \"column\": 0}, \"end\": {\"row\": 44, \"column\": 19}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 97416b91f332000d:8c36424900000000 100% Complete (9 out of 9)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"97416b91f332000d:8c36424900000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=97416b91f332000d:8c36424900000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 97416b91f332000d:8c36424900000000 100% Complete (9 out of 9)\", \"progress\": 100, \"jobs\": [{\"name\": \"97416b91f332000d:8c36424900000000\", \"url\": \"/hue/jobbrowser#!id=97416b91f332000d:8c36424900000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 11535, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 154, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ========================================================================\r\n-- PARTE 1: Tabela de Dados Brutos - FuncionÃ¡rios (RAIS/CAGED)\r\n-- MELHORADO: LÃ³gica de filtro para buscar vÃ­nculos ATIVOS mais recentes (RAIS + CAGED)\r\n--            e desduplicar registros por funcionÃ¡rio/empresa.\r\n-- ========================================================================\r\nDROP TABLE IF EXISTS gessimples.gei_funcionarios_detalhe;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_funcionarios_detalhe AS\r\nSELECT\r\n    gc.num_grupo,\r\n    r.cnpj_cei,\r\n    r.cpf,\r\n    -- Usamos MAX/MIN para garantir um Ãºnico valor no agrupamento\r\n    MAX(r.nome_trabalhador) AS nome_trabalhador,        -- O nome nÃ£o deve mudar\r\n    MAX(r.cbo_ocupacao_2002) AS cbo_ocupacao,         -- Pega a CBO mais recente\r\n    MAX(r.vl_remun_media_nom) AS remuneracao_media,   -- Pega a remuneraÃ§Ã£o mais recente\r\n    MIN(r.data_admissao_declarada) AS data_admissao    -- Pega a data de admissÃ£o original\r\nFROM rais_caged.vw_rais_vinculos r\r\nJOIN gessimples.gei_cnpj gc ON r.cnpj_cei = gc.cnpj\r\nWHERE \r\n    -- Filtros para buscar apenas vÃ­nculos ATIVOS e RECENTES\r\n    r.vinculo_ativo_31_12 = 1\r\n    AND TRIM(r.mes_desligamento) = \"ignorado\"\r\n    AND r.ano_arquivo >= 2023  -- Foca nos dados de 2023 e 2024 (RAIS) + 2025 (CAGED)\r\nGROUP BY \r\n    gc.num_grupo,\r\n    r.cnpj_cei,\r\n    r.cpf;\r\n\r\n\r\n-- ========================================================================\r\n-- PARTE 2: Tabela de MÃ©tricas - FuncionÃ¡rios (Agregado por Grupo)\r\n-- (Sem alteraÃ§Ãµes)\r\n-- ========================================================================\r\nDROP TABLE IF EXISTS gessimples.gei_funcionarios_metricas_grupo;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_funcionarios_metricas_grupo AS\r\nSELECT\r\n    num_grupo,\r\n    COUNT(DISTINCT cpf) AS total_funcionarios,\r\n    COUNT(DISTINCT cnpj_cei) AS cnpjs_com_funcionarios\r\nFROM gessimples.gei_funcionarios_detalhe\r\nGROUP BY num_grupo;\r\n\r\n-- ================================",
    "last_modified": "2025-10-24T18:00:52.819",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 158076,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: ANALISES",
    "description": "",
    "uuid": "9f2bcaa3-4b8f-fdff-2d45-d3d34a4067c5",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 158076, \"uuid\": \"a6231068-6eb8-4955-a4b0-d1c180fe9a94\", \"name\": \"GEI: ANALISES\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"9f2bcaa3-4b8f-fdff-2d45-d3d34a4067c5\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"2bc9b8c0-d9d2-b895-e59c-a47c21cbf597\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 348, \"column\": 0}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"/***************************************************************************************************\\r\\n * =================================================================================================\\r\\n * SCRIPT UNIFICADO DE AN\\u00c1LISE E CONSULTA - SISTEMA GEI (Gest\\u00e3o de Empresas e Ind\\u00edcios)\\r\\n * =================================================================================================\\r\\n *\\r\\n * DESCRI\\u00c7\\u00c3O:\\r\\n * Este script cont\\u00e9m um conjunto completo de consultas prontas para uso que extraem estat\\u00edsticas,\\r\\n * rankings e an\\u00e1lises detalhadas do data warehouse GEI.\\r\\n *\\r\\n * COMO USAR:\\r\\n * 1. Para as \\\"An\\u00e1lises Completas (Dossi\\u00ea)\\\", modifique o n\\u00famero do grupo na se\\u00e7\\u00e3o \\\"PAR\\u00c2METRO DE\\r\\n * AN\\u00c1LISE\\\" abaixo.\\r\\n * 2. Execute o script completo ou cada consulta individualmente.\\r\\n *\\r\\n * DATA DE GERA\\u00c7\\u00c3O: 29 de Setembro de 2025\\r\\n ***************************************************************************************************/\\r\\n\\r\\n-- =================================================================================================\\r\\n-- PAR\\u00c2METRO DE AN\\u00c1LISE (MODIFIQUE AQUI)\\r\\n-- Defina o n\\u00famero do grupo que voc\\u00ea deseja analisar em detalhe nas se\\u00e7\\u00f5es de \\\"Dossi\\u00ea\\\".\\r\\n-- Altere o valor '101' para o c\\u00f3digo do grupo desejado.\\r\\n-- =================================================================================================\\r\\n-- DECLARE @grupo_alvo VARCHAR(20) = '101'; -- Exemplo de sintaxe para SQL Server.\\r\\n-- SET gei_grupo_alvo = '101'; -- Exemplo de sintaxe para outros SGBDs.\\r\\n-- Para portabilidade, o valor ser\\u00e1 inserido diretamente nas cl\\u00e1usulas WHERE abaixo.\\r\\n\\r\\n\\r\\n/***************************************************************************************************\\r\\n * SE\\u00c7\\u00c3O 1: ESTAT\\u00cdSTICAS GERAIS DO SISTEMA (VIS\\u00c3O MACRO)\\r\\n ***************************************************************************************************/\\r\\n\\r\\n-- 1.1. Resumo Quantitativo do Ambiente\\r\\n-- Objetivo: Obter as contagens totais de grupos, CNPJs monitorados e o volume de dados processados.\\r\\nSELECT\\r\\n    '1.1. Resumo Quantitativo do Ambiente' AS Consulta,\\r\\n    (SELECT COUNT(DISTINCT num_grupo) FROM gessimples.gei_cnpj) AS total_grupos_monitorados,\\r\\n    (SELECT COUNT(DISTINCT cnpj) FROM gessimples.gei_cnpj) AS total_cnpjs_monitorados,\\r\\n    (SELECT COUNT(DISTINCT nfe_nu_chave_acesso) FROM gessimples.gei_nfe_completo) AS total_documentos_fiscais_analisados,\\r\\n    (SELECT COUNT(*) FROM gessimples.gei_nfe_completo) AS total_itens_de_nota_analisados;\\r\\n\\r\\n-- 1.2. Distribui\\u00e7\\u00e3o de Grupos por N\\u00edvel de Risco (C115)\\r\\n-- Objetivo: Entender como os grupos se distribuem entre as classifica\\u00e7\\u00f5es de risco.\\r\\nSELECT\\r\\n    '1.2. Distribui\\u00e7\\u00e3o de Grupos por N\\u00edvel de Risco (C115)' AS Consulta,\\r\\n    nivel_risco_grupo_economico,\\r\\n    COUNT(DISTINCT num_grupo) AS quantidade_de_grupos,\\r\\n    ROUND(COUNT(DISTINCT num_grupo) * 100.0 / (SELECT COUNT(*) FROM gessimples.gei_percent), 2) AS percentual_total\\r\\nFROM\\r\\n    gessimples.gei_percent\\r\\nWHERE nivel_risco_grupo_economico IS NOT NULL\\r\\nGROUP BY\\r\\n    nivel_risco_grupo_economico\\r\\nORDER BY\\r\\n    quantidade_de_grupos DESC;\\r\\n\\r\\n-- Objetivo: Identificar quais tipos de inconsist\\u00eancias operacionais s\\u00e3o mais frequentes.\\r\\n-- 1.3. Totaliza\\u00e7\\u00e3o Ranqueada de Inconsist\\u00eancias (com N\\u00edvel e Percentual)\\r\\n\\r\\n-- Usamos uma CTE (Common Table Expression) para calcular o total de itens uma \\u00fanica vez, otimizando a consulta.\\r\\nWITH DADOS_TOTAIS AS (\\r\\n    SELECT\\r\\n        COUNT(*) AS total_geral_itens\\r\\n    FROM\\r\\n        gessimples.gei_nfe_completo\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    '1.3. Totaliza\\u00e7\\u00e3o Ranqueada de Inconsist\\u00eancias (com N\\u00edvel e Percentual)' AS Consulta,\\r\\n    ti.Tipo_de_Inconsistencia,\\r\\n    ti.Nivel_da_Informacao,\\r\\n    ti.Quantidade_Total,\\r\\n    -- Calcula o percentual de cada inconsist\\u00eancia sobre o total de itens.\\r\\n    -- Multiplicamos por 100.0 para garantir a divis\\u00e3o com casas decimais.\\r\\n    ROUND(ti.Quantidade_Total * 100.0 / dt.total_geral_itens, 4) AS Percentual_do_Total_de_Itens\\r\\nFROM (\\r\\n    -- Inconsist\\u00eancias em n\\u00edvel de Documento (informa\\u00e7\\u00f5es do cabe\\u00e7alho da NFe)\\r\\n    SELECT 'IP de Transmiss\\u00e3o' AS Tipo_de_Inconsistencia, 'N\\u00edvel do Documento' AS Nivel_da_Informacao, SUM(CASE WHEN ip_transmissao_incons = 'S' THEN 1 ELSE 0 END) AS Quantidade_Total FROM gessimples.gei_nfe_completo\\r\\n    UNION ALL\\r\\n    SELECT 'Endere\\u00e7o do Emitente' AS Tipo_de_Inconsistencia, 'N\\u00edvel do Documento' AS Nivel_da_Informacao, SUM(CASE WHEN end_emit_incons = 'S' THEN 1 ELSE 0 END) FROM gessimples.gei_nfe_completo\\r\\n    UNION ALL\\r\\n    SELECT 'Cliente (CNPJ Destino)' AS Tipo_de_Inconsistencia, 'N\\u00edvel do Documento' AS Nivel_da_Informacao, SUM(CASE WHEN cliente_incons = 'S' THEN 1 ELSE 0 END) FROM gessimples.gei_nfe_completo\\r\\n    UNION ALL\\r\\n    SELECT 'Fornecedor (CNPJ Origem)' AS Tipo_de_Inconsistencia, 'N\\u00edvel do Documento' AS Nivel_da_Informacao, SUM(CASE WHEN fornecedor_incons = 'S' THEN 1 ELSE 0 END) FROM gessimples.gei_nfe_completo\\r\\n    UNION ALL\\r\\n    SELECT 'Telefone do Emitente' AS Tipo_de_Inconsistencia, 'N\\u00edvel do Documento' AS Nivel_da_Informacao, SUM(CASE WHEN tel_emit_incons = 'S' THEN 1 ELSE 0 END) FROM gessimples.gei_nfe_completo\\r\\n    UNION ALL\\r\\n    SELECT 'Endere\\u00e7o do Destinat\\u00e1rio' AS Tipo_de_Inconsistencia, 'N\\u00edvel do Documento' AS Nivel_da_Informacao, SUM(CASE WHEN end_dest_incons = 'S' THEN 1 ELSE 0 END) FROM gessimples.gei_nfe_completo\\r\\n    UNION ALL\\r\\n    SELECT 'Telefone do Destinat\\u00e1rio' AS Tipo_de_Inconsistencia, 'N\\u00edvel do Documento' AS Nivel_da_Informacao, SUM(CASE WHEN tel_dest_incons = 'S' THEN 1 ELSE 0 END) FROM gessimples.gei_nfe_completo\\r\\n    UNION ALL\\r\\n    SELECT 'E-mail do Destinat\\u00e1rio' AS Tipo_de_Inconsistencia, 'N\\u00edvel do Documento' AS Nivel_da_Informacao, SUM(CASE WHEN email_incons = 'S' THEN 1 ELSE 0 END) FROM gessimples.gei_nfe_completo\\r\\n    \\r\\n    UNION ALL\\r\\n\\r\\n    -- Inconsist\\u00eancias em n\\u00edvel de Item (informa\\u00e7\\u00f5es de cada produto na NFe)\\r\\n    SELECT 'Descri\\u00e7\\u00e3o do Produto' AS Tipo_de_Inconsistencia, 'N\\u00edvel do Item' AS Nivel_da_Informacao, SUM(CASE WHEN descricao_produto_incons = 'S' THEN 1 ELSE 0 END) FROM gessimples.gei_nfe_completo\\r\\n    UNION ALL\\r\\n    SELECT 'C\\u00f3digo do Produto' AS Tipo_de_Inconsistencia, 'N\\u00edvel do Item' AS Nivel_da_Informacao, SUM(CASE WHEN codigo_produto_incons = 'S' THEN 1 ELSE 0 END) FROM gessimples.gei_nfe_completo\\r\\n) AS ti, DADOS_TOTAIS AS dt -- Cruzamos o resultado com a CTE para ter o total em todas as linhas\\r\\nORDER BY\\r\\n    ti.Quantidade_Total DESC;\\r\\n\\r\\n\\r\\n/***************************************************************************************************\\r\\n * SE\\u00c7\\u00c3O 2: CONSULTAS ANAL\\u00cdTICAS (RANKINGS E PADR\\u00d5ES)\\r\\n ***************************************************************************************************/\\r\\n\\r\\n-- 2.1. Top 20 Grupos por Score Final de Risco\\r\\n-- Objetivo: Listar os grupos com a maior pontua\\u00e7\\u00e3o de risco combinado para direcionar a fiscaliza\\u00e7\\u00e3o.\\r\\nSELECT\\r\\n    '2.1. Top 20 Grupos por Score Final de Risco' AS Consulta,\\r\\n    num_grupo,\\r\\n    score_final_avancado,\\r\\n    qntd_cnpj,\\r\\n    total AS score_soma_inconsistencias,\\r\\n    indice_interconexao,\\r\\n    indice_risco_grupo_economico,\\r\\n    indice_risco_indicios,\\r\\n    indice_risco_pagamentos,\\r\\n    indice_risco_fat_func,\\r\\n    nivel_risco_grupo_economico\\r\\nFROM\\r\\n    gessimples.gei_percent\\r\\nORDER BY\\r\\n    score_final_avancado DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- 2.2. Top 10 Contadores Associados a Grupos de Alto Risco\\r\\n-- Objetivo: Identificar contadores cujos clientes apresentam, em m\\u00e9dia, os maiores scores de risco.\\r\\nSELECT\\r\\n    '2.2. Top 10 Contadores Associados a Grupos de Alto Risco' AS Consulta,\\r\\n    nm_contador,\\r\\n    nm_gerfe,\\r\\n    media AS media_score_dos_grupos,\\r\\n    qntd_grupos\\r\\nFROM\\r\\n    gessimples.gei_contador\\r\\nORDER BY\\r\\n    media DESC, qntd_grupos DESC\\r\\nLIMIT 10;\\r\\n\\r\\n-- 2.3. Top 15 Grupos com Maior Risco de Confus\\u00e3o Patrimonial (An\\u00e1lise de Pagamentos)\\r\\n-- Objetivo: Listar grupos onde a movimenta\\u00e7\\u00e3o financeira nos CPFs dos s\\u00f3cios \\u00e9 alta em rela\\u00e7\\u00e3o \\u00e0 dos CNPJs.\\r\\nSELECT\\r\\n    '2.3. Top 15 Grupos com Maior Risco de Confus\\u00e3o Patrimonial' AS Consulta,\\r\\n    num_grupo,\\r\\n    indice_risco_pagamentos,\\r\\n    valor_meios_pagamento_empresas,\\r\\n    valor_meios_pagamento_socios,\\r\\n    qntd_cnpj,\\r\\n    score_final_avancado\\r\\nFROM\\r\\n    gessimples.gei_percent\\r\\nWHERE valor_meios_pagamento_empresas > 0\\r\\nORDER BY\\r\\n    indice_risco_pagamentos DESC\\r\\nLIMIT 15;\\r\\n\\r\\n\\r\\n/***************************************************************************************************\\r\\n * SE\\u00c7\\u00c3O 3: AN\\u00c1LISES COMPLETAS (DOSSI\\u00ca DE GRUPOS ESPEC\\u00cdFICOS)\\r\\n * Lembre-se de alterar o valor '101' na cl\\u00e1usula WHERE para o grupo que deseja investigar.\\r\\n ***************************************************************************************************/\\r\\n\\r\\n-- 3.1. Dossi\\u00ea de um Grupo: Vis\\u00e3o Geral e CNPJs Componentes\\r\\n-- Objetivo: Mostrar as m\\u00e9tricas de risco e listar todas as empresas de um grupo espec\\u00edfico.\\r\\n-- Parte A: M\\u00e9tricas Consolidadas do Grupo\\r\\nSELECT\\r\\n    '3.1. Dossi\\u00ea do Grupo - M\\u00e9tricas Consolidadas' AS Consulta,\\r\\n    *\\r\\nFROM gessimples.gei_percent\\r\\nWHERE num_grupo = 101; -- << MODIFIQUE AQUI O GRUPO ALVO\\r\\n\\r\\n-- Parte B: Detalhe dos CNPJs do Grupo\\r\\nSELECT\\r\\n    '3.1. Dossi\\u00ea do Grupo - Detalhe dos CNPJs Componentes' AS Consulta,\\r\\n    c.cnpj,\\r\\n    cad.nm_razao_social,\\r\\n    cad.nm_fantasia,\\r\\n    cad.cd_cnae,\\r\\n    cad.nm_logradouro || ', ' || cad.nu_logradouro || ' - ' || cad.nm_bairro || ', ' || cad.nm_munic AS endereco,\\r\\n    cad.nm_reg_apuracao\\r\\nFROM gessimples.gei_cnpj c\\r\\nLEFT JOIN gessimples.gei_cadastro cad ON c.cnpj = cad.nu_cnpj\\r\\nWHERE c.num_grupo = 101; -- << MODIFIQUE AQUI O GRUPO ALVO\\r\\n\\r\\n-- 3.2. Dossi\\u00ea de um Grupo: Detalhe das Rela\\u00e7\\u00f5es Societ\\u00e1rias\\r\\n-- Objetivo: Mostrar quais s\\u00f3cios conectam quais empresas dentro de um grupo espec\\u00edfico.\\r\\nSELECT\\r\\n    '3.2. Dossi\\u00ea do Grupo - Detalhe das Rela\\u00e7\\u00f5es Societ\\u00e1rias' AS Consulta,\\r\\n    cpf_socio,\\r\\n    qtd_empresas,\\r\\n    cnpj,\\r\\n    nm_relacao,\\r\\n    pe_capital_empresa,\\r\\n    sn_relacao_ativa\\r\\nFROM\\r\\n    gessimples.gei_socios_compartilhados\\r\\nWHERE\\r\\n    num_grupo = 101 -- << MODIFIQUE AQUI O GRUPO ALVO\\r\\nORDER BY\\r\\n    cpf_socio, cnpj;\\r\\n\\r\\n-- 3.3. Dossi\\u00ea de um Grupo: Detalhe dos Ind\\u00edcios Fiscais\\r\\n-- Objetivo: Listar todos os ind\\u00edcios de irregularidades pr\\u00e9-existentes para cada CNPJ do grupo.\\r\\nSELECT\\r\\n    '3.3. Dossi\\u00ea do Grupo - Detalhe dos Ind\\u00edcios Fiscais' AS Consulta,\\r\\n    i.cnpj,\\r\\n    c.nm_razao_social,\\r\\n    i.tx_descricao_indicio,\\r\\n    i.tx_descricao_complemento\\r\\nFROM\\r\\n    gessimples.gei_indicios i\\r\\nJOIN gessimples.gei_cadastro c ON i.cnpj = c.nu_cnpj\\r\\nWHERE\\r\\n    i.num_grupo = 101 -- << MODIFIQUE AQUI O GRUPO ALVO\\r\\nORDER BY\\r\\n    i.cnpj;\\r\\n\\r\\n\\r\\n/***************************************************************************************************\\r\\n * SE\\u00c7\\u00c3O 4: CONSULTAS ADICIONAIS RELEVANTES\\r\\n ***************************************************************************************************/\\r\\n\\r\\n-- 4.1. An\\u00e1lise Geogr\\u00e1fica de Risco\\r\\n-- Objetivo: Calcular o score de risco m\\u00e9dio por munic\\u00edpio para identificar concentra\\u00e7\\u00f5es geogr\\u00e1ficas.\\r\\nSELECT\\r\\n    '4.1. An\\u00e1lise Geogr\\u00e1fica de Risco por Munic\\u00edpio' AS Consulta,\\r\\n    nm_munic AS nome_municipio,\\r\\n    COUNT(DISTINCT num_grupo) AS qntd_grupos_no_municipio,\\r\\n    ROUND(AVG(score_final_avancado), 2) AS media_score_no_municipio,\\r\\n    ROUND(MAX(score_final_avancado), 2) AS max_score_no_municipio\\r\\nFROM (\\r\\n    SELECT DISTINCT\\r\\n        p.num_grupo,\\r\\n        p.score_final_avancado,\\r\\n        cad.nm_munic\\r\\n    FROM gessimples.gei_percent p\\r\\n    JOIN gessimples.gei_cnpj c ON p.num_grupo = c.num_grupo\\r\\n    JOIN gessimples.gei_cadastro cad ON c.cnpj = cad.nu_cnpj\\r\\n    WHERE cad.nm_munic IS NOT NULL\\r\\n) AS municipio_risco\\r\\nGROUP BY nm_munic\\r\\nHAVING COUNT(DISTINCT num_grupo) > 5 -- Filtra para munic\\u00edpios com mais de 5 grupos\\r\\nORDER BY media_score_no_municipio DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- 4.2. Investigando a Inconsist\\u00eancia de IP em um Grupo Espec\\u00edfico\\r\\nSELECT\\r\\n    '4.2. Detalhe da Inconsist\\u00eancia de IP para o Grupo Alvo' AS Consulta,\\r\\n    nfe_ip_transmissao,\\r\\n    COUNT(DISTINCT nfe_cnpj_cpf_emit) AS qntd_cnpjs_usando_ip,\\r\\n    -- CORRIGIDO: Substitu\\u00edmos ARRAY_AGG por GROUP_CONCAT, que \\u00e9 mais comum.\\r\\n    -- O segundo par\\u00e2metro (separador) pode variar. ', ' \\u00e9 uma boa op\\u00e7\\u00e3o.\\r\\n    GROUP_CONCAT(DISTINCT nfe_cnpj_cpf_emit, ', ') AS lista_de_cnpjs\\r\\nFROM\\r\\n    gessimples.gei_nfe_completo\\r\\nWHERE\\r\\n    grupo_emit = 101 -- << MODIFIQUE AQUI O GRUPO ALVO\\r\\n    AND ip_transmissao_incons = 'S'\\r\\nGROUP BY\\r\\n    nfe_ip_transmissao\\r\\nHAVING\\r\\n    COUNT(DISTINCT nfe_cnpj_cpf_emit) > 1\\r\\nORDER BY\\r\\n    qntd_cnpjs_usando_ip DESC;\\r\\n\\r\\n-- 5.1. Ranking de Risco \\\"Empresa Fantasma / Laranja\\\"\\r\\nSELECT\\r\\n    '5.1. Ranking de Risco \\\"Empresa Fantasma / Laranja\\\"' AS Consulta,\\r\\n    p.num_grupo,\\r\\n    -- C\\u00e1lculo de um score espec\\u00edfico para este risco\\r\\n    ROUND(\\r\\n        (p.indice_risco_fat_func * 0.5) +                                         -- 50% de peso para Faturamento vs Funcion\\u00e1rios\\r\\n        ((COALESCE(i.perc_ip_transmissao, 0) + COALESCE(i.perc_end_emit, 0)) * 0.3) + -- 30% de peso para inconsist\\u00eancias operacionais\\r\\n        (p.indice_interconexao * 0.2)                                             -- 20% de peso para a estrutura societ\\u00e1ria fechada\\r\\n    , 4) AS score_risco_fantasma,\\r\\n    p.valor_max AS faturamento_maximo_12m,\\r\\n    p.total_funcionarios,\\r\\n    i.perc_ip_transmissao,\\r\\n    i.perc_end_emit,\\r\\n    p.qntd_cnpj\\r\\nFROM\\r\\n    gessimples.gei_percent p\\r\\n-- Usamos a tabela intermedi\\u00e1ria para pegar os percentuais de inconsist\\u00eancia\\r\\nJOIN gessimples.gei_percent_intermediario i ON p.num_grupo = i.num_grupo\\r\\nWHERE\\r\\n    p.total_funcionarios <= 5 -- Filtra para grupos com estrutura de pessoal m\\u00ednima\\r\\nORDER BY\\r\\n    score_risco_fantasma DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- 5.2. Ranking de Risco \\\"Confus\\u00e3o Patrimonial Grave\\\"\\r\\nSELECT\\r\\n    '5.2. Ranking de Risco \\\"Confus\\u00e3o Patrimonial Grave\\\"' AS Consulta,\\r\\n    num_grupo,\\r\\n    -- Score que combina os dois principais fatores de risco\\r\\n    ROUND((indice_risco_pagamentos * 0.6) + (indice_interconexao * 0.4), 4) AS score_confusao_patrimonial,\\r\\n    indice_risco_pagamentos,\\r\\n    indice_interconexao,\\r\\n    valor_meios_pagamento_empresas,\\r\\n    valor_meios_pagamento_socios,\\r\\n    qtd_socios_compartilhados,\\r\\n    qntd_cnpj,\\r\\n    score_final_avancado\\r\\nFROM\\r\\n    gessimples.gei_percent\\r\\nWHERE\\r\\n    -- Filtra por grupos com ind\\u00edcios significativos em ambos os fatores\\r\\n    indice_risco_pagamentos > 0.25 AND indice_interconexao > 0.25\\r\\nORDER BY\\r\\n    score_confusao_patrimonial DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- 5.3. Ranking de Risco \\\"Crescimento Explosivo e At\\u00edpico\\\" (VERS\\u00c3O FINAL COM DATAS CORRIGIDAS)\\r\\nWITH grupo_idade AS (\\r\\n    SELECT\\r\\n        g.num_grupo,\\r\\n        MIN(c.dt_constituicao_empresa) AS data_abertura_recente\\r\\n    FROM gessimples.gei_cnpj g\\r\\n    JOIN gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\\r\\n    WHERE c.dt_constituicao_empresa IS NOT NULL\\r\\n    GROUP BY g.num_grupo\\r\\n)\\r\\nSELECT\\r\\n    '5.3. Ranking de Risco \\\"Crescimento Explosivo e At\\u00edpico\\\"' AS Consulta,\\r\\n    p.num_grupo,\\r\\n    -- CORRIGIDO: Substitu\\u00eddo DATE_DIFF(..., DAY) por DATEDIFF(...)\\r\\n    ROUND(p.valor_max / NULLIF(DATEDIFF(CAST(CURRENT_TIMESTAMP() AS DATE), gi.data_abertura_recente), 0), 2) AS receita_por_dia_de_vida,\\r\\n    p.valor_max AS faturamento_maximo_12m,\\r\\n    gi.data_abertura_recente,\\r\\n    -- CORRIGIDO: Substitu\\u00eddo DATE_DIFF(..., DAY) por DATEDIFF(...)\\r\\n    DATEDIFF(CAST(CURRENT_TIMESTAMP() AS DATE), gi.data_abertura_recente) as dias_de_existencia,\\r\\n    p.total_funcionarios,\\r\\n    p.score_final_avancado\\r\\nFROM\\r\\n    gessimples.gei_percent p\\r\\nJOIN\\r\\n    grupo_idade gi ON p.num_grupo = gi.num_grupo\\r\\nWHERE\\r\\n    -- CORRIGIDO: Substitu\\u00eddo DATE_DIFF(..., YEAR) por uma subtra\\u00e7\\u00e3o de anos\\r\\n    (YEAR(CAST(CURRENT_TIMESTAMP() AS DATE)) - YEAR(gi.data_abertura_recente)) < 3\\r\\n    AND p.valor_max > 1000000 -- E com faturamento relevante\\r\\nORDER BY\\r\\n    receita_por_dia_de_vida DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- 5.4. Ranking de S\\u00f3cios que mais Conectam Grupos de Alto Risco (VERS\\u00c3O CORRIGIDA)\\r\\nWITH grupos_alto_risco AS (\\r\\n    SELECT num_grupo FROM gessimples.gei_percent WHERE score_final_avancado > 10 -- Define um limiar de alto risco\\r\\n)\\r\\nSELECT\\r\\n    '5.4. Ranking de S\\u00f3cios que mais Conectam Grupos de Alto Risco' AS Consulta,\\r\\n    s.cpf_socio,\\r\\n    COUNT(DISTINCT s.num_grupo) AS n_grupos_de_alto_risco_conectados,\\r\\n    -- CORRIGIDO: Convertemos s.num_grupo (que \\u00e9 um BIGINT) para STRING antes de concatenar.\\r\\n    GROUP_CONCAT(DISTINCT CAST(s.num_grupo AS STRING), ', ') AS lista_grupos_conectados\\r\\nFROM\\r\\n    gessimples.gei_socios_compartilhados s\\r\\nJOIN\\r\\n    grupos_alto_risco gar ON s.num_grupo = gar.num_grupo\\r\\nGROUP BY\\r\\n    s.cpf_socio\\r\\nHAVING\\r\\n    COUNT(DISTINCT s.num_grupo) > 1 -- Apenas s\\u00f3cios que conectam mais de um grupo de risco\\r\\nORDER BY\\r\\n    n_grupos_de_alto_risco_conectados DESC\\r\\nLIMIT 15;\\r\\n\\r\\n\\r\\n/***************************************************************************************************\\r\\n * FIM DO SCRIPT\\r\\n ***************************************************************************************************/\", \"statementsList\": [\"\\r\\n\\r\\n\\r\\n/***************************************************************************************************\\r\\n * SE\\u00c7\\u00c3O 2: CONSULTAS ANAL\\u00cdTICAS (RANKINGS E PADR\\u00d5ES)\\r\\n ***************************************************************************************************/\\r\\n\\r\\n-- 2.1. Top 20 Grupos por Score Final de Risco\\r\\n-- Objetivo: Listar os grupos com a maior pontua\\u00e7\\u00e3o de risco combinado para direcionar a fiscaliza\\u00e7\\u00e3o.\\r\\nSELECT\\r\\n    '2.1. Top 20 Grupos por Score Final de Risco' AS Consulta,\\r\\n    num_grupo,\\r\\n    score_final_avancado,\\r\\n    qntd_cnpj,\\r\\n    total AS score_soma_inconsistencias,\\r\\n    indice_interconexao,\\r\\n    indice_risco_grupo_economico,\\r\\n    indice_risco_indicios,\\r\\n    indice_risco_pagamentos,\\r\\n    indice_risco_fat_func,\\r\\n    nivel_risco_grupo_economico\\r\\nFROM\\r\\n    gessimples.gei_percent\\r\\nORDER BY\\r\\n    score_final_avancado DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n-- 2.2. Top 10 Contadores Associados a Grupos de Alto Risco\\r\\n-- Objetivo: Identificar contadores cujos clientes apresentam, em m\\u00e9dia, os maiores scores de risco.\\r\\nSELECT\\r\\n    '2.2. Top 10 Contadores Associados a Grupos de Alto Risco' AS Consulta,\\r\\n    nm_contador,\\r\\n    nm_gerfe,\\r\\n    media AS media_score_dos_grupos,\\r\\n    qntd_grupos\\r\\nFROM\\r\\n    gessimples.gei_contador\\r\\nORDER BY\\r\\n    media DESC, qntd_grupos DESC\\r\\nLIMIT 10;\", \"\\r\\n\\r\\n-- 2.3. Top 15 Grupos com Maior Risco de Confus\\u00e3o Patrimonial (An\\u00e1lise de Pagamentos)\\r\\n-- Objetivo: Listar grupos onde a movimenta\\u00e7\\u00e3o financeira nos CPFs dos s\\u00f3cios \\u00e9 alta em rela\\u00e7\\u00e3o \\u00e0 dos CNPJs.\\r\\nSELECT\\r\\n    '2.3. Top 15 Grupos com Maior Risco de Confus\\u00e3o Patrimonial' AS Consulta,\\r\\n    num_grupo,\\r\\n    indice_risco_pagamentos,\\r\\n    valor_meios_pagamento_empresas,\\r\\n    valor_meios_pagamento_socios,\\r\\n    qntd_cnpj,\\r\\n    score_final_avancado\\r\\nFROM\\r\\n    gessimples.gei_percent\\r\\nWHERE valor_meios_pagamento_empresas > 0\\r\\nORDER BY\\r\\n    indice_risco_pagamentos DESC\\r\\nLIMIT 15;\", \"\\r\\n\\r\\n\\r\\n/***************************************************************************************************\\r\\n * SE\\u00c7\\u00c3O 3: AN\\u00c1LISES COMPLETAS (DOSSI\\u00ca DE GRUPOS ESPEC\\u00cdFICOS)\\r\\n * Lembre-se de alterar o valor '101' na cl\\u00e1usula WHERE para o grupo que deseja investigar.\\r\\n ***************************************************************************************************/\\r\\n\\r\\n-- 3.1. Dossi\\u00ea de um Grupo: Vis\\u00e3o Geral e CNPJs Componentes\\r\\n-- Objetivo: Mostrar as m\\u00e9tricas de risco e listar todas as empresas de um grupo espec\\u00edfico.\\r\\n-- Parte A: M\\u00e9tricas Consolidadas do Grupo\\r\\nSELECT\\r\\n    '3.1. Dossi\\u00ea do Grupo - M\\u00e9tricas Consolidadas' AS Consulta,\\r\\n    *\\r\\nFROM gessimples.gei_percent\\r\\nWHERE num_grupo = 101;\", \" -- << MODIFIQUE AQUI O GRUPO ALVO\\r\\n\\r\\n-- Parte B: Detalhe dos CNPJs do Grupo\\r\\nSELECT\\r\\n    '3.1. Dossi\\u00ea do Grupo - Detalhe dos CNPJs Componentes' AS Consulta,\\r\\n    c.cnpj,\\r\\n    cad.nm_razao_social,\\r\\n    cad.nm_fantasia,\\r\\n    cad.cd_cnae,\\r\\n    cad.nm_logradouro || ', ' || cad.nu_logradouro || ' - ' || cad.nm_bairro || ', ' || cad.nm_munic AS endereco,\\r\\n    cad.nm_reg_apuracao\\r\\nFROM gessimples.gei_cnpj c\\r\\nLEFT JOIN gessimples.gei_cadastro cad ON c.cnpj = cad.nu_cnpj\\r\\nWHERE c.num_grupo = 101;\", \" -- << MODIFIQUE AQUI O GRUPO ALVO\\r\\n\\r\\n-- 3.2. Dossi\\u00ea de um Grupo: Detalhe das Rela\\u00e7\\u00f5es Societ\\u00e1rias\\r\\n-- Objetivo: Mostrar quais s\\u00f3cios conectam quais empresas dentro de um grupo espec\\u00edfico.\\r\\nSELECT\\r\\n    '3.2. Dossi\\u00ea do Grupo - Detalhe das Rela\\u00e7\\u00f5es Societ\\u00e1rias' AS Consulta,\\r\\n    cpf_socio,\\r\\n    qtd_empresas,\\r\\n    cnpj,\\r\\n    nm_relacao,\\r\\n    pe_capital_empresa,\\r\\n    sn_relacao_ativa\\r\\nFROM\\r\\n    gessimples.gei_socios_compartilhados\\r\\nWHERE\\r\\n    num_grupo = 101 -- << MODIFIQUE AQUI O GRUPO ALVO\\r\\nORDER BY\\r\\n    cpf_socio, cnpj;\", \"\\r\\n\\r\\n-- 3.3. Dossi\\u00ea de um Grupo: Detalhe dos Ind\\u00edcios Fiscais\\r\\n-- Objetivo: Listar todos os ind\\u00edcios de irregularidades pr\\u00e9-existentes para cada CNPJ do grupo.\\r\\nSELECT\\r\\n    '3.3. Dossi\\u00ea do Grupo - Detalhe dos Ind\\u00edcios Fiscais' AS Consulta,\\r\\n    i.cnpj,\\r\\n    c.nm_razao_social,\\r\\n    i.tx_descricao_indicio,\\r\\n    i.tx_descricao_complemento\\r\\nFROM\\r\\n    gessimples.gei_indicios i\\r\\nJOIN gessimples.gei_cadastro c ON i.cnpj = c.nu_cnpj\\r\\nWHERE\\r\\n    i.num_grupo = 101 -- << MODIFIQUE AQUI O GRUPO ALVO\\r\\nORDER BY\\r\\n    i.cnpj;\", \"\\r\\n\\r\\n\\r\\n/***************************************************************************************************\\r\\n * SE\\u00c7\\u00c3O 4: CONSULTAS ADICIONAIS RELEVANTES\\r\\n ***************************************************************************************************/\\r\\n\\r\\n-- 4.1. An\\u00e1lise Geogr\\u00e1fica de Risco\\r\\n-- Objetivo: Calcular o score de risco m\\u00e9dio por munic\\u00edpio para identificar concentra\\u00e7\\u00f5es geogr\\u00e1ficas.\\r\\nSELECT\\r\\n    '4.1. An\\u00e1lise Geogr\\u00e1fica de Risco por Munic\\u00edpio' AS Consulta,\\r\\n    nm_munic AS nome_municipio,\\r\\n    COUNT(DISTINCT num_grupo) AS qntd_grupos_no_municipio,\\r\\n    ROUND(AVG(score_final_avancado), 2) AS media_score_no_municipio,\\r\\n    ROUND(MAX(score_final_avancado), 2) AS max_score_no_municipio\\r\\nFROM (\\r\\n    SELECT DISTINCT\\r\\n        p.num_grupo,\\r\\n        p.score_final_avancado,\\r\\n        cad.nm_munic\\r\\n    FROM gessimples.gei_percent p\\r\\n    JOIN gessimples.gei_cnpj c ON p.num_grupo = c.num_grupo\\r\\n    JOIN gessimples.gei_cadastro cad ON c.cnpj = cad.nu_cnpj\\r\\n    WHERE cad.nm_munic IS NOT NULL\\r\\n) AS municipio_risco\\r\\nGROUP BY nm_munic\\r\\nHAVING COUNT(DISTINCT num_grupo) > 5 -- Filtra para munic\\u00edpios com mais de 5 grupos\\r\\nORDER BY media_score_no_municipio DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n\\r\\n-- 4.2. Investigando a Inconsist\\u00eancia de IP em um Grupo Espec\\u00edfico\\r\\nSELECT\\r\\n    '4.2. Detalhe da Inconsist\\u00eancia de IP para o Grupo Alvo' AS Consulta,\\r\\n    nfe_ip_transmissao,\\r\\n    COUNT(DISTINCT nfe_cnpj_cpf_emit) AS qntd_cnpjs_usando_ip,\\r\\n    -- CORRIGIDO: Substitu\\u00edmos ARRAY_AGG por GROUP_CONCAT, que \\u00e9 mais comum.\\r\\n    -- O segundo par\\u00e2metro (separador) pode variar. ', ' \\u00e9 uma boa op\\u00e7\\u00e3o.\\r\\n    GROUP_CONCAT(DISTINCT nfe_cnpj_cpf_emit, ', ') AS lista_de_cnpjs\\r\\nFROM\\r\\n    gessimples.gei_nfe_completo\\r\\nWHERE\\r\\n    grupo_emit = 101 -- << MODIFIQUE AQUI O GRUPO ALVO\\r\\n    AND ip_transmissao_incons = 'S'\\r\\nGROUP BY\\r\\n    nfe_ip_transmissao\\r\\nHAVING\\r\\n    COUNT(DISTINCT nfe_cnpj_cpf_emit) > 1\\r\\nORDER BY\\r\\n    qntd_cnpjs_usando_ip DESC;\", \"\\r\\n\\r\\n-- 5.1. Ranking de Risco \\\"Empresa Fantasma / Laranja\\\"\\r\\nSELECT\\r\\n    '5.1. Ranking de Risco \\\"Empresa Fantasma / Laranja\\\"' AS Consulta,\\r\\n    p.num_grupo,\\r\\n    -- C\\u00e1lculo de um score espec\\u00edfico para este risco\\r\\n    ROUND(\\r\\n        (p.indice_risco_fat_func * 0.5) +                                         -- 50% de peso para Faturamento vs Funcion\\u00e1rios\\r\\n        ((COALESCE(i.perc_ip_transmissao, 0) + COALESCE(i.perc_end_emit, 0)) * 0.3) + -- 30% de peso para inconsist\\u00eancias operacionais\\r\\n        (p.indice_interconexao * 0.2)                                             -- 20% de peso para a estrutura societ\\u00e1ria fechada\\r\\n    , 4) AS score_risco_fantasma,\\r\\n    p.valor_max AS faturamento_maximo_12m,\\r\\n    p.total_funcionarios,\\r\\n    i.perc_ip_transmissao,\\r\\n    i.perc_end_emit,\\r\\n    p.qntd_cnpj\\r\\nFROM\\r\\n    gessimples.gei_percent p\\r\\n-- Usamos a tabela intermedi\\u00e1ria para pegar os percentuais de inconsist\\u00eancia\\r\\nJOIN gessimples.gei_percent_intermediario i ON p.num_grupo = i.num_grupo\\r\\nWHERE\\r\\n    p.total_funcionarios <= 5 -- Filtra para grupos com estrutura de pessoal m\\u00ednima\\r\\nORDER BY\\r\\n    score_risco_fantasma DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n-- 5.2. Ranking de Risco \\\"Confus\\u00e3o Patrimonial Grave\\\"\\r\\nSELECT\\r\\n    '5.2. Ranking de Risco \\\"Confus\\u00e3o Patrimonial Grave\\\"' AS Consulta,\\r\\n    num_grupo,\\r\\n    -- Score que combina os dois principais fatores de risco\\r\\n    ROUND((indice_risco_pagamentos * 0.6) + (indice_interconexao * 0.4), 4) AS score_confusao_patrimonial,\\r\\n    indice_risco_pagamentos,\\r\\n    indice_interconexao,\\r\\n    valor_meios_pagamento_empresas,\\r\\n    valor_meios_pagamento_socios,\\r\\n    qtd_socios_compartilhados,\\r\\n    qntd_cnpj,\\r\\n    score_final_avancado\\r\\nFROM\\r\\n    gessimples.gei_percent\\r\\nWHERE\\r\\n    -- Filtra por grupos com ind\\u00edcios significativos em ambos os fatores\\r\\n    indice_risco_pagamentos > 0.25 AND indice_interconexao > 0.25\\r\\nORDER BY\\r\\n    score_confusao_patrimonial DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n-- 5.3. Ranking de Risco \\\"Crescimento Explosivo e At\\u00edpico\\\" (VERS\\u00c3O FINAL COM DATAS CORRIGIDAS)\\r\\nWITH grupo_idade AS (\\r\\n    SELECT\\r\\n        g.num_grupo,\\r\\n        MIN(c.dt_constituicao_empresa) AS data_abertura_recente\\r\\n    FROM gessimples.gei_cnpj g\\r\\n    JOIN gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\\r\\n    WHERE c.dt_constituicao_empresa IS NOT NULL\\r\\n    GROUP BY g.num_grupo\\r\\n)\\r\\nSELECT\\r\\n    '5.3. Ranking de Risco \\\"Crescimento Explosivo e At\\u00edpico\\\"' AS Consulta,\\r\\n    p.num_grupo,\\r\\n    -- CORRIGIDO: Substitu\\u00eddo DATE_DIFF(..., DAY) por DATEDIFF(...)\\r\\n    ROUND(p.valor_max / NULLIF(DATEDIFF(CAST(CURRENT_TIMESTAMP() AS DATE), gi.data_abertura_recente), 0), 2) AS receita_por_dia_de_vida,\\r\\n    p.valor_max AS faturamento_maximo_12m,\\r\\n    gi.data_abertura_recente,\\r\\n    -- CORRIGIDO: Substitu\\u00eddo DATE_DIFF(..., DAY) por DATEDIFF(...)\\r\\n    DATEDIFF(CAST(CURRENT_TIMESTAMP() AS DATE), gi.data_abertura_recente) as dias_de_existencia,\\r\\n    p.total_funcionarios,\\r\\n    p.score_final_avancado\\r\\nFROM\\r\\n    gessimples.gei_percent p\\r\\nJOIN\\r\\n    grupo_idade gi ON p.num_grupo = gi.num_grupo\\r\\nWHERE\\r\\n    -- CORRIGIDO: Substitu\\u00eddo DATE_DIFF(..., YEAR) por uma subtra\\u00e7\\u00e3o de anos\\r\\n    (YEAR(CAST(CURRENT_TIMESTAMP() AS DATE)) - YEAR(gi.data_abertura_recente)) < 3\\r\\n    AND p.valor_max > 1000000 -- E com faturamento relevante\\r\\nORDER BY\\r\\n    receita_por_dia_de_vida DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n-- 5.4. Ranking de S\\u00f3cios que mais Conectam Grupos de Alto Risco (VERS\\u00c3O CORRIGIDA)\\r\\nWITH grupos_alto_risco AS (\\r\\n    SELECT num_grupo FROM gessimples.gei_percent WHERE score_final_avancado > 10 -- Define um limiar de alto risco\\r\\n)\\r\\nSELECT\\r\\n    '5.4. Ranking de S\\u00f3cios que mais Conectam Grupos de Alto Risco' AS Consulta,\\r\\n    s.cpf_socio,\\r\\n    COUNT(DISTINCT s.num_grupo) AS n_grupos_de_alto_risco_conectados,\\r\\n    -- CORRIGIDO: Convertemos s.num_grupo (que \\u00e9 um BIGINT) para STRING antes de concatenar.\\r\\n    GROUP_CONCAT(DISTINCT CAST(s.num_grupo AS STRING), ', ') AS lista_grupos_conectados\\r\\nFROM\\r\\n    gessimples.gei_socios_compartilhados s\\r\\nJOIN\\r\\n    grupos_alto_risco gar ON s.num_grupo = gar.num_grupo\\r\\nGROUP BY\\r\\n    s.cpf_socio\\r\\nHAVING\\r\\n    COUNT(DISTINCT s.num_grupo) > 1 -- Apenas s\\u00f3cios que conectam mais de um grupo de risco\\r\\nORDER BY\\r\\n    n_grupos_de_alto_risco_conectados DESC\\r\\nLIMIT 15;\", \"\\r\\n\\r\\n\\r\\n/***************************************************************************************************\\r\\n * FIM DO SCRIPT\\r\\n ***************************************************************************************************/\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- 5.4. Ranking de S\\u00f3cios que mais Conectam Grupos de Alto Risco (VERS\\u00c3O CORRIGIDA)\\r\\nWITH grupos_alto_risco AS (\\r\\n    SELECT num_grupo FROM gessimples.gei_percent WHERE score_final_avancado > 10 -- Define um limiar de alto risco\\r\\n)\\r\\nSELECT\\r\\n    '5.4. Ranking de S\\u00f3cios que mais Conectam Grupos de Alto Risco' AS Consulta,\\r\\n    s.cpf_socio,\\r\\n    COUNT(DISTINCT s.num_grupo) AS n_grupos_de_alto_risco_conectados,\\r\\n    -- CORRIGIDO: Convertemos s.num_grupo (que \\u00e9 um BIGINT) para STRING antes de concatenar.\\r\\n    GROUP_CONCAT(DISTINCT CAST(s.num_grupo AS STRING), ', ') AS lista_grupos_conectados\\r\\nFROM\\r\\n    gessimples.gei_socios_compartilhados s\\r\\nJOIN\\r\\n    grupos_alto_risco gar ON s.num_grupo = gar.num_grupo\\r\\nGROUP BY\\r\\n    s.cpf_socio\\r\\nHAVING\\r\\n    COUNT(DISTINCT s.num_grupo) > 1 -- Apenas s\\u00f3cios que conectam mais de um grupo de risco\\r\\nORDER BY\\r\\n    n_grupos_de_alto_risco_conectados DESC\\r\\nLIMIT 15;\", \"result\": {\"id\": \"914c9043-ddf6-1a3e-a720-e975a2f5990d\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"RRsMavRVQ5OmLayhH3EfOQ==\", \"guid\": \"i3bXGXl3SGMAAAAAvzEuyw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"ab42a38d9e47fa0e:b4ed6631bc5727b3\", \"session_id\": 20989, \"session_type\": \"impala\", \"statement_id\": 0, \"has_more_statements\": false, \"statements_count\": 1, \"previous_statement_hash\": \"5f3998dd0b06cf72d1595586e914149770b1b0f3123be5a03a616290\", \"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 898}, \"statement\": \"-- 5.4. Ranking de S\\u00f3cios que mais Conectam Grupos de Alto Risco (VERS\\u00c3O CORRIGIDA)\\r\\nWITH grupos_alto_risco AS (\\r\\n    SELECT num_grupo FROM gessimples.gei_percent WHERE score_final_avancado > 10 -- Define um limiar de alto risco\\r\\n)\\r\\nSELECT\\r\\n    '5.4. Ranking de S\\u00f3cios que mais Conectam Grupos de Alto Risco' AS Consulta,\\r\\n    s.cpf_socio,\\r\\n    COUNT(DISTINCT s.num_grupo) AS n_grupos_de_alto_risco_conectados,\\r\\n    -- CORRIGIDO: Convertemos s.num_grupo (que \\u00e9 um BIGINT) para STRING antes de concatenar.\\r\\n    GROUP_CONCAT(DISTINCT CAST(s.num_grupo AS STRING), ', ') AS lista_grupos_conectados\\r\\nFROM\\r\\n    gessimples.gei_socios_compartilhados s\\r\\nJOIN\\r\\n    grupos_alto_risco gar ON s.num_grupo = gar.num_grupo\\r\\nGROUP BY\\r\\n    s.cpf_socio\\r\\nHAVING\\r\\n    COUNT(DISTINCT s.num_grupo) > 1 -- Apenas s\\u00f3cios que conectam mais de um grupo de risco\\r\\nORDER BY\\r\\n    n_grupos_de_alto_risco_conectados DESC\\r\\nLIMIT 15\"}, \"meta\": [], \"rows\": 15, \"hasMore\": false, \"statement_id\": 0, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 1, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 4, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"consulta\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}, {\"name\": \"cpf_socio\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 2}, {\"name\": \"n_grupos_de_alto_risco_conectados\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 3}, {\"name\": \"lista_grupos_conectados\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 4}], \"fetchedOnce\": false, \"startTime\": \"2025-09-29T21:41:29.318Z\", \"endTime\": \"2025-09-29T21:41:30.654Z\", \"executionTime\": 1336, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 3, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 81620, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"consulta\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"n_grupos_de_alto_risco_conectados\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 83795, \"getLogsTimeout\": 83965, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1759182089051, \"lastAceSelectionRowOffset\": 348, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- 5.4. Ranking de S\\u00f3cios que mais Conectam Grupos de Alto Risco (VERS\\u00c3O CORRIGIDA)\\r\\nWITH grupos_alto_risco AS (\\r\\n    SELECT num_grupo FROM gessimples.gei_percent WHERE score_final_avancado > 10 -- Define um limiar de alto risco\\r\\n)\\r\\nSELECT\\r\\n    '5.4. Ranking de S\\u00f3cios que mais Conectam Grupos de Alto Risco' AS Consulta,\\r\\n    s.cpf_socio,\\r\\n    COUNT(DISTINCT s.num_grupo) AS n_grupos_de_alto_risco_conectados,\\r\\n    -- CORRIGIDO: Convertemos s.num_grupo (que \\u00e9 um BIGINT) para STRING antes de concatenar.\\r\\n    GROUP_CONCAT(DISTINCT CAST(s.num_grupo AS STRING), ', ') AS lista_grupos_conectados\\r\\nFROM\\r\\n    gessimples.gei_socios_compartilhados s\\r\\nJOIN\\r\\n    grupos_alto_risco gar ON s.num_grupo = gar.num_grupo\\r\\nGROUP BY\\r\\n    s.cpf_socio\\r\\nHAVING\\r\\n    COUNT(DISTINCT s.num_grupo) > 1 -- Apenas s\\u00f3cios que conectam mais de um grupo de risco\\r\\nORDER BY\\r\\n    n_grupos_de_alto_risco_conectados DESC\\r\\nLIMIT 15;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 348, \"column\": 0}, \"end\": {\"row\": 368, \"column\": 9}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 6348777919d7768b:cb2e31bf00000000 100% Complete (2 out of 2)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"6348777919d7768b:cb2e31bf00000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=6348777919d7768b:cb2e31bf00000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 6348777919d7768b:cb2e31bf00000000 100% Complete (2 out of 2)\", \"progress\": 100, \"jobs\": [{\"name\": \"6348777919d7768b:cb2e31bf00000000\", \"url\": \"/hue/jobbrowser#!id=6348777919d7768b:cb2e31bf00000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 9589, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 96, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "/***************************************************************************************************\r\n * =================================================================================================\r\n * SCRIPT UNIFICADO DE ANÃLISE E CONSULTA - SISTEMA GEI (GestÃ£o de Empresas e IndÃ­cios)\r\n * =================================================================================================\r\n *\r\n * DESCRIÃÃO:\r\n * Este script contÃ©m um conjunto completo de consultas prontas para uso que extraem estatÃ­sticas,\r\n * rankings e anÃ¡lises detalhadas do data warehouse GEI.\r\n *\r\n * COMO USAR:\r\n * 1. Para as \"AnÃ¡lises Completas (DossiÃª)\", modifique o nÃºmero do grupo na seÃ§Ã£o \"PARÃMETRO DE\r\n * ANÃLISE\" abaixo.\r\n * 2. Execute o script completo ou cada consulta individualmente.\r\n *\r\n * DATA DE GERAÃÃO: 29 de Setembro de 2025\r\n ***************************************************************************************************/\r\n\r\n-- =================================================================================================\r\n-- PARÃMETRO DE ANÃLISE (MODIFIQUE AQUI)\r\n-- Defina o nÃºmero do grupo que vocÃª deseja analisar em detalhe nas seÃ§Ãµes de \"DossiÃª\".\r\n-- Altere o valor '101' para o cÃ³digo do grupo desejado.\r\n-- =================================================================================================\r\n-- DECLARE @grupo_alvo VARCHAR(20) = '101'; -- Exemplo de sintaxe para SQL Server.\r\n-- SET gei_grupo_alvo = '101'; -- Exemplo de sintaxe para outros SGBDs.\r\n-- Para portabilidade, o valor serÃ¡ inserido diretamente nas clÃ¡usulas WHERE abaixo.\r\n\r\n\r\n/***************************************************************************************************\r\n * SEÃÃO 1: ESTATÃSTICAS GERAIS DO SISTEMA (VISÃO MACRO)\r\n ***************************************************************************************************/\r\n\r\n-- 1.1. Resumo Quantitativo do Ambiente\r\n-- Objetivo: Obter as contagens totais de grupos, CNPJs monitorados e o volume de dados processados.\r\nSELECT\r\n    '1.1. Resum",
    "last_modified": "2025-09-29T18:41:46.601",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 158244,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: ANALISES C",
    "description": "",
    "uuid": "7f3a3e9a-aa8f-6117-ac74-feb464f52afd",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 158244, \"uuid\": \"7f3a3e9a-aa8f-6117-ac74-feb464f52afd\", \"name\": \"GEI: ANALISES C\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"2fb9a712-a447-de26-9fc9-21dc8e4175d3\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- CONFIGURA\\u00c7\\u00c3O PADR\\u00c3O PARA CONSULTAS PESADAS\\r\\nSET REQUEST_POOL = 'medium';\\r\\nSET MEM_LIMIT = 8G;\\r\\n\\r\\n-- ============================================================================\\r\\n-- 1. ESTAT\\u00cdSTICAS GERAIS DO SISTEMA\\r\\n-- ============================================================================\\r\\n\\r\\n-- 1.1 PANORAMA GERAL DO SISTEMA\\r\\n-- Vis\\u00e3o executiva com principais m\\u00e9tricas consolidadas\\r\\nSELECT \\r\\n    'PANORAMA GERAL DO SISTEMA GEI' AS categoria,\\r\\n    \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT num_grupo) AS total_grupos_monitorados,\\r\\n    COUNT(DISTINCT CASE WHEN qntd_cnpj >= 2 THEN num_grupo END) AS grupos_multiplas_empresas,\\r\\n    SUM(qntd_cnpj) AS total_cnpjs_monitorados,\\r\\n    \\r\\n    -- M\\u00e9tricas de Risco\\r\\n    COUNT(DISTINCT CASE WHEN score_final_avancado >= 20 THEN num_grupo END) AS grupos_risco_critico,\\r\\n    COUNT(DISTINCT CASE WHEN score_final_avancado >= 15 AND score_final_avancado < 20 THEN num_grupo END) AS grupos_risco_alto,\\r\\n    COUNT(DISTINCT CASE WHEN score_final_avancado >= 10 AND score_final_avancado < 15 THEN num_grupo END) AS grupos_risco_medio,\\r\\n    \\r\\n    -- Percentuais de Risco\\r\\n    ROUND(COUNT(DISTINCT CASE WHEN score_final_avancado >= 15 THEN num_grupo END) * 100.0 / \\r\\n          COUNT(DISTINCT num_grupo), 2) AS perc_grupos_alto_risco,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    SUM(COALESCE(valor_max, 0)) AS receita_bruta_total_monitorada,\\r\\n    COUNT(DISTINCT CASE WHEN valor_max >= 4800000 THEN num_grupo END) AS grupos_acima_limite_sn,\\r\\n    \\r\\n    -- M\\u00e9tricas de Inconsist\\u00eancias\\r\\n    AVG(total) AS media_inconsistencias_nfe,\\r\\n    COUNT(DISTINCT CASE WHEN total >= 5 THEN num_grupo END) AS grupos_alta_inconsistencia,\\r\\n    \\r\\n    -- M\\u00e9tricas Societ\\u00e1rias\\r\\n    AVG(COALESCE(indice_interconexao, 0)) AS indice_interconexao_medio,\\r\\n    COUNT(DISTINCT CASE WHEN qtd_socios_compartilhados > 0 THEN num_grupo END) AS grupos_socios_compartilhados,\\r\\n    \\r\\n    -- M\\u00e9tricas C115\\r\\n    COUNT(DISTINCT CASE WHEN nivel_risco_grupo_economico IS NOT NULL THEN num_grupo END) AS grupos_com_dados_c115,\\r\\n    COUNT(DISTINCT CASE WHEN nivel_risco_grupo_economico IN ('CR\\u00cdTICO', 'ALTO') THEN num_grupo END) AS grupos_risco_c115_critico_alto,\\r\\n    \\r\\n    -- M\\u00e9tricas de Ind\\u00edcios\\r\\n    COUNT(DISTINCT CASE WHEN qtd_total_indicios > 0 THEN num_grupo END) AS grupos_com_indicios,\\r\\n    AVG(COALESCE(qtd_total_indicios, 0)) AS media_indicios_por_grupo,\\r\\n    \\r\\n    -- Data de Atualiza\\u00e7\\u00e3o\\r\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_consulta\\r\\n    \\r\\nFROM gessimples.gei_percent;\\r\\n\\r\\n-- 1.2 DISTRIBUI\\u00c7\\u00c3O POR FAIXAS DE SCORE\\r\\n-- An\\u00e1lise da distribui\\u00e7\\u00e3o dos grupos por faixas de risco\\r\\nSELECT \\r\\n    'DISTRIBUI\\u00c7\\u00c3O POR FAIXAS DE SCORE' AS categoria,\\r\\n    \\r\\n    CASE \\r\\n        WHEN score_final_avancado >= 25 THEN '25+ (Cr\\u00edtico Extremo)'\\r\\n        WHEN score_final_avancado >= 20 THEN '20-24.99 (Cr\\u00edtico)'\\r\\n        WHEN score_final_avancado >= 15 THEN '15-19.99 (Alto)'\\r\\n        WHEN score_final_avancado >= 10 THEN '10-14.99 (M\\u00e9dio)'\\r\\n        WHEN score_final_avancado >= 5 THEN '5-9.99 (Baixo)'\\r\\n        ELSE '0-4.99 (M\\u00ednimo)'\\r\\n    END AS faixa_score,\\r\\n    \\r\\n    COUNT(num_grupo) AS quantidade_grupos,\\r\\n    ROUND(COUNT(num_grupo) * 100.0 / SUM(COUNT(num_grupo)) OVER(), 2) AS percentual,\\r\\n    SUM(qntd_cnpj) AS total_cnpjs_faixa,\\r\\n    AVG(score_final_avancado) AS score_medio_faixa,\\r\\n    MIN(score_final_avancado) AS score_minimo_faixa,\\r\\n    MAX(score_final_avancado) AS score_maximo_faixa,\\r\\n    \\r\\n    -- M\\u00e9tricas adicionais por faixa\\r\\n    AVG(COALESCE(valor_max, 0)) AS receita_media_faixa,\\r\\n    COUNT(CASE WHEN valor_max >= 4800000 THEN 1 END) AS grupos_acima_sn_faixa,\\r\\n    AVG(total) AS media_inconsistencias_faixa\\r\\n    \\r\\nFROM gessimples.gei_percent\\r\\nGROUP BY \\r\\n    CASE \\r\\n        WHEN score_final_avancado >= 25 THEN '25+ (Cr\\u00edtico Extremo)'\\r\\n        WHEN score_final_avancado >= 20 THEN '20-24.99 (Cr\\u00edtico)'\\r\\n        WHEN score_final_avancado >= 15 THEN '15-19.99 (Alto)'\\r\\n        WHEN score_final_avancado >= 10 THEN '10-14.99 (M\\u00e9dio)'\\r\\n        WHEN score_final_avancado >= 5 THEN '5-9.99 (Baixo)'\\r\\n        ELSE '0-4.99 (M\\u00ednimo)'\\r\\n    END\\r\\nORDER BY MIN(score_final_avancado) DESC;\\r\\n\\r\\n-- 1.3 TOP CONTADORES POR RISCO\\r\\n-- Identifica\\u00e7\\u00e3o dos contadores com grupos de maior risco\\r\\nSELECT \\r\\n    'TOP 20 CONTADORES POR RISCO' AS categoria,\\r\\n    c.nm_contador,\\r\\n    c.nm_gerfe,\\r\\n    c.qntd_grupos,\\r\\n    c.media AS score_medio_grupos,\\r\\n    \\r\\n    -- M\\u00e9tricas adicionais calculadas\\r\\n    COUNT(p.num_grupo) AS grupos_encontrados_base,\\r\\n    AVG(p.score_final_avancado) AS score_medio_atual,\\r\\n    COUNT(CASE WHEN p.score_final_avancado >= 15 THEN 1 END) AS grupos_alto_risco,\\r\\n    SUM(p.qntd_cnpj) AS total_cnpjs_contador,\\r\\n    SUM(COALESCE(p.valor_max, 0)) AS receita_total_contador\\r\\n    \\r\\nFROM gessimples.gei_contador c\\r\\nLEFT JOIN gessimples.gei_percent p \\r\\n    ON c.nm_contador = p.nm_contador  -- Simplificado para funcionar no Impala\\r\\nWHERE c.qntd_grupos >= 3  -- Apenas contadores com 3+ grupos\\r\\nGROUP BY c.nm_contador, c.nm_gerfe, c.qntd_grupos, c.media\\r\\nORDER BY c.media DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- ============================================================================\\r\\n-- 2. CONSULTAS ANAL\\u00cdTICAS ESPEC\\u00cdFICAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 2.1 AN\\u00c1LISE DE OUTLIERS E ANOMALIAS (VERS\\u00c3O CORRIGIDA SEM APPROX_PERCENTILE)\\r\\n-- Identifica\\u00e7\\u00e3o de grupos com comportamentos an\\u00f4malos\\r\\nWITH\\r\\n  dados_base AS (\\r\\n    -- Seleciona apenas os dados necess\\u00e1rios e remove nulos para o c\\u00e1lculo de percentis\\r\\n    SELECT\\r\\n      score_final_avancado,\\r\\n      valor_max\\r\\n    FROM\\r\\n      gessimples.gei_percent\\r\\n    WHERE\\r\\n      score_final_avancado IS NOT NULL AND valor_max IS NOT NULL\\r\\n  ),\\r\\n  metricas_agregadas AS (\\r\\n    -- Calcula m\\u00e9tricas simples (m\\u00e9dia e desvio padr\\u00e3o) em uma passagem\\r\\n    SELECT\\r\\n      AVG(score_final_avancado) AS media_score,\\r\\n      STDDEV(score_final_avancado) AS desvio_score\\r\\n    FROM\\r\\n      dados_base\\r\\n  ),\\r\\n  ranks AS (\\r\\n    -- Atribui um n\\u00famero de linha (rank) para cada registro ordenado por score e receita\\r\\n    SELECT\\r\\n      score_final_avancado,\\r\\n      valor_max,\\r\\n      ROW_NUMBER() OVER (ORDER BY score_final_avancado) AS rn_score,\\r\\n      ROW_NUMBER() OVER (ORDER BY valor_max) AS rn_receita,\\r\\n      COUNT(*) OVER () AS total_linhas\\r\\n    FROM\\r\\n      dados_base\\r\\n  ),\\r\\n  quartis AS (\\r\\n    -- Usa os ranks para encontrar os valores nos pontos de corte dos percentis\\r\\n    SELECT\\r\\n      MAX(CASE WHEN rn_score = CAST(total_linhas * 0.25 AS INT) THEN score_final_avancado END) AS q1_score,\\r\\n      MAX(CASE WHEN rn_score = CAST(total_linhas * 0.75 AS INT) THEN score_final_avancado END) AS q3_score,\\r\\n      MAX(CASE WHEN rn_score = CAST(total_linhas * 0.95 AS INT) THEN score_final_avancado END) AS p95_score,\\r\\n      MAX(CASE WHEN rn_receita = CAST(total_linhas * 0.25 AS INT) THEN valor_max END) AS q1_receita,\\r\\n      MAX(CASE WHEN rn_receita = CAST(total_linhas * 0.75 AS INT) THEN valor_max END) AS q3_receita,\\r\\n      MAX(CASE WHEN rn_receita = CAST(total_linhas * 0.95 AS INT) THEN valor_max END) AS p95_receita,\\r\\n      m.media_score,\\r\\n      m.desvio_score\\r\\n    FROM\\r\\n      ranks\\r\\n      CROSS JOIN metricas_agregadas m\\r\\n    GROUP BY\\r\\n      m.media_score,\\r\\n      m.desvio_score\\r\\n  )\\r\\nSELECT\\r\\n  'AN\\u00c1LISE DE OUTLIERS' AS categoria,\\r\\n  p.num_grupo,\\r\\n  p.qntd_cnpj,\\r\\n  p.score_final_avancado,\\r\\n  p.valor_max,\\r\\n  p.total_funcionarios,\\r\\n  -- Classifica\\u00e7\\u00e3o de anomalias\\r\\n  CASE\\r\\n    WHEN p.score_final_avancado > q.p95_score THEN 'Score Extremo (P95+)'\\r\\n    WHEN p.score_final_avancado > (q.media_score + 2 * q.desvio_score) THEN 'Score Muito Alto (>2\\u03c3)'\\r\\n    WHEN p.valor_max > q.p95_receita AND p.score_final_avancado < 5 THEN 'Alta Receita/Baixo Risco'\\r\\n    WHEN p.total_funcionarios > 100 AND p.valor_max < 1000000 THEN 'Muitos Funcion\\u00e1rios/Baixa Receita'\\r\\n    WHEN p.valor_max > 10000000 AND p.total_funcionarios < 5 THEN 'Alta Receita/Poucos Funcion\\u00e1rios'\\r\\n    WHEN p.indice_risco_pagamentos > 0.5 THEN 'Alto Risco Pagamentos'\\r\\n    ELSE 'Outros'\\r\\n  END AS tipo_anomalia,\\r\\n  -- M\\u00e9tricas contextuais\\r\\n  p.total AS inconsistencias_nfe,\\r\\n  p.indice_interconexao,\\r\\n  p.qtd_total_indicios,\\r\\n  p.nivel_risco_grupo_economico\\r\\nFROM\\r\\n  gessimples.gei_percent p\\r\\n  CROSS JOIN quartis q\\r\\nWHERE\\r\\n  p.score_final_avancado IS NOT NULL AND (\\r\\n    p.score_final_avancado > q.p95_score\\r\\n    OR p.score_final_avancado > (q.media_score + 2 * q.desvio_score)\\r\\n    OR (\\r\\n      p.valor_max > q.p95_receita AND p.score_final_avancado < 5\\r\\n    )\\r\\n    OR (\\r\\n      p.total_funcionarios > 100 AND p.valor_max < 1000000\\r\\n    )\\r\\n    OR (\\r\\n      p.valor_max > 10000000 AND p.total_funcionarios < 5\\r\\n    )\\r\\n    OR p.indice_risco_pagamentos > 0.5\\r\\n  )\\r\\nORDER BY\\r\\n  p.score_final_avancado DESC;\\r\\n\\r\\n-- 2.2 AN\\u00c1LISE TEMPORAL DE LIMITES DO SIMPLES NACIONAL\\r\\n-- Evolu\\u00e7\\u00e3o dos grupos pr\\u00f3ximos ou acima do limite\\r\\nWITH receitas_agregadas AS (\\r\\n    SELECT \\r\\n        gc.num_grupo,\\r\\n        -- Apenas \\u00faltimos 6 meses para simplicidade\\r\\n        SUM(pg.abr2025) AS abr2025,\\r\\n        SUM(pg.mai2025) AS mai2025, \\r\\n        SUM(pg.jun2025) AS jun2025,\\r\\n        SUM(pg.jul2025) AS jul2025, \\r\\n        SUM(pg.ago2025) AS ago2025, \\r\\n        SUM(pg.set2025) AS set2025\\r\\n    FROM gessimples.gei_cnpj gc\\r\\n    JOIN gessimples.gei_pgdas pg ON gc.cnpj = pg.cnpj\\r\\n    GROUP BY gc.num_grupo\\r\\n)\\r\\nSELECT \\r\\n    'AN\\u00c1LISE TEMPORAL LIMITES SN' AS categoria,\\r\\n    ra.num_grupo,\\r\\n    p.qntd_cnpj,\\r\\n    p.score_final_avancado,\\r\\n    \\r\\n    -- Receitas \\u00faltimos 6 meses\\r\\n    ra.abr2025, ra.mai2025, ra.jun2025, ra.jul2025, ra.ago2025, ra.set2025,\\r\\n    \\r\\n    -- An\\u00e1lise de tend\\u00eancia simplificada\\r\\n    CASE \\r\\n        WHEN ra.set2025 > ra.ago2025 AND ra.ago2025 > ra.jul2025 THEN 'Crescente'\\r\\n        WHEN ra.set2025 < ra.ago2025 AND ra.ago2025 < ra.jul2025 THEN 'Decrescente'\\r\\n        ELSE 'Est\\u00e1vel/Oscilante'\\r\\n    END AS tendencia,\\r\\n    \\r\\n    -- Proximidade do limite\\r\\n    CASE \\r\\n        WHEN ra.set2025 >= 4800000 THEN 'Acima do limite'\\r\\n        WHEN ra.set2025 >= 4300000 THEN 'Muito pr\\u00f3ximo (90%+)'\\r\\n        WHEN ra.set2025 >= 3840000 THEN 'Pr\\u00f3ximo (80%+)'\\r\\n        WHEN ra.set2025 >= 2400000 THEN 'Moderado (50%+)'\\r\\n        ELSE 'Distante'\\r\\n    END AS situacao_limite\\r\\n    \\r\\nFROM receitas_agregadas ra\\r\\nJOIN gessimples.gei_percent p ON ra.num_grupo = p.num_grupo\\r\\nWHERE ra.set2025 >= 2400000  -- Apenas grupos com receita significativa\\r\\nORDER BY ra.set2025 DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- 3. AN\\u00c1LISES COMPLETAS E INVESTIGA\\u00c7\\u00c3O\\r\\n-- ============================================================================\\r\\n\\r\\n-- 3.1 RELAT\\u00d3RIO COMPLETO DE GRUPO ESPEC\\u00cdFICO\\r\\n-- Template para an\\u00e1lise detalhada de um grupo\\r\\nSELECT \\r\\n    'RELAT\\u00d3RIO COMPLETO - GRUPO' AS categoria,\\r\\n    p.num_grupo,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o b\\u00e1sica\\r\\n    p.qntd_cnpj AS quantidade_empresas,\\r\\n    p.score_final_avancado AS score_atual,\\r\\n    \\r\\n    -- Ranking aproximado usando ROW_NUMBER\\r\\n    ROW_NUMBER() OVER (ORDER BY p.score_final_avancado DESC) AS posicao_ranking_aprox,\\r\\n    \\r\\n    -- Decomposi\\u00e7\\u00e3o do score\\r\\n    p.total AS score_inconsistencias_nfe,\\r\\n    p.total_cadastro AS score_consistencia_cadastral,\\r\\n    (p.indice_interconexao * 10) AS score_societario,\\r\\n    p.indice_risco_grupo_economico AS score_c115,\\r\\n    (p.indice_risco_indicios * 20) AS score_indicios,\\r\\n    p.indice_risco_pagamentos AS score_pagamentos,\\r\\n    p.indice_risco_fat_func AS score_faturamento_funcionarios,\\r\\n    \\r\\n    -- Detalhes das inconsist\\u00eancias\\r\\n    p.perc_cliente AS perc_clientes_compartilhados,\\r\\n    p.perc_email AS perc_emails_compartilhados,\\r\\n    p.perc_tel_dest AS perc_telefones_dest_compartilhados,\\r\\n    p.perc_tel_emit AS perc_telefones_emit_compartilhados,\\r\\n    p.perc_codigo_produto AS perc_codigos_produto_compartilhados,\\r\\n    p.perc_fornecedor AS perc_fornecedores_compartilhados,\\r\\n    \\r\\n    -- Consist\\u00eancia cadastral\\r\\n    p.nm_razao_social AS razao_social_consistente,\\r\\n    p.nm_fantasia AS fantasia_consistente,\\r\\n    p.cd_cnae AS cnae_consistente,\\r\\n    p.nm_contador AS contador_consistente,\\r\\n    p.endereco AS endereco_consistente,\\r\\n    \\r\\n    -- M\\u00e9tricas societ\\u00e1rias\\r\\n    p.qtd_socios_compartilhados,\\r\\n    p.qtd_cnpjs_com_socios_compartilhados,\\r\\n    p.indice_interconexao,\\r\\n    p.qtd_pares_cnpjs_relacionados,\\r\\n    \\r\\n    -- M\\u00e9tricas financeiras\\r\\n    p.valor_max AS receita_bruta_maxima,\\r\\n    p.periodo_max AS periodo_receita_maxima,\\r\\n    p.periodo AS primeiro_periodo_excesso_sn,\\r\\n    \\r\\n    -- Dados C115\\r\\n    p.nivel_risco_grupo_economico AS risco_c115,\\r\\n    p.total_tomadores,\\r\\n    p.tomadores_com_compartilhamento,\\r\\n    p.perc_tomadores_com_compartilhamento,\\r\\n    \\r\\n    -- Ind\\u00edcios fiscais\\r\\n    p.qtd_total_indicios,\\r\\n    p.qtd_tipos_indicios_distintos,\\r\\n    p.qtd_cnpjs_com_indicios,\\r\\n    \\r\\n    -- Dados complementares\\r\\n    p.total_funcionarios,\\r\\n    p.valor_meios_pagamento_empresas,\\r\\n    p.valor_meios_pagamento_socios,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o final\\r\\n    CASE \\r\\n        WHEN p.score_final_avancado >= 25 THEN 'CR\\u00cdTICO EXTREMO - Investiga\\u00e7\\u00e3o Imediata'\\r\\n        WHEN p.score_final_avancado >= 20 THEN 'CR\\u00cdTICO - Alta Prioridade'\\r\\n        WHEN p.score_final_avancado >= 15 THEN 'ALTO - Monitoramento Intensivo'\\r\\n        WHEN p.score_final_avancado >= 10 THEN 'M\\u00c9DIO - Acompanhamento Regular'\\r\\n        WHEN p.score_final_avancado >= 5 THEN 'BAIXO - Monitoramento B\\u00e1sico'\\r\\n        ELSE 'M\\u00cdNIMO - Acompanhamento Rotineiro'\\r\\n    END AS classificacao_risco_recomendacao\\r\\n    \\r\\nFROM gessimples.gei_percent p\\r\\n-- WHERE p.num_grupo = @NUM_GRUPO  -- Descomentar e substituir para grupo espec\\u00edfico\\r\\nORDER BY p.score_final_avancado DESC\\r\\nLIMIT 10;  -- Remover para an\\u00e1lise de grupo espec\\u00edfico\\r\\n\\r\\n-- 3.2 AN\\u00c1LISE SETORIAL POR CNAE (VERS\\u00c3O CORRIGIDA E ATUALIZADA)\\r\\n-- Compara\\u00e7\\u00e3o de grupos por setor de atividade\\r\\nWITH\\r\\n  cnae_grupos AS (\\r\\n    SELECT\\r\\n      g.num_grupo,\\r\\n      c.cd_cnae,\\r\\n      -- CORRE\\u00c7\\u00c3O APLICADA AQUI: CAST para converter n\\u00famero em string\\r\\n      SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS secao_cnae\\r\\n    FROM\\r\\n      gessimples.gei_cnpj g\\r\\n      JOIN gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\\r\\n    WHERE\\r\\n      c.cd_cnae IS NOT NULL\\r\\n  ),\\r\\n  grupos_cnae_principal AS (\\r\\n    SELECT\\r\\n      num_grupo,\\r\\n      secao_cnae,\\r\\n      ROW_NUMBER() OVER (\\r\\n        PARTITION BY\\r\\n          num_grupo\\r\\n        ORDER BY\\r\\n          secao_cnae\\r\\n      ) AS rn\\r\\n    FROM\\r\\n      cnae_grupos\\r\\n    GROUP BY\\r\\n      num_grupo,\\r\\n      secao_cnae\\r\\n  ),\\r\\n  dados_setoriais_com_percentil AS (\\r\\n    -- Adiciona o c\\u00e1lculo de percentil usando NTILE() para cada setor\\r\\n    SELECT\\r\\n      gcp.secao_cnae,\\r\\n      p.*,\\r\\n      NTILE(100) OVER (\\r\\n        PARTITION BY\\r\\n          gcp.secao_cnae\\r\\n        ORDER BY\\r\\n          p.score_final_avancado\\r\\n      ) AS percentil_score\\r\\n    FROM\\r\\n      grupos_cnae_principal gcp\\r\\n      JOIN gessimples.gei_percent p ON gcp.num_grupo = p.num_grupo\\r\\n    WHERE\\r\\n      gcp.rn = 1 -- Apenas a primeira se\\u00e7\\u00e3o CNAE por grupo\\r\\n  )\\r\\nSELECT\\r\\n  'AN\\u00c1LISE SETORIAL - CNAE' AS categoria,\\r\\n  secao_cnae,\\r\\n  -- Descri\\u00e7\\u00e3o da se\\u00e7\\u00e3o CNAE (principais setores)\\r\\n  CASE secao_cnae\\r\\n    WHEN '01' THEN 'Agricultura, Pecu\\u00e1ria'\\r\\n    WHEN '10' THEN 'Fabrica\\u00e7\\u00e3o de Produtos Aliment\\u00edcios'\\r\\n    WHEN '46' THEN 'Com\\u00e9rcio Atacadista'\\r\\n    WHEN '47' THEN 'Com\\u00e9rcio Varejista'\\r\\n    WHEN '68' THEN 'Atividades Imobili\\u00e1rias'\\r\\n    WHEN '70' THEN 'Atividades de Consultoria'\\r\\n    WHEN '77' THEN 'Aluguel e Leasing'\\r\\n    WHEN '82' THEN 'Servi\\u00e7os de Apoio'\\r\\n    ELSE CONCAT('Se\\u00e7\\u00e3o ', secao_cnae)\\r\\n  END AS descricao_setor,\\r\\n  COUNT(DISTINCT num_grupo) AS grupos_no_setor,\\r\\n  AVG(score_final_avancado) AS score_medio_setor,\\r\\n  STDDEV(score_final_avancado) AS desvio_score_setor,\\r\\n  MIN(score_final_avancado) AS score_minimo_setor,\\r\\n  MAX(score_final_avancado) AS score_maximo_setor,\\r\\n  -- Percentis calculados a partir dos \\\"baldes\\\" criados pelo NTILE\\r\\n  MAX(CASE WHEN percentil_score = 25 THEN score_final_avancado END) AS p25_score,\\r\\n  MAX(CASE WHEN percentil_score = 50 THEN score_final_avancado END) AS mediana_score,\\r\\n  MAX(CASE WHEN percentil_score = 75 THEN score_final_avancado END) AS p75_score,\\r\\n  -- M\\u00e9tricas espec\\u00edficas por setor\\r\\n  AVG(valor_max) AS receita_media_setor,\\r\\n  AVG(qntd_cnpj) AS media_empresas_por_grupo,\\r\\n  COUNT(CASE WHEN score_final_avancado >= 15 THEN 1 END) AS grupos_alto_risco,\\r\\n  ROUND(\\r\\n    COUNT(CASE WHEN score_final_avancado >= 15 THEN 1 END) * 100.0 / COUNT(DISTINCT num_grupo),\\r\\n    2\\r\\n  ) AS perc_alto_risco_setor,\\r\\n  -- Principais problemas do setor\\r\\n  AVG(total) AS media_inconsistencias_setor,\\r\\n  AVG(indice_interconexao) AS media_interconexao_setor,\\r\\n  COUNT(CASE WHEN qtd_total_indicios > 0 THEN 1 END) AS grupos_com_indicios_setor\\r\\nFROM\\r\\n  dados_setoriais_com_percentil\\r\\nGROUP BY\\r\\n  secao_cnae\\r\\nHAVING\\r\\n  COUNT(DISTINCT num_grupo) >= 5 -- Apenas setores com 5+ grupos\\r\\nORDER BY\\r\\n  AVG(score_final_avancado) DESC;-- 3.2 AN\\u00c1LISE SETORIAL POR CNAE (VERS\\u00c3O CORRIGIDA E ATUALIZADA)\\r\\n-- Compara\\u00e7\\u00e3o de grupos por setor de atividade\\r\\nWITH\\r\\n  cnae_grupos AS (\\r\\n    SELECT\\r\\n      g.num_grupo,\\r\\n      c.cd_cnae,\\r\\n      -- CORRE\\u00c7\\u00c3O APLICADA AQUI: CAST para converter n\\u00famero em string\\r\\n      SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS secao_cnae\\r\\n    FROM\\r\\n      gessimples.gei_cnpj g\\r\\n      JOIN gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\\r\\n    WHERE\\r\\n      c.cd_cnae IS NOT NULL\\r\\n  ),\\r\\n  grupos_cnae_principal AS (\\r\\n    SELECT\\r\\n      num_grupo,\\r\\n      secao_cnae,\\r\\n      ROW_NUMBER() OVER (\\r\\n        PARTITION BY\\r\\n          num_grupo\\r\\n        ORDER BY\\r\\n          secao_cnae\\r\\n      ) AS rn\\r\\n    FROM\\r\\n      cnae_grupos\\r\\n    GROUP BY\\r\\n      num_grupo,\\r\\n      secao_cnae\\r\\n  ),\\r\\n  dados_setoriais_com_percentil AS (\\r\\n    -- Adiciona o c\\u00e1lculo de percentil usando NTILE() para cada setor\\r\\n    SELECT\\r\\n      gcp.secao_cnae,\\r\\n      p.*,\\r\\n      NTILE(100) OVER (\\r\\n        PARTITION BY\\r\\n          gcp.secao_cnae\\r\\n        ORDER BY\\r\\n          p.score_final_avancado\\r\\n      ) AS percentil_score\\r\\n    FROM\\r\\n      grupos_cnae_principal gcp\\r\\n      JOIN gessimples.gei_percent p ON gcp.num_grupo = p.num_grupo\\r\\n    WHERE\\r\\n      gcp.rn = 1 -- Apenas a primeira se\\u00e7\\u00e3o CNAE por grupo\\r\\n  )\\r\\nSELECT\\r\\n  'AN\\u00c1LISE SETORIAL - CNAE' AS categoria,\\r\\n  secao_cnae,\\r\\n  -- Descri\\u00e7\\u00e3o da se\\u00e7\\u00e3o CNAE (principais setores)\\r\\n  CASE secao_cnae\\r\\n    WHEN '01' THEN 'Agricultura, Pecu\\u00e1ria'\\r\\n    WHEN '10' THEN 'Fabrica\\u00e7\\u00e3o de Produtos Aliment\\u00edcios'\\r\\n    WHEN '46' THEN 'Com\\u00e9rcio Atacadista'\\r\\n    WHEN '47' THEN 'Com\\u00e9rcio Varejista'\\r\\n    WHEN '68' THEN 'Atividades Imobili\\u00e1rias'\\r\\n    WHEN '70' THEN 'Atividades de Consultoria'\\r\\n    WHEN '77' THEN 'Aluguel e Leasing'\\r\\n    WHEN '82' THEN 'Servi\\u00e7os de Apoio'\\r\\n    ELSE CONCAT('Se\\u00e7\\u00e3o ', secao_cnae)\\r\\n  END AS descricao_setor,\\r\\n  COUNT(DISTINCT num_grupo) AS grupos_no_setor,\\r\\n  AVG(score_final_avancado) AS score_medio_setor,\\r\\n  STDDEV(score_final_avancado) AS desvio_score_setor,\\r\\n  MIN(score_final_avancado) AS score_minimo_setor,\\r\\n  MAX(score_final_avancado) AS score_maximo_setor,\\r\\n  -- Percentis calculados a partir dos \\\"baldes\\\" criados pelo NTILE\\r\\n  MAX(CASE WHEN percentil_score = 25 THEN score_final_avancado END) AS p25_score,\\r\\n  MAX(CASE WHEN percentil_score = 50 THEN score_final_avancado END) AS mediana_score,\\r\\n  MAX(CASE WHEN percentil_score = 75 THEN score_final_avancado END) AS p75_score,\\r\\n  -- M\\u00e9tricas espec\\u00edficas por setor\\r\\n  AVG(valor_max) AS receita_media_setor,\\r\\n  AVG(qntd_cnpj) AS media_empresas_por_grupo,\\r\\n  COUNT(CASE WHEN score_final_avancado >= 15 THEN 1 END) AS grupos_alto_risco,\\r\\n  ROUND(\\r\\n    COUNT(CASE WHEN score_final_avancado >= 15 THEN 1 END) * 100.0 / COUNT(DISTINCT num_grupo),\\r\\n    2\\r\\n  ) AS perc_alto_risco_setor,\\r\\n  -- Principais problemas do setor\\r\\n  AVG(total) AS media_inconsistencias_setor,\\r\\n  AVG(indice_interconexao) AS media_interconexao_setor,\\r\\n  COUNT(CASE WHEN qtd_total_indicios > 0 THEN 1 END) AS grupos_com_indicios_setor\\r\\nFROM\\r\\n  dados_setoriais_com_percentil\\r\\nGROUP BY\\r\\n  secao_cnae\\r\\nHAVING\\r\\n  COUNT(DISTINCT num_grupo) >= 5 -- Apenas setores com 5+ grupos\\r\\nORDER BY\\r\\n  AVG(score_final_avancado) DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- 4. CONSULTAS PARA MONITORAMENTO OPERACIONAL\\r\\n-- ============================================================================\\r\\n\\r\\n-- 4.1 DASHBOARD EXECUTIVO - M\\u00c9TRICAS DI\\u00c1RIAS\\r\\n-- KPIs principais para acompanhamento gerencial\\r\\nSELECT \\r\\n    'DASHBOARD EXECUTIVO' AS categoria,\\r\\n    \\r\\n    -- M\\u00e9tricas Principais\\r\\n    COUNT(DISTINCT num_grupo) AS total_grupos,\\r\\n    SUM(qntd_cnpj) AS total_cnpjs,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Risco\\r\\n    COUNT(CASE WHEN score_final_avancado >= 20 THEN 1 END) AS grupos_criticos,\\r\\n    COUNT(CASE WHEN score_final_avancado >= 15 AND score_final_avancado < 20 THEN 1 END) AS grupos_alto_risco,\\r\\n    COUNT(CASE WHEN score_final_avancado >= 10 AND score_final_avancado < 15 THEN 1 END) AS grupos_medio_risco,\\r\\n    \\r\\n    -- Percentuais\\r\\n    ROUND(COUNT(CASE WHEN score_final_avancado >= 15 THEN 1 END) * 100.0 / \\r\\n          COUNT(DISTINCT num_grupo), 1) AS perc_grupos_prioritarios,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    SUM(CASE WHEN valor_max IS NOT NULL THEN valor_max ELSE 0 END) AS receita_total_monitorada,\\r\\n    COUNT(CASE WHEN valor_max >= 4800000 THEN 1 END) AS grupos_acima_limite_sn,\\r\\n    ROUND(COUNT(CASE WHEN valor_max >= 4800000 THEN 1 END) * 100.0 / \\r\\n          COUNT(CASE WHEN valor_max IS NOT NULL THEN 1 END), 1) AS perc_acima_limite,\\r\\n    \\r\\n    -- Top Alertas\\r\\n    COUNT(CASE WHEN perc_cliente >= 0.5 THEN 1 END) AS alertas_clientes_compartilhados,\\r\\n    COUNT(CASE WHEN perc_ip_transmissao >= 0.8 THEN 1 END) AS alertas_ip_compartilhado,\\r\\n    COUNT(CASE WHEN indice_interconexao >= 0.8 THEN 1 END) AS alertas_alta_interconexao,\\r\\n    COUNT(CASE WHEN qtd_total_indicios >= 5 THEN 1 END) AS alertas_multiplos_indicios,\\r\\n    \\r\\n    -- Timestamp\\r\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_atualizacao\\r\\n    \\r\\nFROM gessimples.gei_percent;\\r\\n\\r\\n-- 4.2 ALERTAS AUTOM\\u00c1TICOS PARA MONITORAMENTO\\r\\n-- Identifica\\u00e7\\u00e3o de situa\\u00e7\\u00f5es que requerem a\\u00e7\\u00e3o imediata\\r\\nSELECT \\r\\n    'ALERTAS AUTOM\\u00c1TICOS' AS categoria,\\r\\n    num_grupo,\\r\\n    qntd_cnpj,\\r\\n    score_final_avancado,\\r\\n    \\r\\n    -- Tipo de Alerta\\r\\n    CASE \\r\\n        WHEN score_final_avancado >= 25 \\r\\n        THEN 'CR\\u00cdTICO: Score Extremo - Investiga\\u00e7\\u00e3o Imediata'\\r\\n        \\r\\n        WHEN valor_max >= 4800000 AND perc_cliente >= 0.7 AND perc_fornecedor >= 0.7 \\r\\n        THEN 'CR\\u00cdTICO: Limite SN + Opera\\u00e7\\u00f5es Cruzadas Intensas'\\r\\n        \\r\\n        WHEN perc_ip_transmissao >= 0.9 AND indice_interconexao >= 0.8 \\r\\n        THEN 'ALTO: Infraestrutura Compartilhada + Alta Interconex\\u00e3o'\\r\\n        \\r\\n        WHEN qtd_total_indicios >= 8 \\r\\n        THEN 'ALTO: M\\u00faltiplos Ind\\u00edcios Fiscais'\\r\\n        \\r\\n        WHEN indice_risco_pagamentos >= 0.6 \\r\\n        THEN 'ALTO: Risco Alto em Meios de Pagamento'\\r\\n        \\r\\n        WHEN valor_max >= 4800000 AND total_funcionarios <= 3 \\r\\n        THEN 'M\\u00c9DIO: Alta Receita com Poucos Funcion\\u00e1rios'\\r\\n        \\r\\n        WHEN score_final_avancado >= 15 AND nivel_risco_grupo_economico = 'CR\\u00cdTICO' \\r\\n        THEN 'M\\u00c9DIO: Converg\\u00eancia M\\u00faltiplas Evid\\u00eancias'\\r\\n        \\r\\n        ELSE 'BAIXO: Monitoramento Rotineiro'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- Prioridade (1=Mais alta, 4=Mais baixa)\\r\\n    CASE \\r\\n        WHEN score_final_avancado >= 25 OR \\r\\n             (valor_max >= 4800000 AND perc_cliente >= 0.7 AND perc_fornecedor >= 0.7)\\r\\n        THEN 1\\r\\n        \\r\\n        WHEN (perc_ip_transmissao >= 0.9 AND indice_interconexao >= 0.8) OR \\r\\n             qtd_total_indicios >= 8 OR \\r\\n             indice_risco_pagamentos >= 0.6\\r\\n        THEN 2\\r\\n        \\r\\n        WHEN (valor_max >= 4800000 AND total_funcionarios <= 3) OR \\r\\n             (score_final_avancado >= 15 AND nivel_risco_grupo_economico = 'CR\\u00cdTICO')\\r\\n        THEN 3\\r\\n        \\r\\n        ELSE 4\\r\\n    END AS prioridade,\\r\\n    \\r\\n    -- A\\u00e7\\u00f5es Sugeridas\\r\\n    CASE \\r\\n        WHEN score_final_avancado >= 25 \\r\\n        THEN 'Abertura de procedimento fiscal imediato'\\r\\n        \\r\\n        WHEN valor_max >= 4800000 AND perc_cliente >= 0.7 \\r\\n        THEN 'Verifica\\u00e7\\u00e3o de elis\\u00e3o fiscal e limites SN'\\r\\n        \\r\\n        WHEN perc_ip_transmissao >= 0.9 \\r\\n        THEN 'Investiga\\u00e7\\u00e3o de infraestrutura tecnol\\u00f3gica compartilhada'\\r\\n        \\r\\n        WHEN qtd_total_indicios >= 8 \\r\\n        THEN 'Consolida\\u00e7\\u00e3o de todos os ind\\u00edcios para an\\u00e1lise jur\\u00eddica'\\r\\n        \\r\\n        WHEN indice_risco_pagamentos >= 0.6 \\r\\n        THEN 'Auditoria de meios de pagamento e fluxo financeiro'\\r\\n        \\r\\n        ELSE 'Monitoramento cont\\u00ednuo com revis\\u00e3o mensal'\\r\\n    END AS acao_sugerida,\\r\\n    \\r\\n    -- Dados de Contexto\\r\\n    valor_max AS receita_maxima,\\r\\n    nivel_risco_grupo_economico,\\r\\n    qtd_total_indicios,\\r\\n    indice_interconexao\\r\\n    \\r\\nFROM gessimples.gei_percent\\r\\nWHERE (\\r\\n    score_final_avancado >= 15 OR\\r\\n    valor_max >= 4800000 OR\\r\\n    perc_ip_transmissao >= 0.8 OR\\r\\n    qtd_total_indicios >= 5 OR\\r\\n    indice_risco_pagamentos >= 0.4 OR\\r\\n    (perc_cliente >= 0.5 AND perc_fornecedor >= 0.5)\\r\\n)\\r\\nORDER BY \\r\\n    CASE \\r\\n        WHEN score_final_avancado >= 25 OR \\r\\n             (valor_max >= 4800000 AND perc_cliente >= 0.7 AND perc_fornecedor >= 0.7)\\r\\n        THEN 1\\r\\n        WHEN (perc_ip_transmissao >= 0.9 AND indice_interconexao >= 0.8) OR \\r\\n             qtd_total_indicios >= 8 OR \\r\\n             indice_risco_pagamentos >= 0.6\\r\\n        THEN 2\\r\\n        WHEN (valor_max >= 4800000 AND total_funcionarios <= 3) OR \\r\\n             (score_final_avancado >= 15 AND nivel_risco_grupo_economico = 'CR\\u00cdTICO')\\r\\n        THEN 3\\r\\n        ELSE 4\\r\\n    END,\\r\\n    score_final_avancado DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- 5. CONSULTAS DE INVESTIGA\\u00c7\\u00c3O ESPEC\\u00cdFICA\\r\\n-- ============================================================================\\r\\n\\r\\n-- 5.1 GRUPOS COM PADR\\u00d5ES SUSPEITOS M\\u00daLTIPLOS\\r\\n-- Identifica\\u00e7\\u00e3o de grupos com combina\\u00e7\\u00f5es espec\\u00edficas de riscos\\r\\nSELECT \\r\\n    'PADR\\u00d5ES SUSPEITOS M\\u00daLTIPLOS' AS categoria,\\r\\n    p.num_grupo,\\r\\n    p.qntd_cnpj,\\r\\n    p.score_final_avancado,\\r\\n    \\r\\n    -- Padr\\u00f5es identificados (X = presente, - = ausente)\\r\\n    CASE WHEN p.perc_cliente > 0.3 AND p.perc_fornecedor > 0.3 THEN 'X' ELSE '-' END AS cliente_fornecedor_compartilhado,\\r\\n    CASE WHEN p.perc_tel_emit > 0.5 AND p.perc_tel_dest > 0.5 THEN 'X' ELSE '-' END AS telefones_compartilhados,\\r\\n    CASE WHEN p.perc_end_emit > 0.7 OR p.perc_end_dest > 0.7 THEN 'X' ELSE '-' END AS enderecos_compartilhados,\\r\\n    CASE WHEN p.perc_ip_transmissao > 0.8 THEN 'X' ELSE '-' END AS ip_compartilhado,\\r\\n    CASE WHEN p.indice_interconexao > 0.8 THEN 'X' ELSE '-' END AS alta_interconexao,\\r\\n    CASE WHEN p.valor_max >= 4800000 AND p.nivel_risco_grupo_economico IN ('CR\\u00cdTICO', 'ALTO') THEN 'X' ELSE '-' END AS limite_sn_risco_c115,\\r\\n    CASE WHEN p.qtd_total_indicios >= 5 THEN 'X' ELSE '-' END AS multiplos_indicios,\\r\\n    CASE WHEN p.indice_risco_pagamentos > 0.3 THEN 'X' ELSE '-' END AS risco_pagamentos,\\r\\n    \\r\\n    -- Contagem de padr\\u00f5es suspeitos\\r\\n    (CASE WHEN p.perc_cliente > 0.3 AND p.perc_fornecedor > 0.3 THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.perc_tel_emit > 0.5 AND p.perc_tel_dest > 0.5 THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.perc_end_emit > 0.7 OR p.perc_end_dest > 0.7 THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.perc_ip_transmissao > 0.8 THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.indice_interconexao > 0.8 THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.valor_max >= 4800000 AND p.nivel_risco_grupo_economico IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.qtd_total_indicios >= 5 THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.indice_risco_pagamentos > 0.3 THEN 1 ELSE 0 END) AS total_padroes_suspeitos,\\r\\n     \\r\\n    -- Dados contextuais\\r\\n    p.valor_max AS receita_maxima,\\r\\n    p.total_funcionarios,\\r\\n    p.nivel_risco_grupo_economico\\r\\n    \\r\\nFROM gessimples.gei_percent p\\r\\nWHERE (\\r\\n    (p.perc_cliente > 0.3 AND p.perc_fornecedor > 0.3) OR\\r\\n    (p.perc_tel_emit > 0.5 AND p.perc_tel_dest > 0.5) OR\\r\\n    (p.perc_end_emit > 0.7 OR p.perc_end_dest > 0.7) OR\\r\\n    p.perc_ip_transmissao > 0.8 OR\\r\\n    p.indice_interconexao > 0.8 OR\\r\\n    (p.valor_max >= 4800000 AND p.nivel_risco_grupo_economico IN ('CR\\u00cdTICO', 'ALTO')) OR\\r\\n    p.qtd_total_indicios >= 5 OR\\r\\n    p.indice_risco_pagamentos > 0.3\\r\\n)\\r\\nORDER BY \\r\\n    (CASE WHEN p.perc_cliente > 0.3 AND p.perc_fornecedor > 0.3 THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.perc_tel_emit > 0.5 AND p.perc_tel_dest > 0.5 THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.perc_end_emit > 0.7 OR p.perc_end_dest > 0.7 THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.perc_ip_transmissao > 0.8 THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.indice_interconexao > 0.8 THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.valor_max >= 4800000 AND p.nivel_risco_grupo_economico IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.qtd_total_indicios >= 5 THEN 1 ELSE 0 END +\\r\\n     CASE WHEN p.indice_risco_pagamentos > 0.3 THEN 1 ELSE 0 END) DESC,\\r\\n    p.score_final_avancado DESC;\\r\\n\\r\\n-- 5.2 AN\\u00c1LISE DE REDE DE RELACIONAMENTOS SOCIET\\u00c1RIOS (VERS\\u00c3O CORRIGIDA)\\r\\n-- Identifica\\u00e7\\u00e3o de grupos altamente conectados entre si via s\\u00f3cios\\r\\nWITH \\r\\n  socio_contagem_grupos AS (\\r\\n    -- ETAPA 1: Contar o n\\u00famero de grupos distintos para cada s\\u00f3cio, antecipadamente.\\r\\n    -- Isso \\u00e9 mais preciso e evita o erro.\\r\\n    SELECT \\r\\n      cpf_socio, \\r\\n      COUNT(DISTINCT num_grupo) AS grupos_do_socio\\r\\n    FROM gessimples.gei_socios\\r\\n    GROUP BY cpf_socio\\r\\n  ),\\r\\n  relacionamentos_cruzados AS (\\r\\n    -- ETAPA 2: Achar as liga\\u00e7\\u00f5es (s\\u00f3cios em comum) entre os grupos, sem fun\\u00e7\\u00f5es de janela.\\r\\n    SELECT DISTINCT\\r\\n      s1.num_grupo AS grupo1,\\r\\n      s2.num_grupo AS grupo2,\\r\\n      s1.cpf_socio\\r\\n    FROM gessimples.gei_socios s1\\r\\n    JOIN gessimples.gei_socios s2 ON s1.cpf_socio = s2.cpf_socio AND s1.num_grupo < s2.num_grupo\\r\\n  ),\\r\\n  matriz_relacionamentos AS (\\r\\n    -- ETAPA 3: Montar a matriz, agregando os dados e juntando com a contagem de grupos.\\r\\n    SELECT \\r\\n      rc.grupo1,\\r\\n      rc.grupo2,\\r\\n      COUNT(DISTINCT rc.cpf_socio) AS socios_comuns,\\r\\n      AVG(scg.grupos_do_socio) AS media_grupos_por_socio\\r\\n    FROM relacionamentos_cruzados rc\\r\\n    JOIN socio_contagem_grupos scg ON rc.cpf_socio = scg.cpf_socio\\r\\n    GROUP BY rc.grupo1, rc.grupo2\\r\\n    HAVING COUNT(DISTINCT rc.cpf_socio) >= 2 -- Pelo menos 2 s\\u00f3cios em comum\\r\\n  )\\r\\nSELECT \\r\\n  'REDE DE RELACIONAMENTOS ENTRE GRUPOS' AS categoria,\\r\\n  mr.grupo1,\\r\\n  p1.score_final_avancado AS score_grupo1,\\r\\n  mr.grupo2, \\r\\n  p2.score_final_avancado AS score_grupo2,\\r\\n  mr.socios_comuns,\\r\\n  mr.media_grupos_por_socio,\\r\\n  -- For\\u00e7a do relacionamento\\r\\n  CASE \\r\\n    WHEN mr.socios_comuns >= 5 THEN 'Muito Forte'\\r\\n    WHEN mr.socios_comuns >= 3 THEN 'Forte'\\r\\n    ELSE 'Moderado'\\r\\n  END AS forca_relacionamento,\\r\\n  -- Risco combinado\\r\\n  (p1.score_final_avancado + p2.score_final_avancado) / 2 AS score_medio_combinado,\\r\\n  -- Indicadores de suspei\\u00e7\\u00e3o\\r\\n  CASE \\r\\n    WHEN (p1.score_final_avancado + p2.score_final_avancado) / 2 >= 15 \\r\\n      AND mr.socios_comuns >= 3 \\r\\n    THEN 'ALTA SUSPEI\\u00c7\\u00c3O'\\r\\n    WHEN (p1.score_final_avancado + p2.score_final_avancado) / 2 >= 10 \\r\\n      AND mr.socios_comuns >= 2 \\r\\n    THEN 'M\\u00c9DIA SUSPEI\\u00c7\\u00c3O'\\r\\n    ELSE 'BAIXA SUSPEI\\u00c7\\u00c3O'\\r\\n  END AS nivel_suspeicao,\\r\\n  -- Dados contextuais\\r\\n  p1.valor_max AS receita_grupo1,\\r\\n  p2.valor_max AS receita_grupo2,\\r\\n  (COALESCE(p1.valor_max, 0) + COALESCE(p2.valor_max, 0)) AS receita_combinada\\r\\nFROM matriz_relacionamentos mr\\r\\nJOIN gessimples.gei_percent p1 ON mr.grupo1 = p1.num_grupo\\r\\nJOIN gessimples.gei_percent p2 ON mr.grupo2 = p2.num_grupo\\r\\nORDER BY mr.socios_comuns DESC, (p1.score_final_avancado + p2.score_final_avancado) DESC;\\r\\n\\r\\n-- 5.3 DETALHAMENTO COMPLETO DE INCONSIST\\u00caNCIAS POR GRUPO\\r\\n-- Template para an\\u00e1lise detalhada das inconsist\\u00eancias\\r\\nSELECT \\r\\n    'DETALHAMENTO INCONSIST\\u00caNCIAS' AS categoria,\\r\\n    nfc.nfe_nu_chave_acesso,\\r\\n    nfc.nfe_dt_emissao,\\r\\n    nfc.nfe_cnpj_cpf_emit,\\r\\n    nfc.nfe_emit_razao_social,\\r\\n    nfc.nfe_cnpj_cpf_dest,\\r\\n    nfc.nfe_dest_razao_social,\\r\\n    \\r\\n    -- Flags de Inconsist\\u00eancia\\r\\n    nfc.cliente_incons,\\r\\n    nfc.email_incons,\\r\\n    nfc.tel_dest_incons,\\r\\n    nfc.tel_emit_incons,\\r\\n    nfc.codigo_produto_incons,\\r\\n    nfc.fornecedor_incons,\\r\\n    nfc.end_emit_incons,\\r\\n    nfc.end_dest_incons,\\r\\n    nfc.descricao_produto_incons,\\r\\n    nfc.ip_transmissao_incons,\\r\\n    \\r\\n    -- Contagem de inconsist\\u00eancias por nota\\r\\n    (CASE WHEN nfc.cliente_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.email_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.tel_dest_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.tel_emit_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.codigo_produto_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.fornecedor_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.end_emit_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.end_dest_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.descricao_produto_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.ip_transmissao_incons = 'S' THEN 1 ELSE 0 END) AS total_incons_nota,\\r\\n    \\r\\n    -- Dados espec\\u00edficos para an\\u00e1lise\\r\\n    nfc.nfe_cd_produto,\\r\\n    nfc.nfe_de_produto,\\r\\n    nfc.nfe_dest_email,\\r\\n    nfc.nfe_dest_telefone,\\r\\n    nfc.nfe_emit_telefone,\\r\\n    nfc.nfe_ip_transmissao,\\r\\n    nfc.nfe_emit_end_completo,\\r\\n    nfc.nfe_dest_end_completo\\r\\n    \\r\\nFROM gessimples.gei_nfe_completo nfc\\r\\n-- WHERE nfc.grupo_emit = @NUM_GRUPO OR nfc.grupo_dest = @NUM_GRUPO  -- Descomentar para grupo espec\\u00edfico\\r\\nWHERE (\\r\\n    nfc.cliente_incons = 'S' OR nfc.email_incons = 'S' OR \\r\\n    nfc.tel_dest_incons = 'S' OR nfc.tel_emit_incons = 'S' OR\\r\\n    nfc.codigo_produto_incons = 'S' OR nfc.fornecedor_incons = 'S' OR\\r\\n    nfc.end_emit_incons = 'S' OR nfc.end_dest_incons = 'S' OR\\r\\n    nfc.descricao_produto_incons = 'S' OR nfc.ip_transmissao_incons = 'S'\\r\\n)\\r\\nORDER BY \\r\\n    (CASE WHEN nfc.cliente_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.email_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.tel_dest_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.tel_emit_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.codigo_produto_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.fornecedor_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.end_emit_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.end_dest_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.descricao_produto_incons = 'S' THEN 1 ELSE 0 END +\\r\\n     CASE WHEN nfc.ip_transmissao_incons = 'S' THEN 1 ELSE 0 END) DESC,\\r\\n    nfc.nfe_dt_emissao DESC\\r\\nLIMIT 1000;\\r\\n\\r\\n-- ============================================================================\\r\\n-- 6. CONSULTAS ESPEC\\u00cdFICAS PARA C115\\r\\n-- ============================================================================\\r\\n\\r\\n-- 6.1 RANKING C115 COM DETALHAMENTO\\r\\n-- An\\u00e1lise espec\\u00edfica dos dados C115 com m\\u00e9tricas de risco\\r\\nSELECT \\r\\n    'RANKING RISCO C115' AS categoria,\\r\\n    rk.num_grupo,\\r\\n    rk.ranking_risco,\\r\\n    rk.indice_risco_grupo_economico,\\r\\n    rk.nivel_risco_grupo_economico,\\r\\n    \\r\\n    -- M\\u00e9tricas de tomadores\\r\\n    rk.total_tomadores,\\r\\n    rk.tomadores_com_compartilhamento,\\r\\n    rk.perc_tomadores_com_compartilhamento,\\r\\n    \\r\\n    -- M\\u00e9tricas de relacionamentos\\r\\n    rk.qtd_cnpjs_relacionados,\\r\\n    rk.perc_cnpjs_relacionados,\\r\\n    rk.max_tipos_identificadores_comuns,\\r\\n    rk.pares_com_tres_tipos_comum,\\r\\n    \\r\\n    -- Dados do grupo principal\\r\\n    p.score_final_avancado,\\r\\n    p.qntd_cnpj,\\r\\n    p.valor_max,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o combinada\\r\\n    CASE \\r\\n        WHEN rk.nivel_risco_grupo_economico = 'CR\\u00cdTICO' AND p.score_final_avancado >= 20 \\r\\n        THEN 'PRIORIDADE M\\u00c1XIMA'\\r\\n        WHEN rk.nivel_risco_grupo_economico IN ('CR\\u00cdTICO', 'ALTO') AND p.score_final_avancado >= 15 \\r\\n        THEN 'PRIORIDADE ALTA'\\r\\n        WHEN rk.nivel_risco_grupo_economico IN ('CR\\u00cdTICO', 'ALTO', 'M\\u00c9DIO') \\r\\n        THEN 'PRIORIDADE M\\u00c9DIA'\\r\\n        ELSE 'PRIORIDADE BAIXA'\\r\\n    END AS prioridade_investigacao\\r\\n    \\r\\nFROM gessimples.gei_c115_ranking_risco_grupo_economico rk\\r\\nJOIN gessimples.gei_percent p ON rk.num_grupo = p.num_grupo\\r\\nWHERE rk.nivel_risco_grupo_economico IN ('CR\\u00cdTICO', 'ALTO', 'M\\u00c9DIO')\\r\\nORDER BY \\r\\n    CASE rk.nivel_risco_grupo_economico \\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2  \\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        ELSE 4\\r\\n    END,\\r\\n    rk.indice_risco_grupo_economico DESC,\\r\\n    p.score_final_avancado DESC;\\r\\n\\r\\n-- 6.2 AN\\u00c1LISE DE IDENTIFICADORES COMPARTILHADOS C115\\r\\n-- Detalhamento dos tipos de compartilhamento mais cr\\u00edticos\\r\\nSELECT \\r\\n    'IDENTIFICADORES COMPARTILHADOS C115' AS categoria,\\r\\n    \\r\\n    -- An\\u00e1lise de telefones de contato\\r\\n    'TELEFONE_CONTATO' AS tipo_identificador,\\r\\n    tc.num_grupo,\\r\\n    tc.nu_tel_contato AS identificador,\\r\\n    tc.qtd_tomadores_distintos,\\r\\n    COUNT(*) AS total_ocorrencias,\\r\\n    MIN(tc.primeira_operacao) AS primeira_operacao,\\r\\n    MAX(tc.ultima_operacao) AS ultima_operacao,\\r\\n    \\r\\n    -- String com CNPJs relacionados (limitado para performance)\\r\\n    SUBSTR(GROUP_CONCAT(tc.cnpj_tomador), 1, 200) AS cnpjs_relacionados,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de risco\\r\\n    CASE \\r\\n        WHEN tc.qtd_tomadores_distintos >= 5 THEN 'ALTO RISCO'\\r\\n        WHEN tc.qtd_tomadores_distintos >= 3 THEN 'M\\u00c9DIO RISCO'\\r\\n        ELSE 'BAIXO RISCO'\\r\\n    END AS classificacao_risco\\r\\n    \\r\\nFROM gessimples.gei_c115_tel_contato_compartilhado tc\\r\\nGROUP BY tc.num_grupo, tc.nu_tel_contato, tc.qtd_tomadores_distintos\\r\\nHAVING COUNT(*) >= 3  -- Apenas casos com m\\u00faltiplas ocorr\\u00eancias\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'IDENTIFICADORES C115' AS categoria,\\r\\n    \\r\\n    -- An\\u00e1lise de identificadores de tomador\\r\\n    'IDENTIFICADOR_TOMADOR' AS tipo_identificador,\\r\\n    it.num_grupo,\\r\\n    it.nu_identificador_tomador AS identificador,\\r\\n    it.qtd_tomadores_distintos,\\r\\n    COUNT(*) AS total_ocorrencias,\\r\\n    MIN(it.primeira_operacao) AS primeira_operacao,\\r\\n    MAX(it.ultima_operacao) AS ultima_operacao,\\r\\n    \\r\\n    -- String com CNPJs relacionados\\r\\n    SUBSTR(GROUP_CONCAT(it.cnpj_tomador), 1, 200) AS cnpjs_relacionados,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de risco\\r\\n    CASE \\r\\n        WHEN it.qtd_tomadores_distintos >= 5 THEN 'ALTO RISCO'\\r\\n        WHEN it.qtd_tomadores_distintos >= 3 THEN 'M\\u00c9DIO RISCO'\\r\\n        ELSE 'BAIXO RISCO'\\r\\n    END AS classificacao_risco\\r\\n    \\r\\nFROM gessimples.gei_c115_identificador_tomador_compartilhado it\\r\\nGROUP BY it.num_grupo, it.nu_identificador_tomador, it.qtd_tomadores_distintos\\r\\nHAVING COUNT(*) >= 3\\r\\n\\r\\nORDER BY qtd_tomadores_distintos DESC, total_ocorrencias DESC\\r\\nLIMIT 100;\\r\\n\\r\\n-- ============================================================================\\r\\n-- 7. RELAT\\u00d3RIOS DE PERFORMANCE E QUALIDADE\\r\\n-- ============================================================================\\r\\n\\r\\n-- 7.1 RELAT\\u00d3RIO DE PERFORMANCE DO SISTEMA\\r\\n-- M\\u00e9tricas de qualidade e efetividade do sistema GEI\\r\\nWITH metricas_base AS (\\r\\n    SELECT \\r\\n        COUNT(*) AS total_grupos,\\r\\n        COUNT(CASE WHEN score_final_avancado IS NOT NULL THEN 1 END) AS grupos_com_score,\\r\\n        COUNT(CASE WHEN distinct_nfe > 0 THEN 1 END) AS grupos_com_nfe,\\r\\n        COUNT(CASE WHEN qtd_socios_compartilhados > 0 THEN 1 END) AS grupos_com_socios,\\r\\n        COUNT(CASE WHEN nivel_risco_grupo_economico IS NOT NULL THEN 1 END) AS grupos_com_c115,\\r\\n        COUNT(CASE WHEN qtd_total_indicios > 0 THEN 1 END) AS grupos_com_indicios,\\r\\n        COUNT(CASE WHEN total_funcionarios > 0 THEN 1 END) AS grupos_com_funcionarios,\\r\\n        COUNT(CASE WHEN valor_meios_pagamento_empresas > 0 THEN 1 END) AS grupos_com_pagamentos\\r\\n    FROM gessimples.gei_percent\\r\\n),\\r\\ncontagens_tabelas AS (\\r\\n    SELECT \\r\\n        (SELECT COUNT(*) FROM gessimples.gei_nfe_completo) AS total_registros_nfe,\\r\\n        (SELECT COUNT(DISTINCT num_grupo) FROM gessimples.gei_socios) AS grupos_com_dados_societarios,\\r\\n        (SELECT COUNT(*) FROM gessimples.gei_indicios) AS total_indicios_sistema\\r\\n)\\r\\nSELECT \\r\\n    'PERFORMANCE DO SISTEMA' AS categoria,\\r\\n    \\r\\n    -- Cobertura de Dados\\r\\n    mb.total_grupos AS total_grupos_sistema,\\r\\n    mb.grupos_com_score AS grupos_processados,\\r\\n    ROUND(mb.grupos_com_score * 100.0 / mb.total_grupos, 1) AS perc_cobertura_score,\\r\\n    \\r\\n    -- Cobertura por Fonte de Dados\\r\\n    ROUND(mb.grupos_com_nfe * 100.0 / mb.total_grupos, 1) AS perc_cobertura_nfe,\\r\\n    ROUND(mb.grupos_com_socios * 100.0 / mb.total_grupos, 1) AS perc_cobertura_socios,\\r\\n    ROUND(mb.grupos_com_c115 * 100.0 / mb.total_grupos, 1) AS perc_cobertura_c115,\\r\\n    ROUND(mb.grupos_com_indicios * 100.0 / mb.total_grupos, 1) AS perc_cobertura_indicios,\\r\\n    ROUND(mb.grupos_com_funcionarios * 100.0 / mb.total_grupos, 1) AS perc_cobertura_funcionarios,\\r\\n    ROUND(mb.grupos_com_pagamentos * 100.0 / mb.total_grupos, 1) AS perc_cobertura_pagamentos,\\r\\n    \\r\\n    -- Contagens detalhadas\\r\\n    ct.total_registros_nfe,\\r\\n    ct.grupos_com_dados_societarios,\\r\\n    ct.total_indicios_sistema,\\r\\n    \\r\\n    -- M\\u00e9tricas de Efici\\u00eancia\\r\\n    ROUND(\\r\\n        (mb.grupos_com_nfe + mb.grupos_com_socios + mb.grupos_com_c115 + \\r\\n         mb.grupos_com_indicios + mb.grupos_com_funcionarios + mb.grupos_com_pagamentos) \\r\\n        / (mb.total_grupos * 6.0) * 100, 1\\r\\n    ) AS indice_integracao_fontes,\\r\\n    \\r\\n    -- Timestamp\\r\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_avaliacao\\r\\n    \\r\\nFROM metricas_base mb\\r\\nCROSS JOIN contagens_tabelas ct;\", \"statementsList\": [\"-- CONFIGURA\\u00c7\\u00c3O PADR\\u00c3O PARA CONSULTAS PESADAS\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\nSET MEM_LIMIT = 8G;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- 1. ESTAT\\u00cdSTICAS GERAIS DO SISTEMA\\r\\n-- ============================================================================\\r\\n\\r\\n-- 1.1 PANORAMA GERAL DO SISTEMA\\r\\n-- Vis\\u00e3o executiva com principais m\\u00e9tricas consolidadas\\r\\nSELECT \\r\\n    'PANORAMA GERAL DO SISTEMA GEI' AS categoria,\\r\\n    \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT num_grupo) AS total_grupos_monitorados,\\r\\n    COUNT(DISTINCT CASE WHEN qntd_cnpj >= 2 THEN num_grupo END) AS grupos_multiplas_empresas,\\r\\n    SUM(qntd_cnpj) AS total_cnpjs_monitorados,\\r\\n    \\r\\n    -- M\\u00e9tricas de Risco\\r\\n    COUNT(DISTINCT CASE WHEN score_final_avancado >= 20 THEN num_grupo END) AS grupos_risco_critico,\\r\\n    COUNT(DISTINCT CASE WHEN score_final_avancado >= 15 AND score_final_avancado < 20 THEN num_grupo END) AS grupos_risco_alto,\\r\\n    COUNT(DISTINCT CASE WHEN score_final_avancado >= 10 AND score_final_avancado < 15 THEN num_grupo END) AS grupos_risco_medio,\\r\\n    \\r\\n    -- Percentuais de Risco\\r\\n    ROUND(COUNT(DISTINCT CASE WHEN score_final_avancado >= 15 THEN num_grupo END) * 100.0 / \\r\\n          COUNT(DISTINCT num_grupo), 2) AS perc_grupos_alto_risco,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    SUM(COALESCE(valor_max, 0)) AS receita_bruta_total_monitorada,\\r\\n    COUNT(DISTINCT CASE WHEN valor_max >= 4800000 THEN num_grupo END) AS grupos_acima_limite_sn,\\r\\n    \\r\\n    -- M\\u00e9tricas de Inconsist\\u00eancias\\r\\n    AVG(total) AS media_inconsistencias_nfe,\\r\\n    COUNT(DISTINCT CASE WHEN total >= 5 THEN num_grupo END) AS grupos_alta_inconsistencia,\\r\\n    \\r\\n    -- M\\u00e9tricas Societ\\u00e1rias\\r\\n    AVG(COALESCE(indice_interconexao, 0)) AS indice_interconexao_medio,\\r\\n    COUNT(DISTINCT CASE WHEN qtd_socios_compartilhados > 0 THEN num_grupo END) AS grupos_socios_compartilhados,\\r\\n    \\r\\n    -- M\\u00e9tricas C115\\r\\n    COUNT(DISTINCT CASE WHEN nivel_risco_grupo_economico IS NOT NULL THEN num_grupo END) AS grupos_com_dados_c115,\\r\\n    COUNT(DISTINCT CASE WHEN nivel_risco_grupo_economico IN ('CR\\u00cdTICO', 'ALTO') THEN num_grupo END) AS grupos_risco_c115_critico_alto,\\r\\n    \\r\\n    -- M\\u00e9tricas de Ind\\u00edcios\\r\\n    COUNT(DISTINCT CASE WHEN qtd_total_indicios > 0 THEN num_grupo END) AS grupos_com_indicios,\\r\\n    AVG(COALESCE(qtd_total_indicios, 0)) AS media_indicios_por_grupo,\\r\\n    \\r\\n    -- Data de Atualiza\\u00e7\\u00e3o\\r\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_consulta\\r\\n    \\r\\nFROM gessimples.gei_percent;\", \"\\r\\n\\r\\n-- 1.2 DISTRIBUI\\u00c7\\u00c3O POR FAIXAS DE SCORE\\r\\n-- An\\u00e1lise da distribui\\u00e7\\u00e3o dos grupos por faixas de risco\\r\\nSELECT \\r\\n    'DISTRIBUI\\u00c7\\u00c3O POR FAIXAS DE SCORE' AS categoria,\\r\\n    \\r\\n    CASE \\r\\n        WHEN score_final_avancado >= 25 THEN '25+ (Cr\\u00edtico Extremo)'\\r\\n        WHEN score_final_avancado >= 20 THEN '20-24.99 (Cr\\u00edtico)'\\r\\n        WHEN score_final_avancado >= 15 THEN '15-19.99 (Alto)'\\r\\n        WHEN score_final_avancado >= 10 THEN '10-14.99 (M\\u00e9dio)'\\r\\n        WHEN score_final_avancado >= 5 THEN '5-9.99 (Baixo)'\\r\\n        ELSE '0-4.99 (M\\u00ednimo)'\\r\\n    END AS faixa_score,\\r\\n    \\r\\n    COUNT(num_grupo) AS quantidade_grupos,\\r\\n    ROUND(COUNT(num_grupo) * 100.0 / SUM(COUNT(num_grupo)) OVER(), 2) AS percentual,\\r\\n    SUM(qntd_cnpj) AS total_cnpjs_faixa,\\r\\n    AVG(score_final_avancado) AS score_medio_faixa,\\r\\n    MIN(score_final_avancado) AS score_minimo_faixa,\\r\\n    MAX(score_final_avancado) AS score_maximo_faixa,\\r\\n    \\r\\n    -- M\\u00e9tricas adicionais por faixa\\r\\n    AVG(COALESCE(valor_max, 0)) AS receita_media_faixa,\\r\\n    COUNT(CASE WHEN valor_max >= 4800000 THEN 1 END) AS grupos_acima_sn_faixa,\\r\\n    AVG(total) AS media_inconsistencias_faixa\\r\\n    \\r\\nFROM gessimples.gei_percent\\r\\nGROUP BY \\r\\n    CASE \\r\\n        WHEN score_final_avancado >= 25 THEN '25+ (Cr\\u00edtico Extremo)'\\r\\n        WHEN score_final_avancado >= 20 THEN '20-24.99 (Cr\\u00edtico)'\\r\\n        WHEN score_final_avancado >= 15 THEN '15-19.99 (Alto)'\\r\\n        WHEN score_final_avancado >= 10 THEN '10-14.99 (M\\u00e9dio)'\\r\\n        WHEN score_final_avancado >= 5 THEN '5-9.99 (Baixo)'\\r\\n        ELSE '0-4.99 (M\\u00ednimo)'\\r\\n    END\\r\\nORDER BY MIN(score_final_avancado) DESC;\", \"\\r\\n\\r\\n-- 1.3 TOP CONTADORES POR RISCO\\r\\n-- Identifica\\u00e7\\u00e3o dos contadores com grupos de maior risco\\r\\nSELECT \\r\\n    'TOP 20 CONTADORES POR RISCO' AS categoria,\\r\\n    c.nm_contador,\\r\\n    c.nm_gerfe,\\r\\n    c.qntd_grupos,\\r\\n    c.media AS score_medio_grupos,\\r\\n    \\r\\n    -- M\\u00e9tricas adicionais calculadas\\r\\n    COUNT(p.num_grupo) AS grupos_encontrados_base,\\r\\n    AVG(p.score_final_avancado) AS score_medio_atual,\\r\\n    COUNT(CASE WHEN p.score_final_avancado >= 15 THEN 1 END) AS grupos_alto_risco,\\r\\n    SUM(p.qntd_cnpj) AS total_cnpjs_contador,\\r\\n    SUM(COALESCE(p.valor_max, 0)) AS receita_total_contador\\r\\n    \\r\\nFROM gessimples.gei_contador c\\r\\nLEFT JOIN gessimples.gei_percent p \\r\\n    ON c.nm_contador = p.nm_contador  -- Simplificado para funcionar no Impala\\r\\nWHERE c.qntd_grupos >= 3  -- Apenas contadores com 3+ grupos\\r\\nGROUP BY c.nm_contador, c.nm_gerfe, c.qntd_grupos, c.media\\r\\nORDER BY c.media DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- 2. CONSULTAS ANAL\\u00cdTICAS ESPEC\\u00cdFICAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 2.1 AN\\u00c1LISE DE OUTLIERS E ANOMALIAS (VERS\\u00c3O CORRIGIDA SEM APPROX_PERCENTILE)\\r\\n-- Identifica\\u00e7\\u00e3o de grupos com comportamentos an\\u00f4malos\\r\\nWITH\\r\\n  dados_base AS (\\r\\n    -- Seleciona apenas os dados necess\\u00e1rios e remove nulos para o c\\u00e1lculo de percentis\\r\\n    SELECT\\r\\n      score_final_avancado,\\r\\n      valor_max\\r\\n    FROM\\r\\n      gessimples.gei_percent\\r\\n    WHERE\\r\\n      score_final_avancado IS NOT NULL AND valor_max IS NOT NULL\\r\\n  ),\\r\\n  metricas_agregadas AS (\\r\\n    -- Calcula m\\u00e9tricas simples (m\\u00e9dia e desvio padr\\u00e3o) em uma passagem\\r\\n    SELECT\\r\\n      AVG(score_final_avancado) AS media_score,\\r\\n      STDDEV(score_final_avancado) AS desvio_score\\r\\n    FROM\\r\\n      dados_base\\r\\n  ),\\r\\n  ranks AS (\\r\\n    -- Atribui um n\\u00famero de linha (rank) para cada registro ordenado por score e receita\\r\\n    SELECT\\r\\n      score_final_avancado,\\r\\n      valor_max,\\r\\n      ROW_NUMBER() OVER (ORDER BY score_final_avancado) AS rn_score,\\r\\n      ROW_NUMBER() OVER (ORDER BY valor_max) AS rn_receita,\\r\\n      COUNT(*) OVER () AS total_linhas\\r\\n    FROM\\r\\n      dados_base\\r\\n  ),\\r\\n  quartis AS (\\r\\n    -- Usa os ranks para encontrar os valores nos pontos de corte dos percentis\\r\\n    SELECT\\r\\n      MAX(CASE WHEN rn_score = CAST(total_linhas * 0.25 AS INT) THEN score_final_avancado END) AS q1_score,\\r\\n      MAX(CASE WHEN rn_score = CAST(total_linhas * 0.75 AS INT) THEN score_final_avancado END) AS q3_score,\\r\\n      MAX(CASE WHEN rn_score = CAST(total_linhas * 0.95 AS INT) THEN score_final_avancado END) AS p95_score,\\r\\n      MAX(CASE WHEN rn_receita = CAST(total_linhas * 0.25 AS INT) THEN valor_max END) AS q1_receita,\\r\\n      MAX(CASE WHEN rn_receita = CAST(total_linhas * 0.75 AS INT) THEN valor_max END) AS q3_receita,\\r\\n      MAX(CASE WHEN rn_receita = CAST(total_linhas * 0.95 AS INT) THEN valor_max END) AS p95_receita,\\r\\n      m.media_score,\\r\\n      m.desvio_score\\r\\n    FROM\\r\\n      ranks\\r\\n      CROSS JOIN metricas_agregadas m\\r\\n    GROUP BY\\r\\n      m.media_score,\\r\\n      m.desvio_score\\r\\n  )\\r\\nSELECT\\r\\n  'AN\\u00c1LISE DE OUTLIERS' AS categoria,\\r\\n  p.num_grupo,\\r\\n  p.qntd_cnpj,\\r\\n  p.score_final_avancado,\\r\\n  p.valor_max,\\r\\n  p.total_funcionarios,\\r\\n  -- Classifica\\u00e7\\u00e3o de anomalias\\r\\n  CASE\\r\\n    WHEN p.score_final_avancado > q.p95_score THEN 'Score Extremo (P95+)'\\r\\n    WHEN p.score_final_avancado > (q.media_score + 2 * q.desvio_score) THEN 'Score Muito Alto (>2\\u03c3)'\\r\\n    WHEN p.valor_max > q.p95_receita AND p.score_final_avancado < 5 THEN 'Alta Receita/Baixo Risco'\\r\\n    WHEN p.total_funcionarios > 100 AND p.valor_max < 1000000 THEN 'Muitos Funcion\\u00e1rios/Baixa Receita'\\r\\n    WHEN p.valor_max > 10000000 AND p.total_funcionarios < 5 THEN 'Alta Receita/Poucos Funcion\\u00e1rios'\\r\\n    WHEN p.indice_risco_pagamentos > 0.5 THEN 'Alto Risco Pagamentos'\\r\\n    ELSE 'Outros'\\r\\n  END AS tipo_anomalia,\\r\\n  -- M\\u00e9tricas contextuais\\r\\n  p.total AS inconsistencias_nfe,\\r\\n  p.indice_interconexao,\\r\\n  p.qtd_total_indicios,\\r\\n  p.nivel_risco_grupo_economico\\r\\nFROM\\r\\n  gessimples.gei_percent p\\r\\n  CROSS JOIN quartis q\\r\\nWHERE\\r\\n  p.score_final_avancado IS NOT NULL AND (\\r\\n    p.score_final_avancado > q.p95_score\\r\\n    OR p.score_final_avancado > (q.media_score + 2 * q.desvio_score)\\r\\n    OR (\\r\\n      p.valor_max > q.p95_receita AND p.score_final_avancado < 5\\r\\n    )\\r\\n    OR (\\r\\n      p.total_funcionarios > 100 AND p.valor_max < 1000000\\r\\n    )\\r\\n    OR (\\r\\n      p.valor_max > 10000000 AND p.total_funcionarios < 5\\r\\n    )\\r\\n    OR p.indice_risco_pagamentos > 0.5\\r\\n  )\\r\\nORDER BY\\r\\n  p.score_final_avancado DESC;\", \"\\r\\n\\r\\n-- 2.2 AN\\u00c1LISE TEMPORAL DE LIMITES DO SIMPLES NACIONAL\\r\\n-- Evolu\\u00e7\\u00e3o dos grupos pr\\u00f3ximos ou acima do limite\\r\\nWITH receitas_agregadas AS (\\r\\n    SELECT \\r\\n        gc.num_grupo,\\r\\n        -- Apenas \\u00faltimos 6 meses para simplicidade\\r\\n        SUM(pg.abr2025) AS abr2025,\\r\\n        SUM(pg.mai2025) AS mai2025, \\r\\n        SUM(pg.jun2025) AS jun2025,\\r\\n        SUM(pg.jul2025) AS jul2025, \\r\\n        SUM(pg.ago2025) AS ago2025, \\r\\n        SUM(pg.set2025) AS set2025\\r\\n    FROM gessimples.gei_cnpj gc\\r\\n    JOIN gessimples.gei_pgdas pg ON gc.cnpj = pg.cnpj\\r\\n    GROUP BY gc.num_grupo\\r\\n)\\r\\nSELECT \\r\\n    'AN\\u00c1LISE TEMPORAL LIMITES SN' AS categoria,\\r\\n    ra.num_grupo,\\r\\n    p.qntd_cnpj,\\r\\n    p.score_final_avancado,\\r\\n    \\r\\n    -- Receitas \\u00faltimos 6 meses\\r\\n    ra.abr2025, ra.mai2025, ra.jun2025, ra.jul2025, ra.ago2025, ra.set2025,\\r\\n    \\r\\n    -- An\\u00e1lise de tend\\u00eancia simplificada\\r\\n    CASE \\r\\n        WHEN ra.set2025 > ra.ago2025 AND ra.ago2025 > ra.jul2025 THEN 'Crescente'\\r\\n        WHEN ra.set2025 < ra.ago2025 AND ra.ago2025 < ra.jul2025 THEN 'Decrescente'\\r\\n        ELSE 'Est\\u00e1vel/Oscilante'\\r\\n    END AS tendencia,\\r\\n    \\r\\n    -- Proximidade do limite\\r\\n    CASE \\r\\n        WHEN ra.set2025 >= 4800000 THEN 'Acima do limite'\\r\\n        WHEN ra.set2025 >= 4300000 THEN 'Muito pr\\u00f3ximo (90%+)'\\r\\n        WHEN ra.set2025 >= 3840000 THEN 'Pr\\u00f3ximo (80%+)'\\r\\n        WHEN ra.set2025 >= 2400000 THEN 'Moderado (50%+)'\\r\\n        ELSE 'Distante'\\r\\n    END AS situacao_limite\\r\\n    \\r\\nFROM receitas_agregadas ra\\r\\nJOIN gessimples.gei_percent p ON ra.num_grupo = p.num_grupo\\r\\nWHERE ra.set2025 >= 2400000  -- Apenas grupos com receita significativa\\r\\nORDER BY ra.set2025 DESC;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- 3. AN\\u00c1LISES COMPLETAS E INVESTIGA\\u00c7\\u00c3O\\r\\n-- ============================================================================\\r\\n\\r\\n-- 3.1 RELAT\\u00d3RIO COMPLETO DE GRUPO ESPEC\\u00cdFICO\\r\\n-- Template para an\\u00e1lise detalhada de um grupo\\r\\nSELECT \\r\\n    'RELAT\\u00d3RIO COMPLETO - GRUPO' AS categoria,\\r\\n    p.num_grupo,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o b\\u00e1sica\\r\\n    p.qntd_cnpj AS quantidade_empresas,\\r\\n    p.score_final_avancado AS score_atual,\\r\\n    \\r\\n    -- Ranking aproximado usando ROW_NUMBER\\r\\n    ROW_NUMBER() OVER (ORDER BY p.score_final_avancado DESC) AS posicao_ranking_aprox,\\r\\n    \\r\\n    -- Decomposi\\u00e7\\u00e3o do score\\r\\n    p.total AS score_inconsistencias_nfe,\\r\\n    p.total_cadastro AS score_consistencia_cadastral,\\r\\n    (p.indice_interconexao * 10) AS score_societario,\\r\\n    p.indice_risco_grupo_economico AS score_c115,\\r\\n    (p.indice_risco_indicios * 20) AS score_indicios,\\r\\n    p.indice_risco_pagamentos AS score_pagamentos,\\r\\n    p.indice_risco_fat_func AS score_faturamento_funcionarios,\\r\\n    \\r\\n    -- Detalhes das inconsist\\u00eancias\\r\\n    p.perc_cliente AS perc_clientes_compartilhados,\\r\\n    p.perc_email AS perc_emails_compartilhados,\\r\\n    p.perc_tel_dest AS perc_telefones_dest_compartilhados,\\r\\n    p.perc_tel_emit AS perc_telefones_emit_compartilhados,\\r\\n    p.perc_codigo_produto AS perc_codigos_produto_compartilhados,\\r\\n    p.perc_fornecedor AS perc_fornecedores_compartilhados,\\r\\n    \\r\\n    -- Consist\\u00eancia cadastral\\r\\n    p.nm_razao_social AS razao_social_consistente,\\r\\n    p.nm_fantasia AS fantasia_consistente,\\r\\n    p.cd_cnae AS cnae_consistente,\\r\\n    p.nm_contador AS contador_consistente,\\r\\n    p.endereco AS endereco_consistente,\\r\\n    \\r\\n    -- M\\u00e9tricas societ\\u00e1rias\\r\\n    p.qtd_socios_compartilhados,\\r\\n    p.qtd_cnpjs_com_socios_compartilhados,\\r\\n    p.indice_interconexao,\\r\\n    p.qtd_pares_cnpjs_relacionados,\\r\\n    \\r\\n    -- M\\u00e9tricas financeiras\\r\\n    p.valor_max AS receita_bruta_maxima,\\r\\n    p.periodo_max AS periodo_receita_maxima,\\r\\n    p.periodo AS primeiro_periodo_excesso_sn,\\r\\n    \\r\\n    -- Dados C115\\r\\n    p.nivel_risco_grupo_economico AS risco_c115,\\r\\n    p.total_tomadores,\\r\\n    p.tomadores_com_compartilhamento,\\r\\n    p.perc_tomadores_com_compartilhamento,\\r\\n    \\r\\n    -- Ind\\u00edcios fiscais\\r\\n    p.qtd_total_indicios,\\r\\n    p.qtd_tipos_indicios_distintos,\\r\\n    p.qtd_cnpjs_com_indicios,\\r\\n    \\r\\n    -- Dados complementares\\r\\n    p.total_funcionarios,\\r\\n    p.valor_meios_pagamento_empresas,\\r\\n    p.valor_meios_pagamento_socios,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o final\\r\\n    CASE \\r\\n        WHEN p.score_final_avancado >= 25 THEN 'CR\\u00cdTICO EXTREMO - Investiga\\u00e7\\u00e3o Imediata'\\r\\n        WHEN p.score_final_avancado >= 20 THEN 'CR\\u00cdTICO - Alta Prioridade'\\r\\n        WHEN p.score_final_avancado >= 15 THEN 'ALTO - Monitoramento Intensivo'\\r\\n        WHEN p.score_final_avancado >= 10 THEN 'M\\u00c9DIO - Acompanhamento Regular'\\r\\n        WHEN p.score_final_avancado >= 5 THEN 'BAIXO - Monitoramento B\\u00e1sico'\\r\\n        ELSE 'M\\u00cdNIMO - Acompanhamento Rotineiro'\\r\\n    END AS classificacao_risco_recomendacao\\r\\n    \\r\\nFROM gessimples.gei_percent p\\r\\n-- WHERE p.num_grupo = @NUM_GRUPO  -- Descomentar e substituir para grupo espec\\u00edfico\\r\\nORDER BY p.score_final_avancado DESC\\r\\nLIMIT 10;\", \"  -- Remover para an\\u00e1lise de grupo espec\\u00edfico\\r\\n\\r\\n-- 3.2 AN\\u00c1LISE SETORIAL POR CNAE (VERS\\u00c3O CORRIGIDA E ATUALIZADA)\\r\\n-- Compara\\u00e7\\u00e3o de grupos por setor de atividade\\r\\nWITH\\r\\n  cnae_grupos AS (\\r\\n    SELECT\\r\\n      g.num_grupo,\\r\\n      c.cd_cnae,\\r\\n      -- CORRE\\u00c7\\u00c3O APLICADA AQUI: CAST para converter n\\u00famero em string\\r\\n      SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS secao_cnae\\r\\n    FROM\\r\\n      gessimples.gei_cnpj g\\r\\n      JOIN gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\\r\\n    WHERE\\r\\n      c.cd_cnae IS NOT NULL\\r\\n  ),\\r\\n  grupos_cnae_principal AS (\\r\\n    SELECT\\r\\n      num_grupo,\\r\\n      secao_cnae,\\r\\n      ROW_NUMBER() OVER (\\r\\n        PARTITION BY\\r\\n          num_grupo\\r\\n        ORDER BY\\r\\n          secao_cnae\\r\\n      ) AS rn\\r\\n    FROM\\r\\n      cnae_grupos\\r\\n    GROUP BY\\r\\n      num_grupo,\\r\\n      secao_cnae\\r\\n  ),\\r\\n  dados_setoriais_com_percentil AS (\\r\\n    -- Adiciona o c\\u00e1lculo de percentil usando NTILE() para cada setor\\r\\n    SELECT\\r\\n      gcp.secao_cnae,\\r\\n      p.*,\\r\\n      NTILE(100) OVER (\\r\\n        PARTITION BY\\r\\n          gcp.secao_cnae\\r\\n        ORDER BY\\r\\n          p.score_final_avancado\\r\\n      ) AS percentil_score\\r\\n    FROM\\r\\n      grupos_cnae_principal gcp\\r\\n      JOIN gessimples.gei_percent p ON gcp.num_grupo = p.num_grupo\\r\\n    WHERE\\r\\n      gcp.rn = 1 -- Apenas a primeira se\\u00e7\\u00e3o CNAE por grupo\\r\\n  )\\r\\nSELECT\\r\\n  'AN\\u00c1LISE SETORIAL - CNAE' AS categoria,\\r\\n  secao_cnae,\\r\\n  -- Descri\\u00e7\\u00e3o da se\\u00e7\\u00e3o CNAE (principais setores)\\r\\n  CASE secao_cnae\\r\\n    WHEN '01' THEN 'Agricultura, Pecu\\u00e1ria'\\r\\n    WHEN '10' THEN 'Fabrica\\u00e7\\u00e3o de Produtos Aliment\\u00edcios'\\r\\n    WHEN '46' THEN 'Com\\u00e9rcio Atacadista'\\r\\n    WHEN '47' THEN 'Com\\u00e9rcio Varejista'\\r\\n    WHEN '68' THEN 'Atividades Imobili\\u00e1rias'\\r\\n    WHEN '70' THEN 'Atividades de Consultoria'\\r\\n    WHEN '77' THEN 'Aluguel e Leasing'\\r\\n    WHEN '82' THEN 'Servi\\u00e7os de Apoio'\\r\\n    ELSE CONCAT('Se\\u00e7\\u00e3o ', secao_cnae)\\r\\n  END AS descricao_setor,\\r\\n  COUNT(DISTINCT num_grupo) AS grupos_no_setor,\\r\\n  AVG(score_final_avancado) AS score_medio_setor,\\r\\n  STDDEV(score_final_avancado) AS desvio_score_setor,\\r\\n  MIN(score_final_avancado) AS score_minimo_setor,\\r\\n  MAX(score_final_avancado) AS score_maximo_setor,\\r\\n  -- Percentis calculados a partir dos \\\"baldes\\\" criados pelo NTILE\\r\\n  MAX(CASE WHEN percentil_score = 25 THEN score_final_avancado END) AS p25_score,\\r\\n  MAX(CASE WHEN percentil_score = 50 THEN score_final_avancado END) AS mediana_score,\\r\\n  MAX(CASE WHEN percentil_score = 75 THEN score_final_avancado END) AS p75_score,\\r\\n  -- M\\u00e9tricas espec\\u00edficas por setor\\r\\n  AVG(valor_max) AS receita_media_setor,\\r\\n  AVG(qntd_cnpj) AS media_empresas_por_grupo,\\r\\n  COUNT(CASE WHEN score_final_avancado >= 15 THEN 1 END) AS grupos_alto_risco,\\r\\n  ROUND(\\r\\n    COUNT(CASE WHEN score_final_avancado >= 15 THEN 1 END) * 100.0 / COUNT(DISTINCT num_grupo),\\r\\n    2\\r\\n  ) AS perc_alto_risco_setor,\\r\\n  -- Principais problemas do setor\\r\\n  AVG(total) AS media_inconsistencias_setor,\\r\\n  AVG(indice_interconexao) AS media_interconexao_setor,\\r\\n  COUNT(CASE WHEN qtd_total_indicios > 0 THEN 1 END) AS grupos_com_indicios_setor\\r\\nFROM\\r\\n  dados_setoriais_com_percentil\\r\\nGROUP BY\\r\\n  secao_cnae\\r\\nHAVING\\r\\n  COUNT(DISTINCT num_grupo) >= 5 -- Apenas setores com 5+ grupos\\r\\nORDER BY\\r\\n  AVG(score_final_avancado) DESC;\", \"-- 3.2 AN\\u00c1LISE SETORIAL POR CNAE (VERS\\u00c3O CORRIGIDA E ATUALIZADA)\\r\\n-- Compara\\u00e7\\u00e3o de grupos por setor de atividade\\r\\nWITH\\r\\n  cnae_grupos AS (\\r\\n    SELECT\\r\\n      g.num_grupo,\\r\\n      c.cd_cnae,\\r\\n      -- CORRE\\u00c7\\u00c3O APLICADA AQUI: CAST para converter n\\u00famero em string\\r\\n      SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS secao_cnae\\r\\n    FROM\\r\\n      gessimples.gei_cnpj g\\r\\n      JOIN gessimples.gei_cadastro c ON g.cnpj = c.nu_cnpj\\r\\n    WHERE\\r\\n      c.cd_cnae IS NOT NULL\\r\\n  ),\\r\\n  grupos_cnae_principal AS (\\r\\n    SELECT\\r\\n      num_grupo,\\r\\n      secao_cnae,\\r\\n      ROW_NUMBER() OVER (\\r\\n        PARTITION BY\\r\\n          num_grupo\\r\\n        ORDER BY\\r\\n          secao_cnae\\r\\n      ) AS rn\\r\\n    FROM\\r\\n      cnae_grupos\\r\\n    GROUP BY\\r\\n      num_grupo,\\r\\n      secao_cnae\\r\\n  ),\\r\\n  dados_setoriais_com_percentil AS (\\r\\n    -- Adiciona o c\\u00e1lculo de percentil usando NTILE() para cada setor\\r\\n    SELECT\\r\\n      gcp.secao_cnae,\\r\\n      p.*,\\r\\n      NTILE(100) OVER (\\r\\n        PARTITION BY\\r\\n          gcp.secao_cnae\\r\\n        ORDER BY\\r\\n          p.score_final_avancado\\r\\n      ) AS percentil_score\\r\\n    FROM\\r\\n      grupos_cnae_principal gcp\\r\\n      JOIN gessimples.gei_percent p ON gcp.num_grupo = p.num_grupo\\r\\n    WHERE\\r\\n      gcp.rn = 1 -- Apenas a primeira se\\u00e7\\u00e3o CNAE por grupo\\r\\n  )\\r\\nSELECT\\r\\n  'AN\\u00c1LISE SETORIAL - CNAE' AS categoria,\\r\\n  secao_cnae,\\r\\n  -- Descri\\u00e7\\u00e3o da se\\u00e7\\u00e3o CNAE (principais setores)\\r\\n  CASE secao_cnae\\r\\n    WHEN '01' THEN 'Agricultura, Pecu\\u00e1ria'\\r\\n    WHEN '10' THEN 'Fabrica\\u00e7\\u00e3o de Produtos Aliment\\u00edcios'\\r\\n    WHEN '46' THEN 'Com\\u00e9rcio Atacadista'\\r\\n    WHEN '47' THEN 'Com\\u00e9rcio Varejista'\\r\\n    WHEN '68' THEN 'Atividades Imobili\\u00e1rias'\\r\\n    WHEN '70' THEN 'Atividades de Consultoria'\\r\\n    WHEN '77' THEN 'Aluguel e Leasing'\\r\\n    WHEN '82' THEN 'Servi\\u00e7os de Apoio'\\r\\n    ELSE CONCAT('Se\\u00e7\\u00e3o ', secao_cnae)\\r\\n  END AS descricao_setor,\\r\\n  COUNT(DISTINCT num_grupo) AS grupos_no_setor,\\r\\n  AVG(score_final_avancado) AS score_medio_setor,\\r\\n  STDDEV(score_final_avancado) AS desvio_score_setor,\\r\\n  MIN(score_final_avancado) AS score_minimo_setor,\\r\\n  MAX(score_final_avancado) AS score_maximo_setor,\\r\\n  -- Percentis calculados a partir dos \\\"baldes\\\" criados pelo NTILE\\r\\n  MAX(CASE WHEN percentil_score = 25 THEN score_final_avancado END) AS p25_score,\\r\\n  MAX(CASE WHEN percentil_score = 50 THEN score_final_avancado END) AS mediana_score,\\r\\n  MAX(CASE WHEN percentil_score = 75 THEN score_final_avancado END) AS p75_score,\\r\\n  -- M\\u00e9tricas espec\\u00edficas por setor\\r\\n  AVG(valor_max) AS receita_media_setor,\\r\\n  AVG(qntd_cnpj) AS media_empresas_por_grupo,\\r\\n  COUNT(CASE WHEN score_final_avancado >= 15 THEN 1 END) AS grupos_alto_risco,\\r\\n  ROUND(\\r\\n    COUNT(CASE WHEN score_final_avancado >= 15 THEN 1 END) * 100.0 / COUNT(DISTINCT num_grupo),\\r\\n    2\\r\\n  ) AS perc_alto_risco_setor,\\r\\n  -- Principais problemas do setor\\r\\n  AVG(total) AS media_inconsistencias_setor,\\r\\n  AVG(indice_interconexao) AS media_interconexao_setor,\\r\\n  COUNT(CASE WHEN qtd_total_indicios > 0 THEN 1 END) AS grupos_com_indicios_setor\\r\\nFROM\\r\\n  dados_setoriais_com_percentil\\r\\nGROUP BY\\r\\n  secao_cnae\\r\\nHAVING\\r\\n  COUNT(DISTINCT num_grupo) >= 5 -- Apenas setores com 5+ grupos\\r\\nORDER BY\\r\\n  AVG(score_final_avancado) DESC;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- 4. CONSULTAS PARA MONITORAMENTO OPERACIONAL\\r\\n-- ============================================================================\\r\\n\\r\\n-- 4.1 DASHBOARD EXECUTIVO - M\\u00c9TRICAS DI\\u00c1RIAS\\r\\n-- KPIs principais para acompanhamento gerencial\\r\\nSELECT \\r\\n    'DASHBOARD EXECUTIVO' AS categoria,\\r\\n    \\r\\n    -- M\\u00e9tricas Principais\\r\\n    COUNT(DISTINCT num_grupo) AS total_grupos,\\r\\n    SUM(qntd_cnpj) AS total_cnpjs,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Risco\\r\\n    COUNT(CASE WHEN score_final_avancado >= 20 THEN 1 END) AS grupos_criticos,\\r\\n    COUNT(CASE WHEN score_final_avancado >= 15 AND score_final_avancado < 20 THEN 1 END) AS grupos_alto_risco,\\r\\n    COUNT(CASE WHEN score_final_avancado >= 10 AND score_final_avancado < 15 THEN 1 END) AS grupos_medio_risco,\\r\\n    \\r\\n    -- Percentuais\\r\\n    ROUND(COUNT(CASE WHEN score_final_avancado >= 15 THEN 1 END) * 100.0 / \\r\\n          COUNT(DISTINCT num_grupo), 1) AS perc_grupos_prioritarios,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    SUM(CASE WHEN valor_max IS NOT NULL THEN valor_max ELSE 0 END) AS receita_total_monitorada,\\r\\n    COUNT(CASE WHEN valor_max >= 4800000 THEN 1 END) AS grupos_acima_limite_sn,\\r\\n    ROUND(COUNT(CASE WHEN valor_max >= 4800000 THEN 1 END) * 100.0 / \\r\\n          COUNT(CASE WHEN valor_max IS NOT NULL THEN 1 END), 1) AS perc_acima_limite,\\r\\n    \\r\\n    -- Top Alertas\\r\\n    COUNT(CASE WHEN perc_cliente >= 0.5 THEN 1 END) AS alertas_clientes_compartilhados,\\r\\n    COUNT(CASE WHEN perc_ip_transmissao >= 0.8 THEN 1 END) AS alertas_ip_compartilhado,\\r\\n    COUNT(CASE WHEN indice_interconexao >= 0.8 THEN 1 END) AS alertas_alta_interconexao,\\r\\n    COUNT(CASE WHEN qtd_total_indicios >= 5 THEN 1 END) AS alertas_multiplos_indicios,\\r\\n    \\r\\n    -- Timestamp\\r\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_atualizacao\\r\\n    \\r\\nFROM gessimples.gei_percent;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- CONFIGURA\\u00c7\\u00c3O PADR\\u00c3O PARA CONSULTAS PESADAS\\r\\nSET REQUEST_POOL = 'medium';\", \"result\": {\"id\": \"e6ae2443-b6c0-55ec-41cd-355388540a5b\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"g26N2mT6T6uVLF6sNMafIA==\", \"guid\": \"Yc2lOAXPRtMAAAAAoq3xew==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"324553819f97ab1c:002c1c61fcc4deb3\", \"session_id\": 21005, \"session_type\": \"impala\", \"statement_id\": 1, \"has_more_statements\": false, \"statements_count\": 2, \"previous_statement_hash\": \"3e1cedca2388f305ebf6712b46d2757e6a27e431656c53fe674a89ba\", \"start\": {\"row\": 59, \"column\": 0}, \"end\": {\"row\": 115, \"column\": 31}, \"statement\": \"-- ============================================================================\\n-- 7. RELAT\\u00d3RIOS DE PERFORMANCE E QUALIDADE\\n-- ============================================================================\\n\\n-- 7.1 RELAT\\u00d3RIO DE PERFORMANCE DO SISTEMA\\n-- M\\u00e9tricas de qualidade e efetividade do sistema GEI\\nWITH metricas_base AS (\\n    SELECT \\n        COUNT(*) AS total_grupos,\\n        COUNT(CASE WHEN score_final_avancado IS NOT NULL THEN 1 END) AS grupos_com_score,\\n        COUNT(CASE WHEN distinct_nfe > 0 THEN 1 END) AS grupos_com_nfe,\\n        COUNT(CASE WHEN qtd_socios_compartilhados > 0 THEN 1 END) AS grupos_com_socios,\\n        COUNT(CASE WHEN nivel_risco_grupo_economico IS NOT NULL THEN 1 END) AS grupos_com_c115,\\n        COUNT(CASE WHEN qtd_total_indicios > 0 THEN 1 END) AS grupos_com_indicios,\\n        COUNT(CASE WHEN total_funcionarios > 0 THEN 1 END) AS grupos_com_funcionarios,\\n        COUNT(CASE WHEN valor_meios_pagamento_empresas > 0 THEN 1 END) AS grupos_com_pagamentos\\n    FROM gessimples.gei_percent\\n),\\ncontagens_tabelas AS (\\n    SELECT \\n        (SELECT COUNT(*) FROM gessimples.gei_nfe_completo) AS total_registros_nfe,\\n        (SELECT COUNT(DISTINCT num_grupo) FROM gessimples.gei_socios) AS grupos_com_dados_societarios,\\n        (SELECT COUNT(*) FROM gessimples.gei_indicios) AS total_indicios_sistema\\n)\\nSELECT \\n    'PERFORMANCE DO SISTEMA' AS categoria,\\n    \\n    -- Cobertura de Dados\\n    mb.total_grupos AS total_grupos_sistema,\\n    mb.grupos_com_score AS grupos_processados,\\n    ROUND(mb.grupos_com_score * 100.0 / mb.total_grupos, 1) AS perc_cobertura_score,\\n    \\n    -- Cobertura por Fonte de Dados\\n    ROUND(mb.grupos_com_nfe * 100.0 / mb.total_grupos, 1) AS perc_cobertura_nfe,\\n    ROUND(mb.grupos_com_socios * 100.0 / mb.total_grupos, 1) AS perc_cobertura_socios,\\n    ROUND(mb.grupos_com_c115 * 100.0 / mb.total_grupos, 1) AS perc_cobertura_c115,\\n    ROUND(mb.grupos_com_indicios * 100.0 / mb.total_grupos, 1) AS perc_cobertura_indicios,\\n    ROUND(mb.grupos_com_funcionarios * 100.0 / mb.total_grupos, 1) AS perc_cobertura_funcionarios,\\n    ROUND(mb.grupos_com_pagamentos * 100.0 / mb.total_grupos, 1) AS perc_cobertura_pagamentos,\\n    \\n    -- Contagens detalhadas\\n    ct.total_registros_nfe,\\n    ct.grupos_com_dados_societarios,\\n    ct.total_indicios_sistema,\\n    \\n    -- M\\u00e9tricas de Efici\\u00eancia\\n    ROUND(\\n        (mb.grupos_com_nfe + mb.grupos_com_socios + mb.grupos_com_c115 + \\n         mb.grupos_com_indicios + mb.grupos_com_funcionarios + mb.grupos_com_pagamentos) \\n        / (mb.total_grupos * 6.0) * 100, 1\\n    ) AS indice_integracao_fontes,\\n    \\n    -- Timestamp\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_avaliacao\\n    \\nFROM metricas_base mb\\nCROSS JOIN contagens_tabelas ct\"}, \"meta\": [], \"rows\": 1, \"hasMore\": false, \"statement_id\": 1, \"statement_range\": {\"start\": {\"row\": 59, \"column\": 0}, \"end\": {\"row\": 115, \"column\": 31}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-09-30T17:50:45.356Z\", \"endTime\": \"2025-09-30T17:50:46.709Z\", \"executionTime\": 1353, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"categoria\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"grupos_processados\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"categoria\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"grupos_processados\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1759254645095, \"lastAceSelectionRowOffset\": 914, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 77.5, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 100, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- CONFIGURAÃÃO PADRÃO PARA CONSULTAS PESADAS\r\nSET REQUEST_POOL = 'medium';\r\nSET MEM_LIMIT = 8G;\r\n\r\n-- ============================================================================\r\n-- 1. ESTATÃSTICAS GERAIS DO SISTEMA\r\n-- ============================================================================\r\n\r\n-- 1.1 PANORAMA GERAL DO SISTEMA\r\n-- VisÃ£o executiva com principais mÃ©tricas consolidadas\r\nSELECT \r\n    'PANORAMA GERAL DO SISTEMA GEI' AS categoria,\r\n    \r\n    -- MÃ©tricas de Volume\r\n    COUNT(DISTINCT num_grupo) AS total_grupos_monitorados,\r\n    COUNT(DISTINCT CASE WHEN qntd_cnpj >= 2 THEN num_grupo END) AS grupos_multiplas_empresas,\r\n    SUM(qntd_cnpj) AS total_cnpjs_monitorados,\r\n    \r\n    -- MÃ©tricas de Risco\r\n    COUNT(DISTINCT CASE WHEN score_final_avancado >= 20 THEN num_grupo END) AS grupos_risco_critico,\r\n    COUNT(DISTINCT CASE WHEN score_final_avancado >= 15 AND score_final_avancado < 20 THEN num_grupo END) AS grupos_risco_alto,\r\n    COUNT(DISTINCT CASE WHEN score_final_avancado >= 10 AND score_final_avancado < 15 THEN num_grupo END) AS grupos_risco_medio,\r\n    \r\n    -- Percentuais de Risco\r\n    ROUND(COUNT(DISTINCT CASE WHEN score_final_avancado >= 15 THEN num_grupo END) * 100.0 / \r\n          COUNT(DISTINCT num_grupo), 2) AS perc_grupos_alto_risco,\r\n    \r\n    -- MÃ©tricas Financeiras\r\n    SUM(COALESCE(valor_max, 0)) AS receita_bruta_total_monitorada,\r\n    COUNT(DISTINCT CASE WHEN valor_max >= 4800000 THEN num_grupo END) AS grupos_acima_limite_sn,\r\n    \r\n    -- MÃ©tricas de InconsistÃªncias\r\n    AVG(total) AS media_inconsistencias_nfe,\r\n    COUNT(DISTINCT CASE WHEN total >= 5 THEN num_grupo END) AS grupos_alta_inconsistencia,\r\n    \r\n    -- MÃ©tricas SocietÃ¡rias\r\n    AVG(COALESCE(indice_interconexao, 0)) AS indice_interconexao_medio,\r\n    COUNT(DISTINCT CASE WHEN qtd_socios_compartilhados > 0 THEN num_grupo END) AS grupos_socios_compartilhados,\r\n    \r\n    -- MÃ©tricas C115\r\n    COUNT(DISTINCT CASE WHEN nivel_risco_grupo_economico IS NOT NULL THEN num_grupo END) AS",
    "last_modified": "2025-10-02T17:43:43.935",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 159489,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: CCS",
    "description": "",
    "uuid": "c22d8bed-152c-9c94-b1cf-d935ec5f68eb",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 159489, \"uuid\": \"31f3b8a9-3a50-4079-a102-5ec3c5c8e4e8\", \"name\": \"GEI: CCS\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"c22d8bed-152c-9c94-b1cf-d935ec5f68eb\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"2294b232-e98e-126a-0715-b2e2fb8edb4a\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 390, \"column\": 26}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ========================================================================\\r\\n-- PARTE 1: Tabela base de contas banc\\u00e1rias do grupo\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_contas;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_contas AS\\r\\nSELECT\\r\\n    g.num_grupo,\\r\\n    g.cnpj,\\r\\n    c.nr_cpf,\\r\\n    c.nm_responsavel,\\r\\n    c.nm_banco,\\r\\n    c.dt_abertura,\\r\\n    c.dt_encerramento,\\r\\n    c.tp_conta,\\r\\n    c.cd_agencia,\\r\\n    c.nr_conta,\\r\\n    c.tp_responsavel,\\r\\n    c.dt_inicio_responsavel,\\r\\n    c.dt_final_responsavel,\\r\\n    c.cnpj_instituicao,\\r\\n    CASE \\r\\n        WHEN c.dt_encerramento IS NULL THEN 'ATIVA'\\r\\n        WHEN c.dt_encerramento >= DATE_SUB(CURRENT_DATE(), 365) THEN 'ENCERRADA_RECENTE'\\r\\n        ELSE 'ENCERRADA_ANTIGA'\\r\\n    END AS status_conta\\r\\nFROM \\r\\n    gessimples.gei_cnpj g\\r\\nJOIN \\r\\n    usr_sat_fsn.fsn_conta_bancaria c ON g.cnpj = c.nr_cnpj\\r\\nWHERE \\r\\n    (c.valido IS NULL OR c.valido = 1)\\r\\n    AND c.nr_cpf IS NOT NULL;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 2: Identifica\\u00e7\\u00e3o de CPFs compartilhando contas entre CNPJs do grupo\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_cpf_compartilhado;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_cpf_compartilhado AS\\r\\nWITH cpf_conta_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nr_cpf,\\r\\n        nm_banco,\\r\\n        cd_agencia,\\r\\n        nr_conta,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_usando_conta,\\r\\n        COUNT(*) AS qtd_vinculos,\\r\\n        MIN(dt_abertura) AS dt_primeira_abertura,\\r\\n        MAX(dt_abertura) AS dt_ultima_abertura,\\r\\n        COUNT(CASE WHEN status_conta = 'ATIVA' THEN 1 END) AS qtd_vinculos_ativos\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    GROUP BY\\r\\n        num_grupo, nr_cpf, nm_banco, cd_agencia, nr_conta\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n)\\r\\nSELECT\\r\\n    cc.num_grupo,\\r\\n    cc.nr_cpf,\\r\\n    cc.nm_banco,\\r\\n    cc.cd_agencia,\\r\\n    cc.nr_conta,\\r\\n    cc.qtd_cnpjs_usando_conta,\\r\\n    cc.qtd_vinculos,\\r\\n    cc.dt_primeira_abertura,\\r\\n    cc.dt_ultima_abertura,\\r\\n    cc.qtd_vinculos_ativos,\\r\\n    c.cnpj,\\r\\n    c.nm_responsavel,\\r\\n    c.tp_responsavel,\\r\\n    c.dt_inicio_responsavel,\\r\\n    c.dt_final_responsavel,\\r\\n    c.status_conta\\r\\nFROM\\r\\n    cpf_conta_count cc\\r\\nJOIN\\r\\n    gessimples.gei_ccs_contas c\\r\\n    ON cc.num_grupo = c.num_grupo\\r\\n    AND cc.nr_cpf = c.nr_cpf\\r\\n    AND cc.nm_banco = c.nm_banco\\r\\n    AND cc.cd_agencia = c.cd_agencia\\r\\n    AND cc.nr_conta = c.nr_conta;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 3: Identifica\\u00e7\\u00e3o de sobreposi\\u00e7\\u00e3o temporal de respons\\u00e1veis\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_sobreposicao_responsaveis;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_sobreposicao_responsaveis AS\\r\\nWITH periodos_responsavel AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nr_cpf,\\r\\n        cnpj,\\r\\n        nm_responsavel,\\r\\n        tp_responsavel,\\r\\n        dt_inicio_responsavel,\\r\\n        COALESCE(dt_final_responsavel, CURRENT_DATE()) AS dt_final_responsavel_adj\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    WHERE\\r\\n        dt_inicio_responsavel IS NOT NULL\\r\\n),\\r\\nsobreposicoes AS (\\r\\n    SELECT\\r\\n        p1.num_grupo,\\r\\n        p1.nr_cpf,\\r\\n        p1.cnpj AS cnpj1,\\r\\n        p2.cnpj AS cnpj2,\\r\\n        p1.nm_responsavel,\\r\\n        p1.dt_inicio_responsavel AS inicio1,\\r\\n        p1.dt_final_responsavel_adj AS fim1,\\r\\n        p2.dt_inicio_responsavel AS inicio2,\\r\\n        p2.dt_final_responsavel_adj AS fim2,\\r\\n        DATEDIFF(\\r\\n            LEAST(p1.dt_final_responsavel_adj, p2.dt_final_responsavel_adj),\\r\\n            GREATEST(p1.dt_inicio_responsavel, p2.dt_inicio_responsavel)\\r\\n        ) AS dias_sobreposicao\\r\\n    FROM\\r\\n        periodos_responsavel p1\\r\\n    JOIN\\r\\n        periodos_responsavel p2\\r\\n        ON p1.num_grupo = p2.num_grupo\\r\\n        AND p1.nr_cpf = p2.nr_cpf\\r\\n        AND p1.cnpj < p2.cnpj\\r\\n        AND p1.dt_inicio_responsavel < p2.dt_final_responsavel_adj\\r\\n        AND p2.dt_inicio_responsavel < p1.dt_final_responsavel_adj\\r\\n)\\r\\nSELECT\\r\\n    *\\r\\nFROM\\r\\n    sobreposicoes\\r\\nWHERE\\r\\n    dias_sobreposicao > 0;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 4: Padr\\u00f5es coordenados de abertura/encerramento de contas\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_padroes_coordenados;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_padroes_coordenados AS\\r\\nWITH janelas_abertura AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        dt_abertura,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_abertura,\\r\\n        COUNT(*) AS qtd_contas_abertura,\\r\\n        COUNT(DISTINCT nr_cpf) AS qtd_cpfs_distintos\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    WHERE\\r\\n        dt_abertura IS NOT NULL\\r\\n    GROUP BY\\r\\n        num_grupo, dt_abertura\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n),\\r\\njanelas_encerramento AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        dt_encerramento,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_encerramento,\\r\\n        COUNT(*) AS qtd_contas_encerramento,\\r\\n        COUNT(DISTINCT nr_cpf) AS qtd_cpfs_distintos\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    WHERE\\r\\n        dt_encerramento IS NOT NULL\\r\\n    GROUP BY\\r\\n        num_grupo, dt_encerramento\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n)\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    'ABERTURA' AS tipo_evento,\\r\\n    dt_abertura AS dt_evento,\\r\\n    qtd_cnpjs_abertura AS qtd_cnpjs,\\r\\n    qtd_contas_abertura AS qtd_contas,\\r\\n    qtd_cpfs_distintos\\r\\nFROM\\r\\n    janelas_abertura\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    'ENCERRAMENTO' AS tipo_evento,\\r\\n    dt_encerramento AS dt_evento,\\r\\n    qtd_cnpjs_encerramento AS qtd_cnpjs,\\r\\n    qtd_contas_encerramento AS qtd_contas,\\r\\n    qtd_cpfs_distintos\\r\\nFROM\\r\\n    janelas_encerramento\\r\\nORDER BY\\r\\n    num_grupo, dt_evento DESC;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 5: M\\u00e9tricas consolidadas por grupo (CORRIGIDO)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_metricas_grupo;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_metricas_grupo AS\\r\\nWITH total_contas_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(*) AS total_contas,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs_com_contas,\\r\\n        COUNT(DISTINCT nr_cpf) AS total_cpfs_responsaveis,\\r\\n        COUNT(DISTINCT CONCAT(\\r\\n            COALESCE(nm_banco, ''), '-', \\r\\n            CAST(COALESCE(cd_agencia, 0) AS STRING), '-', \\r\\n            CAST(COALESCE(nr_conta, 0) AS STRING)\\r\\n        )) AS total_contas_unicas,\\r\\n        COUNT(CASE WHEN status_conta = 'ATIVA' THEN 1 END) AS total_contas_ativas\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ncontas_compartilhadas AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT CONCAT(\\r\\n            COALESCE(nm_banco, ''), '-', \\r\\n            CAST(COALESCE(cd_agencia, 0) AS STRING), '-', \\r\\n            CAST(COALESCE(nr_conta, 0) AS STRING)\\r\\n        )) AS qtd_contas_compartilhadas,\\r\\n        COUNT(DISTINCT nr_cpf) AS qtd_cpfs_compartilhando,\\r\\n        SUM(qtd_cnpjs_usando_conta) AS soma_cnpjs_usando_contas,\\r\\n        MAX(qtd_cnpjs_usando_conta) AS max_cnpjs_por_conta,\\r\\n        SUM(CASE WHEN qtd_vinculos_ativos > 0 THEN 1 ELSE 0 END) AS qtd_contas_compartilhadas_ativas\\r\\n    FROM (\\r\\n        SELECT\\r\\n            num_grupo,\\r\\n            nr_cpf,\\r\\n            nm_banco,\\r\\n            cd_agencia,\\r\\n            nr_conta,\\r\\n            qtd_cnpjs_usando_conta,\\r\\n            qtd_vinculos_ativos\\r\\n        FROM\\r\\n            gessimples.gei_ccs_cpf_compartilhado\\r\\n        GROUP BY\\r\\n            num_grupo, nr_cpf, nm_banco, cd_agencia, nr_conta, \\r\\n            qtd_cnpjs_usando_conta, qtd_vinculos_ativos\\r\\n    ) t\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\nsobreposicoes_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(*) AS qtd_sobreposicoes_responsaveis,\\r\\n        SUM(dias_sobreposicao) AS total_dias_sobreposicao,\\r\\n        AVG(dias_sobreposicao) AS media_dias_sobreposicao,\\r\\n        MAX(dias_sobreposicao) AS max_dias_sobreposicao\\r\\n    FROM\\r\\n        gessimples.gei_ccs_sobreposicao_responsaveis\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\npadroes_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT CASE WHEN tipo_evento = 'ABERTURA' THEN dt_evento END) AS qtd_datas_abertura_coordenada,\\r\\n        COUNT(DISTINCT CASE WHEN tipo_evento = 'ENCERRAMENTO' THEN dt_evento END) AS qtd_datas_encerramento_coordenado,\\r\\n        SUM(CASE WHEN tipo_evento = 'ABERTURA' THEN qtd_cnpjs ELSE 0 END) AS total_cnpjs_abertura_coordenada,\\r\\n        SUM(CASE WHEN tipo_evento = 'ENCERRAMENTO' THEN qtd_cnpjs ELSE 0 END) AS total_cnpjs_encerramento_coordenado\\r\\n    FROM\\r\\n        gessimples.gei_ccs_padroes_coordenados\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ntotal_cnpjs_sistema AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs_grupo\\r\\n    FROM\\r\\n        gessimples.gei_cnpj\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n)\\r\\nSELECT\\r\\n    t.num_grupo,\\r\\n    ts.total_cnpjs_grupo,\\r\\n    t.total_contas,\\r\\n    t.total_cnpjs_com_contas,\\r\\n    t.total_cpfs_responsaveis,\\r\\n    t.total_contas_unicas,\\r\\n    t.total_contas_ativas,\\r\\n    COALESCE(cc.qtd_contas_compartilhadas, 0) AS qtd_contas_compartilhadas,\\r\\n    COALESCE(cc.qtd_cpfs_compartilhando, 0) AS qtd_cpfs_compartilhando,\\r\\n    COALESCE(cc.max_cnpjs_por_conta, 0) AS max_cnpjs_por_conta,\\r\\n    COALESCE(cc.qtd_contas_compartilhadas_ativas, 0) AS qtd_contas_compartilhadas_ativas,\\r\\n    COALESCE(s.qtd_sobreposicoes_responsaveis, 0) AS qtd_sobreposicoes_responsaveis,\\r\\n    COALESCE(s.total_dias_sobreposicao, 0) AS total_dias_sobreposicao,\\r\\n    COALESCE(s.media_dias_sobreposicao, 0) AS media_dias_sobreposicao,\\r\\n    COALESCE(s.max_dias_sobreposicao, 0) AS max_dias_sobreposicao,\\r\\n    COALESCE(p.qtd_datas_abertura_coordenada, 0) AS qtd_datas_abertura_coordenada,\\r\\n    COALESCE(p.qtd_datas_encerramento_coordenado, 0) AS qtd_datas_encerramento_coordenado,\\r\\n    COALESCE(p.total_cnpjs_abertura_coordenada, 0) AS total_cnpjs_abertura_coordenada,\\r\\n    COALESCE(p.total_cnpjs_encerramento_coordenado, 0) AS total_cnpjs_encerramento_coordenado,\\r\\n    -- Percentuais e \\u00edndices\\r\\n    CASE \\r\\n        WHEN t.total_contas_unicas > 0 THEN \\r\\n            ROUND(COALESCE(cc.qtd_contas_compartilhadas, 0) * 100.0 / t.total_contas_unicas, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_contas_compartilhadas,\\r\\n    CASE \\r\\n        WHEN ts.total_cnpjs_grupo > 0 THEN \\r\\n            ROUND(t.total_cnpjs_com_contas * 100.0 / ts.total_cnpjs_grupo, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_cnpjs_com_contas,\\r\\n    -- \\u00cdndice de risco CCS\\r\\n    ROUND(\\r\\n        (\\r\\n            -- Peso 40%: Propor\\u00e7\\u00e3o de contas compartilhadas\\r\\n            (CASE WHEN t.total_contas_unicas > 0 THEN \\r\\n                COALESCE(cc.qtd_contas_compartilhadas, 0) * 1.0 / t.total_contas_unicas \\r\\n            ELSE 0 END * 0.40) +\\r\\n            \\r\\n            -- Peso 30%: Intensidade do compartilhamento (max CNPJs por conta normalizado)\\r\\n            (CASE WHEN ts.total_cnpjs_grupo > 1 THEN \\r\\n                LEAST(COALESCE(cc.max_cnpjs_por_conta, 0) * 1.0 / ts.total_cnpjs_grupo, 1.0)\\r\\n            ELSE 0 END * 0.30) +\\r\\n            \\r\\n            -- Peso 20%: Sobreposi\\u00e7\\u00e3o de respons\\u00e1veis (normalizado por 365 dias)\\r\\n            (CASE WHEN COALESCE(s.media_dias_sobreposicao, 0) > 0 THEN \\r\\n                LEAST(s.media_dias_sobreposicao / 365.0, 1.0)\\r\\n            ELSE 0 END * 0.20) +\\r\\n            \\r\\n            -- Peso 10%: Padr\\u00f5es coordenados\\r\\n            (CASE WHEN ts.total_cnpjs_grupo > 1 THEN \\r\\n                LEAST((COALESCE(p.qtd_datas_abertura_coordenada, 0) + \\r\\n                       COALESCE(p.qtd_datas_encerramento_coordenado, 0)) * 1.0 / ts.total_cnpjs_grupo, 1.0)\\r\\n            ELSE 0 END * 0.10)\\r\\n        )\\r\\n    , 4) AS indice_risco_ccs\\r\\nFROM\\r\\n    total_contas_grupo t\\r\\nLEFT JOIN\\r\\n    total_cnpjs_sistema ts ON t.num_grupo = ts.num_grupo\\r\\nLEFT JOIN\\r\\n    contas_compartilhadas cc ON t.num_grupo = cc.num_grupo\\r\\nLEFT JOIN\\r\\n    sobreposicoes_grupo s ON t.num_grupo = s.num_grupo\\r\\nLEFT JOIN\\r\\n    padroes_grupo p ON t.num_grupo = p.num_grupo;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 6: Ranking de grupos por risco CCS\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_ranking_risco;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_ranking_risco AS\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    RANK() OVER(ORDER BY indice_risco_ccs DESC, qtd_contas_compartilhadas DESC) AS ranking_risco_ccs,\\r\\n    indice_risco_ccs,\\r\\n    total_cnpjs_grupo,\\r\\n    total_cnpjs_com_contas,\\r\\n    perc_cnpjs_com_contas,\\r\\n    total_contas_unicas,\\r\\n    qtd_contas_compartilhadas,\\r\\n    perc_contas_compartilhadas,\\r\\n    max_cnpjs_por_conta,\\r\\n    qtd_sobreposicoes_responsaveis,\\r\\n    media_dias_sobreposicao,\\r\\n    qtd_datas_abertura_coordenada,\\r\\n    qtd_datas_encerramento_coordenado,\\r\\n    CASE\\r\\n        WHEN indice_risco_ccs >= 0.50 THEN 'CR\\u00cdTICO'\\r\\n        WHEN indice_risco_ccs >= 0.30 THEN 'ALTO'\\r\\n        WHEN indice_risco_ccs >= 0.15 THEN 'M\\u00c9DIO'\\r\\n        WHEN indice_risco_ccs > 0 THEN 'BAIXO'\\r\\n        ELSE 'INEXISTENTE'\\r\\n    END AS nivel_risco_ccs\\r\\nFROM\\r\\n    gessimples.gei_ccs_metricas_grupo\\r\\nORDER BY\\r\\n    indice_risco_ccs DESC;\", \"statementsList\": [\"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_cpf_compartilhado AS\\r\\nWITH cpf_conta_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nr_cpf,\\r\\n        nm_banco,\\r\\n        cd_agencia,\\r\\n        nr_conta,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_usando_conta,\\r\\n        COUNT(*) AS qtd_vinculos,\\r\\n        MIN(dt_abertura) AS dt_primeira_abertura,\\r\\n        MAX(dt_abertura) AS dt_ultima_abertura,\\r\\n        COUNT(CASE WHEN status_conta = 'ATIVA' THEN 1 END) AS qtd_vinculos_ativos\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    GROUP BY\\r\\n        num_grupo, nr_cpf, nm_banco, cd_agencia, nr_conta\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n)\\r\\nSELECT\\r\\n    cc.num_grupo,\\r\\n    cc.nr_cpf,\\r\\n    cc.nm_banco,\\r\\n    cc.cd_agencia,\\r\\n    cc.nr_conta,\\r\\n    cc.qtd_cnpjs_usando_conta,\\r\\n    cc.qtd_vinculos,\\r\\n    cc.dt_primeira_abertura,\\r\\n    cc.dt_ultima_abertura,\\r\\n    cc.qtd_vinculos_ativos,\\r\\n    c.cnpj,\\r\\n    c.nm_responsavel,\\r\\n    c.tp_responsavel,\\r\\n    c.dt_inicio_responsavel,\\r\\n    c.dt_final_responsavel,\\r\\n    c.status_conta\\r\\nFROM\\r\\n    cpf_conta_count cc\\r\\nJOIN\\r\\n    gessimples.gei_ccs_contas c\\r\\n    ON cc.num_grupo = c.num_grupo\\r\\n    AND cc.nr_cpf = c.nr_cpf\\r\\n    AND cc.nm_banco = c.nm_banco\\r\\n    AND cc.cd_agencia = c.cd_agencia\\r\\n    AND cc.nr_conta = c.nr_conta;\", \"\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 3: Identifica\\u00e7\\u00e3o de sobreposi\\u00e7\\u00e3o temporal de respons\\u00e1veis\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_sobreposicao_responsaveis;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_sobreposicao_responsaveis AS\\r\\nWITH periodos_responsavel AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nr_cpf,\\r\\n        cnpj,\\r\\n        nm_responsavel,\\r\\n        tp_responsavel,\\r\\n        dt_inicio_responsavel,\\r\\n        COALESCE(dt_final_responsavel, CURRENT_DATE()) AS dt_final_responsavel_adj\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    WHERE\\r\\n        dt_inicio_responsavel IS NOT NULL\\r\\n),\\r\\nsobreposicoes AS (\\r\\n    SELECT\\r\\n        p1.num_grupo,\\r\\n        p1.nr_cpf,\\r\\n        p1.cnpj AS cnpj1,\\r\\n        p2.cnpj AS cnpj2,\\r\\n        p1.nm_responsavel,\\r\\n        p1.dt_inicio_responsavel AS inicio1,\\r\\n        p1.dt_final_responsavel_adj AS fim1,\\r\\n        p2.dt_inicio_responsavel AS inicio2,\\r\\n        p2.dt_final_responsavel_adj AS fim2,\\r\\n        DATEDIFF(\\r\\n            LEAST(p1.dt_final_responsavel_adj, p2.dt_final_responsavel_adj),\\r\\n            GREATEST(p1.dt_inicio_responsavel, p2.dt_inicio_responsavel)\\r\\n        ) AS dias_sobreposicao\\r\\n    FROM\\r\\n        periodos_responsavel p1\\r\\n    JOIN\\r\\n        periodos_responsavel p2\\r\\n        ON p1.num_grupo = p2.num_grupo\\r\\n        AND p1.nr_cpf = p2.nr_cpf\\r\\n        AND p1.cnpj < p2.cnpj\\r\\n        AND p1.dt_inicio_responsavel < p2.dt_final_responsavel_adj\\r\\n        AND p2.dt_inicio_responsavel < p1.dt_final_responsavel_adj\\r\\n)\\r\\nSELECT\\r\\n    *\\r\\nFROM\\r\\n    sobreposicoes\\r\\nWHERE\\r\\n    dias_sobreposicao > 0;\", \"\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 4: Padr\\u00f5es coordenados de abertura/encerramento de contas\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_padroes_coordenados;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_padroes_coordenados AS\\r\\nWITH janelas_abertura AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        dt_abertura,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_abertura,\\r\\n        COUNT(*) AS qtd_contas_abertura,\\r\\n        COUNT(DISTINCT nr_cpf) AS qtd_cpfs_distintos\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    WHERE\\r\\n        dt_abertura IS NOT NULL\\r\\n    GROUP BY\\r\\n        num_grupo, dt_abertura\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n),\\r\\njanelas_encerramento AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        dt_encerramento,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_encerramento,\\r\\n        COUNT(*) AS qtd_contas_encerramento,\\r\\n        COUNT(DISTINCT nr_cpf) AS qtd_cpfs_distintos\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    WHERE\\r\\n        dt_encerramento IS NOT NULL\\r\\n    GROUP BY\\r\\n        num_grupo, dt_encerramento\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n)\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    'ABERTURA' AS tipo_evento,\\r\\n    dt_abertura AS dt_evento,\\r\\n    qtd_cnpjs_abertura AS qtd_cnpjs,\\r\\n    qtd_contas_abertura AS qtd_contas,\\r\\n    qtd_cpfs_distintos\\r\\nFROM\\r\\n    janelas_abertura\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    'ENCERRAMENTO' AS tipo_evento,\\r\\n    dt_encerramento AS dt_evento,\\r\\n    qtd_cnpjs_encerramento AS qtd_cnpjs,\\r\\n    qtd_contas_encerramento AS qtd_contas,\\r\\n    qtd_cpfs_distintos\\r\\nFROM\\r\\n    janelas_encerramento\\r\\nORDER BY\\r\\n    num_grupo, dt_evento DESC;\", \"\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 5: M\\u00e9tricas consolidadas por grupo (CORRIGIDO)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_metricas_grupo;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_metricas_grupo AS\\r\\nWITH total_contas_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(*) AS total_contas,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs_com_contas,\\r\\n        COUNT(DISTINCT nr_cpf) AS total_cpfs_responsaveis,\\r\\n        COUNT(DISTINCT CONCAT(\\r\\n            COALESCE(nm_banco, ''), '-', \\r\\n            CAST(COALESCE(cd_agencia, 0) AS STRING), '-', \\r\\n            CAST(COALESCE(nr_conta, 0) AS STRING)\\r\\n        )) AS total_contas_unicas,\\r\\n        COUNT(CASE WHEN status_conta = 'ATIVA' THEN 1 END) AS total_contas_ativas\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ncontas_compartilhadas AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT CONCAT(\\r\\n            COALESCE(nm_banco, ''), '-', \\r\\n            CAST(COALESCE(cd_agencia, 0) AS STRING), '-', \\r\\n            CAST(COALESCE(nr_conta, 0) AS STRING)\\r\\n        )) AS qtd_contas_compartilhadas,\\r\\n        COUNT(DISTINCT nr_cpf) AS qtd_cpfs_compartilhando,\\r\\n        SUM(qtd_cnpjs_usando_conta) AS soma_cnpjs_usando_contas,\\r\\n        MAX(qtd_cnpjs_usando_conta) AS max_cnpjs_por_conta,\\r\\n        SUM(CASE WHEN qtd_vinculos_ativos > 0 THEN 1 ELSE 0 END) AS qtd_contas_compartilhadas_ativas\\r\\n    FROM (\\r\\n        SELECT\\r\\n            num_grupo,\\r\\n            nr_cpf,\\r\\n            nm_banco,\\r\\n            cd_agencia,\\r\\n            nr_conta,\\r\\n            qtd_cnpjs_usando_conta,\\r\\n            qtd_vinculos_ativos\\r\\n        FROM\\r\\n            gessimples.gei_ccs_cpf_compartilhado\\r\\n        GROUP BY\\r\\n            num_grupo, nr_cpf, nm_banco, cd_agencia, nr_conta, \\r\\n            qtd_cnpjs_usando_conta, qtd_vinculos_ativos\\r\\n    ) t\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\nsobreposicoes_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(*) AS qtd_sobreposicoes_responsaveis,\\r\\n        SUM(dias_sobreposicao) AS total_dias_sobreposicao,\\r\\n        AVG(dias_sobreposicao) AS media_dias_sobreposicao,\\r\\n        MAX(dias_sobreposicao) AS max_dias_sobreposicao\\r\\n    FROM\\r\\n        gessimples.gei_ccs_sobreposicao_responsaveis\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\npadroes_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT CASE WHEN tipo_evento = 'ABERTURA' THEN dt_evento END) AS qtd_datas_abertura_coordenada,\\r\\n        COUNT(DISTINCT CASE WHEN tipo_evento = 'ENCERRAMENTO' THEN dt_evento END) AS qtd_datas_encerramento_coordenado,\\r\\n        SUM(CASE WHEN tipo_evento = 'ABERTURA' THEN qtd_cnpjs ELSE 0 END) AS total_cnpjs_abertura_coordenada,\\r\\n        SUM(CASE WHEN tipo_evento = 'ENCERRAMENTO' THEN qtd_cnpjs ELSE 0 END) AS total_cnpjs_encerramento_coordenado\\r\\n    FROM\\r\\n        gessimples.gei_ccs_padroes_coordenados\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ntotal_cnpjs_sistema AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs_grupo\\r\\n    FROM\\r\\n        gessimples.gei_cnpj\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n)\\r\\nSELECT\\r\\n    t.num_grupo,\\r\\n    ts.total_cnpjs_grupo,\\r\\n    t.total_contas,\\r\\n    t.total_cnpjs_com_contas,\\r\\n    t.total_cpfs_responsaveis,\\r\\n    t.total_contas_unicas,\\r\\n    t.total_contas_ativas,\\r\\n    COALESCE(cc.qtd_contas_compartilhadas, 0) AS qtd_contas_compartilhadas,\\r\\n    COALESCE(cc.qtd_cpfs_compartilhando, 0) AS qtd_cpfs_compartilhando,\\r\\n    COALESCE(cc.max_cnpjs_por_conta, 0) AS max_cnpjs_por_conta,\\r\\n    COALESCE(cc.qtd_contas_compartilhadas_ativas, 0) AS qtd_contas_compartilhadas_ativas,\\r\\n    COALESCE(s.qtd_sobreposicoes_responsaveis, 0) AS qtd_sobreposicoes_responsaveis,\\r\\n    COALESCE(s.total_dias_sobreposicao, 0) AS total_dias_sobreposicao,\\r\\n    COALESCE(s.media_dias_sobreposicao, 0) AS media_dias_sobreposicao,\\r\\n    COALESCE(s.max_dias_sobreposicao, 0) AS max_dias_sobreposicao,\\r\\n    COALESCE(p.qtd_datas_abertura_coordenada, 0) AS qtd_datas_abertura_coordenada,\\r\\n    COALESCE(p.qtd_datas_encerramento_coordenado, 0) AS qtd_datas_encerramento_coordenado,\\r\\n    COALESCE(p.total_cnpjs_abertura_coordenada, 0) AS total_cnpjs_abertura_coordenada,\\r\\n    COALESCE(p.total_cnpjs_encerramento_coordenado, 0) AS total_cnpjs_encerramento_coordenado,\\r\\n    -- Percentuais e \\u00edndices\\r\\n    CASE \\r\\n        WHEN t.total_contas_unicas > 0 THEN \\r\\n            ROUND(COALESCE(cc.qtd_contas_compartilhadas, 0) * 100.0 / t.total_contas_unicas, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_contas_compartilhadas,\\r\\n    CASE \\r\\n        WHEN ts.total_cnpjs_grupo > 0 THEN \\r\\n            ROUND(t.total_cnpjs_com_contas * 100.0 / ts.total_cnpjs_grupo, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_cnpjs_com_contas,\\r\\n    -- \\u00cdndice de risco CCS\\r\\n    ROUND(\\r\\n        (\\r\\n            -- Peso 40%: Propor\\u00e7\\u00e3o de contas compartilhadas\\r\\n            (CASE WHEN t.total_contas_unicas > 0 THEN \\r\\n                COALESCE(cc.qtd_contas_compartilhadas, 0) * 1.0 / t.total_contas_unicas \\r\\n            ELSE 0 END * 0.40) +\\r\\n            \\r\\n            -- Peso 30%: Intensidade do compartilhamento (max CNPJs por conta normalizado)\\r\\n            (CASE WHEN ts.total_cnpjs_grupo > 1 THEN \\r\\n                LEAST(COALESCE(cc.max_cnpjs_por_conta, 0) * 1.0 / ts.total_cnpjs_grupo, 1.0)\\r\\n            ELSE 0 END * 0.30) +\\r\\n            \\r\\n            -- Peso 20%: Sobreposi\\u00e7\\u00e3o de respons\\u00e1veis (normalizado por 365 dias)\\r\\n            (CASE WHEN COALESCE(s.media_dias_sobreposicao, 0) > 0 THEN \\r\\n                LEAST(s.media_dias_sobreposicao / 365.0, 1.0)\\r\\n            ELSE 0 END * 0.20) +\\r\\n            \\r\\n            -- Peso 10%: Padr\\u00f5es coordenados\\r\\n            (CASE WHEN ts.total_cnpjs_grupo > 1 THEN \\r\\n                LEAST((COALESCE(p.qtd_datas_abertura_coordenada, 0) + \\r\\n                       COALESCE(p.qtd_datas_encerramento_coordenado, 0)) * 1.0 / ts.total_cnpjs_grupo, 1.0)\\r\\n            ELSE 0 END * 0.10)\\r\\n        )\\r\\n    , 4) AS indice_risco_ccs\\r\\nFROM\\r\\n    total_contas_grupo t\\r\\nLEFT JOIN\\r\\n    total_cnpjs_sistema ts ON t.num_grupo = ts.num_grupo\\r\\nLEFT JOIN\\r\\n    contas_compartilhadas cc ON t.num_grupo = cc.num_grupo\\r\\nLEFT JOIN\\r\\n    sobreposicoes_grupo s ON t.num_grupo = s.num_grupo\\r\\nLEFT JOIN\\r\\n    padroes_grupo p ON t.num_grupo = p.num_grupo;\", \"\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 6: Ranking de grupos por risco CCS\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_ranking_risco;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_ranking_risco AS\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    RANK() OVER(ORDER BY indice_risco_ccs DESC, qtd_contas_compartilhadas DESC) AS ranking_risco_ccs,\\r\\n    indice_risco_ccs,\\r\\n    total_cnpjs_grupo,\\r\\n    total_cnpjs_com_contas,\\r\\n    perc_cnpjs_com_contas,\\r\\n    total_contas_unicas,\\r\\n    qtd_contas_compartilhadas,\\r\\n    perc_contas_compartilhadas,\\r\\n    max_cnpjs_por_conta,\\r\\n    qtd_sobreposicoes_responsaveis,\\r\\n    media_dias_sobreposicao,\\r\\n    qtd_datas_abertura_coordenada,\\r\\n    qtd_datas_encerramento_coordenado,\\r\\n    CASE\\r\\n        WHEN indice_risco_ccs >= 0.50 THEN 'CR\\u00cdTICO'\\r\\n        WHEN indice_risco_ccs >= 0.30 THEN 'ALTO'\\r\\n        WHEN indice_risco_ccs >= 0.15 THEN 'M\\u00c9DIO'\\r\\n        WHEN indice_risco_ccs > 0 THEN 'BAIXO'\\r\\n        ELSE 'INEXISTENTE'\\r\\n    END AS nivel_risco_ccs\\r\\nFROM\\r\\n    gessimples.gei_ccs_metricas_grupo\\r\\nORDER BY\\r\\n    indice_risco_ccs DESC;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ========================================================================\\r\\n-- PARTE 1: Tabela base de contas banc\\u00e1rias do grupo\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_contas;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_contas AS\\r\\nSELECT\\r\\n    g.num_grupo,\\r\\n    g.cnpj,\\r\\n    c.nr_cpf,\\r\\n    c.nm_responsavel,\\r\\n    c.nm_banco,\\r\\n    c.dt_abertura,\\r\\n    c.dt_encerramento,\\r\\n    c.tp_conta,\\r\\n    c.cd_agencia,\\r\\n    c.nr_conta,\\r\\n    c.tp_responsavel,\\r\\n    c.dt_inicio_responsavel,\\r\\n    c.dt_final_responsavel,\\r\\n    c.cnpj_instituicao,\\r\\n    CASE \\r\\n        WHEN c.dt_encerramento IS NULL THEN 'ATIVA'\\r\\n        WHEN c.dt_encerramento >= DATE_SUB(CURRENT_DATE(), 365) THEN 'ENCERRADA_RECENTE'\\r\\n        ELSE 'ENCERRADA_ANTIGA'\\r\\n    END AS status_conta\\r\\nFROM \\r\\n    gessimples.gei_cnpj g\\r\\nJOIN \\r\\n    usr_sat_fsn.fsn_conta_bancaria c ON g.cnpj = c.nr_cnpj\\r\\nWHERE \\r\\n    (c.valido IS NULL OR c.valido = 1)\\r\\n    AND c.nr_cpf IS NOT NULL;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 2: Identifica\\u00e7\\u00e3o de CPFs compartilhando contas entre CNPJs do grupo\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_cpf_compartilhado;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_cpf_compartilhado AS\\r\\nWITH cpf_conta_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nr_cpf,\\r\\n        nm_banco,\\r\\n        cd_agencia,\\r\\n        nr_conta,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_usando_conta,\\r\\n        COUNT(*) AS qtd_vinculos,\\r\\n        MIN(dt_abertura) AS dt_primeira_abertura,\\r\\n        MAX(dt_abertura) AS dt_ultima_abertura,\\r\\n        COUNT(CASE WHEN status_conta = 'ATIVA' THEN 1 END) AS qtd_vinculos_ativos\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    GROUP BY\\r\\n        num_grupo, nr_cpf, nm_banco, cd_agencia, nr_conta\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n)\\r\\nSELECT\\r\\n    cc.num_grupo,\\r\\n    cc.nr_cpf,\\r\\n    cc.nm_banco,\\r\\n    cc.cd_agencia,\\r\\n    cc.nr_conta,\\r\\n    cc.qtd_cnpjs_usando_conta,\\r\\n    cc.qtd_vinculos,\\r\\n    cc.dt_primeira_abertura,\\r\\n    cc.dt_ultima_abertura,\\r\\n    cc.qtd_vinculos_ativos,\\r\\n    c.cnpj,\\r\\n    c.nm_responsavel,\\r\\n    c.tp_responsavel,\\r\\n    c.dt_inicio_responsavel,\\r\\n    c.dt_final_responsavel,\\r\\n    c.status_conta\\r\\nFROM\\r\\n    cpf_conta_count cc\\r\\nJOIN\\r\\n    gessimples.gei_ccs_contas c\\r\\n    ON cc.num_grupo = c.num_grupo\\r\\n    AND cc.nr_cpf = c.nr_cpf\\r\\n    AND cc.nm_banco = c.nm_banco\\r\\n    AND cc.cd_agencia = c.cd_agencia\\r\\n    AND cc.nr_conta = c.nr_conta;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 3: Identifica\\u00e7\\u00e3o de sobreposi\\u00e7\\u00e3o temporal de respons\\u00e1veis\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_sobreposicao_responsaveis;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_sobreposicao_responsaveis AS\\r\\nWITH periodos_responsavel AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nr_cpf,\\r\\n        cnpj,\\r\\n        nm_responsavel,\\r\\n        tp_responsavel,\\r\\n        dt_inicio_responsavel,\\r\\n        COALESCE(dt_final_responsavel, CURRENT_DATE()) AS dt_final_responsavel_adj\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    WHERE\\r\\n        dt_inicio_responsavel IS NOT NULL\\r\\n),\\r\\nsobreposicoes AS (\\r\\n    SELECT\\r\\n        p1.num_grupo,\\r\\n        p1.nr_cpf,\\r\\n        p1.cnpj AS cnpj1,\\r\\n        p2.cnpj AS cnpj2,\\r\\n        p1.nm_responsavel,\\r\\n        p1.dt_inicio_responsavel AS inicio1,\\r\\n        p1.dt_final_responsavel_adj AS fim1,\\r\\n        p2.dt_inicio_responsavel AS inicio2,\\r\\n        p2.dt_final_responsavel_adj AS fim2,\\r\\n        DATEDIFF(\\r\\n            LEAST(p1.dt_final_responsavel_adj, p2.dt_final_responsavel_adj),\\r\\n            GREATEST(p1.dt_inicio_responsavel, p2.dt_inicio_responsavel)\\r\\n        ) AS dias_sobreposicao\\r\\n    FROM\\r\\n        periodos_responsavel p1\\r\\n    JOIN\\r\\n        periodos_responsavel p2\\r\\n        ON p1.num_grupo = p2.num_grupo\\r\\n        AND p1.nr_cpf = p2.nr_cpf\\r\\n        AND p1.cnpj < p2.cnpj\\r\\n        AND p1.dt_inicio_responsavel < p2.dt_final_responsavel_adj\\r\\n        AND p2.dt_inicio_responsavel < p1.dt_final_responsavel_adj\\r\\n)\\r\\nSELECT\\r\\n    *\\r\\nFROM\\r\\n    sobreposicoes\\r\\nWHERE\\r\\n    dias_sobreposicao > 0;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 4: Padr\\u00f5es coordenados de abertura/encerramento de contas\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_padroes_coordenados;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_padroes_coordenados AS\\r\\nWITH janelas_abertura AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        dt_abertura,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_abertura,\\r\\n        COUNT(*) AS qtd_contas_abertura,\\r\\n        COUNT(DISTINCT nr_cpf) AS qtd_cpfs_distintos\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    WHERE\\r\\n        dt_abertura IS NOT NULL\\r\\n    GROUP BY\\r\\n        num_grupo, dt_abertura\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n),\\r\\njanelas_encerramento AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        dt_encerramento,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_encerramento,\\r\\n        COUNT(*) AS qtd_contas_encerramento,\\r\\n        COUNT(DISTINCT nr_cpf) AS qtd_cpfs_distintos\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    WHERE\\r\\n        dt_encerramento IS NOT NULL\\r\\n    GROUP BY\\r\\n        num_grupo, dt_encerramento\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n)\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    'ABERTURA' AS tipo_evento,\\r\\n    dt_abertura AS dt_evento,\\r\\n    qtd_cnpjs_abertura AS qtd_cnpjs,\\r\\n    qtd_contas_abertura AS qtd_contas,\\r\\n    qtd_cpfs_distintos\\r\\nFROM\\r\\n    janelas_abertura\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    'ENCERRAMENTO' AS tipo_evento,\\r\\n    dt_encerramento AS dt_evento,\\r\\n    qtd_cnpjs_encerramento AS qtd_cnpjs,\\r\\n    qtd_contas_encerramento AS qtd_contas,\\r\\n    qtd_cpfs_distintos\\r\\nFROM\\r\\n    janelas_encerramento\\r\\nORDER BY\\r\\n    num_grupo, dt_evento DESC;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 5: M\\u00e9tricas consolidadas por grupo (CORRIGIDO)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_metricas_grupo;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_metricas_grupo AS\\r\\nWITH total_contas_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(*) AS total_contas,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs_com_contas,\\r\\n        COUNT(DISTINCT nr_cpf) AS total_cpfs_responsaveis,\\r\\n        COUNT(DISTINCT CONCAT(\\r\\n            COALESCE(nm_banco, ''), '-', \\r\\n            CAST(COALESCE(cd_agencia, 0) AS STRING), '-', \\r\\n            CAST(COALESCE(nr_conta, 0) AS STRING)\\r\\n        )) AS total_contas_unicas,\\r\\n        COUNT(CASE WHEN status_conta = 'ATIVA' THEN 1 END) AS total_contas_ativas\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ncontas_compartilhadas AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT CONCAT(\\r\\n            COALESCE(nm_banco, ''), '-', \\r\\n            CAST(COALESCE(cd_agencia, 0) AS STRING), '-', \\r\\n            CAST(COALESCE(nr_conta, 0) AS STRING)\\r\\n        )) AS qtd_contas_compartilhadas,\\r\\n        COUNT(DISTINCT nr_cpf) AS qtd_cpfs_compartilhando,\\r\\n        SUM(qtd_cnpjs_usando_conta) AS soma_cnpjs_usando_contas,\\r\\n        MAX(qtd_cnpjs_usando_conta) AS max_cnpjs_por_conta,\\r\\n        SUM(CASE WHEN qtd_vinculos_ativos > 0 THEN 1 ELSE 0 END) AS qtd_contas_compartilhadas_ativas\\r\\n    FROM (\\r\\n        SELECT\\r\\n            num_grupo,\\r\\n            nr_cpf,\\r\\n            nm_banco,\\r\\n            cd_agencia,\\r\\n            nr_conta,\\r\\n            qtd_cnpjs_usando_conta,\\r\\n            qtd_vinculos_ativos\\r\\n        FROM\\r\\n            gessimples.gei_ccs_cpf_compartilhado\\r\\n        GROUP BY\\r\\n            num_grupo, nr_cpf, nm_banco, cd_agencia, nr_conta, \\r\\n            qtd_cnpjs_usando_conta, qtd_vinculos_ativos\\r\\n    ) t\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\nsobreposicoes_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(*) AS qtd_sobreposicoes_responsaveis,\\r\\n        SUM(dias_sobreposicao) AS total_dias_sobreposicao,\\r\\n        AVG(dias_sobreposicao) AS media_dias_sobreposicao,\\r\\n        MAX(dias_sobreposicao) AS max_dias_sobreposicao\\r\\n    FROM\\r\\n        gessimples.gei_ccs_sobreposicao_responsaveis\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\npadroes_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT CASE WHEN tipo_evento = 'ABERTURA' THEN dt_evento END) AS qtd_datas_abertura_coordenada,\\r\\n        COUNT(DISTINCT CASE WHEN tipo_evento = 'ENCERRAMENTO' THEN dt_evento END) AS qtd_datas_encerramento_coordenado,\\r\\n        SUM(CASE WHEN tipo_evento = 'ABERTURA' THEN qtd_cnpjs ELSE 0 END) AS total_cnpjs_abertura_coordenada,\\r\\n        SUM(CASE WHEN tipo_evento = 'ENCERRAMENTO' THEN qtd_cnpjs ELSE 0 END) AS total_cnpjs_encerramento_coordenado\\r\\n    FROM\\r\\n        gessimples.gei_ccs_padroes_coordenados\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ntotal_cnpjs_sistema AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs_grupo\\r\\n    FROM\\r\\n        gessimples.gei_cnpj\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n)\\r\\nSELECT\\r\\n    t.num_grupo,\\r\\n    ts.total_cnpjs_grupo,\\r\\n    t.total_contas,\\r\\n    t.total_cnpjs_com_contas,\\r\\n    t.total_cpfs_responsaveis,\\r\\n    t.total_contas_unicas,\\r\\n    t.total_contas_ativas,\\r\\n    COALESCE(cc.qtd_contas_compartilhadas, 0) AS qtd_contas_compartilhadas,\\r\\n    COALESCE(cc.qtd_cpfs_compartilhando, 0) AS qtd_cpfs_compartilhando,\\r\\n    COALESCE(cc.max_cnpjs_por_conta, 0) AS max_cnpjs_por_conta,\\r\\n    COALESCE(cc.qtd_contas_compartilhadas_ativas, 0) AS qtd_contas_compartilhadas_ativas,\\r\\n    COALESCE(s.qtd_sobreposicoes_responsaveis, 0) AS qtd_sobreposicoes_responsaveis,\\r\\n    COALESCE(s.total_dias_sobreposicao, 0) AS total_dias_sobreposicao,\\r\\n    COALESCE(s.media_dias_sobreposicao, 0) AS media_dias_sobreposicao,\\r\\n    COALESCE(s.max_dias_sobreposicao, 0) AS max_dias_sobreposicao,\\r\\n    COALESCE(p.qtd_datas_abertura_coordenada, 0) AS qtd_datas_abertura_coordenada,\\r\\n    COALESCE(p.qtd_datas_encerramento_coordenado, 0) AS qtd_datas_encerramento_coordenado,\\r\\n    COALESCE(p.total_cnpjs_abertura_coordenada, 0) AS total_cnpjs_abertura_coordenada,\\r\\n    COALESCE(p.total_cnpjs_encerramento_coordenado, 0) AS total_cnpjs_encerramento_coordenado,\\r\\n    -- Percentuais e \\u00edndices\\r\\n    CASE \\r\\n        WHEN t.total_contas_unicas > 0 THEN \\r\\n            ROUND(COALESCE(cc.qtd_contas_compartilhadas, 0) * 100.0 / t.total_contas_unicas, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_contas_compartilhadas,\\r\\n    CASE \\r\\n        WHEN ts.total_cnpjs_grupo > 0 THEN \\r\\n            ROUND(t.total_cnpjs_com_contas * 100.0 / ts.total_cnpjs_grupo, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_cnpjs_com_contas,\\r\\n    -- \\u00cdndice de risco CCS\\r\\n    ROUND(\\r\\n        (\\r\\n            -- Peso 40%: Propor\\u00e7\\u00e3o de contas compartilhadas\\r\\n            (CASE WHEN t.total_contas_unicas > 0 THEN \\r\\n                COALESCE(cc.qtd_contas_compartilhadas, 0) * 1.0 / t.total_contas_unicas \\r\\n            ELSE 0 END * 0.40) +\\r\\n            \\r\\n            -- Peso 30%: Intensidade do compartilhamento (max CNPJs por conta normalizado)\\r\\n            (CASE WHEN ts.total_cnpjs_grupo > 1 THEN \\r\\n                LEAST(COALESCE(cc.max_cnpjs_por_conta, 0) * 1.0 / ts.total_cnpjs_grupo, 1.0)\\r\\n            ELSE 0 END * 0.30) +\\r\\n            \\r\\n            -- Peso 20%: Sobreposi\\u00e7\\u00e3o de respons\\u00e1veis (normalizado por 365 dias)\\r\\n            (CASE WHEN COALESCE(s.media_dias_sobreposicao, 0) > 0 THEN \\r\\n                LEAST(s.media_dias_sobreposicao / 365.0, 1.0)\\r\\n            ELSE 0 END * 0.20) +\\r\\n            \\r\\n            -- Peso 10%: Padr\\u00f5es coordenados\\r\\n            (CASE WHEN ts.total_cnpjs_grupo > 1 THEN \\r\\n                LEAST((COALESCE(p.qtd_datas_abertura_coordenada, 0) + \\r\\n                       COALESCE(p.qtd_datas_encerramento_coordenado, 0)) * 1.0 / ts.total_cnpjs_grupo, 1.0)\\r\\n            ELSE 0 END * 0.10)\\r\\n        )\\r\\n    , 4) AS indice_risco_ccs\\r\\nFROM\\r\\n    total_contas_grupo t\\r\\nLEFT JOIN\\r\\n    total_cnpjs_sistema ts ON t.num_grupo = ts.num_grupo\\r\\nLEFT JOIN\\r\\n    contas_compartilhadas cc ON t.num_grupo = cc.num_grupo\\r\\nLEFT JOIN\\r\\n    sobreposicoes_grupo s ON t.num_grupo = s.num_grupo\\r\\nLEFT JOIN\\r\\n    padroes_grupo p ON t.num_grupo = p.num_grupo;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 6: Ranking de grupos por risco CCS\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_ranking_risco;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_ranking_risco AS\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    RANK() OVER(ORDER BY indice_risco_ccs DESC, qtd_contas_compartilhadas DESC) AS ranking_risco_ccs,\\r\\n    indice_risco_ccs,\\r\\n    total_cnpjs_grupo,\\r\\n    total_cnpjs_com_contas,\\r\\n    perc_cnpjs_com_contas,\\r\\n    total_contas_unicas,\\r\\n    qtd_contas_compartilhadas,\\r\\n    perc_contas_compartilhadas,\\r\\n    max_cnpjs_por_conta,\\r\\n    qtd_sobreposicoes_responsaveis,\\r\\n    media_dias_sobreposicao,\\r\\n    qtd_datas_abertura_coordenada,\\r\\n    qtd_datas_encerramento_coordenado,\\r\\n    CASE\\r\\n        WHEN indice_risco_ccs >= 0.50 THEN 'CR\\u00cdTICO'\\r\\n        WHEN indice_risco_ccs >= 0.30 THEN 'ALTO'\\r\\n        WHEN indice_risco_ccs >= 0.15 THEN 'M\\u00c9DIO'\\r\\n        WHEN indice_risco_ccs > 0 THEN 'BAIXO'\\r\\n        ELSE 'INEXISTENTE'\\r\\n    END AS nivel_risco_ccs\\r\\nFROM\\r\\n    gessimples.gei_ccs_metricas_grupo\\r\\nORDER BY\\r\\n    indice_risco_ccs DESC;\", \"result\": {\"id\": \"6e04b2b2-ce2b-6577-d850-92005ff51847\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"MHaLbAtpSJi/z+hw29I0Ug==\", \"guid\": \"G7FWDQzkR/oAAAAAi6K8tQ==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"3447f08c9e61b7c0:3ef3238e0d7f4285\", \"session_id\": 21242, \"session_type\": \"impala\", \"statement_id\": 17, \"has_more_statements\": false, \"statements_count\": 18, \"previous_statement_hash\": \"721340acbdf030104d4e0b3b019b2bc84e0735a1001761196d8097e2\", \"start\": {\"row\": 364, \"column\": 0}, \"end\": {\"row\": 390, \"column\": 25}, \"statement\": \"CREATE TABLE gessimples.gei_ccs_ranking_risco AS\\nSELECT\\n    num_grupo,\\n    RANK() OVER(ORDER BY indice_risco_ccs DESC, qtd_contas_compartilhadas DESC) AS ranking_risco_ccs,\\n    indice_risco_ccs,\\n    total_cnpjs_grupo,\\n    total_cnpjs_com_contas,\\n    perc_cnpjs_com_contas,\\n    total_contas_unicas,\\n    qtd_contas_compartilhadas,\\n    perc_contas_compartilhadas,\\n    max_cnpjs_por_conta,\\n    qtd_sobreposicoes_responsaveis,\\n    media_dias_sobreposicao,\\n    qtd_datas_abertura_coordenada,\\n    qtd_datas_encerramento_coordenado,\\n    CASE\\n        WHEN indice_risco_ccs >= 0.50 THEN 'CR\\u00cdTICO'\\n        WHEN indice_risco_ccs >= 0.30 THEN 'ALTO'\\n        WHEN indice_risco_ccs >= 0.15 THEN 'M\\u00c9DIO'\\n        WHEN indice_risco_ccs > 0 THEN 'BAIXO'\\n        ELSE 'INEXISTENTE'\\n    END AS nivel_risco_ccs\\nFROM\\n    gessimples.gei_ccs_metricas_grupo\\nORDER BY\\n    indice_risco_ccs DESC\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 17, \"statement_range\": {\"start\": {\"row\": 364, \"column\": 0}, \"end\": {\"row\": 390, \"column\": 25}}, \"statements_count\": 18, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"summary\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-10-06T18:20:15.130Z\", \"endTime\": \"2025-10-06T18:20:16.477Z\", \"executionTime\": 1347, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 9, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 5450, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"option\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 5524, \"getLogsTimeout\": 5586, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1759774814890, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- ========================================================================\\r\\n-- PARTE 1: Tabela base de contas banc\\u00e1rias do grupo\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_contas;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_contas AS\\r\\nSELECT\\r\\n    g.num_grupo,\\r\\n    g.cnpj,\\r\\n    c.nr_cpf,\\r\\n    c.nm_responsavel,\\r\\n    c.nm_banco,\\r\\n    c.dt_abertura,\\r\\n    c.dt_encerramento,\\r\\n    c.tp_conta,\\r\\n    c.cd_agencia,\\r\\n    c.nr_conta,\\r\\n    c.tp_responsavel,\\r\\n    c.dt_inicio_responsavel,\\r\\n    c.dt_final_responsavel,\\r\\n    c.cnpj_instituicao,\\r\\n    CASE \\r\\n        WHEN c.dt_encerramento IS NULL THEN 'ATIVA'\\r\\n        WHEN c.dt_encerramento >= DATE_SUB(CURRENT_DATE(), 365) THEN 'ENCERRADA_RECENTE'\\r\\n        ELSE 'ENCERRADA_ANTIGA'\\r\\n    END AS status_conta\\r\\nFROM \\r\\n    gessimples.gei_cnpj g\\r\\nJOIN \\r\\n    usr_sat_fsn.fsn_conta_bancaria c ON g.cnpj = c.nr_cnpj\\r\\nWHERE \\r\\n    (c.valido IS NULL OR c.valido = 1)\\r\\n    AND c.nr_cpf IS NOT NULL;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 2: Identifica\\u00e7\\u00e3o de CPFs compartilhando contas entre CNPJs do grupo\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_cpf_compartilhado;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_cpf_compartilhado AS\\r\\nWITH cpf_conta_count AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nr_cpf,\\r\\n        nm_banco,\\r\\n        cd_agencia,\\r\\n        nr_conta,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_usando_conta,\\r\\n        COUNT(*) AS qtd_vinculos,\\r\\n        MIN(dt_abertura) AS dt_primeira_abertura,\\r\\n        MAX(dt_abertura) AS dt_ultima_abertura,\\r\\n        COUNT(CASE WHEN status_conta = 'ATIVA' THEN 1 END) AS qtd_vinculos_ativos\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    GROUP BY\\r\\n        num_grupo, nr_cpf, nm_banco, cd_agencia, nr_conta\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n)\\r\\nSELECT\\r\\n    cc.num_grupo,\\r\\n    cc.nr_cpf,\\r\\n    cc.nm_banco,\\r\\n    cc.cd_agencia,\\r\\n    cc.nr_conta,\\r\\n    cc.qtd_cnpjs_usando_conta,\\r\\n    cc.qtd_vinculos,\\r\\n    cc.dt_primeira_abertura,\\r\\n    cc.dt_ultima_abertura,\\r\\n    cc.qtd_vinculos_ativos,\\r\\n    c.cnpj,\\r\\n    c.nm_responsavel,\\r\\n    c.tp_responsavel,\\r\\n    c.dt_inicio_responsavel,\\r\\n    c.dt_final_responsavel,\\r\\n    c.status_conta\\r\\nFROM\\r\\n    cpf_conta_count cc\\r\\nJOIN\\r\\n    gessimples.gei_ccs_contas c\\r\\n    ON cc.num_grupo = c.num_grupo\\r\\n    AND cc.nr_cpf = c.nr_cpf\\r\\n    AND cc.nm_banco = c.nm_banco\\r\\n    AND cc.cd_agencia = c.cd_agencia\\r\\n    AND cc.nr_conta = c.nr_conta;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 3: Identifica\\u00e7\\u00e3o de sobreposi\\u00e7\\u00e3o temporal de respons\\u00e1veis\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_sobreposicao_responsaveis;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_sobreposicao_responsaveis AS\\r\\nWITH periodos_responsavel AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        nr_cpf,\\r\\n        cnpj,\\r\\n        nm_responsavel,\\r\\n        tp_responsavel,\\r\\n        dt_inicio_responsavel,\\r\\n        COALESCE(dt_final_responsavel, CURRENT_DATE()) AS dt_final_responsavel_adj\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    WHERE\\r\\n        dt_inicio_responsavel IS NOT NULL\\r\\n),\\r\\nsobreposicoes AS (\\r\\n    SELECT\\r\\n        p1.num_grupo,\\r\\n        p1.nr_cpf,\\r\\n        p1.cnpj AS cnpj1,\\r\\n        p2.cnpj AS cnpj2,\\r\\n        p1.nm_responsavel,\\r\\n        p1.dt_inicio_responsavel AS inicio1,\\r\\n        p1.dt_final_responsavel_adj AS fim1,\\r\\n        p2.dt_inicio_responsavel AS inicio2,\\r\\n        p2.dt_final_responsavel_adj AS fim2,\\r\\n        DATEDIFF(\\r\\n            LEAST(p1.dt_final_responsavel_adj, p2.dt_final_responsavel_adj),\\r\\n            GREATEST(p1.dt_inicio_responsavel, p2.dt_inicio_responsavel)\\r\\n        ) AS dias_sobreposicao\\r\\n    FROM\\r\\n        periodos_responsavel p1\\r\\n    JOIN\\r\\n        periodos_responsavel p2\\r\\n        ON p1.num_grupo = p2.num_grupo\\r\\n        AND p1.nr_cpf = p2.nr_cpf\\r\\n        AND p1.cnpj < p2.cnpj\\r\\n        AND p1.dt_inicio_responsavel < p2.dt_final_responsavel_adj\\r\\n        AND p2.dt_inicio_responsavel < p1.dt_final_responsavel_adj\\r\\n)\\r\\nSELECT\\r\\n    *\\r\\nFROM\\r\\n    sobreposicoes\\r\\nWHERE\\r\\n    dias_sobreposicao > 0;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 4: Padr\\u00f5es coordenados de abertura/encerramento de contas\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_padroes_coordenados;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_padroes_coordenados AS\\r\\nWITH janelas_abertura AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        dt_abertura,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_abertura,\\r\\n        COUNT(*) AS qtd_contas_abertura,\\r\\n        COUNT(DISTINCT nr_cpf) AS qtd_cpfs_distintos\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    WHERE\\r\\n        dt_abertura IS NOT NULL\\r\\n    GROUP BY\\r\\n        num_grupo, dt_abertura\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n),\\r\\njanelas_encerramento AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        dt_encerramento,\\r\\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_encerramento,\\r\\n        COUNT(*) AS qtd_contas_encerramento,\\r\\n        COUNT(DISTINCT nr_cpf) AS qtd_cpfs_distintos\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    WHERE\\r\\n        dt_encerramento IS NOT NULL\\r\\n    GROUP BY\\r\\n        num_grupo, dt_encerramento\\r\\n    HAVING\\r\\n        COUNT(DISTINCT cnpj) > 1\\r\\n)\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    'ABERTURA' AS tipo_evento,\\r\\n    dt_abertura AS dt_evento,\\r\\n    qtd_cnpjs_abertura AS qtd_cnpjs,\\r\\n    qtd_contas_abertura AS qtd_contas,\\r\\n    qtd_cpfs_distintos\\r\\nFROM\\r\\n    janelas_abertura\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    'ENCERRAMENTO' AS tipo_evento,\\r\\n    dt_encerramento AS dt_evento,\\r\\n    qtd_cnpjs_encerramento AS qtd_cnpjs,\\r\\n    qtd_contas_encerramento AS qtd_contas,\\r\\n    qtd_cpfs_distintos\\r\\nFROM\\r\\n    janelas_encerramento\\r\\nORDER BY\\r\\n    num_grupo, dt_evento DESC;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 5: M\\u00e9tricas consolidadas por grupo (CORRIGIDO)\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_metricas_grupo;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_metricas_grupo AS\\r\\nWITH total_contas_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(*) AS total_contas,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs_com_contas,\\r\\n        COUNT(DISTINCT nr_cpf) AS total_cpfs_responsaveis,\\r\\n        COUNT(DISTINCT CONCAT(\\r\\n            COALESCE(nm_banco, ''), '-', \\r\\n            CAST(COALESCE(cd_agencia, 0) AS STRING), '-', \\r\\n            CAST(COALESCE(nr_conta, 0) AS STRING)\\r\\n        )) AS total_contas_unicas,\\r\\n        COUNT(CASE WHEN status_conta = 'ATIVA' THEN 1 END) AS total_contas_ativas\\r\\n    FROM\\r\\n        gessimples.gei_ccs_contas\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ncontas_compartilhadas AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT CONCAT(\\r\\n            COALESCE(nm_banco, ''), '-', \\r\\n            CAST(COALESCE(cd_agencia, 0) AS STRING), '-', \\r\\n            CAST(COALESCE(nr_conta, 0) AS STRING)\\r\\n        )) AS qtd_contas_compartilhadas,\\r\\n        COUNT(DISTINCT nr_cpf) AS qtd_cpfs_compartilhando,\\r\\n        SUM(qtd_cnpjs_usando_conta) AS soma_cnpjs_usando_contas,\\r\\n        MAX(qtd_cnpjs_usando_conta) AS max_cnpjs_por_conta,\\r\\n        SUM(CASE WHEN qtd_vinculos_ativos > 0 THEN 1 ELSE 0 END) AS qtd_contas_compartilhadas_ativas\\r\\n    FROM (\\r\\n        SELECT\\r\\n            num_grupo,\\r\\n            nr_cpf,\\r\\n            nm_banco,\\r\\n            cd_agencia,\\r\\n            nr_conta,\\r\\n            qtd_cnpjs_usando_conta,\\r\\n            qtd_vinculos_ativos\\r\\n        FROM\\r\\n            gessimples.gei_ccs_cpf_compartilhado\\r\\n        GROUP BY\\r\\n            num_grupo, nr_cpf, nm_banco, cd_agencia, nr_conta, \\r\\n            qtd_cnpjs_usando_conta, qtd_vinculos_ativos\\r\\n    ) t\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\nsobreposicoes_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(*) AS qtd_sobreposicoes_responsaveis,\\r\\n        SUM(dias_sobreposicao) AS total_dias_sobreposicao,\\r\\n        AVG(dias_sobreposicao) AS media_dias_sobreposicao,\\r\\n        MAX(dias_sobreposicao) AS max_dias_sobreposicao\\r\\n    FROM\\r\\n        gessimples.gei_ccs_sobreposicao_responsaveis\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\npadroes_grupo AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT CASE WHEN tipo_evento = 'ABERTURA' THEN dt_evento END) AS qtd_datas_abertura_coordenada,\\r\\n        COUNT(DISTINCT CASE WHEN tipo_evento = 'ENCERRAMENTO' THEN dt_evento END) AS qtd_datas_encerramento_coordenado,\\r\\n        SUM(CASE WHEN tipo_evento = 'ABERTURA' THEN qtd_cnpjs ELSE 0 END) AS total_cnpjs_abertura_coordenada,\\r\\n        SUM(CASE WHEN tipo_evento = 'ENCERRAMENTO' THEN qtd_cnpjs ELSE 0 END) AS total_cnpjs_encerramento_coordenado\\r\\n    FROM\\r\\n        gessimples.gei_ccs_padroes_coordenados\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n),\\r\\ntotal_cnpjs_sistema AS (\\r\\n    SELECT\\r\\n        num_grupo,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpjs_grupo\\r\\n    FROM\\r\\n        gessimples.gei_cnpj\\r\\n    GROUP BY\\r\\n        num_grupo\\r\\n)\\r\\nSELECT\\r\\n    t.num_grupo,\\r\\n    ts.total_cnpjs_grupo,\\r\\n    t.total_contas,\\r\\n    t.total_cnpjs_com_contas,\\r\\n    t.total_cpfs_responsaveis,\\r\\n    t.total_contas_unicas,\\r\\n    t.total_contas_ativas,\\r\\n    COALESCE(cc.qtd_contas_compartilhadas, 0) AS qtd_contas_compartilhadas,\\r\\n    COALESCE(cc.qtd_cpfs_compartilhando, 0) AS qtd_cpfs_compartilhando,\\r\\n    COALESCE(cc.max_cnpjs_por_conta, 0) AS max_cnpjs_por_conta,\\r\\n    COALESCE(cc.qtd_contas_compartilhadas_ativas, 0) AS qtd_contas_compartilhadas_ativas,\\r\\n    COALESCE(s.qtd_sobreposicoes_responsaveis, 0) AS qtd_sobreposicoes_responsaveis,\\r\\n    COALESCE(s.total_dias_sobreposicao, 0) AS total_dias_sobreposicao,\\r\\n    COALESCE(s.media_dias_sobreposicao, 0) AS media_dias_sobreposicao,\\r\\n    COALESCE(s.max_dias_sobreposicao, 0) AS max_dias_sobreposicao,\\r\\n    COALESCE(p.qtd_datas_abertura_coordenada, 0) AS qtd_datas_abertura_coordenada,\\r\\n    COALESCE(p.qtd_datas_encerramento_coordenado, 0) AS qtd_datas_encerramento_coordenado,\\r\\n    COALESCE(p.total_cnpjs_abertura_coordenada, 0) AS total_cnpjs_abertura_coordenada,\\r\\n    COALESCE(p.total_cnpjs_encerramento_coordenado, 0) AS total_cnpjs_encerramento_coordenado,\\r\\n    -- Percentuais e \\u00edndices\\r\\n    CASE \\r\\n        WHEN t.total_contas_unicas > 0 THEN \\r\\n            ROUND(COALESCE(cc.qtd_contas_compartilhadas, 0) * 100.0 / t.total_contas_unicas, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_contas_compartilhadas,\\r\\n    CASE \\r\\n        WHEN ts.total_cnpjs_grupo > 0 THEN \\r\\n            ROUND(t.total_cnpjs_com_contas * 100.0 / ts.total_cnpjs_grupo, 2)\\r\\n        ELSE 0\\r\\n    END AS perc_cnpjs_com_contas,\\r\\n    -- \\u00cdndice de risco CCS\\r\\n    ROUND(\\r\\n        (\\r\\n            -- Peso 40%: Propor\\u00e7\\u00e3o de contas compartilhadas\\r\\n            (CASE WHEN t.total_contas_unicas > 0 THEN \\r\\n                COALESCE(cc.qtd_contas_compartilhadas, 0) * 1.0 / t.total_contas_unicas \\r\\n            ELSE 0 END * 0.40) +\\r\\n            \\r\\n            -- Peso 30%: Intensidade do compartilhamento (max CNPJs por conta normalizado)\\r\\n            (CASE WHEN ts.total_cnpjs_grupo > 1 THEN \\r\\n                LEAST(COALESCE(cc.max_cnpjs_por_conta, 0) * 1.0 / ts.total_cnpjs_grupo, 1.0)\\r\\n            ELSE 0 END * 0.30) +\\r\\n            \\r\\n            -- Peso 20%: Sobreposi\\u00e7\\u00e3o de respons\\u00e1veis (normalizado por 365 dias)\\r\\n            (CASE WHEN COALESCE(s.media_dias_sobreposicao, 0) > 0 THEN \\r\\n                LEAST(s.media_dias_sobreposicao / 365.0, 1.0)\\r\\n            ELSE 0 END * 0.20) +\\r\\n            \\r\\n            -- Peso 10%: Padr\\u00f5es coordenados\\r\\n            (CASE WHEN ts.total_cnpjs_grupo > 1 THEN \\r\\n                LEAST((COALESCE(p.qtd_datas_abertura_coordenada, 0) + \\r\\n                       COALESCE(p.qtd_datas_encerramento_coordenado, 0)) * 1.0 / ts.total_cnpjs_grupo, 1.0)\\r\\n            ELSE 0 END * 0.10)\\r\\n        )\\r\\n    , 4) AS indice_risco_ccs\\r\\nFROM\\r\\n    total_contas_grupo t\\r\\nLEFT JOIN\\r\\n    total_cnpjs_sistema ts ON t.num_grupo = ts.num_grupo\\r\\nLEFT JOIN\\r\\n    contas_compartilhadas cc ON t.num_grupo = cc.num_grupo\\r\\nLEFT JOIN\\r\\n    sobreposicoes_grupo s ON t.num_grupo = s.num_grupo\\r\\nLEFT JOIN\\r\\n    padroes_grupo p ON t.num_grupo = p.num_grupo;\\r\\n\\r\\n-- ========================================================================\\r\\n-- PARTE 6: Ranking de grupos por risco CCS\\r\\n-- ========================================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_ccs_ranking_risco;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_ccs_ranking_risco AS\\r\\nSELECT\\r\\n    num_grupo,\\r\\n    RANK() OVER(ORDER BY indice_risco_ccs DESC, qtd_contas_compartilhadas DESC) AS ranking_risco_ccs,\\r\\n    indice_risco_ccs,\\r\\n    total_cnpjs_grupo,\\r\\n    total_cnpjs_com_contas,\\r\\n    perc_cnpjs_com_contas,\\r\\n    total_contas_unicas,\\r\\n    qtd_contas_compartilhadas,\\r\\n    perc_contas_compartilhadas,\\r\\n    max_cnpjs_por_conta,\\r\\n    qtd_sobreposicoes_responsaveis,\\r\\n    media_dias_sobreposicao,\\r\\n    qtd_datas_abertura_coordenada,\\r\\n    qtd_datas_encerramento_coordenado,\\r\\n    CASE\\r\\n        WHEN indice_risco_ccs >= 0.50 THEN 'CR\\u00cdTICO'\\r\\n        WHEN indice_risco_ccs >= 0.30 THEN 'ALTO'\\r\\n        WHEN indice_risco_ccs >= 0.15 THEN 'M\\u00c9DIO'\\r\\n        WHEN indice_risco_ccs > 0 THEN 'BAIXO'\\r\\n        ELSE 'INEXISTENTE'\\r\\n    END AS nivel_risco_ccs\\r\\nFROM\\r\\n    gessimples.gei_ccs_metricas_grupo\\r\\nORDER BY\\r\\n    indice_risco_ccs DESC;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 390, \"column\": 26}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query fa47e40c0d56b11b:b5bca28b00000000 100% Complete (1 out of 1)\\\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY indice_risco_ccs DESC.\\\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"fa47e40c0d56b11b:b5bca28b00000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=fa47e40c0d56b11b:b5bca28b00000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query fa47e40c0d56b11b:b5bca28b00000000 100% Complete (1 out of 1)\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY indice_risco_ccs DESC.\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\", \"progress\": 100, \"jobs\": [{\"name\": \"fa47e40c0d56b11b:b5bca28b00000000\", \"url\": \"/hue/jobbrowser#!id=fa47e40c0d56b11b:b5bca28b00000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 11292, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 102, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ========================================================================\r\n-- PARTE 1: Tabela base de contas bancÃ¡rias do grupo\r\n-- ========================================================================\r\nDROP TABLE IF EXISTS gessimples.gei_ccs_contas;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_ccs_contas AS\r\nSELECT\r\n    g.num_grupo,\r\n    g.cnpj,\r\n    c.nr_cpf,\r\n    c.nm_responsavel,\r\n    c.nm_banco,\r\n    c.dt_abertura,\r\n    c.dt_encerramento,\r\n    c.tp_conta,\r\n    c.cd_agencia,\r\n    c.nr_conta,\r\n    c.tp_responsavel,\r\n    c.dt_inicio_responsavel,\r\n    c.dt_final_responsavel,\r\n    c.cnpj_instituicao,\r\n    CASE \r\n        WHEN c.dt_encerramento IS NULL THEN 'ATIVA'\r\n        WHEN c.dt_encerramento >= DATE_SUB(CURRENT_DATE(), 365) THEN 'ENCERRADA_RECENTE'\r\n        ELSE 'ENCERRADA_ANTIGA'\r\n    END AS status_conta\r\nFROM \r\n    gessimples.gei_cnpj g\r\nJOIN \r\n    usr_sat_fsn.fsn_conta_bancaria c ON g.cnpj = c.nr_cnpj\r\nWHERE \r\n    (c.valido IS NULL OR c.valido = 1)\r\n    AND c.nr_cpf IS NOT NULL;\r\n\r\n-- ========================================================================\r\n-- PARTE 2: IdentificaÃ§Ã£o de CPFs compartilhando contas entre CNPJs do grupo\r\n-- ========================================================================\r\nDROP TABLE IF EXISTS gessimples.gei_ccs_cpf_compartilhado;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_ccs_cpf_compartilhado AS\r\nWITH cpf_conta_count AS (\r\n    SELECT\r\n        num_grupo,\r\n        nr_cpf,\r\n        nm_banco,\r\n        cd_agencia,\r\n        nr_conta,\r\n        COUNT(DISTINCT cnpj) AS qtd_cnpjs_usando_conta,\r\n        COUNT(*) AS qtd_vinculos,\r\n        MIN(dt_abertura) AS dt_primeira_abertura,\r\n        MAX(dt_abertura) AS dt_ultima_abertura,\r\n        COUNT(CASE WHEN status_conta = 'ATIVA' THEN 1 END) AS qtd_vinculos_ativos\r\n    FROM\r\n        gessimples.gei_ccs_contas\r\n    GROUP BY\r\n        num_grupo, nr_cpf, nm_banco, cd_agencia, nr_conta\r\n    HAVING\r\n        COUNT(DISTINCT cnpj) > 1\r\n)\r\nSELECT\r\n    cc.num_gr",
    "last_modified": "2025-10-06T15:26:28.585",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 178233,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: CNPJ CCS",
    "description": "",
    "uuid": "b92fad1a-f1a7-e4df-a851-31e47e8e3ef5",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 178233, \"uuid\": \"b92fad1a-f1a7-e4df-a851-31e47e8e3ef5\", \"name\": \"GEI: CNPJ CCS\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"0b48a187-d014-7b7b-466a-370b19069224\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 128, \"column\": 90}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- =====================================================\\r\\n-- C\\u00d3DIGO FINAL - GRUPOS ECON\\u00d4MICOS SEM DUPLICATAS\\r\\n-- Cada CNPJ aparece em apenas UM grupo\\r\\n-- =====================================================\\r\\n\\r\\n-- PASSO 1: Recriar a tabela ccs_grupos_sc (c\\u00f3digo original mantido)\\r\\nDROP TABLE IF EXISTS gessimples.ccs_grupos_sc;\\r\\n\\r\\nCREATE TABLE gessimples.ccs_grupos_sc AS\\r\\nWITH base_sc AS (\\r\\n    SELECT DISTINCT\\r\\n        b.nr_cpf,\\r\\n        b.nr_cnpj\\r\\n    FROM\\r\\n        usr_sat_fsn.fsn_conta_bancaria b\\r\\n    INNER JOIN\\r\\n        usr_sat_ods.vw_ods_contrib info ON b.nr_cnpj = info.nu_cnpj\\r\\n    WHERE\\r\\n        (b.valido IS NULL OR b.valido = 1)\\r\\n        AND b.nr_cpf IS NOT NULL\\r\\n),\\r\\ncpfs_formam_grupos_sc AS (\\r\\n    SELECT\\r\\n        nr_cpf\\r\\n    FROM\\r\\n        base_sc\\r\\n    GROUP BY\\r\\n        nr_cpf\\r\\n    HAVING\\r\\n        COUNT(DISTINCT SUBSTR(nr_cnpj, 1, 8)) > 1\\r\\n),\\r\\ndados_enriquecidos_sc AS (\\r\\n    SELECT\\r\\n        g.nr_cpf,\\r\\n        g.nr_cnpj,\\r\\n        info.nm_razao_social,\\r\\n        info.nm_ges,\\r\\n        info.cd_cnae,\\r\\n        info.de_cnae,\\r\\n        info.nm_sit_cadastral,\\r\\n        info.nm_reg_apuracao\\r\\n    FROM\\r\\n        base_sc g\\r\\n    INNER JOIN\\r\\n        cpfs_formam_grupos_sc c ON g.nr_cpf = c.nr_cpf\\r\\n    INNER JOIN\\r\\n        usr_sat_ods.vw_ods_contrib info ON g.nr_cnpj = info.nu_cnpj\\r\\n),\\r\\ndados_com_contagem_e_flags AS (\\r\\n    SELECT\\r\\n        *,\\r\\n        DENSE_RANK() OVER (ORDER BY nr_cpf) AS nm_grupo,\\r\\n        COUNT(nr_cnpj) OVER (PARTITION BY nr_cpf) AS qtd_cnpj_grupo,\\r\\n        COUNT(CASE WHEN nm_reg_apuracao = 'SIMPLES NACIONAL' THEN 1 END) OVER (PARTITION BY nr_cpf) as flag_simples_nacional\\r\\n    FROM\\r\\n        dados_enriquecidos_sc\\r\\n)\\r\\nSELECT\\r\\n    nm_grupo,\\r\\n    nr_cpf,\\r\\n    qtd_cnpj_grupo,\\r\\n    nr_cnpj,\\r\\n    nm_razao_social,\\r\\n    nm_ges,\\r\\n    cd_cnae,\\r\\n    de_cnae,\\r\\n    nm_sit_cadastral,\\r\\n    nm_reg_apuracao\\r\\nFROM\\r\\n    dados_com_contagem_e_flags\\r\\nWHERE\\r\\n    flag_simples_nacional > 0\\r\\nORDER BY\\r\\n    nm_grupo, nr_cpf, nr_cnpj;\\r\\n\\r\\n\\r\\n-- PASSO 2: Criar tabela gei_cnpj SEM DUPLICATAS\\r\\nDROP TABLE IF EXISTS gessimples.gei_cnpj;\\r\\n\\r\\nCREATE TABLE gessimples.gei_cnpj AS\\r\\nWITH grupos_qualificados AS (\\r\\n    SELECT\\r\\n        nm_grupo\\r\\n    FROM\\r\\n        gessimples.ccs_grupos_sc\\r\\n    GROUP BY\\r\\n        nm_grupo\\r\\n    HAVING\\r\\n        (COUNT(DISTINCT nm_sit_cadastral) = 1 AND MIN(nm_sit_cadastral) = 'ATIVO')\\r\\n        AND\\r\\n        (COUNT(DISTINCT cd_cnae) = 1)\\r\\n),\\r\\nbase_filtrada AS (\\r\\n    SELECT\\r\\n        CAST(nm_grupo AS STRING) AS num_grupo,\\r\\n        nr_cnpj AS cnpj\\r\\n    FROM\\r\\n        gessimples.ccs_grupos_sc\\r\\n    WHERE\\r\\n        nm_grupo IN (SELECT nm_grupo FROM grupos_qualificados)\\r\\n),\\r\\n-- NOVO: Atribuir cada CNPJ ao grupo de MENOR n\\u00famero\\r\\ncnpj_grupo_unico AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        MIN(CAST(num_grupo AS INT)) AS grupo_menor\\r\\n    FROM\\r\\n        base_filtrada\\r\\n    GROUP BY\\r\\n        cnpj\\r\\n)\\r\\nSELECT\\r\\n    CAST(c.grupo_menor AS STRING) AS num_grupo,\\r\\n    c.cnpj\\r\\nFROM\\r\\n    cnpj_grupo_unico c\\r\\nORDER BY\\r\\n    c.grupo_menor, c.cnpj;\\r\\n\\r\\n\\r\\n-- PASSO 3: Valida\\u00e7\\u00e3o - Confirmar que n\\u00e3o h\\u00e1 duplicatas\\r\\nSELECT \\r\\n   'Total CNPJs' as metrica, COUNT(*) as valor FROM gessimples.gei_cnpj\\r\\nUNION ALL\\r\\nSELECT \\r\\n   'CNPJs \\u00fanicos' as metrica, COUNT(DISTINCT cnpj) as valor FROM gessimples.gei_cnpj\\r\\nUNION ALL\\r\\nSELECT \\r\\n   'Total grupos' as metrica, COUNT(DISTINCT num_grupo) as valor FROM gessimples.gei_cnpj;\", \"statementsList\": [\"-- =====================================================\\r\\n-- C\\u00d3DIGO FINAL - GRUPOS ECON\\u00d4MICOS SEM DUPLICATAS\\r\\n-- Cada CNPJ aparece em apenas UM grupo\\r\\n-- =====================================================\\r\\n\\r\\n-- PASSO 1: Recriar a tabela ccs_grupos_sc (c\\u00f3digo original mantido)\\r\\nDROP TABLE IF EXISTS gessimples.ccs_grupos_sc;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.ccs_grupos_sc AS\\r\\nWITH base_sc AS (\\r\\n    SELECT DISTINCT\\r\\n        b.nr_cpf,\\r\\n        b.nr_cnpj\\r\\n    FROM\\r\\n        usr_sat_fsn.fsn_conta_bancaria b\\r\\n    INNER JOIN\\r\\n        usr_sat_ods.vw_ods_contrib info ON b.nr_cnpj = info.nu_cnpj\\r\\n    WHERE\\r\\n        (b.valido IS NULL OR b.valido = 1)\\r\\n        AND b.nr_cpf IS NOT NULL\\r\\n),\\r\\ncpfs_formam_grupos_sc AS (\\r\\n    SELECT\\r\\n        nr_cpf\\r\\n    FROM\\r\\n        base_sc\\r\\n    GROUP BY\\r\\n        nr_cpf\\r\\n    HAVING\\r\\n        COUNT(DISTINCT SUBSTR(nr_cnpj, 1, 8)) > 1\\r\\n),\\r\\ndados_enriquecidos_sc AS (\\r\\n    SELECT\\r\\n        g.nr_cpf,\\r\\n        g.nr_cnpj,\\r\\n        info.nm_razao_social,\\r\\n        info.nm_ges,\\r\\n        info.cd_cnae,\\r\\n        info.de_cnae,\\r\\n        info.nm_sit_cadastral,\\r\\n        info.nm_reg_apuracao\\r\\n    FROM\\r\\n        base_sc g\\r\\n    INNER JOIN\\r\\n        cpfs_formam_grupos_sc c ON g.nr_cpf = c.nr_cpf\\r\\n    INNER JOIN\\r\\n        usr_sat_ods.vw_ods_contrib info ON g.nr_cnpj = info.nu_cnpj\\r\\n),\\r\\ndados_com_contagem_e_flags AS (\\r\\n    SELECT\\r\\n        *,\\r\\n        DENSE_RANK() OVER (ORDER BY nr_cpf) AS nm_grupo,\\r\\n        COUNT(nr_cnpj) OVER (PARTITION BY nr_cpf) AS qtd_cnpj_grupo,\\r\\n        COUNT(CASE WHEN nm_reg_apuracao = 'SIMPLES NACIONAL' THEN 1 END) OVER (PARTITION BY nr_cpf) as flag_simples_nacional\\r\\n    FROM\\r\\n        dados_enriquecidos_sc\\r\\n)\\r\\nSELECT\\r\\n    nm_grupo,\\r\\n    nr_cpf,\\r\\n    qtd_cnpj_grupo,\\r\\n    nr_cnpj,\\r\\n    nm_razao_social,\\r\\n    nm_ges,\\r\\n    cd_cnae,\\r\\n    de_cnae,\\r\\n    nm_sit_cadastral,\\r\\n    nm_reg_apuracao\\r\\nFROM\\r\\n    dados_com_contagem_e_flags\\r\\nWHERE\\r\\n    flag_simples_nacional > 0\\r\\nORDER BY\\r\\n    nm_grupo, nr_cpf, nr_cnpj;\", \"\\r\\n\\r\\n\\r\\n-- PASSO 2: Criar tabela gei_cnpj SEM DUPLICATAS\\r\\nDROP TABLE IF EXISTS gessimples.gei_cnpj;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_cnpj AS\\r\\nWITH grupos_qualificados AS (\\r\\n    SELECT\\r\\n        nm_grupo\\r\\n    FROM\\r\\n        gessimples.ccs_grupos_sc\\r\\n    GROUP BY\\r\\n        nm_grupo\\r\\n    HAVING\\r\\n        (COUNT(DISTINCT nm_sit_cadastral) = 1 AND MIN(nm_sit_cadastral) = 'ATIVO')\\r\\n        AND\\r\\n        (COUNT(DISTINCT cd_cnae) = 1)\\r\\n),\\r\\nbase_filtrada AS (\\r\\n    SELECT\\r\\n        CAST(nm_grupo AS STRING) AS num_grupo,\\r\\n        nr_cnpj AS cnpj\\r\\n    FROM\\r\\n        gessimples.ccs_grupos_sc\\r\\n    WHERE\\r\\n        nm_grupo IN (SELECT nm_grupo FROM grupos_qualificados)\\r\\n),\\r\\n-- NOVO: Atribuir cada CNPJ ao grupo de MENOR n\\u00famero\\r\\ncnpj_grupo_unico AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        MIN(CAST(num_grupo AS INT)) AS grupo_menor\\r\\n    FROM\\r\\n        base_filtrada\\r\\n    GROUP BY\\r\\n        cnpj\\r\\n)\\r\\nSELECT\\r\\n    CAST(c.grupo_menor AS STRING) AS num_grupo,\\r\\n    c.cnpj\\r\\nFROM\\r\\n    cnpj_grupo_unico c\\r\\nORDER BY\\r\\n    c.grupo_menor, c.cnpj;\", \"\\r\\n\\r\\n\\r\\n-- PASSO 3: Valida\\u00e7\\u00e3o - Confirmar que n\\u00e3o h\\u00e1 duplicatas\\r\\nSELECT \\r\\n   'Total CNPJs' as metrica, COUNT(*) as valor FROM gessimples.gei_cnpj\\r\\nUNION ALL\\r\\nSELECT \\r\\n   'CNPJs \\u00fanicos' as metrica, COUNT(DISTINCT cnpj) as valor FROM gessimples.gei_cnpj\\r\\nUNION ALL\\r\\nSELECT \\r\\n   'Total grupos' as metrica, COUNT(DISTINCT num_grupo) as valor FROM gessimples.gei_cnpj;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- =====================================================\\r\\n-- C\\u00d3DIGO FINAL - GRUPOS ECON\\u00d4MICOS SEM DUPLICATAS\\r\\n-- Cada CNPJ aparece em apenas UM grupo\\r\\n-- =====================================================\\r\\n\\r\\n-- PASSO 1: Recriar a tabela ccs_grupos_sc (c\\u00f3digo original mantido)\\r\\nDROP TABLE IF EXISTS gessimples.ccs_grupos_sc;\\r\\n\\r\\nCREATE TABLE gessimples.ccs_grupos_sc AS\\r\\nWITH base_sc AS (\\r\\n    SELECT DISTINCT\\r\\n        b.nr_cpf,\\r\\n        b.nr_cnpj\\r\\n    FROM\\r\\n        usr_sat_fsn.fsn_conta_bancaria b\\r\\n    INNER JOIN\\r\\n        usr_sat_ods.vw_ods_contrib info ON b.nr_cnpj = info.nu_cnpj\\r\\n    WHERE\\r\\n        (b.valido IS NULL OR b.valido = 1)\\r\\n        AND b.nr_cpf IS NOT NULL\\r\\n),\\r\\ncpfs_formam_grupos_sc AS (\\r\\n    SELECT\\r\\n        nr_cpf\\r\\n    FROM\\r\\n        base_sc\\r\\n    GROUP BY\\r\\n        nr_cpf\\r\\n    HAVING\\r\\n        COUNT(DISTINCT SUBSTR(nr_cnpj, 1, 8)) > 1\\r\\n),\\r\\ndados_enriquecidos_sc AS (\\r\\n    SELECT\\r\\n        g.nr_cpf,\\r\\n        g.nr_cnpj,\\r\\n        info.nm_razao_social,\\r\\n        info.nm_ges,\\r\\n        info.cd_cnae,\\r\\n        info.de_cnae,\\r\\n        info.nm_sit_cadastral,\\r\\n        info.nm_reg_apuracao\\r\\n    FROM\\r\\n        base_sc g\\r\\n    INNER JOIN\\r\\n        cpfs_formam_grupos_sc c ON g.nr_cpf = c.nr_cpf\\r\\n    INNER JOIN\\r\\n        usr_sat_ods.vw_ods_contrib info ON g.nr_cnpj = info.nu_cnpj\\r\\n),\\r\\ndados_com_contagem_e_flags AS (\\r\\n    SELECT\\r\\n        *,\\r\\n        DENSE_RANK() OVER (ORDER BY nr_cpf) AS nm_grupo,\\r\\n        COUNT(nr_cnpj) OVER (PARTITION BY nr_cpf) AS qtd_cnpj_grupo,\\r\\n        COUNT(CASE WHEN nm_reg_apuracao = 'SIMPLES NACIONAL' THEN 1 END) OVER (PARTITION BY nr_cpf) as flag_simples_nacional\\r\\n    FROM\\r\\n        dados_enriquecidos_sc\\r\\n)\\r\\nSELECT\\r\\n    nm_grupo,\\r\\n    nr_cpf,\\r\\n    qtd_cnpj_grupo,\\r\\n    nr_cnpj,\\r\\n    nm_razao_social,\\r\\n    nm_ges,\\r\\n    cd_cnae,\\r\\n    de_cnae,\\r\\n    nm_sit_cadastral,\\r\\n    nm_reg_apuracao\\r\\nFROM\\r\\n    dados_com_contagem_e_flags\\r\\nWHERE\\r\\n    flag_simples_nacional > 0\\r\\nORDER BY\\r\\n    nm_grupo, nr_cpf, nr_cnpj;\\r\\n\\r\\n\\r\\n-- PASSO 2: Criar tabela gei_cnpj SEM DUPLICATAS\\r\\nDROP TABLE IF EXISTS gessimples.gei_cnpj;\\r\\n\\r\\nCREATE TABLE gessimples.gei_cnpj AS\\r\\nWITH grupos_qualificados AS (\\r\\n    SELECT\\r\\n        nm_grupo\\r\\n    FROM\\r\\n        gessimples.ccs_grupos_sc\\r\\n    GROUP BY\\r\\n        nm_grupo\\r\\n    HAVING\\r\\n        (COUNT(DISTINCT nm_sit_cadastral) = 1 AND MIN(nm_sit_cadastral) = 'ATIVO')\\r\\n        AND\\r\\n        (COUNT(DISTINCT cd_cnae) = 1)\\r\\n),\\r\\nbase_filtrada AS (\\r\\n    SELECT\\r\\n        CAST(nm_grupo AS STRING) AS num_grupo,\\r\\n        nr_cnpj AS cnpj\\r\\n    FROM\\r\\n        gessimples.ccs_grupos_sc\\r\\n    WHERE\\r\\n        nm_grupo IN (SELECT nm_grupo FROM grupos_qualificados)\\r\\n),\\r\\n-- NOVO: Atribuir cada CNPJ ao grupo de MENOR n\\u00famero\\r\\ncnpj_grupo_unico AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        MIN(CAST(num_grupo AS INT)) AS grupo_menor\\r\\n    FROM\\r\\n        base_filtrada\\r\\n    GROUP BY\\r\\n        cnpj\\r\\n)\\r\\nSELECT\\r\\n    CAST(c.grupo_menor AS STRING) AS num_grupo,\\r\\n    c.cnpj\\r\\nFROM\\r\\n    cnpj_grupo_unico c\\r\\nORDER BY\\r\\n    c.grupo_menor, c.cnpj;\\r\\n\\r\\n\\r\\n-- PASSO 3: Valida\\u00e7\\u00e3o - Confirmar que n\\u00e3o h\\u00e1 duplicatas\\r\\nSELECT \\r\\n   'Total CNPJs' as metrica, COUNT(*) as valor FROM gessimples.gei_cnpj\\r\\nUNION ALL\\r\\nSELECT \\r\\n   'CNPJs \\u00fanicos' as metrica, COUNT(DISTINCT cnpj) as valor FROM gessimples.gei_cnpj\\r\\nUNION ALL\\r\\nSELECT \\r\\n   'Total grupos' as metrica, COUNT(DISTINCT num_grupo) as valor FROM gessimples.gei_cnpj;\", \"result\": {\"id\": \"a364ea51-4a45-118e-a969-aa5a54b091ad\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"HOddI+iNR3KXW+HnhvFuEw==\", \"guid\": \"RPmHPNfJTusAAAAAjdIZWQ==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"554b68d05294f5b2:42a461d9474728b3\", \"session_id\": 23179, \"session_type\": \"impala\", \"statement_id\": 4, \"has_more_statements\": false, \"statements_count\": 5, \"previous_statement_hash\": \"74044a03ebbb4810d3f86b02529d1d218592656cdaade043aa0ea3f1\", \"start\": {\"row\": 120, \"column\": 0}, \"end\": {\"row\": 128, \"column\": 89}, \"statement\": \"-- PASSO 3: Valida\\u00e7\\u00e3o - Confirmar que n\\u00e3o h\\u00e1 duplicatas\\nSELECT \\n   'Total CNPJs' as metrica, COUNT(*) as valor FROM gessimples.gei_cnpj\\nUNION ALL\\nSELECT \\n   'CNPJs \\u00fanicos' as metrica, COUNT(DISTINCT cnpj) as valor FROM gessimples.gei_cnpj\\nUNION ALL\\nSELECT \\n   'Total grupos' as metrica, COUNT(DISTINCT num_grupo) as valor FROM gessimples.gei_cnpj\"}, \"meta\": [], \"rows\": 3, \"hasMore\": false, \"statement_id\": 4, \"statement_range\": {\"start\": {\"row\": 120, \"column\": 0}, \"end\": {\"row\": 128, \"column\": 89}}, \"statements_count\": 5, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 2, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"metrica\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}, {\"name\": \"valor\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 2}], \"fetchedOnce\": false, \"startTime\": \"2025-11-26T18:42:01.630Z\", \"endTime\": \"2025-11-26T18:42:01.806Z\", \"executionTime\": 176, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 3, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 14473, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"metrica\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"valor\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": 14758, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1764182521417, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- =====================================================\\r\\n-- C\\u00d3DIGO FINAL - GRUPOS ECON\\u00d4MICOS SEM DUPLICATAS\\r\\n-- Cada CNPJ aparece em apenas UM grupo\\r\\n-- =====================================================\\r\\n\\r\\n-- PASSO 1: Recriar a tabela ccs_grupos_sc (c\\u00f3digo original mantido)\\r\\nDROP TABLE IF EXISTS gessimples.ccs_grupos_sc;\\r\\n\\r\\nCREATE TABLE gessimples.ccs_grupos_sc AS\\r\\nWITH base_sc AS (\\r\\n    SELECT DISTINCT\\r\\n        b.nr_cpf,\\r\\n        b.nr_cnpj\\r\\n    FROM\\r\\n        usr_sat_fsn.fsn_conta_bancaria b\\r\\n    INNER JOIN\\r\\n        usr_sat_ods.vw_ods_contrib info ON b.nr_cnpj = info.nu_cnpj\\r\\n    WHERE\\r\\n        (b.valido IS NULL OR b.valido = 1)\\r\\n        AND b.nr_cpf IS NOT NULL\\r\\n),\\r\\ncpfs_formam_grupos_sc AS (\\r\\n    SELECT\\r\\n        nr_cpf\\r\\n    FROM\\r\\n        base_sc\\r\\n    GROUP BY\\r\\n        nr_cpf\\r\\n    HAVING\\r\\n        COUNT(DISTINCT SUBSTR(nr_cnpj, 1, 8)) > 1\\r\\n),\\r\\ndados_enriquecidos_sc AS (\\r\\n    SELECT\\r\\n        g.nr_cpf,\\r\\n        g.nr_cnpj,\\r\\n        info.nm_razao_social,\\r\\n        info.nm_ges,\\r\\n        info.cd_cnae,\\r\\n        info.de_cnae,\\r\\n        info.nm_sit_cadastral,\\r\\n        info.nm_reg_apuracao\\r\\n    FROM\\r\\n        base_sc g\\r\\n    INNER JOIN\\r\\n        cpfs_formam_grupos_sc c ON g.nr_cpf = c.nr_cpf\\r\\n    INNER JOIN\\r\\n        usr_sat_ods.vw_ods_contrib info ON g.nr_cnpj = info.nu_cnpj\\r\\n),\\r\\ndados_com_contagem_e_flags AS (\\r\\n    SELECT\\r\\n        *,\\r\\n        DENSE_RANK() OVER (ORDER BY nr_cpf) AS nm_grupo,\\r\\n        COUNT(nr_cnpj) OVER (PARTITION BY nr_cpf) AS qtd_cnpj_grupo,\\r\\n        COUNT(CASE WHEN nm_reg_apuracao = 'SIMPLES NACIONAL' THEN 1 END) OVER (PARTITION BY nr_cpf) as flag_simples_nacional\\r\\n    FROM\\r\\n        dados_enriquecidos_sc\\r\\n)\\r\\nSELECT\\r\\n    nm_grupo,\\r\\n    nr_cpf,\\r\\n    qtd_cnpj_grupo,\\r\\n    nr_cnpj,\\r\\n    nm_razao_social,\\r\\n    nm_ges,\\r\\n    cd_cnae,\\r\\n    de_cnae,\\r\\n    nm_sit_cadastral,\\r\\n    nm_reg_apuracao\\r\\nFROM\\r\\n    dados_com_contagem_e_flags\\r\\nWHERE\\r\\n    flag_simples_nacional > 0\\r\\nORDER BY\\r\\n    nm_grupo, nr_cpf, nr_cnpj;\\r\\n\\r\\n\\r\\n-- PASSO 2: Criar tabela gei_cnpj SEM DUPLICATAS\\r\\nDROP TABLE IF EXISTS gessimples.gei_cnpj;\\r\\n\\r\\nCREATE TABLE gessimples.gei_cnpj AS\\r\\nWITH grupos_qualificados AS (\\r\\n    SELECT\\r\\n        nm_grupo\\r\\n    FROM\\r\\n        gessimples.ccs_grupos_sc\\r\\n    GROUP BY\\r\\n        nm_grupo\\r\\n    HAVING\\r\\n        (COUNT(DISTINCT nm_sit_cadastral) = 1 AND MIN(nm_sit_cadastral) = 'ATIVO')\\r\\n        AND\\r\\n        (COUNT(DISTINCT cd_cnae) = 1)\\r\\n),\\r\\nbase_filtrada AS (\\r\\n    SELECT\\r\\n        CAST(nm_grupo AS STRING) AS num_grupo,\\r\\n        nr_cnpj AS cnpj\\r\\n    FROM\\r\\n        gessimples.ccs_grupos_sc\\r\\n    WHERE\\r\\n        nm_grupo IN (SELECT nm_grupo FROM grupos_qualificados)\\r\\n),\\r\\n-- NOVO: Atribuir cada CNPJ ao grupo de MENOR n\\u00famero\\r\\ncnpj_grupo_unico AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        MIN(CAST(num_grupo AS INT)) AS grupo_menor\\r\\n    FROM\\r\\n        base_filtrada\\r\\n    GROUP BY\\r\\n        cnpj\\r\\n)\\r\\nSELECT\\r\\n    CAST(c.grupo_menor AS STRING) AS num_grupo,\\r\\n    c.cnpj\\r\\nFROM\\r\\n    cnpj_grupo_unico c\\r\\nORDER BY\\r\\n    c.grupo_menor, c.cnpj;\\r\\n\\r\\n\\r\\n-- PASSO 3: Valida\\u00e7\\u00e3o - Confirmar que n\\u00e3o h\\u00e1 duplicatas\\r\\nSELECT \\r\\n   'Total CNPJs' as metrica, COUNT(*) as valor FROM gessimples.gei_cnpj\\r\\nUNION ALL\\r\\nSELECT \\r\\n   'CNPJs \\u00fanicos' as metrica, COUNT(DISTINCT cnpj) as valor FROM gessimples.gei_cnpj\\r\\nUNION ALL\\r\\nSELECT \\r\\n   'Total grupos' as metrica, COUNT(DISTINCT num_grupo) as valor FROM gessimples.gei_cnpj;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 128, \"column\": 90}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query eb4ec9d73c87f944:5919d28d00000000 100% Complete (3 out of 3)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"eb4ec9d73c87f944:5919d28d00000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=eb4ec9d73c87f944:5919d28d00000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query eb4ec9d73c87f944:5919d28d00000000 100% Complete (3 out of 3)\", \"progress\": 100, \"jobs\": [{\"name\": \"eb4ec9d73c87f944:5919d28d00000000\", \"url\": \"/hue/jobbrowser#!id=eb4ec9d73c87f944:5919d28d00000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 11320, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 195, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": null, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- =====================================================\r\n-- CÃDIGO FINAL - GRUPOS ECONÃMICOS SEM DUPLICATAS\r\n-- Cada CNPJ aparece em apenas UM grupo\r\n-- =====================================================\r\n\r\n-- PASSO 1: Recriar a tabela ccs_grupos_sc (cÃ³digo original mantido)\r\nDROP TABLE IF EXISTS gessimples.ccs_grupos_sc;\r\n\r\nCREATE TABLE gessimples.ccs_grupos_sc AS\r\nWITH base_sc AS (\r\n    SELECT DISTINCT\r\n        b.nr_cpf,\r\n        b.nr_cnpj\r\n    FROM\r\n        usr_sat_fsn.fsn_conta_bancaria b\r\n    INNER JOIN\r\n        usr_sat_ods.vw_ods_contrib info ON b.nr_cnpj = info.nu_cnpj\r\n    WHERE\r\n        (b.valido IS NULL OR b.valido = 1)\r\n        AND b.nr_cpf IS NOT NULL\r\n),\r\ncpfs_formam_grupos_sc AS (\r\n    SELECT\r\n        nr_cpf\r\n    FROM\r\n        base_sc\r\n    GROUP BY\r\n        nr_cpf\r\n    HAVING\r\n        COUNT(DISTINCT SUBSTR(nr_cnpj, 1, 8)) > 1\r\n),\r\ndados_enriquecidos_sc AS (\r\n    SELECT\r\n        g.nr_cpf,\r\n        g.nr_cnpj,\r\n        info.nm_razao_social,\r\n        info.nm_ges,\r\n        info.cd_cnae,\r\n        info.de_cnae,\r\n        info.nm_sit_cadastral,\r\n        info.nm_reg_apuracao\r\n    FROM\r\n        base_sc g\r\n    INNER JOIN\r\n        cpfs_formam_grupos_sc c ON g.nr_cpf = c.nr_cpf\r\n    INNER JOIN\r\n        usr_sat_ods.vw_ods_contrib info ON g.nr_cnpj = info.nu_cnpj\r\n),\r\ndados_com_contagem_e_flags AS (\r\n    SELECT\r\n        *,\r\n        DENSE_RANK() OVER (ORDER BY nr_cpf) AS nm_grupo,\r\n        COUNT(nr_cnpj) OVER (PARTITION BY nr_cpf) AS qtd_cnpj_grupo,\r\n        COUNT(CASE WHEN nm_reg_apuracao = 'SIMPLES NACIONAL' THEN 1 END) OVER (PARTITION BY nr_cpf) as flag_simples_nacional\r\n    FROM\r\n        dados_enriquecidos_sc\r\n)\r\nSELECT\r\n    nm_grupo,\r\n    nr_cpf,\r\n    qtd_cnpj_grupo,\r\n    nr_cnpj,\r\n    nm_razao_social,\r\n    nm_ges,\r\n    cd_cnae,\r\n    de_cnae,\r\n    nm_sit_cadastral,\r\n    nm_reg_apuracao\r\nFROM\r\n    dados_com_contagem_e_flags\r\nWHERE\r\n    flag_simples_nacional > 0\r\nORDER BY\r\n    nm_grupo, nr_cpf, nr_cnpj;\r\n\r\n\r\n-- PASSO 2: Criar tabela gei_cnpj SEM DUPLICATAS\r\nDROP",
    "last_modified": "2025-11-26T15:42:30.634",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 185677,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: NF3E",
    "description": "",
    "uuid": "c72ad524-1897-f7bb-1c4b-4ff316e204f6",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 185677, \"uuid\": \"c72ad524-1897-f7bb-1c4b-4ff316e204f6\", \"name\": \"GEI: NF3E\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"0853c15e-3d3c-6447-964c-f19540796c85\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Query\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 217, \"column\": 44}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"nfcom\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- =====================================================\\r\\n-- GEI - SISTEMA DE DETECAO DE GRUPOS ECONOMICOS\\r\\n-- TABELA GEI_NF3E - Notas Fiscais de Energia Eletrica\\r\\n-- =====================================================\\r\\n-- Autor: Sistema GEI\\r\\n-- Data: 2025-12-18\\r\\n-- Descricao: Agregacao de consumo de energia eletrica por CNPJ\\r\\n-- Fonte: nf3e.nf3e (84 milhoes de registros)\\r\\n-- =====================================================\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 1: gei_nf3e - Valores mensais por CNPJ destinatario\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nf3e;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_nf3e AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnf3e.nf3e.infnf3e.dest.cnpj,\\r\\n      procnf3e.nf3e.infnf3e.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\r\\n    COALESCE(CAST(procnf3e.nf3e.infnf3e.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nf3e.nf3e\\r\\n  WHERE ano_emissao >= 2020\\r\\n    AND ano_emissao <= 2025\\r\\n    AND (procnf3e.nf3e.infnf3e.dest.cnpj IS NOT NULL\\r\\n         OR procnf3e.nf3e.infnf3e.dest.cpf IS NOT NULL)\\r\\n),\\r\\nagregado AS (\\r\\n  SELECT\\r\\n    cnpj_dest,\\r\\n    nu_per_ref,\\r\\n    SUM(vl_nota) AS vl_energia_mensal,\\r\\n    COUNT(*) AS qt_notas\\r\\n  FROM base\\r\\n  WHERE LENGTH(cnpj_dest) >= 11\\r\\n  GROUP BY cnpj_dest, nu_per_ref\\r\\n),\\r\\nacumulado AS (\\r\\n  SELECT\\r\\n    cnpj_dest,\\r\\n    nu_per_ref,\\r\\n    vl_energia_mensal,\\r\\n    qt_notas,\\r\\n    SUM(vl_energia_mensal) OVER (\\r\\n      PARTITION BY cnpj_dest\\r\\n      ORDER BY nu_per_ref\\r\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\r\\n    ) AS vl_energia_12m\\r\\n  FROM agregado\\r\\n)\\r\\nSELECT\\r\\n  a.cnpj_dest AS cnpj,\\r\\n\\r\\n  -- Periodo 2021\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202101 THEN a.vl_energia_12m ELSE 0 END) AS jan2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202102 THEN a.vl_energia_12m ELSE 0 END) AS fev2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202103 THEN a.vl_energia_12m ELSE 0 END) AS mar2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202104 THEN a.vl_energia_12m ELSE 0 END) AS abr2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202105 THEN a.vl_energia_12m ELSE 0 END) AS mai2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202106 THEN a.vl_energia_12m ELSE 0 END) AS jun2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202107 THEN a.vl_energia_12m ELSE 0 END) AS jul2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202108 THEN a.vl_energia_12m ELSE 0 END) AS ago2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202109 THEN a.vl_energia_12m ELSE 0 END) AS set2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202110 THEN a.vl_energia_12m ELSE 0 END) AS out2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202111 THEN a.vl_energia_12m ELSE 0 END) AS nov2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202112 THEN a.vl_energia_12m ELSE 0 END) AS dez2021,\\r\\n\\r\\n  -- Periodo 2022\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202201 THEN a.vl_energia_12m ELSE 0 END) AS jan2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202202 THEN a.vl_energia_12m ELSE 0 END) AS fev2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202203 THEN a.vl_energia_12m ELSE 0 END) AS mar2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202204 THEN a.vl_energia_12m ELSE 0 END) AS abr2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202205 THEN a.vl_energia_12m ELSE 0 END) AS mai2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202206 THEN a.vl_energia_12m ELSE 0 END) AS jun2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202207 THEN a.vl_energia_12m ELSE 0 END) AS jul2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202208 THEN a.vl_energia_12m ELSE 0 END) AS ago2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202209 THEN a.vl_energia_12m ELSE 0 END) AS set2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202210 THEN a.vl_energia_12m ELSE 0 END) AS out2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202211 THEN a.vl_energia_12m ELSE 0 END) AS nov2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202212 THEN a.vl_energia_12m ELSE 0 END) AS dez2022,\\r\\n\\r\\n  -- Periodo 2023\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202301 THEN a.vl_energia_12m ELSE 0 END) AS jan2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202302 THEN a.vl_energia_12m ELSE 0 END) AS fev2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202303 THEN a.vl_energia_12m ELSE 0 END) AS mar2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202304 THEN a.vl_energia_12m ELSE 0 END) AS abr2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202305 THEN a.vl_energia_12m ELSE 0 END) AS mai2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202306 THEN a.vl_energia_12m ELSE 0 END) AS jun2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202307 THEN a.vl_energia_12m ELSE 0 END) AS jul2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202308 THEN a.vl_energia_12m ELSE 0 END) AS ago2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202309 THEN a.vl_energia_12m ELSE 0 END) AS set2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202310 THEN a.vl_energia_12m ELSE 0 END) AS out2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202311 THEN a.vl_energia_12m ELSE 0 END) AS nov2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202312 THEN a.vl_energia_12m ELSE 0 END) AS dez2023,\\r\\n\\r\\n  -- Periodo 2024\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202401 THEN a.vl_energia_12m ELSE 0 END) AS jan2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202402 THEN a.vl_energia_12m ELSE 0 END) AS fev2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202403 THEN a.vl_energia_12m ELSE 0 END) AS mar2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202404 THEN a.vl_energia_12m ELSE 0 END) AS abr2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202405 THEN a.vl_energia_12m ELSE 0 END) AS mai2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202406 THEN a.vl_energia_12m ELSE 0 END) AS jun2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202407 THEN a.vl_energia_12m ELSE 0 END) AS jul2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202408 THEN a.vl_energia_12m ELSE 0 END) AS ago2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202409 THEN a.vl_energia_12m ELSE 0 END) AS set2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202410 THEN a.vl_energia_12m ELSE 0 END) AS out2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202411 THEN a.vl_energia_12m ELSE 0 END) AS nov2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202412 THEN a.vl_energia_12m ELSE 0 END) AS dez2024,\\r\\n\\r\\n  -- Periodo 2025\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202501 THEN a.vl_energia_12m ELSE 0 END) AS jan2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202502 THEN a.vl_energia_12m ELSE 0 END) AS fev2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202503 THEN a.vl_energia_12m ELSE 0 END) AS mar2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202504 THEN a.vl_energia_12m ELSE 0 END) AS abr2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202505 THEN a.vl_energia_12m ELSE 0 END) AS mai2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202506 THEN a.vl_energia_12m ELSE 0 END) AS jun2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202507 THEN a.vl_energia_12m ELSE 0 END) AS jul2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202508 THEN a.vl_energia_12m ELSE 0 END) AS ago2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202509 THEN a.vl_energia_12m ELSE 0 END) AS set2025\\r\\n\\r\\nFROM acumulado a\\r\\nJOIN gessimples.gei_cnpj gc ON a.cnpj_dest = gc.cnpj\\r\\nWHERE a.vl_energia_12m IS NOT NULL\\r\\nGROUP BY a.cnpj_dest;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nf3e;\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 2: gei_nf3e_metricas_grupo - Metricas agregadas por grupo economico\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nf3e_metricas_grupo;\\r\\n\\r\\nCREATE TABLE gessimples.gei_nf3e_metricas_grupo AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnf3e.nf3e.infnf3e.dest.cnpj,\\r\\n      procnf3e.nf3e.infnf3e.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnf3e.nf3e.infnf3e.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\r\\n    COALESCE(CAST(procnf3e.nf3e.infnf3e.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nf3e.nf3e\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnf3e.nf3e.infnf3e.dest.cnpj IS NOT NULL\\r\\n         OR procnf3e.nf3e.infnf3e.dest.cpf IS NOT NULL)\\r\\n),\\r\\npor_cnpj AS (\\r\\n  SELECT\\r\\n    b.cnpj_dest,\\r\\n    gc.num_grupo,\\r\\n    SUM(b.vl_nota) AS vl_total_energia,\\r\\n    COUNT(*) AS qt_notas,\\r\\n    COUNT(DISTINCT b.cnpj_emit) AS qt_fornecedores,\\r\\n    COUNT(DISTINCT b.nu_per_ref) AS qt_meses_consumo,\\r\\n    AVG(b.vl_nota) AS vl_medio_nota,\\r\\n    MAX(b.vl_nota) AS vl_max_nota,\\r\\n    MIN(CASE WHEN b.vl_nota > 0 THEN b.vl_nota END) AS vl_min_nota\\r\\n  FROM base b\\r\\n  JOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\n  WHERE LENGTH(b.cnpj_dest) >= 11\\r\\n  GROUP BY b.cnpj_dest, gc.num_grupo\\r\\n)\\r\\nSELECT\\r\\n  num_grupo,\\r\\n  COUNT(DISTINCT cnpj_dest) AS qt_empresas_consumidoras,\\r\\n  SUM(vl_total_energia) AS vl_energia_grupo,\\r\\n  SUM(qt_notas) AS qt_notas_grupo,\\r\\n  SUM(qt_fornecedores) AS qt_fornecedores_grupo,\\r\\n  AVG(vl_medio_nota) AS vl_medio_nota_grupo,\\r\\n  MAX(vl_max_nota) AS vl_max_nota_grupo,\\r\\n  AVG(qt_meses_consumo) AS media_meses_consumo\\r\\nFROM por_cnpj\\r\\nGROUP BY num_grupo;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nf3e_metricas_grupo;\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 3: gei_nf3e_detalhado - Detalhamento mensal por empresa\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nf3e_detalhado;\\r\\n\\r\\nCREATE TABLE gessimples.gei_nf3e_detalhado AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnf3e.nf3e.infnf3e.dest.cnpj,\\r\\n      procnf3e.nf3e.infnf3e.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnf3e.nf3e.infnf3e.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    ano_emissao,\\r\\n    mes_emissao,\\r\\n    COALESCE(CAST(procnf3e.nf3e.infnf3e.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nf3e.nf3e\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnf3e.nf3e.infnf3e.dest.cnpj IS NOT NULL\\r\\n         OR procnf3e.nf3e.infnf3e.dest.cpf IS NOT NULL)\\r\\n)\\r\\nSELECT\\r\\n  b.cnpj_dest AS cnpj,\\r\\n  gc.num_grupo,\\r\\n  b.ano_emissao,\\r\\n  b.mes_emissao,\\r\\n  SUM(b.vl_nota) AS vl_energia_mensal,\\r\\n  COUNT(*) AS qt_notas,\\r\\n  COUNT(DISTINCT b.cnpj_emit) AS qt_fornecedores\\r\\nFROM base b\\r\\nJOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\nWHERE LENGTH(b.cnpj_dest) >= 11\\r\\nGROUP BY b.cnpj_dest, gc.num_grupo, b.ano_emissao, b.mes_emissao;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nf3e_detalhado;\", \"statementsList\": [\"-- =====================================================\\r\\n-- GEI - SISTEMA DE DETECAO DE GRUPOS ECONOMICOS\\r\\n-- TABELA GEI_NF3E - Notas Fiscais de Energia Eletrica\\r\\n-- =====================================================\\r\\n-- Autor: Sistema GEI\\r\\n-- Data: 2025-12-18\\r\\n-- Descricao: Agregacao de consumo de energia eletrica por CNPJ\\r\\n-- Fonte: nf3e.nf3e (84 milhoes de registros)\\r\\n-- =====================================================\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 1: gei_nf3e - Valores mensais por CNPJ destinatario\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nf3e;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_nf3e AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnf3e.nf3e.infnf3e.dest.cnpj,\\r\\n      procnf3e.nf3e.infnf3e.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\r\\n    COALESCE(CAST(procnf3e.nf3e.infnf3e.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nf3e.nf3e\\r\\n  WHERE ano_emissao >= 2020\\r\\n    AND ano_emissao <= 2025\\r\\n    AND (procnf3e.nf3e.infnf3e.dest.cnpj IS NOT NULL\\r\\n         OR procnf3e.nf3e.infnf3e.dest.cpf IS NOT NULL)\\r\\n),\\r\\nagregado AS (\\r\\n  SELECT\\r\\n    cnpj_dest,\\r\\n    nu_per_ref,\\r\\n    SUM(vl_nota) AS vl_energia_mensal,\\r\\n    COUNT(*) AS qt_notas\\r\\n  FROM base\\r\\n  WHERE LENGTH(cnpj_dest) >= 11\\r\\n  GROUP BY cnpj_dest, nu_per_ref\\r\\n),\\r\\nacumulado AS (\\r\\n  SELECT\\r\\n    cnpj_dest,\\r\\n    nu_per_ref,\\r\\n    vl_energia_mensal,\\r\\n    qt_notas,\\r\\n    SUM(vl_energia_mensal) OVER (\\r\\n      PARTITION BY cnpj_dest\\r\\n      ORDER BY nu_per_ref\\r\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\r\\n    ) AS vl_energia_12m\\r\\n  FROM agregado\\r\\n)\\r\\nSELECT\\r\\n  a.cnpj_dest AS cnpj,\\r\\n\\r\\n  -- Periodo 2021\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202101 THEN a.vl_energia_12m ELSE 0 END) AS jan2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202102 THEN a.vl_energia_12m ELSE 0 END) AS fev2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202103 THEN a.vl_energia_12m ELSE 0 END) AS mar2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202104 THEN a.vl_energia_12m ELSE 0 END) AS abr2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202105 THEN a.vl_energia_12m ELSE 0 END) AS mai2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202106 THEN a.vl_energia_12m ELSE 0 END) AS jun2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202107 THEN a.vl_energia_12m ELSE 0 END) AS jul2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202108 THEN a.vl_energia_12m ELSE 0 END) AS ago2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202109 THEN a.vl_energia_12m ELSE 0 END) AS set2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202110 THEN a.vl_energia_12m ELSE 0 END) AS out2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202111 THEN a.vl_energia_12m ELSE 0 END) AS nov2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202112 THEN a.vl_energia_12m ELSE 0 END) AS dez2021,\\r\\n\\r\\n  -- Periodo 2022\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202201 THEN a.vl_energia_12m ELSE 0 END) AS jan2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202202 THEN a.vl_energia_12m ELSE 0 END) AS fev2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202203 THEN a.vl_energia_12m ELSE 0 END) AS mar2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202204 THEN a.vl_energia_12m ELSE 0 END) AS abr2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202205 THEN a.vl_energia_12m ELSE 0 END) AS mai2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202206 THEN a.vl_energia_12m ELSE 0 END) AS jun2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202207 THEN a.vl_energia_12m ELSE 0 END) AS jul2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202208 THEN a.vl_energia_12m ELSE 0 END) AS ago2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202209 THEN a.vl_energia_12m ELSE 0 END) AS set2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202210 THEN a.vl_energia_12m ELSE 0 END) AS out2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202211 THEN a.vl_energia_12m ELSE 0 END) AS nov2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202212 THEN a.vl_energia_12m ELSE 0 END) AS dez2022,\\r\\n\\r\\n  -- Periodo 2023\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202301 THEN a.vl_energia_12m ELSE 0 END) AS jan2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202302 THEN a.vl_energia_12m ELSE 0 END) AS fev2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202303 THEN a.vl_energia_12m ELSE 0 END) AS mar2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202304 THEN a.vl_energia_12m ELSE 0 END) AS abr2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202305 THEN a.vl_energia_12m ELSE 0 END) AS mai2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202306 THEN a.vl_energia_12m ELSE 0 END) AS jun2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202307 THEN a.vl_energia_12m ELSE 0 END) AS jul2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202308 THEN a.vl_energia_12m ELSE 0 END) AS ago2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202309 THEN a.vl_energia_12m ELSE 0 END) AS set2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202310 THEN a.vl_energia_12m ELSE 0 END) AS out2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202311 THEN a.vl_energia_12m ELSE 0 END) AS nov2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202312 THEN a.vl_energia_12m ELSE 0 END) AS dez2023,\\r\\n\\r\\n  -- Periodo 2024\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202401 THEN a.vl_energia_12m ELSE 0 END) AS jan2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202402 THEN a.vl_energia_12m ELSE 0 END) AS fev2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202403 THEN a.vl_energia_12m ELSE 0 END) AS mar2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202404 THEN a.vl_energia_12m ELSE 0 END) AS abr2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202405 THEN a.vl_energia_12m ELSE 0 END) AS mai2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202406 THEN a.vl_energia_12m ELSE 0 END) AS jun2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202407 THEN a.vl_energia_12m ELSE 0 END) AS jul2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202408 THEN a.vl_energia_12m ELSE 0 END) AS ago2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202409 THEN a.vl_energia_12m ELSE 0 END) AS set2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202410 THEN a.vl_energia_12m ELSE 0 END) AS out2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202411 THEN a.vl_energia_12m ELSE 0 END) AS nov2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202412 THEN a.vl_energia_12m ELSE 0 END) AS dez2024,\\r\\n\\r\\n  -- Periodo 2025\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202501 THEN a.vl_energia_12m ELSE 0 END) AS jan2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202502 THEN a.vl_energia_12m ELSE 0 END) AS fev2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202503 THEN a.vl_energia_12m ELSE 0 END) AS mar2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202504 THEN a.vl_energia_12m ELSE 0 END) AS abr2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202505 THEN a.vl_energia_12m ELSE 0 END) AS mai2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202506 THEN a.vl_energia_12m ELSE 0 END) AS jun2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202507 THEN a.vl_energia_12m ELSE 0 END) AS jul2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202508 THEN a.vl_energia_12m ELSE 0 END) AS ago2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202509 THEN a.vl_energia_12m ELSE 0 END) AS set2025\\r\\n\\r\\nFROM acumulado a\\r\\nJOIN gessimples.gei_cnpj gc ON a.cnpj_dest = gc.cnpj\\r\\nWHERE a.vl_energia_12m IS NOT NULL\\r\\nGROUP BY a.cnpj_dest;\", \"\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nf3e;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 2: gei_nf3e_metricas_grupo - Metricas agregadas por grupo economico\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nf3e_metricas_grupo;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_nf3e_metricas_grupo AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnf3e.nf3e.infnf3e.dest.cnpj,\\r\\n      procnf3e.nf3e.infnf3e.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnf3e.nf3e.infnf3e.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\r\\n    COALESCE(CAST(procnf3e.nf3e.infnf3e.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nf3e.nf3e\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnf3e.nf3e.infnf3e.dest.cnpj IS NOT NULL\\r\\n         OR procnf3e.nf3e.infnf3e.dest.cpf IS NOT NULL)\\r\\n),\\r\\npor_cnpj AS (\\r\\n  SELECT\\r\\n    b.cnpj_dest,\\r\\n    gc.num_grupo,\\r\\n    SUM(b.vl_nota) AS vl_total_energia,\\r\\n    COUNT(*) AS qt_notas,\\r\\n    COUNT(DISTINCT b.cnpj_emit) AS qt_fornecedores,\\r\\n    COUNT(DISTINCT b.nu_per_ref) AS qt_meses_consumo,\\r\\n    AVG(b.vl_nota) AS vl_medio_nota,\\r\\n    MAX(b.vl_nota) AS vl_max_nota,\\r\\n    MIN(CASE WHEN b.vl_nota > 0 THEN b.vl_nota END) AS vl_min_nota\\r\\n  FROM base b\\r\\n  JOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\n  WHERE LENGTH(b.cnpj_dest) >= 11\\r\\n  GROUP BY b.cnpj_dest, gc.num_grupo\\r\\n)\\r\\nSELECT\\r\\n  num_grupo,\\r\\n  COUNT(DISTINCT cnpj_dest) AS qt_empresas_consumidoras,\\r\\n  SUM(vl_total_energia) AS vl_energia_grupo,\\r\\n  SUM(qt_notas) AS qt_notas_grupo,\\r\\n  SUM(qt_fornecedores) AS qt_fornecedores_grupo,\\r\\n  AVG(vl_medio_nota) AS vl_medio_nota_grupo,\\r\\n  MAX(vl_max_nota) AS vl_max_nota_grupo,\\r\\n  AVG(qt_meses_consumo) AS media_meses_consumo\\r\\nFROM por_cnpj\\r\\nGROUP BY num_grupo;\", \"\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nf3e_metricas_grupo;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 3: gei_nf3e_detalhado - Detalhamento mensal por empresa\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nf3e_detalhado;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_nf3e_detalhado AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnf3e.nf3e.infnf3e.dest.cnpj,\\r\\n      procnf3e.nf3e.infnf3e.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnf3e.nf3e.infnf3e.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    ano_emissao,\\r\\n    mes_emissao,\\r\\n    COALESCE(CAST(procnf3e.nf3e.infnf3e.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nf3e.nf3e\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnf3e.nf3e.infnf3e.dest.cnpj IS NOT NULL\\r\\n         OR procnf3e.nf3e.infnf3e.dest.cpf IS NOT NULL)\\r\\n)\\r\\nSELECT\\r\\n  b.cnpj_dest AS cnpj,\\r\\n  gc.num_grupo,\\r\\n  b.ano_emissao,\\r\\n  b.mes_emissao,\\r\\n  SUM(b.vl_nota) AS vl_energia_mensal,\\r\\n  COUNT(*) AS qt_notas,\\r\\n  COUNT(DISTINCT b.cnpj_emit) AS qt_fornecedores\\r\\nFROM base b\\r\\nJOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\nWHERE LENGTH(b.cnpj_dest) >= 11\\r\\nGROUP BY b.cnpj_dest, gc.num_grupo, b.ano_emissao, b.mes_emissao;\", \"\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nf3e_detalhado;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Example: SELECT * FROM tablename, or press CTRL + space\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_nf3e_detalhado AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnf3e.nf3e.infnf3e.dest.cnpj,\\r\\n      procnf3e.nf3e.infnf3e.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnf3e.nf3e.infnf3e.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    ano_emissao,\\r\\n    mes_emissao,\\r\\n    COALESCE(CAST(procnf3e.nf3e.infnf3e.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nf3e.nf3e\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnf3e.nf3e.infnf3e.dest.cnpj IS NOT NULL\\r\\n         OR procnf3e.nf3e.infnf3e.dest.cpf IS NOT NULL)\\r\\n)\\r\\nSELECT\\r\\n  b.cnpj_dest AS cnpj,\\r\\n  gc.num_grupo,\\r\\n  b.ano_emissao,\\r\\n  b.mes_emissao,\\r\\n  SUM(b.vl_nota) AS vl_energia_mensal,\\r\\n  COUNT(*) AS qt_notas,\\r\\n  COUNT(DISTINCT b.cnpj_emit) AS qt_fornecedores\\r\\nFROM base b\\r\\nJOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\nWHERE LENGTH(b.cnpj_dest) >= 11\\r\\nGROUP BY b.cnpj_dest, gc.num_grupo, b.ano_emissao, b.mes_emissao;\", \"result\": {\"id\": \"8f5eb771-b37f-f84b-0125-d0ea43058098\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"B77Sf/y5QiOecFGC/x36kg==\", \"guid\": \"D768zRG4TmQAAAAAx5N8lw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"5c4e9f5ba17e29a4:809e2fe078bdf0a4\", \"session_id\": 24158, \"session_type\": \"impala\", \"statement_id\": 2, \"has_more_statements\": true, \"statements_count\": 10, \"previous_statement_hash\": \"7e69aed6d0ce56d5ab3058db6f1e4f16543575a90642f94593d8fbe3\", \"start\": {\"row\": 16, \"column\": 0}, \"end\": {\"row\": 127, \"column\": 21}, \"statement\": \"CREATE TABLE gessimples.gei_nf3e AS\\nWITH base AS (\\n  SELECT\\n    REGEXP_REPLACE(TRIM(COALESCE(\\n      procnf3e.nf3e.infnf3e.dest.cnpj,\\n      procnf3e.nf3e.infnf3e.dest.cpf\\n    )), '[^0-9]', '') AS cnpj_dest,\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\n    COALESCE(CAST(procnf3e.nf3e.infnf3e.total.vnf AS DOUBLE), 0) AS vl_nota\\n  FROM nf3e.nf3e\\n  WHERE ano_emissao >= 2020\\n    AND ano_emissao <= 2025\\n    AND (procnf3e.nf3e.infnf3e.dest.cnpj IS NOT NULL\\n         OR procnf3e.nf3e.infnf3e.dest.cpf IS NOT NULL)\\n),\\nagregado AS (\\n  SELECT\\n    cnpj_dest,\\n    nu_per_ref,\\n    SUM(vl_nota) AS vl_energia_mensal,\\n    COUNT(*) AS qt_notas\\n  FROM base\\n  WHERE LENGTH(cnpj_dest) >= 11\\n  GROUP BY cnpj_dest, nu_per_ref\\n),\\nacumulado AS (\\n  SELECT\\n    cnpj_dest,\\n    nu_per_ref,\\n    vl_energia_mensal,\\n    qt_notas,\\n    SUM(vl_energia_mensal) OVER (\\n      PARTITION BY cnpj_dest\\n      ORDER BY nu_per_ref\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\n    ) AS vl_energia_12m\\n  FROM agregado\\n)\\nSELECT\\n  a.cnpj_dest AS cnpj,\\n\\n  -- Periodo 2021\\n  MAX(CASE WHEN a.nu_per_ref = 202101 THEN a.vl_energia_12m ELSE 0 END) AS jan2021,\\n  MAX(CASE WHEN a.nu_per_ref = 202102 THEN a.vl_energia_12m ELSE 0 END) AS fev2021,\\n  MAX(CASE WHEN a.nu_per_ref = 202103 THEN a.vl_energia_12m ELSE 0 END) AS mar2021,\\n  MAX(CASE WHEN a.nu_per_ref = 202104 THEN a.vl_energia_12m ELSE 0 END) AS abr2021,\\n  MAX(CASE WHEN a.nu_per_ref = 202105 THEN a.vl_energia_12m ELSE 0 END) AS mai2021,\\n  MAX(CASE WHEN a.nu_per_ref = 202106 THEN a.vl_energia_12m ELSE 0 END) AS jun2021,\\n  MAX(CASE WHEN a.nu_per_ref = 202107 THEN a.vl_energia_12m ELSE 0 END) AS jul2021,\\n  MAX(CASE WHEN a.nu_per_ref = 202108 THEN a.vl_energia_12m ELSE 0 END) AS ago2021,\\n  MAX(CASE WHEN a.nu_per_ref = 202109 THEN a.vl_energia_12m ELSE 0 END) AS set2021,\\n  MAX(CASE WHEN a.nu_per_ref = 202110 THEN a.vl_energia_12m ELSE 0 END) AS out2021,\\n  MAX(CASE WHEN a.nu_per_ref = 202111 THEN a.vl_energia_12m ELSE 0 END) AS nov2021,\\n  MAX(CASE WHEN a.nu_per_ref = 202112 THEN a.vl_energia_12m ELSE 0 END) AS dez2021,\\n\\n  -- Periodo 2022\\n  MAX(CASE WHEN a.nu_per_ref = 202201 THEN a.vl_energia_12m ELSE 0 END) AS jan2022,\\n  MAX(CASE WHEN a.nu_per_ref = 202202 THEN a.vl_energia_12m ELSE 0 END) AS fev2022,\\n  MAX(CASE WHEN a.nu_per_ref = 202203 THEN a.vl_energia_12m ELSE 0 END) AS mar2022,\\n  MAX(CASE WHEN a.nu_per_ref = 202204 THEN a.vl_energia_12m ELSE 0 END) AS abr2022,\\n  MAX(CASE WHEN a.nu_per_ref = 202205 THEN a.vl_energia_12m ELSE 0 END) AS mai2022,\\n  MAX(CASE WHEN a.nu_per_ref = 202206 THEN a.vl_energia_12m ELSE 0 END) AS jun2022,\\n  MAX(CASE WHEN a.nu_per_ref = 202207 THEN a.vl_energia_12m ELSE 0 END) AS jul2022,\\n  MAX(CASE WHEN a.nu_per_ref = 202208 THEN a.vl_energia_12m ELSE 0 END) AS ago2022,\\n  MAX(CASE WHEN a.nu_per_ref = 202209 THEN a.vl_energia_12m ELSE 0 END) AS set2022,\\n  MAX(CASE WHEN a.nu_per_ref = 202210 THEN a.vl_energia_12m ELSE 0 END) AS out2022,\\n  MAX(CASE WHEN a.nu_per_ref = 202211 THEN a.vl_energia_12m ELSE 0 END) AS nov2022,\\n  MAX(CASE WHEN a.nu_per_ref = 202212 THEN a.vl_energia_12m ELSE 0 END) AS dez2022,\\n\\n  -- Periodo 2023\\n  MAX(CASE WHEN a.nu_per_ref = 202301 THEN a.vl_energia_12m ELSE 0 END) AS jan2023,\\n  MAX(CASE WHEN a.nu_per_ref = 202302 THEN a.vl_energia_12m ELSE 0 END) AS fev2023,\\n  MAX(CASE WHEN a.nu_per_ref = 202303 THEN a.vl_energia_12m ELSE 0 END) AS mar2023,\\n  MAX(CASE WHEN a.nu_per_ref = 202304 THEN a.vl_energia_12m ELSE 0 END) AS abr2023,\\n  MAX(CASE WHEN a.nu_per_ref = 202305 THEN a.vl_energia_12m ELSE 0 END) AS mai2023,\\n  MAX(CASE WHEN a.nu_per_ref = 202306 THEN a.vl_energia_12m ELSE 0 END) AS jun2023,\\n  MAX(CASE WHEN a.nu_per_ref = 202307 THEN a.vl_energia_12m ELSE 0 END) AS jul2023,\\n  MAX(CASE WHEN a.nu_per_ref = 202308 THEN a.vl_energia_12m ELSE 0 END) AS ago2023,\\n  MAX(CASE WHEN a.nu_per_ref = 202309 THEN a.vl_energia_12m ELSE 0 END) AS set2023,\\n  MAX(CASE WHEN a.nu_per_ref = 202310 THEN a.vl_energia_12m ELSE 0 END) AS out2023,\\n  MAX(CASE WHEN a.nu_per_ref = 202311 THEN a.vl_energia_12m ELSE 0 END) AS nov2023,\\n  MAX(CASE WHEN a.nu_per_ref = 202312 THEN a.vl_energia_12m ELSE 0 END) AS dez2023,\\n\\n  -- Periodo 2024\\n  MAX(CASE WHEN a.nu_per_ref = 202401 THEN a.vl_energia_12m ELSE 0 END) AS jan2024,\\n  MAX(CASE WHEN a.nu_per_ref = 202402 THEN a.vl_energia_12m ELSE 0 END) AS fev2024,\\n  MAX(CASE WHEN a.nu_per_ref = 202403 THEN a.vl_energia_12m ELSE 0 END) AS mar2024,\\n  MAX(CASE WHEN a.nu_per_ref = 202404 THEN a.vl_energia_12m ELSE 0 END) AS abr2024,\\n  MAX(CASE WHEN a.nu_per_ref = 202405 THEN a.vl_energia_12m ELSE 0 END) AS mai2024,\\n  MAX(CASE WHEN a.nu_per_ref = 202406 THEN a.vl_energia_12m ELSE 0 END) AS jun2024,\\n  MAX(CASE WHEN a.nu_per_ref = 202407 THEN a.vl_energia_12m ELSE 0 END) AS jul2024,\\n  MAX(CASE WHEN a.nu_per_ref = 202408 THEN a.vl_energia_12m ELSE 0 END) AS ago2024,\\n  MAX(CASE WHEN a.nu_per_ref = 202409 THEN a.vl_energia_12m ELSE 0 END) AS set2024,\\n  MAX(CASE WHEN a.nu_per_ref = 202410 THEN a.vl_energia_12m ELSE 0 END) AS out2024,\\n  MAX(CASE WHEN a.nu_per_ref = 202411 THEN a.vl_energia_12m ELSE 0 END) AS nov2024,\\n  MAX(CASE WHEN a.nu_per_ref = 202412 THEN a.vl_energia_12m ELSE 0 END) AS dez2024,\\n\\n  -- Periodo 2025\\n  MAX(CASE WHEN a.nu_per_ref = 202501 THEN a.vl_energia_12m ELSE 0 END) AS jan2025,\\n  MAX(CASE WHEN a.nu_per_ref = 202502 THEN a.vl_energia_12m ELSE 0 END) AS fev2025,\\n  MAX(CASE WHEN a.nu_per_ref = 202503 THEN a.vl_energia_12m ELSE 0 END) AS mar2025,\\n  MAX(CASE WHEN a.nu_per_ref = 202504 THEN a.vl_energia_12m ELSE 0 END) AS abr2025,\\n  MAX(CASE WHEN a.nu_per_ref = 202505 THEN a.vl_energia_12m ELSE 0 END) AS mai2025,\\n  MAX(CASE WHEN a.nu_per_ref = 202506 THEN a.vl_energia_12m ELSE 0 END) AS jun2025,\\n  MAX(CASE WHEN a.nu_per_ref = 202507 THEN a.vl_energia_12m ELSE 0 END) AS jul2025,\\n  MAX(CASE WHEN a.nu_per_ref = 202508 THEN a.vl_energia_12m ELSE 0 END) AS ago2025,\\n  MAX(CASE WHEN a.nu_per_ref = 202509 THEN a.vl_energia_12m ELSE 0 END) AS set2025\\n\\nFROM acumulado a\\nJOIN gessimples.gei_cnpj gc ON a.cnpj_dest = gc.cnpj\\nWHERE a.vl_energia_12m IS NOT NULL\\nGROUP BY a.cnpj_dest\"}, \"meta\": [], \"rows\": null, \"hasMore\": false, \"statement_id\": 2, \"statement_range\": {\"start\": {\"row\": 16, \"column\": 0}, \"end\": {\"row\": 127, \"column\": 21}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-12-18T19:25:40.025Z\", \"endTime\": \"2025-12-18T19:25:51.801Z\", \"executionTime\": 11776, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1766085939636, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 231, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false, \"is_history\": false}",
    "extra": "",
    "search": "-- =====================================================\r\n-- GEI - SISTEMA DE DETECAO DE GRUPOS ECONOMICOS\r\n-- TABELA GEI_NF3E - Notas Fiscais de Energia Eletrica\r\n-- =====================================================\r\n-- Autor: Sistema GEI\r\n-- Data: 2025-12-18\r\n-- Descricao: Agregacao de consumo de energia eletrica por CNPJ\r\n-- Fonte: nf3e.nf3e (84 milhoes de registros)\r\n-- =====================================================\r\n\r\n-- =====================================================\r\n-- TABELA 1: gei_nf3e - Valores mensais por CNPJ destinatario\r\n-- =====================================================\r\nDROP TABLE IF EXISTS gessimples.gei_nf3e;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_nf3e AS\r\nWITH base AS (\r\n  SELECT\r\n    REGEXP_REPLACE(TRIM(COALESCE(\r\n      procnf3e.nf3e.infnf3e.dest.cnpj,\r\n      procnf3e.nf3e.infnf3e.dest.cpf\r\n    )), '[^0-9]', '') AS cnpj_dest,\r\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\r\n    COALESCE(CAST(procnf3e.nf3e.infnf3e.total.vnf AS DOUBLE), 0) AS vl_nota\r\n  FROM nf3e.nf3e\r\n  WHERE ano_emissao >= 2020\r\n    AND ano_emissao <= 2025\r\n    AND (procnf3e.nf3e.infnf3e.dest.cnpj IS NOT NULL\r\n         OR procnf3e.nf3e.infnf3e.dest.cpf IS NOT NULL)\r\n),\r\nagregado AS (\r\n  SELECT\r\n    cnpj_dest,\r\n    nu_per_ref,\r\n    SUM(vl_nota) AS vl_energia_mensal,\r\n    COUNT(*) AS qt_notas\r\n  FROM base\r\n  WHERE LENGTH(cnpj_dest) >= 11\r\n  GROUP BY cnpj_dest, nu_per_ref\r\n),\r\nacumulado AS (\r\n  SELECT\r\n    cnpj_dest,\r\n    nu_per_ref,\r\n    vl_energia_mensal,\r\n    qt_notas,\r\n    SUM(vl_energia_mensal) OVER (\r\n      PARTITION BY cnpj_dest\r\n      ORDER BY nu_per_ref\r\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\r\n    ) AS vl_energia_12m\r\n  FROM agregado\r\n)\r\nSELECT\r\n  a.cnpj_dest AS cnpj,\r\n\r\n  -- Periodo 2021\r\n  MAX(CASE WHEN a.nu_per_ref = 202101 THEN a.vl_energia_12m ELSE 0 END) AS jan2021,\r\n  MAX(CASE WHEN a.nu_per_ref = 202102 THEN a.vl_energia_12m ELSE 0 END) AS fev2021,\r\n  MAX(CASE WHEN a.nu_per_ref = 202",
    "last_modified": "2025-12-18T18:02:01.313",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 185681,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GEI: NFCOM",
    "description": "",
    "uuid": "7df6bb26-747c-9478-e9f5-8c768c7008fd",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 185681, \"uuid\": \"fd45072c-6dc4-4497-9ac3-308f9b8c7b14\", \"name\": \"GEI: NFCOM\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"7df6bb26-747c-9478-e9f5-8c768c7008fd\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"bb721823-c252-3388-3149-9cd9c4dad720\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Query\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 254, \"column\": 49}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"nfcom\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- =====================================================\\r\\n-- GEI - SISTEMA DE DETECAO DE GRUPOS ECONOMICOS\\r\\n-- TABELA GEI_NFCOM - Notas Fiscais de Comunicacao\\r\\n-- =====================================================\\r\\n-- Autor: Sistema GEI\\r\\n-- Data: 2025-12-18\\r\\n-- Descricao: Agregacao de consumo de telecomunicacoes por CNPJ\\r\\n-- Fonte: nfcom.nfcom (34 milhoes de registros)\\r\\n-- =====================================================\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 1: gei_nfcom - Valores mensais por CNPJ destinatario\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2020\\r\\n    AND ano_emissao <= 2025\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n),\\r\\nagregado AS (\\r\\n  SELECT\\r\\n    cnpj_dest,\\r\\n    nu_per_ref,\\r\\n    SUM(vl_nota) AS vl_telecom_mensal,\\r\\n    COUNT(*) AS qt_notas\\r\\n  FROM base\\r\\n  WHERE LENGTH(cnpj_dest) >= 11\\r\\n  GROUP BY cnpj_dest, nu_per_ref\\r\\n),\\r\\nacumulado AS (\\r\\n  SELECT\\r\\n    cnpj_dest,\\r\\n    nu_per_ref,\\r\\n    vl_telecom_mensal,\\r\\n    qt_notas,\\r\\n    SUM(vl_telecom_mensal) OVER (\\r\\n      PARTITION BY cnpj_dest\\r\\n      ORDER BY nu_per_ref\\r\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\r\\n    ) AS vl_telecom_12m\\r\\n  FROM agregado\\r\\n)\\r\\nSELECT\\r\\n  a.cnpj_dest AS cnpj,\\r\\n\\r\\n  -- Periodo 2021\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202101 THEN a.vl_telecom_12m ELSE 0 END) AS jan2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202102 THEN a.vl_telecom_12m ELSE 0 END) AS fev2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202103 THEN a.vl_telecom_12m ELSE 0 END) AS mar2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202104 THEN a.vl_telecom_12m ELSE 0 END) AS abr2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202105 THEN a.vl_telecom_12m ELSE 0 END) AS mai2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202106 THEN a.vl_telecom_12m ELSE 0 END) AS jun2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202107 THEN a.vl_telecom_12m ELSE 0 END) AS jul2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202108 THEN a.vl_telecom_12m ELSE 0 END) AS ago2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202109 THEN a.vl_telecom_12m ELSE 0 END) AS set2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202110 THEN a.vl_telecom_12m ELSE 0 END) AS out2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202111 THEN a.vl_telecom_12m ELSE 0 END) AS nov2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202112 THEN a.vl_telecom_12m ELSE 0 END) AS dez2021,\\r\\n\\r\\n  -- Periodo 2022\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202201 THEN a.vl_telecom_12m ELSE 0 END) AS jan2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202202 THEN a.vl_telecom_12m ELSE 0 END) AS fev2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202203 THEN a.vl_telecom_12m ELSE 0 END) AS mar2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202204 THEN a.vl_telecom_12m ELSE 0 END) AS abr2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202205 THEN a.vl_telecom_12m ELSE 0 END) AS mai2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202206 THEN a.vl_telecom_12m ELSE 0 END) AS jun2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202207 THEN a.vl_telecom_12m ELSE 0 END) AS jul2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202208 THEN a.vl_telecom_12m ELSE 0 END) AS ago2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202209 THEN a.vl_telecom_12m ELSE 0 END) AS set2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202210 THEN a.vl_telecom_12m ELSE 0 END) AS out2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202211 THEN a.vl_telecom_12m ELSE 0 END) AS nov2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202212 THEN a.vl_telecom_12m ELSE 0 END) AS dez2022,\\r\\n\\r\\n  -- Periodo 2023\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202301 THEN a.vl_telecom_12m ELSE 0 END) AS jan2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202302 THEN a.vl_telecom_12m ELSE 0 END) AS fev2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202303 THEN a.vl_telecom_12m ELSE 0 END) AS mar2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202304 THEN a.vl_telecom_12m ELSE 0 END) AS abr2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202305 THEN a.vl_telecom_12m ELSE 0 END) AS mai2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202306 THEN a.vl_telecom_12m ELSE 0 END) AS jun2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202307 THEN a.vl_telecom_12m ELSE 0 END) AS jul2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202308 THEN a.vl_telecom_12m ELSE 0 END) AS ago2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202309 THEN a.vl_telecom_12m ELSE 0 END) AS set2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202310 THEN a.vl_telecom_12m ELSE 0 END) AS out2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202311 THEN a.vl_telecom_12m ELSE 0 END) AS nov2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202312 THEN a.vl_telecom_12m ELSE 0 END) AS dez2023,\\r\\n\\r\\n  -- Periodo 2024\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202401 THEN a.vl_telecom_12m ELSE 0 END) AS jan2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202402 THEN a.vl_telecom_12m ELSE 0 END) AS fev2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202403 THEN a.vl_telecom_12m ELSE 0 END) AS mar2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202404 THEN a.vl_telecom_12m ELSE 0 END) AS abr2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202405 THEN a.vl_telecom_12m ELSE 0 END) AS mai2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202406 THEN a.vl_telecom_12m ELSE 0 END) AS jun2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202407 THEN a.vl_telecom_12m ELSE 0 END) AS jul2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202408 THEN a.vl_telecom_12m ELSE 0 END) AS ago2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202409 THEN a.vl_telecom_12m ELSE 0 END) AS set2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202410 THEN a.vl_telecom_12m ELSE 0 END) AS out2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202411 THEN a.vl_telecom_12m ELSE 0 END) AS nov2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202412 THEN a.vl_telecom_12m ELSE 0 END) AS dez2024,\\r\\n\\r\\n  -- Periodo 2025\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202501 THEN a.vl_telecom_12m ELSE 0 END) AS jan2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202502 THEN a.vl_telecom_12m ELSE 0 END) AS fev2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202503 THEN a.vl_telecom_12m ELSE 0 END) AS mar2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202504 THEN a.vl_telecom_12m ELSE 0 END) AS abr2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202505 THEN a.vl_telecom_12m ELSE 0 END) AS mai2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202506 THEN a.vl_telecom_12m ELSE 0 END) AS jun2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202507 THEN a.vl_telecom_12m ELSE 0 END) AS jul2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202508 THEN a.vl_telecom_12m ELSE 0 END) AS ago2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202509 THEN a.vl_telecom_12m ELSE 0 END) AS set2025\\r\\n\\r\\nFROM acumulado a\\r\\nJOIN gessimples.gei_cnpj gc ON a.cnpj_dest = gc.cnpj\\r\\nWHERE a.vl_telecom_12m IS NOT NULL\\r\\nGROUP BY a.cnpj_dest;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom;\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 2: gei_nfcom_metricas_grupo - Metricas agregadas por grupo economico\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom_metricas_grupo;\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom_metricas_grupo AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnfcom.nfcom.infnfcom.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n),\\r\\npor_cnpj AS (\\r\\n  SELECT\\r\\n    b.cnpj_dest,\\r\\n    gc.num_grupo,\\r\\n    SUM(b.vl_nota) AS vl_total_telecom,\\r\\n    COUNT(*) AS qt_notas,\\r\\n    COUNT(DISTINCT b.cnpj_emit) AS qt_operadoras,\\r\\n    COUNT(DISTINCT b.nu_per_ref) AS qt_meses_consumo,\\r\\n    AVG(b.vl_nota) AS vl_medio_nota,\\r\\n    MAX(b.vl_nota) AS vl_max_nota,\\r\\n    MIN(CASE WHEN b.vl_nota > 0 THEN b.vl_nota END) AS vl_min_nota\\r\\n  FROM base b\\r\\n  JOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\n  WHERE LENGTH(b.cnpj_dest) >= 11\\r\\n  GROUP BY b.cnpj_dest, gc.num_grupo\\r\\n)\\r\\nSELECT\\r\\n  num_grupo,\\r\\n  COUNT(DISTINCT cnpj_dest) AS qt_empresas_consumidoras,\\r\\n  SUM(vl_total_telecom) AS vl_telecom_grupo,\\r\\n  SUM(qt_notas) AS qt_notas_grupo,\\r\\n  SUM(qt_operadoras) AS qt_operadoras_grupo,\\r\\n  AVG(vl_medio_nota) AS vl_medio_nota_grupo,\\r\\n  MAX(vl_max_nota) AS vl_max_nota_grupo,\\r\\n  AVG(qt_meses_consumo) AS media_meses_consumo\\r\\nFROM por_cnpj\\r\\nGROUP BY num_grupo;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom_metricas_grupo;\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 3: gei_nfcom_detalhado - Detalhamento mensal por empresa\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom_detalhado;\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom_detalhado AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnfcom.nfcom.infnfcom.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    ano_emissao,\\r\\n    mes_emissao,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n)\\r\\nSELECT\\r\\n  b.cnpj_dest AS cnpj,\\r\\n  gc.num_grupo,\\r\\n  b.ano_emissao,\\r\\n  b.mes_emissao,\\r\\n  SUM(b.vl_nota) AS vl_telecom_mensal,\\r\\n  COUNT(*) AS qt_notas,\\r\\n  COUNT(DISTINCT b.cnpj_emit) AS qt_operadoras\\r\\nFROM base b\\r\\nJOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\nWHERE LENGTH(b.cnpj_dest) >= 11\\r\\nGROUP BY b.cnpj_dest, gc.num_grupo, b.ano_emissao, b.mes_emissao;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom_detalhado;\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 4: gei_nfcom_por_operadora - Analise por operadora de telecom\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom_por_operadora;\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom_por_operadora AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnfcom.nfcom.infnfcom.emit.cnpj), '[^0-9]', '') AS cnpj_operadora,\\r\\n    procnfcom.nfcom.infnfcom.emit.xnome AS nome_operadora,\\r\\n    ano_emissao,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n)\\r\\nSELECT\\r\\n  gc.num_grupo,\\r\\n  b.cnpj_operadora,\\r\\n  MAX(b.nome_operadora) AS nome_operadora,\\r\\n  COUNT(DISTINCT b.cnpj_dest) AS qt_empresas_clientes,\\r\\n  SUM(b.vl_nota) AS vl_total,\\r\\n  COUNT(*) AS qt_notas\\r\\nFROM base b\\r\\nJOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\nWHERE LENGTH(b.cnpj_dest) >= 11\\r\\n  AND LENGTH(b.cnpj_operadora) >= 11\\r\\nGROUP BY gc.num_grupo, b.cnpj_operadora;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom_por_operadora;\", \"statementsList\": [\"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2020\\r\\n    AND ano_emissao <= 2025\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n),\\r\\nagregado AS (\\r\\n  SELECT\\r\\n    cnpj_dest,\\r\\n    nu_per_ref,\\r\\n    SUM(vl_nota) AS vl_telecom_mensal,\\r\\n    COUNT(*) AS qt_notas\\r\\n  FROM base\\r\\n  WHERE LENGTH(cnpj_dest) >= 11\\r\\n  GROUP BY cnpj_dest, nu_per_ref\\r\\n),\\r\\nacumulado AS (\\r\\n  SELECT\\r\\n    cnpj_dest,\\r\\n    nu_per_ref,\\r\\n    vl_telecom_mensal,\\r\\n    qt_notas,\\r\\n    SUM(vl_telecom_mensal) OVER (\\r\\n      PARTITION BY cnpj_dest\\r\\n      ORDER BY nu_per_ref\\r\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\r\\n    ) AS vl_telecom_12m\\r\\n  FROM agregado\\r\\n)\\r\\nSELECT\\r\\n  a.cnpj_dest AS cnpj,\\r\\n\\r\\n  -- Periodo 2021\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202101 THEN a.vl_telecom_12m ELSE 0 END) AS jan2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202102 THEN a.vl_telecom_12m ELSE 0 END) AS fev2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202103 THEN a.vl_telecom_12m ELSE 0 END) AS mar2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202104 THEN a.vl_telecom_12m ELSE 0 END) AS abr2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202105 THEN a.vl_telecom_12m ELSE 0 END) AS mai2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202106 THEN a.vl_telecom_12m ELSE 0 END) AS jun2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202107 THEN a.vl_telecom_12m ELSE 0 END) AS jul2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202108 THEN a.vl_telecom_12m ELSE 0 END) AS ago2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202109 THEN a.vl_telecom_12m ELSE 0 END) AS set2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202110 THEN a.vl_telecom_12m ELSE 0 END) AS out2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202111 THEN a.vl_telecom_12m ELSE 0 END) AS nov2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202112 THEN a.vl_telecom_12m ELSE 0 END) AS dez2021,\\r\\n\\r\\n  -- Periodo 2022\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202201 THEN a.vl_telecom_12m ELSE 0 END) AS jan2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202202 THEN a.vl_telecom_12m ELSE 0 END) AS fev2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202203 THEN a.vl_telecom_12m ELSE 0 END) AS mar2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202204 THEN a.vl_telecom_12m ELSE 0 END) AS abr2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202205 THEN a.vl_telecom_12m ELSE 0 END) AS mai2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202206 THEN a.vl_telecom_12m ELSE 0 END) AS jun2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202207 THEN a.vl_telecom_12m ELSE 0 END) AS jul2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202208 THEN a.vl_telecom_12m ELSE 0 END) AS ago2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202209 THEN a.vl_telecom_12m ELSE 0 END) AS set2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202210 THEN a.vl_telecom_12m ELSE 0 END) AS out2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202211 THEN a.vl_telecom_12m ELSE 0 END) AS nov2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202212 THEN a.vl_telecom_12m ELSE 0 END) AS dez2022,\\r\\n\\r\\n  -- Periodo 2023\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202301 THEN a.vl_telecom_12m ELSE 0 END) AS jan2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202302 THEN a.vl_telecom_12m ELSE 0 END) AS fev2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202303 THEN a.vl_telecom_12m ELSE 0 END) AS mar2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202304 THEN a.vl_telecom_12m ELSE 0 END) AS abr2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202305 THEN a.vl_telecom_12m ELSE 0 END) AS mai2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202306 THEN a.vl_telecom_12m ELSE 0 END) AS jun2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202307 THEN a.vl_telecom_12m ELSE 0 END) AS jul2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202308 THEN a.vl_telecom_12m ELSE 0 END) AS ago2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202309 THEN a.vl_telecom_12m ELSE 0 END) AS set2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202310 THEN a.vl_telecom_12m ELSE 0 END) AS out2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202311 THEN a.vl_telecom_12m ELSE 0 END) AS nov2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202312 THEN a.vl_telecom_12m ELSE 0 END) AS dez2023,\\r\\n\\r\\n  -- Periodo 2024\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202401 THEN a.vl_telecom_12m ELSE 0 END) AS jan2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202402 THEN a.vl_telecom_12m ELSE 0 END) AS fev2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202403 THEN a.vl_telecom_12m ELSE 0 END) AS mar2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202404 THEN a.vl_telecom_12m ELSE 0 END) AS abr2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202405 THEN a.vl_telecom_12m ELSE 0 END) AS mai2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202406 THEN a.vl_telecom_12m ELSE 0 END) AS jun2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202407 THEN a.vl_telecom_12m ELSE 0 END) AS jul2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202408 THEN a.vl_telecom_12m ELSE 0 END) AS ago2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202409 THEN a.vl_telecom_12m ELSE 0 END) AS set2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202410 THEN a.vl_telecom_12m ELSE 0 END) AS out2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202411 THEN a.vl_telecom_12m ELSE 0 END) AS nov2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202412 THEN a.vl_telecom_12m ELSE 0 END) AS dez2024,\\r\\n\\r\\n  -- Periodo 2025\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202501 THEN a.vl_telecom_12m ELSE 0 END) AS jan2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202502 THEN a.vl_telecom_12m ELSE 0 END) AS fev2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202503 THEN a.vl_telecom_12m ELSE 0 END) AS mar2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202504 THEN a.vl_telecom_12m ELSE 0 END) AS abr2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202505 THEN a.vl_telecom_12m ELSE 0 END) AS mai2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202506 THEN a.vl_telecom_12m ELSE 0 END) AS jun2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202507 THEN a.vl_telecom_12m ELSE 0 END) AS jul2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202508 THEN a.vl_telecom_12m ELSE 0 END) AS ago2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202509 THEN a.vl_telecom_12m ELSE 0 END) AS set2025\\r\\n\\r\\nFROM acumulado a\\r\\nJOIN gessimples.gei_cnpj gc ON a.cnpj_dest = gc.cnpj\\r\\nWHERE a.vl_telecom_12m IS NOT NULL\\r\\nGROUP BY a.cnpj_dest;\", \"\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 2: gei_nfcom_metricas_grupo - Metricas agregadas por grupo economico\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom_metricas_grupo;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom_metricas_grupo AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnfcom.nfcom.infnfcom.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n),\\r\\npor_cnpj AS (\\r\\n  SELECT\\r\\n    b.cnpj_dest,\\r\\n    gc.num_grupo,\\r\\n    SUM(b.vl_nota) AS vl_total_telecom,\\r\\n    COUNT(*) AS qt_notas,\\r\\n    COUNT(DISTINCT b.cnpj_emit) AS qt_operadoras,\\r\\n    COUNT(DISTINCT b.nu_per_ref) AS qt_meses_consumo,\\r\\n    AVG(b.vl_nota) AS vl_medio_nota,\\r\\n    MAX(b.vl_nota) AS vl_max_nota,\\r\\n    MIN(CASE WHEN b.vl_nota > 0 THEN b.vl_nota END) AS vl_min_nota\\r\\n  FROM base b\\r\\n  JOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\n  WHERE LENGTH(b.cnpj_dest) >= 11\\r\\n  GROUP BY b.cnpj_dest, gc.num_grupo\\r\\n)\\r\\nSELECT\\r\\n  num_grupo,\\r\\n  COUNT(DISTINCT cnpj_dest) AS qt_empresas_consumidoras,\\r\\n  SUM(vl_total_telecom) AS vl_telecom_grupo,\\r\\n  SUM(qt_notas) AS qt_notas_grupo,\\r\\n  SUM(qt_operadoras) AS qt_operadoras_grupo,\\r\\n  AVG(vl_medio_nota) AS vl_medio_nota_grupo,\\r\\n  MAX(vl_max_nota) AS vl_max_nota_grupo,\\r\\n  AVG(qt_meses_consumo) AS media_meses_consumo\\r\\nFROM por_cnpj\\r\\nGROUP BY num_grupo;\", \"\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom_metricas_grupo;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 3: gei_nfcom_detalhado - Detalhamento mensal por empresa\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom_detalhado;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom_detalhado AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnfcom.nfcom.infnfcom.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    ano_emissao,\\r\\n    mes_emissao,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n)\\r\\nSELECT\\r\\n  b.cnpj_dest AS cnpj,\\r\\n  gc.num_grupo,\\r\\n  b.ano_emissao,\\r\\n  b.mes_emissao,\\r\\n  SUM(b.vl_nota) AS vl_telecom_mensal,\\r\\n  COUNT(*) AS qt_notas,\\r\\n  COUNT(DISTINCT b.cnpj_emit) AS qt_operadoras\\r\\nFROM base b\\r\\nJOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\nWHERE LENGTH(b.cnpj_dest) >= 11\\r\\nGROUP BY b.cnpj_dest, gc.num_grupo, b.ano_emissao, b.mes_emissao;\", \"\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom_detalhado;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 4: gei_nfcom_por_operadora - Analise por operadora de telecom\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom_por_operadora;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom_por_operadora AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnfcom.nfcom.infnfcom.emit.cnpj), '[^0-9]', '') AS cnpj_operadora,\\r\\n    procnfcom.nfcom.infnfcom.emit.xnome AS nome_operadora,\\r\\n    ano_emissao,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n)\\r\\nSELECT\\r\\n  gc.num_grupo,\\r\\n  b.cnpj_operadora,\\r\\n  MAX(b.nome_operadora) AS nome_operadora,\\r\\n  COUNT(DISTINCT b.cnpj_dest) AS qt_empresas_clientes,\\r\\n  SUM(b.vl_nota) AS vl_total,\\r\\n  COUNT(*) AS qt_notas\\r\\nFROM base b\\r\\nJOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\nWHERE LENGTH(b.cnpj_dest) >= 11\\r\\n  AND LENGTH(b.cnpj_operadora) >= 11\\r\\nGROUP BY gc.num_grupo, b.cnpj_operadora;\", \"\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom_por_operadora;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Example: SELECT * FROM tablename, or press CTRL + space\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- =====================================================\\r\\n-- GEI - SISTEMA DE DETECAO DE GRUPOS ECONOMICOS\\r\\n-- TABELA GEI_NFCOM - Notas Fiscais de Comunicacao\\r\\n-- =====================================================\\r\\n-- Autor: Sistema GEI\\r\\n-- Data: 2025-12-18\\r\\n-- Descricao: Agregacao de consumo de telecomunicacoes por CNPJ\\r\\n-- Fonte: nfcom.nfcom (34 milhoes de registros)\\r\\n-- =====================================================\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 1: gei_nfcom - Valores mensais por CNPJ destinatario\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2020\\r\\n    AND ano_emissao <= 2025\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n),\\r\\nagregado AS (\\r\\n  SELECT\\r\\n    cnpj_dest,\\r\\n    nu_per_ref,\\r\\n    SUM(vl_nota) AS vl_telecom_mensal,\\r\\n    COUNT(*) AS qt_notas\\r\\n  FROM base\\r\\n  WHERE LENGTH(cnpj_dest) >= 11\\r\\n  GROUP BY cnpj_dest, nu_per_ref\\r\\n),\\r\\nacumulado AS (\\r\\n  SELECT\\r\\n    cnpj_dest,\\r\\n    nu_per_ref,\\r\\n    vl_telecom_mensal,\\r\\n    qt_notas,\\r\\n    SUM(vl_telecom_mensal) OVER (\\r\\n      PARTITION BY cnpj_dest\\r\\n      ORDER BY nu_per_ref\\r\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\r\\n    ) AS vl_telecom_12m\\r\\n  FROM agregado\\r\\n)\\r\\nSELECT\\r\\n  a.cnpj_dest AS cnpj,\\r\\n\\r\\n  -- Periodo 2021\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202101 THEN a.vl_telecom_12m ELSE 0 END) AS jan2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202102 THEN a.vl_telecom_12m ELSE 0 END) AS fev2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202103 THEN a.vl_telecom_12m ELSE 0 END) AS mar2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202104 THEN a.vl_telecom_12m ELSE 0 END) AS abr2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202105 THEN a.vl_telecom_12m ELSE 0 END) AS mai2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202106 THEN a.vl_telecom_12m ELSE 0 END) AS jun2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202107 THEN a.vl_telecom_12m ELSE 0 END) AS jul2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202108 THEN a.vl_telecom_12m ELSE 0 END) AS ago2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202109 THEN a.vl_telecom_12m ELSE 0 END) AS set2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202110 THEN a.vl_telecom_12m ELSE 0 END) AS out2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202111 THEN a.vl_telecom_12m ELSE 0 END) AS nov2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202112 THEN a.vl_telecom_12m ELSE 0 END) AS dez2021,\\r\\n\\r\\n  -- Periodo 2022\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202201 THEN a.vl_telecom_12m ELSE 0 END) AS jan2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202202 THEN a.vl_telecom_12m ELSE 0 END) AS fev2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202203 THEN a.vl_telecom_12m ELSE 0 END) AS mar2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202204 THEN a.vl_telecom_12m ELSE 0 END) AS abr2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202205 THEN a.vl_telecom_12m ELSE 0 END) AS mai2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202206 THEN a.vl_telecom_12m ELSE 0 END) AS jun2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202207 THEN a.vl_telecom_12m ELSE 0 END) AS jul2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202208 THEN a.vl_telecom_12m ELSE 0 END) AS ago2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202209 THEN a.vl_telecom_12m ELSE 0 END) AS set2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202210 THEN a.vl_telecom_12m ELSE 0 END) AS out2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202211 THEN a.vl_telecom_12m ELSE 0 END) AS nov2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202212 THEN a.vl_telecom_12m ELSE 0 END) AS dez2022,\\r\\n\\r\\n  -- Periodo 2023\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202301 THEN a.vl_telecom_12m ELSE 0 END) AS jan2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202302 THEN a.vl_telecom_12m ELSE 0 END) AS fev2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202303 THEN a.vl_telecom_12m ELSE 0 END) AS mar2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202304 THEN a.vl_telecom_12m ELSE 0 END) AS abr2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202305 THEN a.vl_telecom_12m ELSE 0 END) AS mai2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202306 THEN a.vl_telecom_12m ELSE 0 END) AS jun2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202307 THEN a.vl_telecom_12m ELSE 0 END) AS jul2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202308 THEN a.vl_telecom_12m ELSE 0 END) AS ago2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202309 THEN a.vl_telecom_12m ELSE 0 END) AS set2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202310 THEN a.vl_telecom_12m ELSE 0 END) AS out2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202311 THEN a.vl_telecom_12m ELSE 0 END) AS nov2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202312 THEN a.vl_telecom_12m ELSE 0 END) AS dez2023,\\r\\n\\r\\n  -- Periodo 2024\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202401 THEN a.vl_telecom_12m ELSE 0 END) AS jan2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202402 THEN a.vl_telecom_12m ELSE 0 END) AS fev2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202403 THEN a.vl_telecom_12m ELSE 0 END) AS mar2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202404 THEN a.vl_telecom_12m ELSE 0 END) AS abr2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202405 THEN a.vl_telecom_12m ELSE 0 END) AS mai2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202406 THEN a.vl_telecom_12m ELSE 0 END) AS jun2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202407 THEN a.vl_telecom_12m ELSE 0 END) AS jul2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202408 THEN a.vl_telecom_12m ELSE 0 END) AS ago2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202409 THEN a.vl_telecom_12m ELSE 0 END) AS set2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202410 THEN a.vl_telecom_12m ELSE 0 END) AS out2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202411 THEN a.vl_telecom_12m ELSE 0 END) AS nov2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202412 THEN a.vl_telecom_12m ELSE 0 END) AS dez2024,\\r\\n\\r\\n  -- Periodo 2025\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202501 THEN a.vl_telecom_12m ELSE 0 END) AS jan2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202502 THEN a.vl_telecom_12m ELSE 0 END) AS fev2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202503 THEN a.vl_telecom_12m ELSE 0 END) AS mar2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202504 THEN a.vl_telecom_12m ELSE 0 END) AS abr2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202505 THEN a.vl_telecom_12m ELSE 0 END) AS mai2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202506 THEN a.vl_telecom_12m ELSE 0 END) AS jun2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202507 THEN a.vl_telecom_12m ELSE 0 END) AS jul2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202508 THEN a.vl_telecom_12m ELSE 0 END) AS ago2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202509 THEN a.vl_telecom_12m ELSE 0 END) AS set2025\\r\\n\\r\\nFROM acumulado a\\r\\nJOIN gessimples.gei_cnpj gc ON a.cnpj_dest = gc.cnpj\\r\\nWHERE a.vl_telecom_12m IS NOT NULL\\r\\nGROUP BY a.cnpj_dest;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom;\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 2: gei_nfcom_metricas_grupo - Metricas agregadas por grupo economico\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom_metricas_grupo;\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom_metricas_grupo AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnfcom.nfcom.infnfcom.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n),\\r\\npor_cnpj AS (\\r\\n  SELECT\\r\\n    b.cnpj_dest,\\r\\n    gc.num_grupo,\\r\\n    SUM(b.vl_nota) AS vl_total_telecom,\\r\\n    COUNT(*) AS qt_notas,\\r\\n    COUNT(DISTINCT b.cnpj_emit) AS qt_operadoras,\\r\\n    COUNT(DISTINCT b.nu_per_ref) AS qt_meses_consumo,\\r\\n    AVG(b.vl_nota) AS vl_medio_nota,\\r\\n    MAX(b.vl_nota) AS vl_max_nota,\\r\\n    MIN(CASE WHEN b.vl_nota > 0 THEN b.vl_nota END) AS vl_min_nota\\r\\n  FROM base b\\r\\n  JOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\n  WHERE LENGTH(b.cnpj_dest) >= 11\\r\\n  GROUP BY b.cnpj_dest, gc.num_grupo\\r\\n)\\r\\nSELECT\\r\\n  num_grupo,\\r\\n  COUNT(DISTINCT cnpj_dest) AS qt_empresas_consumidoras,\\r\\n  SUM(vl_total_telecom) AS vl_telecom_grupo,\\r\\n  SUM(qt_notas) AS qt_notas_grupo,\\r\\n  SUM(qt_operadoras) AS qt_operadoras_grupo,\\r\\n  AVG(vl_medio_nota) AS vl_medio_nota_grupo,\\r\\n  MAX(vl_max_nota) AS vl_max_nota_grupo,\\r\\n  AVG(qt_meses_consumo) AS media_meses_consumo\\r\\nFROM por_cnpj\\r\\nGROUP BY num_grupo;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom_metricas_grupo;\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 3: gei_nfcom_detalhado - Detalhamento mensal por empresa\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom_detalhado;\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom_detalhado AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnfcom.nfcom.infnfcom.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    ano_emissao,\\r\\n    mes_emissao,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n)\\r\\nSELECT\\r\\n  b.cnpj_dest AS cnpj,\\r\\n  gc.num_grupo,\\r\\n  b.ano_emissao,\\r\\n  b.mes_emissao,\\r\\n  SUM(b.vl_nota) AS vl_telecom_mensal,\\r\\n  COUNT(*) AS qt_notas,\\r\\n  COUNT(DISTINCT b.cnpj_emit) AS qt_operadoras\\r\\nFROM base b\\r\\nJOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\nWHERE LENGTH(b.cnpj_dest) >= 11\\r\\nGROUP BY b.cnpj_dest, gc.num_grupo, b.ano_emissao, b.mes_emissao;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom_detalhado;\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 4: gei_nfcom_por_operadora - Analise por operadora de telecom\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom_por_operadora;\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom_por_operadora AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnfcom.nfcom.infnfcom.emit.cnpj), '[^0-9]', '') AS cnpj_operadora,\\r\\n    procnfcom.nfcom.infnfcom.emit.xnome AS nome_operadora,\\r\\n    ano_emissao,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n)\\r\\nSELECT\\r\\n  gc.num_grupo,\\r\\n  b.cnpj_operadora,\\r\\n  MAX(b.nome_operadora) AS nome_operadora,\\r\\n  COUNT(DISTINCT b.cnpj_dest) AS qt_empresas_clientes,\\r\\n  SUM(b.vl_nota) AS vl_total,\\r\\n  COUNT(*) AS qt_notas\\r\\nFROM base b\\r\\nJOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\nWHERE LENGTH(b.cnpj_dest) >= 11\\r\\n  AND LENGTH(b.cnpj_operadora) >= 11\\r\\nGROUP BY gc.num_grupo, b.cnpj_operadora;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom_por_operadora;\", \"result\": {\"id\": \"45383448-903b-deb1-f35b-d4cac0e81b86\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"ZiYizN/fQ6q3keeUj/AU/Q==\", \"guid\": \"m+fPs8hOQZoAAAAAZ3G1QA==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"f64802d29eb8cdab:0a19854054b5ce8d\", \"session_id\": 24178, \"session_type\": \"impala\", \"statement_id\": 12, \"has_more_statements\": false, \"statements_count\": 13, \"previous_statement_hash\": \"3a293975c486da7fd4838336f0fbbb8dac7ea5bf813052488a2e8958\", \"start\": {\"row\": 254, \"column\": 0}, \"end\": {\"row\": 254, \"column\": 48}, \"statement\": \"COMPUTE STATS gessimples.gei_nfcom_por_operadora\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 12, \"statement_range\": {\"start\": {\"row\": 254, \"column\": 0}, \"end\": {\"row\": 254, \"column\": 48}}, \"statements_count\": 13, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"summary\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-12-18T21:03:00.623Z\", \"endTime\": \"2025-12-18T21:03:01.943Z\", \"executionTime\": 1320, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 5870, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 5946, \"getLogsTimeout\": 5958, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1766091780387, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- =====================================================\\r\\n-- GEI - SISTEMA DE DETECAO DE GRUPOS ECONOMICOS\\r\\n-- TABELA GEI_NFCOM - Notas Fiscais de Comunicacao\\r\\n-- =====================================================\\r\\n-- Autor: Sistema GEI\\r\\n-- Data: 2025-12-18\\r\\n-- Descricao: Agregacao de consumo de telecomunicacoes por CNPJ\\r\\n-- Fonte: nfcom.nfcom (34 milhoes de registros)\\r\\n-- =====================================================\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 1: gei_nfcom - Valores mensais por CNPJ destinatario\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2020\\r\\n    AND ano_emissao <= 2025\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n),\\r\\nagregado AS (\\r\\n  SELECT\\r\\n    cnpj_dest,\\r\\n    nu_per_ref,\\r\\n    SUM(vl_nota) AS vl_telecom_mensal,\\r\\n    COUNT(*) AS qt_notas\\r\\n  FROM base\\r\\n  WHERE LENGTH(cnpj_dest) >= 11\\r\\n  GROUP BY cnpj_dest, nu_per_ref\\r\\n),\\r\\nacumulado AS (\\r\\n  SELECT\\r\\n    cnpj_dest,\\r\\n    nu_per_ref,\\r\\n    vl_telecom_mensal,\\r\\n    qt_notas,\\r\\n    SUM(vl_telecom_mensal) OVER (\\r\\n      PARTITION BY cnpj_dest\\r\\n      ORDER BY nu_per_ref\\r\\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\\r\\n    ) AS vl_telecom_12m\\r\\n  FROM agregado\\r\\n)\\r\\nSELECT\\r\\n  a.cnpj_dest AS cnpj,\\r\\n\\r\\n  -- Periodo 2021\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202101 THEN a.vl_telecom_12m ELSE 0 END) AS jan2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202102 THEN a.vl_telecom_12m ELSE 0 END) AS fev2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202103 THEN a.vl_telecom_12m ELSE 0 END) AS mar2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202104 THEN a.vl_telecom_12m ELSE 0 END) AS abr2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202105 THEN a.vl_telecom_12m ELSE 0 END) AS mai2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202106 THEN a.vl_telecom_12m ELSE 0 END) AS jun2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202107 THEN a.vl_telecom_12m ELSE 0 END) AS jul2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202108 THEN a.vl_telecom_12m ELSE 0 END) AS ago2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202109 THEN a.vl_telecom_12m ELSE 0 END) AS set2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202110 THEN a.vl_telecom_12m ELSE 0 END) AS out2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202111 THEN a.vl_telecom_12m ELSE 0 END) AS nov2021,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202112 THEN a.vl_telecom_12m ELSE 0 END) AS dez2021,\\r\\n\\r\\n  -- Periodo 2022\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202201 THEN a.vl_telecom_12m ELSE 0 END) AS jan2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202202 THEN a.vl_telecom_12m ELSE 0 END) AS fev2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202203 THEN a.vl_telecom_12m ELSE 0 END) AS mar2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202204 THEN a.vl_telecom_12m ELSE 0 END) AS abr2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202205 THEN a.vl_telecom_12m ELSE 0 END) AS mai2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202206 THEN a.vl_telecom_12m ELSE 0 END) AS jun2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202207 THEN a.vl_telecom_12m ELSE 0 END) AS jul2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202208 THEN a.vl_telecom_12m ELSE 0 END) AS ago2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202209 THEN a.vl_telecom_12m ELSE 0 END) AS set2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202210 THEN a.vl_telecom_12m ELSE 0 END) AS out2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202211 THEN a.vl_telecom_12m ELSE 0 END) AS nov2022,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202212 THEN a.vl_telecom_12m ELSE 0 END) AS dez2022,\\r\\n\\r\\n  -- Periodo 2023\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202301 THEN a.vl_telecom_12m ELSE 0 END) AS jan2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202302 THEN a.vl_telecom_12m ELSE 0 END) AS fev2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202303 THEN a.vl_telecom_12m ELSE 0 END) AS mar2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202304 THEN a.vl_telecom_12m ELSE 0 END) AS abr2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202305 THEN a.vl_telecom_12m ELSE 0 END) AS mai2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202306 THEN a.vl_telecom_12m ELSE 0 END) AS jun2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202307 THEN a.vl_telecom_12m ELSE 0 END) AS jul2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202308 THEN a.vl_telecom_12m ELSE 0 END) AS ago2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202309 THEN a.vl_telecom_12m ELSE 0 END) AS set2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202310 THEN a.vl_telecom_12m ELSE 0 END) AS out2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202311 THEN a.vl_telecom_12m ELSE 0 END) AS nov2023,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202312 THEN a.vl_telecom_12m ELSE 0 END) AS dez2023,\\r\\n\\r\\n  -- Periodo 2024\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202401 THEN a.vl_telecom_12m ELSE 0 END) AS jan2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202402 THEN a.vl_telecom_12m ELSE 0 END) AS fev2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202403 THEN a.vl_telecom_12m ELSE 0 END) AS mar2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202404 THEN a.vl_telecom_12m ELSE 0 END) AS abr2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202405 THEN a.vl_telecom_12m ELSE 0 END) AS mai2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202406 THEN a.vl_telecom_12m ELSE 0 END) AS jun2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202407 THEN a.vl_telecom_12m ELSE 0 END) AS jul2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202408 THEN a.vl_telecom_12m ELSE 0 END) AS ago2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202409 THEN a.vl_telecom_12m ELSE 0 END) AS set2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202410 THEN a.vl_telecom_12m ELSE 0 END) AS out2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202411 THEN a.vl_telecom_12m ELSE 0 END) AS nov2024,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202412 THEN a.vl_telecom_12m ELSE 0 END) AS dez2024,\\r\\n\\r\\n  -- Periodo 2025\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202501 THEN a.vl_telecom_12m ELSE 0 END) AS jan2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202502 THEN a.vl_telecom_12m ELSE 0 END) AS fev2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202503 THEN a.vl_telecom_12m ELSE 0 END) AS mar2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202504 THEN a.vl_telecom_12m ELSE 0 END) AS abr2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202505 THEN a.vl_telecom_12m ELSE 0 END) AS mai2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202506 THEN a.vl_telecom_12m ELSE 0 END) AS jun2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202507 THEN a.vl_telecom_12m ELSE 0 END) AS jul2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202508 THEN a.vl_telecom_12m ELSE 0 END) AS ago2025,\\r\\n  MAX(CASE WHEN a.nu_per_ref = 202509 THEN a.vl_telecom_12m ELSE 0 END) AS set2025\\r\\n\\r\\nFROM acumulado a\\r\\nJOIN gessimples.gei_cnpj gc ON a.cnpj_dest = gc.cnpj\\r\\nWHERE a.vl_telecom_12m IS NOT NULL\\r\\nGROUP BY a.cnpj_dest;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom;\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 2: gei_nfcom_metricas_grupo - Metricas agregadas por grupo economico\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom_metricas_grupo;\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom_metricas_grupo AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnfcom.nfcom.infnfcom.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n),\\r\\npor_cnpj AS (\\r\\n  SELECT\\r\\n    b.cnpj_dest,\\r\\n    gc.num_grupo,\\r\\n    SUM(b.vl_nota) AS vl_total_telecom,\\r\\n    COUNT(*) AS qt_notas,\\r\\n    COUNT(DISTINCT b.cnpj_emit) AS qt_operadoras,\\r\\n    COUNT(DISTINCT b.nu_per_ref) AS qt_meses_consumo,\\r\\n    AVG(b.vl_nota) AS vl_medio_nota,\\r\\n    MAX(b.vl_nota) AS vl_max_nota,\\r\\n    MIN(CASE WHEN b.vl_nota > 0 THEN b.vl_nota END) AS vl_min_nota\\r\\n  FROM base b\\r\\n  JOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\n  WHERE LENGTH(b.cnpj_dest) >= 11\\r\\n  GROUP BY b.cnpj_dest, gc.num_grupo\\r\\n)\\r\\nSELECT\\r\\n  num_grupo,\\r\\n  COUNT(DISTINCT cnpj_dest) AS qt_empresas_consumidoras,\\r\\n  SUM(vl_total_telecom) AS vl_telecom_grupo,\\r\\n  SUM(qt_notas) AS qt_notas_grupo,\\r\\n  SUM(qt_operadoras) AS qt_operadoras_grupo,\\r\\n  AVG(vl_medio_nota) AS vl_medio_nota_grupo,\\r\\n  MAX(vl_max_nota) AS vl_max_nota_grupo,\\r\\n  AVG(qt_meses_consumo) AS media_meses_consumo\\r\\nFROM por_cnpj\\r\\nGROUP BY num_grupo;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom_metricas_grupo;\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 3: gei_nfcom_detalhado - Detalhamento mensal por empresa\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom_detalhado;\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom_detalhado AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnfcom.nfcom.infnfcom.emit.cnpj), '[^0-9]', '') AS cnpj_emit,\\r\\n    ano_emissao,\\r\\n    mes_emissao,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n)\\r\\nSELECT\\r\\n  b.cnpj_dest AS cnpj,\\r\\n  gc.num_grupo,\\r\\n  b.ano_emissao,\\r\\n  b.mes_emissao,\\r\\n  SUM(b.vl_nota) AS vl_telecom_mensal,\\r\\n  COUNT(*) AS qt_notas,\\r\\n  COUNT(DISTINCT b.cnpj_emit) AS qt_operadoras\\r\\nFROM base b\\r\\nJOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\nWHERE LENGTH(b.cnpj_dest) >= 11\\r\\nGROUP BY b.cnpj_dest, gc.num_grupo, b.ano_emissao, b.mes_emissao;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom_detalhado;\\r\\n\\r\\n\\r\\n-- =====================================================\\r\\n-- TABELA 4: gei_nfcom_por_operadora - Analise por operadora de telecom\\r\\n-- =====================================================\\r\\nDROP TABLE IF EXISTS gessimples.gei_nfcom_por_operadora;\\r\\n\\r\\nCREATE TABLE gessimples.gei_nfcom_por_operadora AS\\r\\nWITH base AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(COALESCE(\\r\\n      procnfcom.nfcom.infnfcom.dest.cnpj,\\r\\n      procnfcom.nfcom.infnfcom.dest.cpf\\r\\n    )), '[^0-9]', '') AS cnpj_dest,\\r\\n    REGEXP_REPLACE(TRIM(procnfcom.nfcom.infnfcom.emit.cnpj), '[^0-9]', '') AS cnpj_operadora,\\r\\n    procnfcom.nfcom.infnfcom.emit.xnome AS nome_operadora,\\r\\n    ano_emissao,\\r\\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\\r\\n  FROM nfcom.nfcom\\r\\n  WHERE ano_emissao >= 2023\\r\\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\\r\\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\\r\\n)\\r\\nSELECT\\r\\n  gc.num_grupo,\\r\\n  b.cnpj_operadora,\\r\\n  MAX(b.nome_operadora) AS nome_operadora,\\r\\n  COUNT(DISTINCT b.cnpj_dest) AS qt_empresas_clientes,\\r\\n  SUM(b.vl_nota) AS vl_total,\\r\\n  COUNT(*) AS qt_notas\\r\\nFROM base b\\r\\nJOIN gessimples.gei_cnpj gc ON b.cnpj_dest = gc.cnpj\\r\\nWHERE LENGTH(b.cnpj_dest) >= 11\\r\\n  AND LENGTH(b.cnpj_operadora) >= 11\\r\\nGROUP BY gc.num_grupo, b.cnpj_operadora;\\r\\n\\r\\nCOMPUTE STATS gessimples.gei_nfcom_por_operadora;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 254, \"column\": 49}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"9a414ec8b3cfe79b:40b5716700000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=9a414ec8b3cfe79b:40b5716700000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"\", \"progress\": 100, \"jobs\": [{\"name\": \"9a414ec8b3cfe79b:40b5716700000000\", \"url\": \"/hue/jobbrowser#!id=9a414ec8b3cfe79b:40b5716700000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 14023, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 231, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false, \"is_history\": false}",
    "extra": "",
    "search": "-- =====================================================\r\n-- GEI - SISTEMA DE DETECAO DE GRUPOS ECONOMICOS\r\n-- TABELA GEI_NFCOM - Notas Fiscais de Comunicacao\r\n-- =====================================================\r\n-- Autor: Sistema GEI\r\n-- Data: 2025-12-18\r\n-- Descricao: Agregacao de consumo de telecomunicacoes por CNPJ\r\n-- Fonte: nfcom.nfcom (34 milhoes de registros)\r\n-- =====================================================\r\n\r\n-- =====================================================\r\n-- TABELA 1: gei_nfcom - Valores mensais por CNPJ destinatario\r\n-- =====================================================\r\nDROP TABLE IF EXISTS gessimples.gei_nfcom;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE gessimples.gei_nfcom AS\r\nWITH base AS (\r\n  SELECT\r\n    REGEXP_REPLACE(TRIM(COALESCE(\r\n      procnfcom.nfcom.infnfcom.dest.cnpj,\r\n      procnfcom.nfcom.infnfcom.dest.cpf\r\n    )), '[^0-9]', '') AS cnpj_dest,\r\n    CAST(ano_emissao AS INT) * 100 + CAST(mes_emissao AS INT) AS nu_per_ref,\r\n    COALESCE(CAST(procnfcom.nfcom.infnfcom.total.vnf AS DOUBLE), 0) AS vl_nota\r\n  FROM nfcom.nfcom\r\n  WHERE ano_emissao >= 2020\r\n    AND ano_emissao <= 2025\r\n    AND (procnfcom.nfcom.infnfcom.dest.cnpj IS NOT NULL\r\n         OR procnfcom.nfcom.infnfcom.dest.cpf IS NOT NULL)\r\n),\r\nagregado AS (\r\n  SELECT\r\n    cnpj_dest,\r\n    nu_per_ref,\r\n    SUM(vl_nota) AS vl_telecom_mensal,\r\n    COUNT(*) AS qt_notas\r\n  FROM base\r\n  WHERE LENGTH(cnpj_dest) >= 11\r\n  GROUP BY cnpj_dest, nu_per_ref\r\n),\r\nacumulado AS (\r\n  SELECT\r\n    cnpj_dest,\r\n    nu_per_ref,\r\n    vl_telecom_mensal,\r\n    qt_notas,\r\n    SUM(vl_telecom_mensal) OVER (\r\n      PARTITION BY cnpj_dest\r\n      ORDER BY nu_per_ref\r\n      ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\r\n    ) AS vl_telecom_12m\r\n  FROM agregado\r\n)\r\nSELECT\r\n  a.cnpj_dest AS cnpj,\r\n\r\n  -- Periodo 2021\r\n  MAX(CASE WHEN a.nu_per_ref = 202101 THEN a.vl_telecom_12m ELSE 0 END) AS jan2021,\r\n  MAX(CASE WHEN a.nu_per_ref = 202102 THEN a.vl_telecom_12m ELSE 0 END) AS fev2021,\r\n  MAX(CASE WHEN ",
    "last_modified": "2025-12-18T18:03:07.142",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "73079828-6334-4071-9c44-0b48b8d62ba7",
      1,
      false
    ],
    "dependencies": []
  }
}
]
